<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Atlas</title>
		<script src="dist/atlas.js"></script>
		<script src="lib/codemirror.js"></script>
		<script src="lib/acorn.js"></script>
		<link rel="stylesheet" href="lib/codemirror.css">
		<script src="lib/javascript.js"></script>
		<script src="lib/jquery-1.12.4.js"></script>
		<script src="lib/jquery-ui.js"></script>
		<link rel="stylesheet" href="lib/jquery-ui.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
		<link rel="stylesheet" href="/main.css">
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>

		<style>
			html {
				margin: 0px;
				padding: 0px;
				height: 100%;
				font-family: Arial;
			}
			body {
				height: 100vh;
				margin: 0px;
				padding: 0px;
			}
			#demoList{
				width: 152px;
				height:calc(100% - 10px);
				border-right: 1px solid #ccc;
				background: #f2f2f2;
				margin: -5px;
				padding: 10px 5px 0 25px;
				float: left;
				list-style: none;
				font-size:12px;
				overflow-y: scroll;
			}
			.category {
				margin:15px 0 10px -7px;
				font-weight: bold;
			}
			.demos {
				margin-bottom: 10px;
				padding: 0px 15px 0 5px;
				list-style: none;
			}
			.demos li {
				margin-bottom: 8px;
			}
			.demos li:hover{
				cursor: pointer;
				color: blue;
			}
			#intro {
				width: calc(100% - 183px);
				position: absolute;
				top: 0;
				left: 185px;
				text-align: center;
				background-image: url("gallery.png");
				background-size: contain;
				height:99%;
			}
			#canvas,
			#svgElement {
				width: calc(100% - 183px);
				height:99%;
				margin:0;
				padding:0;
				position: absolute;
				top: 0;
				left: 185px;
			}
			#console {
				width: calc(100% - 198px);
				position: absolute;
				left: 191px;
				height: 70%;
				resize: none;
				border:none;
				display: none;
				padding: 10px;
			}
			#btmPanel {
				width:calc(100% - 185px);
				height: 260px;
				position:absolute;
				bottom:0px;
				right: 0px;
			}
			.ui-tabs {
				padding:0;
			}
			.ui-tabs .ui-tabs-panel {
    			padding: 0;
			}
			.ui-tabs .ui-tabs-nav li a {
				font-size:8.5pt !important;
				padding:0;
			}
			#codeTab {
				width:100%;
				height:calc(100% - 40px);
			}
			#dataTab {
				width:100%;
				height:calc(100% - 40px);
			}
			#codeControls {
				width:110px;
				height: 30px;
				position:absolute;
				top:0;
				right: 0;
				margin:8px 10px 0 0;
				/* border-top: 1px solid #ccc; */
				/* background: #f2f2f2; */
				font-size: 8.5pt;
			}
			.CodeMirror {
				width: 100%;
				height: 100%; 
				resize: none;
				border:none;
				padding: 0px;
				font-family: Courier;
				font-size:12.5px;
				overflow-x: hidden;
			}
		</style>
	</head>
	<body>
		<div class="header-bar fixed-top"></div>
		<header class="navbar fixed-top navbar-expand-md navbar-light">
		<div class="container">
			<input class="menu-btn order-0" type="checkbox" id="menu-btn">
			<label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>
			<a class="navbar-brand order-1 order-md-0 me-auto" href="/">Atlas</a>
			<button id="mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
			<span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
			</button>
			<ul class="navbar-nav social-nav order-3 order-md-5">
			<li class="nav-item">
				<a class="nav-link" href="https://twitter.com/getdoks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><span class="ms-2 visually-hidden">Twitter</span></a>
				</li>
			<li class="nav-item">
				<a class="nav-link" href="https://github.com/h-enk/doks"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a>
				</li>
			</ul>
			<div class="collapse navbar-collapse order-4 order-md-1">
			<ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class="nav-item">
					<a class="nav-link" href="/catalog.html">Chart Catalog</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/blog/">Getting Started</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/docs/prologue/introduction/">API Reference</a>
				</li>
				</ul>
			<div class="break order-6 d-md-none"></div>
			<form class="navbar-form flex-grow-1 order-7 order-md-3">
				<input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..." aria-label="Search docs..." autocomplete="off">
				<div id="suggestions" class="shadow bg-white rounded"></div>
			</form>
			</div>
		</div>
		</header>
		<ul id="demoList">
			<li class="category">Bars and Rectangles</li>
			<ul class="demos">
				<li onclick="loadDemo('BarChartHorz')">Bar Chart (Horizontal)</li>
				<li onclick="loadDemo('BarChartVert')">Bar Chart (Vertical)</li>
				<li onclick="loadDemo('BoxPlot')">Box Plot</li>
				<li onclick="loadDemo('BulletChart')">Bullet Chart</li>
				<li onclick="loadDemo('DivergingBarChart')">Diverging Bar Chart</li>
				<li onclick="loadDemo('GanttChart')">Gantt Chart</li>
				<li onclick="loadDemo('GroupedBarChart')">Grouped Bar Chart</li>
				<li onclick="loadDemo('HeatMap')">Heat Map</li>
				<li onclick="loadDemo('Histogram')">Histogram</li>
				<li onclick="loadDemo('MosaicPlot')">Mosaic Plot</li>
				<li onclick="loadDemo('StackedBarChart')">Stacked Bar Chart</li>
				<li onclick="loadDemo('Treemap')">Treemap</li>
				<li onclick="loadDemo('VariableWidthBarChart')">Variable Width Bar Chart</li>
				<li onclick="loadDemo('WaffleChart')">Waffle Chart</li>
				<li onclick="loadDemo('WaterfallChart')">Waterfall Chart</li>
			</ul>
			<li class="category">Circles and Pies</li>
			<ul class="demos">
				<li onclick="loadDemo('BubblePlot')">Bubble Plot</li>
				<li onclick="loadDemo('CirclePacking')">Circle Packing Chart</li>
				<li onclick="loadDemo('DotPlot')">Dot Plot</li>
				<li onclick="loadDemo('PieChart')">Pie Chart</li>
				<li onclick="loadDemo('Scatterplot')">Scatter Plot</li>
			</ul>
			<li class="category">Lines and Paths</li>
			<ul class="demos">
				<li onclick="loadDemo('BumpChart')">Bump Chart</li> 
				<li onclick="loadDemo('ConnectedScatterPlot')">Connected Scatter Plot</li>
				<li onclick="loadDemo('DumbbellChart')">Dumbbell Chart</li> 
				<li onclick="loadDemo('LineGraph')">Line Graph</li>
				<li onclick="loadDemo('LollipopChart')">Lollipop Chart</li>
				<li onclick="loadDemo('MultiLineGraph')">Multi-Line Graph</li>
				<li onclick="loadDemo('ParallelCoordinates')">Parallel Coordinates</li>
				<li onclick="loadDemo('RangeChart')">Range Chart</li>
				<li onclick="loadDemo('SlopeGraph')">Slope Graph</li>
				<li onclick="loadDemo('StringlineChart')">Stringline Chart</li>
			</ul>
			<li class="category">Polygons and Areas</li>
			<ul class="demos">
				<li onclick="loadDemo('AreaChart')">Area Chart</li>
				<li onclick="loadDemo('DensityPlot')">Density Plot</li>
				<!-- <li onclick="loadDemo('BeeswarmChart')">Beeswarm Chart</li> -->
				<!-- <li onclick="loadDemo('CascadeChart')">Cascade Chart</li> -->
				<li onclick="loadDemo('RadarChart')">Radar Chart</li>
				<li onclick="loadDemo('ridgelinePlot')">Ridgeline Plot</li>
				<li onclick="loadDemo('StackedAreaChart')">Stacked Area Chart</li>
				<li onclick="loadDemo('StellarChart')">Stellar Chart</li>
				<li onclick="loadDemo('StreamGraph')">Stream Graph</li>
				<li onclick="loadDemo('ViolinPlot')">Violin Plot</li>
			</ul>
			<li class="category">Small Multiples</li>
			<ul class="demos">
				<li onclick="loadDemo('GridAreaChart')">Area Chart</li>
				<li onclick="loadDemo('MultipleBarCharts')">Bar Chart</li>
				<li onclick="loadDemo('MultipleBoxPlots')">Box Plot</li>
				<li onclick="loadDemo('Sparklines')">Line Graph</li>
				<li onclick="loadDemo('MultiplePieCharts')">Pie Chart</li>
				<li onclick="loadDemo('ScatterplotMatrix')">Scatterplot Matrix</li>
				<li onclick="loadDemo('GridStackedAreaChart')">Stacked Area Chart</li>
				<li onclick="loadDemo('MultipleViolinPlots')">Violin Plot</li>
			</ul>
		</ul>
		<div id="console"></div>
		<canvas id="canvasElement"></canvas>
		<svg id="svgElement"></svg>
		<div id="intro">
			<h2 style="width:580px; margin: 200px auto; background-color: white; padding: 20px;">Use the left menu to load chart demos. After a demo is loaded, you can view the dataset and modify the code in the bottom panel.<br><br> To update the demo after modifying the code, click the "run" button; to see the construction process of a demo step by step, click the "play" button.</h2>
		</div>
		<div id="btmPanel">
			<ul>
				<li><a href="#codeTab">Code</a></li>
				<li><a href="#dataTab">Data</a></li>
			  </ul>
			<div id="codeTab">
				<textarea id="scriptEditor"></textarea>
			</div>
			<div id="dataTab" style="overflow-y: auto;">
				<table id="dataTable" class="display" style="font-size: .75rem; width: 100%"></table>
			</div>
			<div id="codeControls">
				<button onclick="loadScript(true)">run</button>
				<button onclick="stepThrough(true)">play</button>
			</div>
		</div>
		<script>
			var editor = CodeMirror.fromTextArea(document.getElementById("scriptEditor"), {lineNumbers: true
			});
			var dataTable = null;
			

			window.onerror = function(message, source, lineno, colno, error) {
				let csl = document.getElementById("console");
				removeAllChildren(csl);
				var msgNode = document.createElement("div");  
				msgNode.textContent = message;
				msgNode.style.color = "red";
				csl.appendChild(msgNode);  
				if (error && error.stack) {
					var stackNode = document.createElement("div");  
					stackNode.textContent = error.stack.replace(/\n/g, "\r\n").replace(/@/g, " at ");
					stackNode.style["white-space"] = "pre-line";
					stackNode.style.color = "#777";
					csl.appendChild(stackNode);
				}
				csl.style.display = "block";
			}

			$( function() {
    			$( "#btmPanel" ).resizable({
					minHeight: 100,
					handles: "n"
				});
  			} );

			$( function() {
    			$( "#btmPanel" ).tabs({
					activate: function(event, ui){
						let t = ui.newTab.attr('li',"innerHTML")[0].getElementsByTagName("a")[0].innerHTML;
						if (t == "Code")
							$("#codeControls").css("visibility", "visible");
						else
							$("#codeControls").css("visibility", "hidden");
					}
				});
  			} );

			function loadDemo(d) {
                var oReq = new XMLHttpRequest();
				oReq.addEventListener("load", function(){
					editor.setValue(this.responseText);
					//window.demo = d;
					loadScript();

					// Set the data for the csv in the script
					let csvRegex = /atlas\.csv\("(.+)"\);/
					let csvPath = csvRegex.exec(this.responseText)[1]

					// Request the csv from the server
					fetch(csvPath).then(resp => {
						return resp.text();
					}).then(text => {
						let rows = text.trim().split("\n")
						// Destroy current table
						if (dataTable !== null) {
							dataTable.destroy()
						}
						// Set the thead for the table
						const table = document.getElementById("dataTable")
						let newHead = `<thead><tr>${
							rows[0].split(",").reduce((acc, row) => acc += `<th>${row}</th>`, "")
						}</tr></thead>`
						table.innerHTML = newHead
						// Initialize table
						dataTable = $('#dataTable').DataTable({
							data: rows.slice(1).map(row => row.split(",")),
							searching: false,
							paging: false,
							scrollCollapse: true,
							fixedColumns: true,
							info: false,
							//responsive: true
						})
					})
				});
				oReq.open("GET", "demo/" + d[0].toLowerCase() + d.substring(1) + ".js");
				oReq.send();
				window.location.hash = d;
			}

			function removeAllChildren(e) {
				while (e.firstChild) {
					e.firstChild.remove();
				}
			}

			function loadScript(hashEditor) {
				let script = editor.getValue();
				let f = function(s) {
					let svg = document.getElementById("svgElement");
					removeAllChildren(svg);
					document.getElementById("intro").style.display = "none";
					s = "(async () => {" + s + "})();";
					eval(s);
				};
				f(script);
				if (hashEditor)
					window.location.hash = "editor";
				document.getElementById("console").style.display = "none";
			}

			let requestAnimationFrame = function(f){return setTimeout(f, 1000)};

			function stepThrough(){
				let script = editor.getValue().replace("await", "");
				let parsed = acorn.parse(script, {ecmaVersion: "latest"});

				let blocks = parsed.body.map(d => script.substring(d.start, d.end));				
				let renderIdx = blocks.findIndex(d => d.indexOf("renderer") > 0),
					renderLines = blocks.slice(renderIdx).join(";\n"),
					code = "";
				let currentIdx = 0;
				let step = function(timeStamp){
					if (currentIdx >= renderIdx)
						return;
					removeAllChildren(document.getElementById("svgElement"));
					//let s = blocks.slice(0, currentIdx).join(";\n") + ";" + blocks.slice(renderIdx).join(";\n");
					let newBlock = blocks[currentIdx];
					if (newBlock.indexOf("atlas.csv") > 0)
						newBlock = newBlock.replace("atlas.csv", "await atlas.csv");
					code += newBlock + "\n";
					editor.setValue(code + renderLines);
					let s = "(async () => {" + code + renderLines + "})();";
					eval(s);
					currentIdx++;
					requestAnimationFrame(step);
				}
				requestAnimationFrame(step);
			}

			function refresh() {
				let demo = window.location.hash.replace("#", "");
				if (demo && demo!= ""){
					loadDemo(demo);	
				}
			}

			window.onhashchange = refresh;
			$(document).ready(refresh);
		</script>
	</body>
</html>
