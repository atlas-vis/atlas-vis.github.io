/* version: 1.3.7 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("pixi.js")):"function"==typeof define&&define.amd?define(["exports","d3","pixi.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).atlas={},t.d3,t.PIXI)}(this,(function(exports,d3,PIXI){"use strict";function _interopNamespace(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var d3__namespace=_interopNamespace(d3),PIXI__namespace=_interopNamespace(PIXI);class Rectangle{constructor(t,e,i,s){this.left=t,this.top=e,this.width=i,this.height=s}toJSON(){let t={};return t.left=this.left,t.top=this.top,t.width=this.width,t.height=this.height,t}union(t){let e=Math.min(this.left,t.left),i=Math.min(this.top,t.top),s=Math.max(this.right,t.right),a=Math.max(this.bottom,t.bottom);return new Rectangle(e,i,s-e,a-i)}clone(){return new Rectangle(this.left,this.top,this.width,this.height)}get right(){return this.left+this.width}get bottom(){return this.top+this.height}get x(){return(this.left+this.right)/2}get y(){return(this.top+this.bottom)/2}get center(){return(this.left+this.right)/2}get middle(){return(this.top+this.bottom)/2}contains(t,e){return this.left<=t&&this.right>=t&&this.top<=e&&this.bottom>=e}}const nodeId="id",atlas_rowId="atlas_rowId",ScaleType=["linear","power","log","sqrt","symlog","identity","time","ordinal","band","point","ordinalColor","sequentialColor"],CurveMode={Natural:"natural",Basis:"basis",BumpX:"bumpX",BumpY:"bumpY",Linear:"linear",Step:"step",CatmullRom:"CatmullRom",Cardinal:"cardinal"},LayoutType={Grid:"grid",Circular:"circular",Stack:"stack",Treemap:"treemap",Packing:"packing",Force:"force",TidyTree:"tidytree"},Orientation={Vertical:"vertical",Horizontal:"horizontal",Angular:"angular",Radial:"radial"},Alignment={Top:"top",Left:"left",Bottom:"bottom",Right:"right",Center:"center",Middle:"middle"},ConstraintType={Align:"alignment",Distribute:"distribution",Affix:"affixation"},ItemType={Area:"area",Rect:"rect",Ellipse:"ellipse",Circle:"circle",Pie:"pie",Ring:"ring",Arc:"arc",Line:"line",Path:"path",Image:"image",PointText:"pointText",Collection:"collection",Group:"group",Scene:"scene",Axis:"axis",Glyph:"glyph",Legend:"legend",Polygon:"polygon",Gridlines:"gridlines",LinearGradient:"LinearGradient",Link:"link",DataTable:"datatable"},DataType={Boolean:"boolean",Integer:"integer",Number:"number",Date:"date",String:"string"},Aggregator={Max:"max",Min:"min",Avg:"avg",Median:"median",Sum:"sum",Count:"count",Mean:"mean",Percentile25:"percentile 25",Percentile75:"percentile 75"},Style2SVG={fillColor:"fill",strokeColor:"stroke",strokeWidth:"stroke-width",fillOpacity:"fill-opacity",strokeOpacity:"stroke-opacity",strokeDash:"stroke-dasharray",opacity:"opacity",fontSize:"font-size",fontFamily:"font-family",fontWeight:"font-weight",visibility:"visibility"},Errors={FIELD_NONEXISTENT:"Data field does not exist in the data table",INCOMPLETE_REPEAT_INFO:"Incomplete information to do repeat. You must specify an item, a categorical data field and a data table",REPEAT_BY_NONCAT:"Repeat only works on a string or date field",PARTITION_BY_NONCAT:"Divide only works on a string or date field",DENSIFY_BY_NONCAT:"Densify only works on a string or date field",COMPNT_NON_REPEATABLE:"Item not repeatable",INCOMPLETE_PARTITION_INFO:"Incomplete information to divide. You must specify an item, a categorical data field and a data table",COMPNT_NON_PARTITIONABLE:"Item cannot be divided",INCOMPLETE_DENSIFY_INFO:"Incomplete information to densify. You must specify an item, a categorical data field and a data table",COMPNT_NON_DENSIFIABLE:"Item cannot be densified",BIND_WITHOUT_DATASCOPE:"Item must be repeated or divided by data first before applyng binding",UNKNOWN_ALIGNMENT:"Unkown alignment",UNKOWNN_SCALE_TYPE:"Unknown scale type",UNKNOWN_ANCHOR:"Unknown anchor",INCOMPLETE_BINDING_INFO:"Incomplete binding information. You must specify an item, a data field and a visual channel",MULTIPLE_VALUES_PER_FIELD:"Multiple distinct field values exist",DIFFERENT_SCALE_TYPE:"Cannot merge different types of scale",INCORRECT_AXIS_INFO:"Cannot find relevant information to create an axis for ",INCORRECT_LEGEND_INFO:"Cannot find relevant information to create a legend for ",INSUFFICIENT_DATA_SCOPES:"Insufficient data to divide or densify a mark",INCORRECT_CONSTRAINT_INFO:"Constrain information is incorreclty passed",FEATURE_NOT_IMPLEMENTED:"This feature has not been implemented yet"};class Layout{constructor(t){this.group=void 0}run(){}clone(){}}class GridLayout extends Layout{constructor(t){super(),this.type="grid",this._numCols=t.numCols,this._numRows=t.numRows,this.baseline=t.baseline,this._horzDir="hDir"in t?t.hDir:GridLayout.direction.Left2Right,this._vert2Dir="vDir"in t?t.vDir:GridLayout.direction.Top2Bottom,this._rowGap="rowGap"in t?t.rowGap:5,this._colGap="colGap"in t?t.colGap:5,this._cellHorzAlignment=Alignment.Left,this._cellVertAlignment=Alignment.Bottom}toJSON(){let t={args:{}};return t.type=this.type,t.args.numCols=this._numCols,t.args.numRows=this._numRows,t.args.baseline=this.baseline,t.args.colGap=this._colGap,t.args.rowGap=this._rowGap,t.args.horzCellAlignment=this._cellHorzAlignment,t.args.vertCellAlignment=this._cellVertAlignment,t.left=this._left,t.top=this._top,t}clone(){return new GridLayout({numCols:this._numCols,numRows:this._numRows,hDir:this._horzDir,vDir:this._vert2Dir,colGap:this._colGap,rowGap:this._rowGap})}get cellBounds(){let t,e=this.group,i=this._colGap,s=this._rowGap;this._numRows?t=Math.ceil(this.group.children.length/this._numRows):this._numCols&&(t=this._numCols,Math.ceil(this.group.children.length/this._numCols));let a=e.children.map((t=>t.bounds));if(void 0===this._left){let t=a.map((t=>t.left)),e=a.map((t=>t.top));this._left=Math.min(...t),this._top=Math.min(...e)}let n=a.map((t=>t.width)),r=a.map((t=>t.height)),l=Math.max(...n),o=Math.max(...r),h=e.getInternalEncodings("x"),d=e.getInternalEncodings("y"),c=e.getInternalEncodings("width"),u=e.getInternalEncodings("height"),p=0;return h.length>0?(l=h[h.length-1].scale.rangeExtent,p=h[h.length-1].scale.range[0]):c.length>0&&c[c.length-1]._rectNegativeValues&&(l=c[c.length-1].scale.rangeExtent,p=c[c.length-1].scale.range[0]),d.length>0?o=d[d.length-1].scale.rangeExtent:u.length>0&&u[u.length-1]._rectNegativeValues&&(o=u[u.length-1].scale.rangeExtent),e.children.map(((e,a)=>new Rectangle(this._left+(l+i)*(a%t)+p,this._top+(o+s)*Math.floor(a/t),l,o)))}run(){if(null==this.group)return;let t=this.cellBounds,e=this.group.getInternalEncodings("x"),i=this.group.getInternalEncodings("y"),s=this.group.getInternalEncodings("width"),a=this.group.getInternalEncodings("height");for(let s=0;s<this.group.children.length;s++){let a=this.group.children[s],n=t[s],r=n.x-a.bounds.x,l=n.y-a.bounds.y;a.translate(r,l);let o=0,h=0;if(0==e.length)switch(this._cellHorzAlignment){case Alignment.Left:o=n.left-a.bounds.left;break;case Alignment.Center:o=n.x-a.bounds.x;break;case Alignment.Right:o=n.right-a.bounds.right}if(0==i.length)switch(this._cellVertAlignment){case Alignment.Top:h=n.top-a.bounds.top;break;case Alignment.Middle:h=n.y-a.bounds.y;break;case Alignment.Bottom:h=n.bottom-a.bounds.bottom}a.translate(o,h)}if(e.length>0){e[e.length-1]._apply()}else if(s.length>0){let t=s[s.length-1];t._rectNegativeValues&&t._apply()}if(i.length>0)i[i.length-1]._apply();else if(a.length>0){let t=a[a.length-1];t._rectNegativeValues&&t._apply()}this.group._updateBounds()}set rowGap(t){this._rowGap=t,this.run(),this.group.getScene()._relayoutAncestors(this.group)}get rowGap(){return this._rowGap}set colGap(t){this._colGap=t,this.run(),this.group.getScene()._relayoutAncestors(this.group)}get colGap(){return this._colGap}set numCols(t){this._numCols=t,this._numRows=Math.ceil(this.group.children.length/t),this.run(),this.group.getScene()._relayoutAncestors(this.group)}get numCols(){return this._numCols?this._numCols:this._numRows?Math.ceil(this.group.children.length/this._numRows):0}set numRows(t){this._numRows=t,this._numCols=Math.ceil(this.group.children.length/t),this.run(),this.group.getScene()._relayoutAncestors(this.group)}get numRows(){return this._numRows?this._numRows:this._numCols?Math.ceil(this.group.children.length/this._numCols):0}set vertCellAlignment(t){if(t!=Alignment.Top&&t!=Alignment.Bottom&&t!=Alignment.Middle)throw Errors.UNKOWN_ALIGNMENT;this._cellVertAlignment=t,this.run()}get vertCellAlignment(){return this._cellVertAlignment}set horzCellAlignment(t){if(t!=Alignment.Left&&t!=Alignment.Center&&t!=Alignment.Right)throw Errors.UNKOWN_ALIGNMENT;this._cellHorzAlignment=t,this.run()}get horzCellAlignment(){return this._cellHorzAlignment}}GridLayout.direction={Left2Right:"l2r",Right2Left:"r2l",Top2Bottom:"t2b",Bottom2Top:"b2t"};class LinearGradient{constructor(t){this._stops=[],this.type=ItemType.LinearGradient,this.id=this.type+ItemCounter[this.type]++,this.x1=t.hasOwnProperty("x1")?t.x1:0,this.x2=t.hasOwnProperty("x2")?t.x2:100,this.y1=t.hasOwnProperty("y1")?t.y1:0,this.y2=t.hasOwnProperty("y2")?t.y2:0}toJSON(){}addStop(t,e,i){this._stops.push({offset:t,color:e,opacity:i})}get stops(){return this._stops}}class Mark{constructor(t){if(this._dataScope=void 0,this.attrs={},this.styles={},void 0!==t)for(let e in Style2SVG)e in t&&(this.styles[e]=t[e])}contains(t,e){if(!this._bounds)return!1;if(!this._bounds.contains(t,e))return!1;switch(this.type){case ItemType.Rect:return!0;case ItemType.Circle:return Math.sqrt(Math.pow(t-this.x,2)+Math.pow(e-this.y,2))<=this.radius+this.strokeWidth;default:{let i=CanvasProvider.getContext(),s=new Path2D(this.getSVGPathData());return i.isPointInPath(s,t,e)}}}toJSON(){let t={};t.type=this.type,t.id=this.id,this.classId&&(t.classId=this.classId),this._dataScope&&(t.dataScope=this._dataScope.toJSON()),t.args={};for(let e in this.attrs)t.args[e]=this.attrs[e];for(let e in this.styles)e.indexOf("color")>0&&this.styles[e]instanceof LinearGradient?t.args[e]=this.styles[e].toJSON():t.args[e]=this.styles[e];return t}getScene(){let t=this;for(;t;){if(t.type==ItemType.Scene)return t;t=t.parent}}set dataScope(t){this._dataScope=t}get dataScope(){return this._dataScope}duplicate(){let t=this.getScene().mark(this.type);return this.copyPropertiesTo(t),t.classId=this.classId,this._dataScope&&(t._dataScope=this._dataScope.clone()),t}translate(t,e){}set visibility(t){this.styles.visibility=t}get visibility(){return this.styles.visibility?this.styles.visibility:"visible"}get opacity(){return"opacity"in this.styles?this.styles.opacity:1}set opacity(t){this.styles.opacity=t}}const EPSILON=1e-12,TRIGONOMETRIC_EPSILON=1e-8;function isZero(t){return t>=-EPSILON&&t<=EPSILON}class Point{constructor(t,e){this.x=t,this.y=e}transform(t){return t?t._transformPoint(this):this}negate(){return new Point(-this.x,-this.y)}subtract(t){return new Point(this.x-t.x,this.y-t.y)}isZero(){return isZero(this.x)&&isZero(this.y)}isCollinear(t){let e=this.x,i=this.y,s=t.x,a=t.y;return Math.abs(e*a-i*s)<=Math.sqrt((e*e+i*i)*(s*s+a*a))*TRIGONOMETRIC_EPSILON}}class Vertex{constructor(t,e,i){this.type="vertex",this._id=i,this.x=t.x,this.y=t.y,this.dataScope=void 0,this.parent=e,this.shape=void 0,this.width=0,this.height=0,this.radius=0,this.fillColor="#555",this.opacity=1,this.strokeWidth=0,this.strokeColor="#aaa"}get id(){return this.parent.id+"v"+this._id}toJSON(){let t={};return t.type=this.type,t.id=this._id,t.x=this.x,t.y=this.y,this._dataScope&&(t.dataScope=this._dataScope.toJSON()),t.shape=this.shape,t.width=this.width,t.height=this.height,t.radius=this.radius,t.fillColor=this.fillColor,t.opacity=this.opacity,t.strokeWidth=this.strokeWidth,t.strokeColor=this.strokeColor,t}static fromJSON(t,e){let i=new Vertex(t,e,t.id);return t.dataScope&&(i.dataScope=t.dataScope),i.shape=t.shape,i.width=t.width,i.height=t.height,i.radius=t.radius,i.fillColor=t.fillColor,i.opacity=t.opacity,i.strokeWidth=t.strokeWidth,i.strokeColor=t.strokeColor,i}translate(t,e){this.x+=t,this.y+=e}_clone(t){let e=new Vertex(new Point(this.x,this.y),t,this._id);return this.dataScope&&(e.dataScope=this.dataScope.clone()),e.shape=this.shape,e.width=this.width,e.height=this.height,e.radius=this.radius,e.fillColor=this.fillColor,e.opacity=this.opacity,e.strokeWidth=this.strokeWidth,e.strokeColor=this.strokeColor,e}}Vertex.styles=["vxShape","vxWidth","vxHeight","vxRadius","vxFillColor","vxStrokeColor","vxStrokeWidth","vxOpacity"];class Segment{constructor(t,e,i,s){this.type="segment",this._id=s,this.vertex1=t,this.vertex2=e,this.dataScope=void 0,this.parent=i}get id(){return this.parent.id+"s"+this._id}translate(t,e){this.vertex1.translate(t,e),this.vertex2.translate(t,e)}get x(){return(this.vertex1.x+this.vertex2.x)/2}get y(){return(this.vertex1.y+this.vertex2.y)/2}}class Path extends Mark{constructor(t){if(super(t),this.type=ItemType.Path,"strokeColor"in this.styles||(this.styles.strokeColor="#ccc"),"strokeWidth"in this.styles||(this.styles.strokeWidth=1),"strokeDash"in this.styles||(this.styles.strokeDash="none"),this.vertices=[],this.vertexCounter=0,this.segmentCounter=0,this.segments=[],this.anchor=void 0,this.closed=!1,this.curveMode="linear",this._vxShape=void 0,this._vxWidth=0,this._vxHeight=0,this._vxRadius=0,this._vxFillColor="#555555",this._vxStrokeColor="#aaaaaa",this._vxStrokeWidth=0,this._vxOpacity=1,void 0!==t){for(let e of Vertex.styles)e in t&&(this["_"+e]=t[e]);"vertices"in t&&this._setVertices(t.vertices)}}toJSON(){let t=super.toJSON();t.type=this.type,t.id=this.id,t.vertices=[];for(let e of this.vertices)t.vertices.push(e.toJSON());t.vertexCounter=this.vertexCounter,t.segmentCounter=this.segmentCounter,t.curveMode=this.curveMode,this._bounds&&(t.bounds=this._bounds.toJSON());for(let e of Vertex.styles)t.args[e]=this[e];return t}_setVertices(t){let e,i;this.vertices=[],this.segments=[];for(let s=0;s<t.length;s++){i=new Point(t[s][0],t[s][1]),e=new Vertex(i,this,this.vertexCounter++);for(let t of Vertex.styles)if(this[t]){let i=t.replace("vx","");e[i[0].toLowerCase()+i.slice(1)]=this[t]}this.vertices.push(e),s>0&&this.segments.push(new Segment(this.vertices[s-1],this.vertices[s],this,this.segmentCounter++))}}copyPropertiesTo(t){t.attrs=Object.assign({},this.attrs),t.styles=Object.assign({},this.styles);for(let e of Vertex.styles)this["_"+e]&&(t["_"+e]=this["_"+e]);this._dataScope&&(t._dataScope=this._dataScope.clone()),t.closed=this.closed,t.curveMode=this.curveMode,t.vertices=[],t.segments=[];for(let e of this.vertices)t.vertices.push(e._clone(t));t.segmentCounter=0;for(let e=1;e<t.vertices.length;e++)t.segments.push(new Segment(t.vertices[e-1],t.vertices[e],t,t.segmentCounter++));t.closed&&t.segments.push(new Segment(t.vertices[t.vertices.length-1],t.vertices[0],t,t.segmentCounter++))}get bounds(){return this._bounds||this._updateBounds(),this._bounds}get x(){return this.bounds.x}get y(){return this.bounds.y}get strokeColor(){return this.styles.strokeColor}set strokeColor(t){this.styles.strokeColor=t}get strokeWidth(){return this.styles.strokeWidth}set strokeWidth(t){this.styles.strokeWidth=t}get fillColor(){return this.styles.fillColor}set fillColor(t){this.styles.fillColor=t}get strokeDash(){return this.styles.strokeDash}set strokeDash(t){this.styles.strokeDash=t}translate(t,e){for(let i of this.vertices)i.translate(t,e);this._updateBounds()}resize(t,e){let i=this.bounds;for(let s of this.vertices)s.x=i.x+t/i.width*(s.x-i.x),s.y=i.y+e/i.height*(s.y-i.y);this._updateBounds()}_updateBounds(){let t=this.vertices.map((t=>t.x)),e=this.vertices.map((t=>t.y)),i=Math.min(...t),s=Math.min(...e),a=Math.max(...t),n=Math.max(...e);this._bounds=new Rectangle(i,s,a-i,n-s)}addVertex(t,e,i){let s=new Vertex(new Point(t,e),this,this.vertexCounter++);this.vertices.splice(i,0,s)}sortVertices(t,e){this.vertices.sort(((e,i)=>e[t]-i[t])),e&&this.vertices.reverse();for(let t=0;t<this.segments.length;t++){let e=this.segments[t];e.vertex1=this.vertices[t],e.vertex2=this.vertices[(t+1)%this.vertices.length]}}sortVerticesByData(t,e,i){let s;s=i?(e,s)=>i.indexOf(e.dataScope.getFieldValue(t))-i.indexOf(s.dataScope.getFieldValue(t)):(e,i)=>e.dataScope.getFieldValue(t)<i.dataScope.getFieldValue(t)?-1:1,this.vertices.sort(s),e&&this.vertices.reverse();for(let t=0;t<this.segments.length;t++){let e=this.segments[t];e.vertex1=this.vertices[t],e.vertex2=this.vertices[(t+1)%this.vertices.length]}}getSVGPathData(){let t=d3__namespace.path(),e=this._getD3CurveFunction(this.curveMode)(t);e.lineStart();for(let t of this.vertices)e.point(t.x,t.y);return this.closed&&e.point(this.vertices[0].x,this.vertices[0].y),e.lineEnd(),t._}get firstVertex(){return this.vertices[0]}_getD3CurveFunction(t){switch(t){case CurveMode.Natural:return d3__namespace.curveNatural;case CurveMode.Basis:return d3__namespace.curveBasis;case CurveMode.BumpX:return d3__namespace.curveBumpX;case CurveMode.BumpY:return d3__namespace.curveBumpY;case CurveMode.Linear:return d3__namespace.curveLinear;case CurveMode.Step:return d3__namespace.curveStep;case CurveMode.CatmullRom:return d3__namespace.curveCatmullRom;case CurveMode.Cardinal:return d3__namespace.curveCardinal;default:return d3__namespace.curveLinear}}get vxShape(){return this._vxShape}set vxShape(t){this._vxShape=t;for(let e of this.vertices)e.shape=t}get vxWidth(){return this._vxWidth}set vxWidth(t){this._vxWidth=t;for(let e of this.vertices)e.width=t}get vxHeight(){return this._vxHeight}set vxHeight(t){this._vxHeight=t;for(let e of this.vertices)e.height=t}get vxRadius(){return this._vxRadius}set vxRadius(t){this._vxRadius=t;for(let e of this.vertices)e.radius=t}get vxFillColor(){return this._vxFillColor}set vxFillColor(t){this._vxFillColor=t;for(let e of this.vertices)e.fillColor=t}get vxStrokeColor(){return this._vxStrokeColor}set vxStrokeColor(t){this._vxStrokeColor=t;for(let e of this.vertices)e.strokeColor=t}get vxStrokeWidth(){return this._vxStrokeWidth}set vxStrokeWidth(t){this._vxStrokeWidth=t;for(let e of this.vertices)e.strokeWidth=t}get vxOpacity(){return this._vxOpacity}set vxOpacity(t){this._vxOpacity=t;for(let e of this.vertices)e.opacity=t}}function findItems(t,e){let i=[];return _findItemsRecursive(t,e,i),i}function getPeers(t,e){return"vertex"==t.type?_getPeerVertices(t,e):"segment"==t.type?_getPeerSegments(t,e):findItems(e,(e=>e.classId==t.classId))}function getPeersGroupedByParent(t,e){let i={},s=getPeers(t,e);for(let t of s){let e=t.parent.id;e in i||(i[e]=[]),i[e].push(t)}return Object.keys(i).map((t=>i[t]))}function _getPeerSegments(t,e){if(t.dataScope){let i=t.parent;if(!i)throw new Error("segment has no parent mark");let s=findItems(e,(t=>t.classId==i.classId)),a=[];for(let t of s)a=a.concat(t.segments);return a}{let i=t.parent;if(!i)throw new Error("segment has no parent mark");let s=i.segments.indexOf(t),a=findItems(e,(t=>t.classId==i.classId)),n=[];for(let t of a)n.push(t.segments[s]);return n}}function _getPeerVertices(t,e){if(!t.classId){if(t.dataScope){let i=t.parent;if(!i)throw new Error("vertex has no parent mark");let s=findItems(e,(t=>t.classId==i.classId)),a=[];for(let t of s)a=a.concat(t.vertices);return a}{let i=t.parent;if(!i)throw new Error("vertex has no parent mark");let s=i.vertices.indexOf(t),a=findItems(e,(t=>t.classId==i.classId)),n=[];for(let t of a)n.push(t.vertices[s]);return n}}}function _findItemsRecursive(t,e,i){if(t&&"axis"!=t.type&&"legend"!=t.type&&"gridlines"!=t.type)if(_matchCriteria(t,e)&&i.push(t),t.vertices)for(let s of t.vertices.concat(t.segments))_matchCriteria(s,e)&&i.push(s);else if(t.children&&t.children.length>0)for(let s of t.children)_findItemsRecursive(s,e,i)}function _matchCriteria(t,e){return e(t)}function getClosestLayout(t){let e=t.parent;for(;e&&e.type!=ItemType.Scene;){if(e.layout)return e.layout;e=e.parent}}function getAllLayouts(t){let e=getParents(t),i=[];for(;e&&e[0].type!=ItemType.Scene;){for(let t of e)t.layout&&i.push(t.layout);e=getParents(e)}return i}function getCellBoundsInLayout(t){let e=t,i=t.parent;for(;i&&i.type!=ItemType.Scene;){if(i.layout){let t=i.children.findIndex((t=>t==e));return i.layout.cellBounds[t]}e=e.parent,i=e.parent}}function getCellBoundsInGridLayout(t){let e=t,i=t.parent;for(;i&&i.type!=ItemType.Scene;){if(i.layout&&i.layout.type==LayoutType.Grid){let t=i.children.findIndex((t=>t==e));return i.layout.cellBounds[t]}e=e.parent,i=e.parent}}function getEncodingKey(t){return t.classId?t.classId:"vertex"==t.type&&t.dataScope?t.parent.classId+"_v":"vertex"==t.type?t.parent.classId+"_v_"+t.parent.vertices.indexOf(t):"segment"==t.type&&t.dataScope?t.parent.classId+"_s":"segment"==t.type?t.parent.classId+"_s_"+t.parent.segments.indexOf(t):null}function getParents(t){let e=[];for(let i of t)i.parent&&e.indexOf(i.parent)<0&&e.push(i.parent);return e}function getLeafItems(t){let e=[];if(t.children&&t.children.length>0)for(let i of t.children)e=e.concat(getLeafItems(i));else e.push(t);return e}function isMark(t){return t instanceof Mark}const ItemCounter={area:0,rect:0,circle:0,pie:0,line:0,path:0,ring:0,arc:0,image:0,pointText:0,collection:0,group:0,scene:0,axis:0,glyph:0,legend:0,polygon:0,gridlines:0,LinearGradient:0,link:0,scale:0,datatable:0};function canAlign(t,e,i){if(e==Alignment.Top||e==Alignment.Bottom||e==Alignment.Middle){for(let e of t)if(!canMoveVertically(e,i))return!1;return!0}if(e==Alignment.Left||e==Alignment.Right||e==Alignment.Center){for(let e of t)if(!canMoveHorizontally(e,i))return!1;return!0}}function canMoveHorizontally(t,e){if(e.getEncodingByItem(t,"x"))return!1;if(t.parent&&t.parent.layout){let e=t.parent.layout;if(e.type==LayoutType.Grid&&e.numCols>1)return!1}return!t.parent||t.parent.type==ItemType.Scene||canMoveHorizontally(t.parent,e)}function canMoveVertically(t,e){if(e.getEncodingByItem(t,"y"))return!1;if(t.parent&&t.parent.layout){let e=t.parent.layout;if(e.type==LayoutType.Grid&&e.numRows>1)return!1}return!t.parent||t.parent.type==ItemType.Scene||canMoveVertically(t.parent,e)}var CanvasProvider={canvas:void 0,getCanvas:function(){return window?(void 0===this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas):null},getContext:function(){var t=this.getCanvas();return t?t.getContext("2d"):null}},SVGProvider={svg:void 0,getSVG:function(){return window?(void 0===this.svg&&(this.svg=document.createElement("svg")),this.svg):null}};function getTextWidth(t,e){let i=CanvasProvider.getContext();return i.font=e,i.measureText(t).width}function getTopLevelGroup(t){let e=t.parent;return e.type==ItemType.Scene?t:getTopLevelGroup(e)}function polar2Cartesian(t,e,i,s){return[i*Math.cos(degree2radian(s))+t,e-i*Math.sin(degree2radian(s))]}function cartesian2Polar(t,e,i,s){let a=radian2degree(Math.atan2(s-e,t-i));a=Math.round(10*a+Number.EPSILON)/10,a<0&&(a+=360);let n=Math.sqrt(Math.pow(t-i,2)+Math.pow(e-s,2));return n=Math.round(10*n+Number.EPSILON)/10,[a,n]}function degree2radian(t){return t*Math.PI/180}function radian2degree(t){return 180*t/Math.PI}function CheckAreaOrien(t){let e=t.vertices.length;for(let i=0;i<t.vertices.length/2;i++){let s=i,a=e-i-1,n=t.vertices[s],r=t.vertices[a];if(n.x!=r.x||n.y!=r.y)return n.x==r.x?"horizontal":"vertical"}}class Group{constructor(){this.children=[],this._dataScope=void 0,this._layout=void 0,this.type=ItemType.Group,this.id=this.type+ItemCounter[this.type]++}contains(t,e){return this._bounds||this._updateBounds(),this._bounds.contains(t,e)}toJSON(){let t={};if(t.type=this.type,t.id=this.id,this._dataScope&&(t.dataScope=this._dataScope.toJSON()),this.classId&&(t.classId=this.classId),this._layout&&(t.layout=this._layout.toJSON()),this._bounds&&(t.bounds=this._bounds.toJSON()),this.children.length>0&&this.type!=ItemType.Axis){t.children=[];for(let e of this.children)t.children.push(e.toJSON())}return this.childrenOrder&&(t.childrenOrder=this.childrenOrder),t}addChild(t){t.parent&&t.parent.removeChild(t),this.children.push(t),t.parent=this}addChildAt(t,e){t.parent&&t.parent.removeChild(t),this.children.splice(e,0,t),t.parent=this}removeChild(t){let e=this.children.indexOf(t);e>=0&&this.children.splice(e,1),t.parent=null}removeAll(){for(let t of this.children)t.parent=null;this.children=[]}getScene(){let t=this;for(;t;){if(t.type==ItemType.Scene)return t;t=t.parent}}get dataScope(){return this._dataScope}set dataScope(t){this._dataScope=t;for(let e of this.children)e.dataScope?e.dataScope=e.dataScope.merge(t):e.dataScope=t}translate(t,e){for(let i of this.children)i.translate(t,e);this._updateBounds(),this._layout&&(null!=this._layout._left&&(this._layout._left+=t),null!=this._layout._top&&(this._layout._top+=e),this._layout.run()),this._updateBounds()}getInternalEncodings(t){if(0==this.children.length)return[];let e=this.children[0],i=this.getScene(),s=Object.keys(i.encodings),a=[];for(;e&&(e.classId&&a.indexOf(e.classId)<0&&a.push(e.classId),e.children);)e=e.children[0];let n=[];for(let e of s){let s=e.split("_");for(let r of a)s[0]==r&&i.encodings[e][t]&&n.push(i.encodings[e][t])}return n}get firstChild(){return this.children[0]}set layout(t){this._layout=t,t.group=this,this._layout.run()}get layout(){return this._layout}get bounds(){return this._bounds||this._updateBounds(),this._bounds}get x(){return this.bounds.x}get y(){return this.bounds.y}_updateBounds(){if(this._layout&&"grid"==this._layout.type){let t=this._layout.cellBounds;this._bounds=t[0].clone();for(let e=1;e<t.length;e++)this._bounds=this._bounds.union(t[e])}else if(this.children.length>0){this._bounds=this.children[0].bounds.clone();for(let t=0;t<this.children.length;t++)this._bounds=this._bounds.union(this.children[t].bounds)}else this._bounds=new Rectangle(0,0,0,0)}sortChildrenByData(t,e,i){let s;switch(this.children[0].dataScope.getFieldType(t)){case DataType.Date:break;case DataType.Number:case DataType.Integer:s=(e,i)=>e.dataScope.aggregateNumericalField(t)-i.dataScope.aggregateNumericalField(t);break;case DataType.String:s=i?(e,s)=>i.indexOf(e.dataScope.getFieldValue(t))-i.indexOf(s.dataScope.getFieldValue(t)):(e,i)=>e.dataScope.getFieldValue(t)<i.dataScope.getFieldValue(t)?-1:1}this.children.sort(s),e&&this.children.reverse(),this.layout&&this.layout.run(),this.childrenOrder={field:t,reverse:e,order:i}}sortChildren(t,e){let i;switch(t){case"x":case"y":case"width":case"height":i=(e,i)=>e.bounds[t]-i.bounds[t];break;default:i=(e,i)=>e[t]-i[t]}this.children.sort(i),e&&this.children.reverse(),this.layout&&this.layout.run(),this.childrenOrder={channel:t,reverse:e}}set visibility(t){this._visibility="hidden"==t?t:"visible";for(let e of this.children)e.visibility=t}get visibility(){return this._visibility?this._visibility:"visible"}}function validateField(t,e){if(e.hasField(t))return!0;if(e.tree&&e.tree.nodeTable.hasField(t.split(".")[1]))return!0;throw new Error(Errors.FIELD_NONEXISTENT+", field: "+t+", data table: "+e.name)}class DataScope{constructor(t){this._field2value={},this._dt=t,this._tuples=this._dt.data}toJSON(){let t={};return t.dt=this._dt.url,t.f2v=Object.assign({},this._field2value),t}isEmpty(){return 0==this._tuples.length}get numTuples(){return this._tuples.length}get fields(){return Object.keys(this._field2value)}get dataTable(){return this._dt}merge(t){let e=new DataScope(this._dt);for(let i in t._field2value)e=e.cross(i,t._field2value[i]);for(let t in this._field2value)e=e.cross(t,this._field2value[t]);return e}cross(t,e){let i=this.clone();return i._field2value[t]=e,i._updateTuples(t,e),i}clone(){let t=new DataScope(this._dt);return t._field2value=Object.assign({},this._field2value),t._tuples=this._tuples.map((t=>t)),t}getFieldValue(t){let e=this._tuples.map((e=>e[t]));return e=[...new Set(e)],e.length,e[0]}hasField(t){return t in this._field2value}getFieldType(t){return this._dt.getFieldType(t)}aggregateNumericalField(t,e){let i=this._tuples.map((e=>e[t]));switch(e){case Aggregator.Max:return Math.max(...i);case Aggregator.Min:return Math.min(...i);case Aggregator.Avg:case Aggregator.Mean:return d3__namespace.mean(i);case Aggregator.Median:return d3__namespace.median(i);case Aggregator.Count:return i.length;case Aggregator.Percentile25:return d3__namespace.quantile(i,.25);case Aggregator.Percentile75:return d3__namespace.quantile(i,.75);case Aggregator.Sum:default:return d3__namespace.sum(i)}}_updateTuples(t,e){this._tuples=this._tuples.filter((i=>i[t]==e))}}function repeatItem(t,e,i,s,a){let n=a?s.transformField(i,a):i,r=s.getFieldType(n);if(r!=DataType.String&&r!=DataType.Date)throw new Error(Errors.REPEAT_BY_NONCAT+": "+n+" is "+r);if(!_canRepeat(e))throw new Error(Errors.COMPNT_NON_REPEATABLE);return _doRepeat(t,e,n,s)}function _canRepeat(t){return!(!isMark(t)&&t.type!=ItemType.Glyph||t.dataScope)||t.type==ItemType.Collection}function _doRepeat(t,e,i,s){let a=s.getFieldSummary(i).unique.map((t=>new DataScope(s).cross(i,t))),n=t.collection();t.addChild(n),n.addChild(e);for(let t=1;t<a.length;t++){let t=e.duplicate();n.addChild(t)}return n.children.forEach(((t,e)=>t.dataScope=a[e])),t._reapplySizeBindings(e),n}class StackLayout extends Layout{constructor(t){super(t),this.type=LayoutType.Stack,this._orientation=t.orientation,this._left=t.left,this._top=t.top,this.baseline=t.baseline,this._horzCellAlignment="horzCellAlignment"in t?t.horzCellAlignment:Alignment.Left,this._vertCellAlignment="vertCellAlignment"in t?t.vertCellAlignment:Alignment.Bottom,this._gap="gap"in t?t.gap:0}toJSON(){let t={args:{}};return t.type=this.type,t.args.orientation=this._orientation,t.args.left=this._left,t.args.top=this._top,t.args.baseline=this.baseline,t.args.gap=this._gap,t.args.horzCellAlignment=this._horzCellAlignment,t.args.vertCellAlignment=this._vertCellAlignment,t}clone(){let t=new StackLayout({orientation:this._orientation,left:this._left,top:this._top,baseline:this.baseline});return t._horzCellAlignment=this._horzCellAlignment,t._vertCellAlignment=this._vertCellAlignment,t}_stackAreas(){let t=this.group.children[0],e=t.vertices.length/2,i=new Array(e).fill(0),s=CheckAreaOrien(t);for(let t of this.group.children){for(let i=0;i<e;i++){let a,n=t.vertices[i],r=t.vertices[2*e-i-1];switch(s){case Orientation.Horizontal:a=this._vertCellAlignment==Alignment.Bottom?this.group.bounds.bottom-r.y:this.group.bounds.top-r.y,n.translate(0,a),r.translate(0,a);break;case Orientation.Vertical:a=this._horzCellAlignment==Alignment.Left?this.group.bounds.left-r.x:this.group.bounds.right-r.x,n.translate(a,0),r.translate(a,0)}}t._updateBounds()}for(let t of this.group.children){for(let a=0;a<e;a++){let n=t.vertices[a],r=t.vertices[2*e-a-1];switch(s){case Orientation.Horizontal:n.translate(0,i[a]),r.translate(0,i[a]),i[a]=i[a]+n.y-r.y;break;case Orientation.Vertical:n.translate(i[a],0),r.translate(i[a],0),i[a]=i[a]+n.x-r.x}}t._updateBounds()}this.group._updateBounds();let a=this.group._bounds.height,n=this.group._bounds.width;if(this.baseline==Alignment.Center||this.baseline==Alignment.Middle)for(let t of this.group.children){for(let r=0;r<e;r++){let l,o=t.vertices[r],h=t.vertices[2*e-r-1];switch(s){case Orientation.Horizontal:l=-(i[r]+a)/2,o.translate(0,l),h.translate(0,l);break;case Orientation.Vertical:l=(n-i[r])/2,o.translate(l,0),h.translate(l,0)}}t._updateBounds()}this.group._updateBounds()}_stackRects(){let t=this.group.getScene(),e=this.group,i=this._orientation,s=e.children.map((t=>t.bounds)),a=s.map((t=>t.left)),n=s.map((t=>t.top)),r=s.map((t=>t.width)),l=s.map((t=>t.height)),o=null==this._left?Math.min(...a):this._left,h=null==this._top?Math.min(...n):this._top,d=Math.max(...r),c=Math.max(...l);if(i==Orientation.Vertical){let i=o+d/2;for(let s=0;s<e.children.length;s++){let a=e.children[s],n=i-a.bounds.x,r=h+a.bounds.height/2-a.bounds.y;h+=a.bounds.height+this._gap,a.translate(n,r);let l=0,c=0;if(!t.getEncodingByItem(a,"x"))switch(this._horzCellAlignment){case Alignment.Left:l=o-a.bounds.left;break;case Alignment.Center:l=o+d/2-a.bounds.x;break;case Alignment.Right:l=o+d-a.bounds.right}a.translate(l,c)}}else{let i=h+c/2;for(let s=0;s<e.children.length;s++){let a=e.children[s],n=o+a.bounds.width/2-a.bounds.x,r=i-a.bounds.y;o+=a.bounds.width+this._gap,a.translate(n,r);let l=0,d=0;if(!t.getEncodingByItem(a,"y"))switch(this._vertCellAlignment){case Alignment.Top:d=h-a.bounds.top;break;case Alignment.Middle:d=h+c/2-a.bounds.y;break;case Alignment.Bottom:d=h+c-a.bounds.bottom}a.translate(l,d)}}this.group._updateBounds()}run(){null!=this.group&&("area"==this.group.children[0].type?this._stackAreas():this._stackRects())}set vertCellAlignment(t){if(t!=Alignment.Top&&t!=Alignment.Bottom&&t!=Alignment.Middle)throw Errors.UNKOWN_ALIGNMENT;this._vertCellAlignment=t,this.run()}get vertCellAlignment(){return this._vertCellAlignment}set horzCellAlignment(t){if(t!=Alignment.Left&&t!=Alignment.Center&&t!=Alignment.Right)throw Errors.UNKOWN_ALIGNMENT;this._horzCellAlignment=t,this.run()}get horzCellAlignment(){return this._horzCellAlignment}get cellBounds(){return this.group.children.map((t=>t.bounds))}get orientation(){return this._orientation}}function divideItem(t,e,i,s,a,n){let r=n?a.transformField(s,n):s,l=a.getFieldType(r);if(l!=DataType.String&&l!=DataType.Date)throw new Error(Errors.PARTITION_BY_NONCAT+": "+r+" is "+l);if(!_canDivide(e,r,t))throw new Error(Errors.COMPNT_NON_PARTITIONABLE);switch(e.type){case ItemType.Line:return _doLineDivide(t,e,r,a);case ItemType.Circle:return _doCircleDivide(t,e,i,r,a);case ItemType.Rect:return _doRectDivide(t,e,i,r,a);case ItemType.Area:return _doAreaDivide(t,e,i,r,a);case ItemType.Ring:return _doRingDivide(t,e,i,r,a)}}function _canDivide(t,e,i){if([ItemType.Line,ItemType.Circle,ItemType.Rect,ItemType.Area,ItemType.Ring].indexOf(t.type)<0)return!1;if(t.dataScope){let e=getPeers(t,i);for(let t of e)if(t.dataScope.numTuples>1)return!0;return!1}return!0}function _doLineDivide(t,e,i,s){let a,n,r=getPeers(e,t),l=s.getFieldSummary(i).unique.map((t=>new DataScope(s).cross(i,t))),o={},h=0;for(let t of r){let e=l;t.dataScope&&(e=l.map((e=>e.merge(t.dataScope))),e=e.filter((t=>!t.isEmpty()))),e.length>h&&(h=e.length),o[t.id]=e}for(let i of r){let s=t.collection();null==n&&(n=s.id),s.classId=n,s.dataScope=i.dataScope,i.parent.addChild(s);let r=o[i.id],l=i.vertices[0].x,d=i.vertices[0].y,c=i.vertices[1].x,u=i.vertices[1].y;i.classId=e.id,i.vertices[0].x=l,i.vertices[0].y=d,i.vertices[1].x=l+(c-l)/h,i.vertices[1].y=d+(u-d)/h,i.dataScope=r[0],s.addChild(i);for(let t=1;t<r.length;t++){let e=i.duplicate();e.vertices[0].x=l+(c-l)*t/h,e.vertices[0].y=d+(u-d)*t/h,e.vertices[1].x=l+(c-l)*(t+1)/h,e.vertices[1].y=d+(u-d)*(t+1)/h,e.dataScope=r[t],s.addChild(e)}i==e&&(a=s)}return a}function _doRectDivide(t,e,i,s,a){let n,r,l=getPeers(e,t),o=i||Orientation.Horizontal,h=a.getFieldSummary(s).unique.map((t=>new DataScope(a).cross(s,t))),d={},c=0;for(let t of l){let e=h;t.dataScope&&(e=h.map((e=>e.merge(t.dataScope))),e=e.filter((t=>!t.isEmpty()))),e.length>c&&(c=e.length),d[t.id]=e}for(let i of l){let s=t.collection();null==r&&(r=s.id),s.classId=r,s.dataScope=i.dataScope,i.parent.addChild(s);let a=d[i.id],l=i.bounds,h=l.left,u=l.top,p=o==Orientation.Horizontal?l.width/c:l.width,g=o==Orientation.Horizontal?l.height:l.height/c;i.classId=e.id,i.resize(p,g),i.dataScope=a[0],s.addChild(i);for(let t=1;t<a.length;t++){let e=i.duplicate();e.resize(p,g),e.dataScope=a[t],s.addChild(e)}s.layout=new StackLayout({orientation:o,left:h,top:u}),i==e&&(n=s)}return t._reapplySizeBindings(n),n}function _doAreaDivide(t,e,i,s,a){let n,r=getPeers(e,t),l=r[0];if(4==l.vertices.length&&i==Orientation.Horizontal&&l.vertices[0].x!==l.vertices[1].x)for(let t of r){let e=t.vertices[1];t.vertices[1]=t.vertices[3],t.vertices[3]=e}let o,h=a.getFieldSummary(s).unique.map((t=>new DataScope(a).cross(s,t)));for(let s of r){let a=t.collection();null==o&&(o=a.id),a.classId=o,a.dataScope=s.dataScope,s.parent.addChild(a);let r=s.left,l=s.top,d=i==Orientation.Horizontal?s.width/h.length:s.width,c=i==Orientation.Horizontal?s.height:s.height/h.length;s.classId=e.id,s.resizeArea(d,c),a.addChild(s);for(let t=1;t<h.length;t++){let t=s.duplicate();t.resizeArea(d,c),a.addChild(t)}for(let t=0;t<a.children.length;t++){let e=a.children[t];e.dataScope?e.dataScope=e.dataScope.merge(h[t]):e.dataScope=h[t];for(let t of e.vertices)t.dataScope?t.dataScope=e.dataScope.merge(t.dataScope):t.dataScope=e.dataScope}a.layout=new StackLayout({orientation:i,left:r,top:l}),s==e&&(n=a)}return t._reapplySizeBindings(n),n}function _doRingDivide(t,e,i,s,a){let n,r,l=i||Orientation.Angular,o=getPeers(e,t);if(l==Orientation.Angular)return o.forEach((i=>{let l=i.dataScope?i.dataScope:new DataScope(a),o=a.getFieldSummary(s).unique.map((t=>l.cross(s,t)));o=o.filter((t=>!t.isEmpty()));let h=o.length,d=t.collection();d.dataScope=l,null==r&&(r=d.id),d.classId=r;let c=i.parent,u=360/h;for(let s=0;s<h;s++){let a=t.mark("arc",{innerRadius:i.innerRadius,outerRadius:i.outerRadius,x:i.x,y:i.y,startAngle:90-u*(s+1),endAngle:90-u*s,strokeColor:i.strokeColor,fillColor:i.fillColor,strokeWidth:i.strokeWidth,opacity:i.opacity});a.dataScope=o[s],a.classId=e.id,d.addChild(a)}c.removeChild(i),c.addChild(d),i==e&&(n=d)})),n}function _doCircleDivide(t,e,i,s,a){let n,r,l=i||Orientation.Angular,o=getPeers(e,t);return l==Orientation.Angular?o.forEach((i=>{let l=i.dataScope?i.dataScope:new DataScope(a),o=a.getFieldSummary(s).unique.map((t=>l.cross(s,t)));o=o.filter((t=>!t.isEmpty()));let h=o.length,d=t.collection();d.dataScope=l,null==r&&(r=d.id),d.classId=r;let c=i.parent,u=360/h;for(let s=0;s<h;s++){let a=t.mark("pie",{radius:i.radius,x:i.x,y:i.y,startAngle:90-u*(s+1),endAngle:90-u*s,strokeColor:"#444444",fillColor:i.styles.fillColor});a.dataScope=o[s],a.classId=e.id,d.addChild(a)}c.removeChild(i),c.addChild(d),i==e&&(n=d)})):o.forEach((i=>{let l=i.dataScope?i.dataScope:new DataScope(a),o=a.getFieldSummary(s).unique.map((t=>l.cross(s,t)));o=o.filter((t=>!t.isEmpty()));let h=o.length,d=t.collection();d.dataScope=l,null==r&&(r=d.id),d.classId=r;let c=i.parent,u=360/h;for(let s=0;s<h;s++){let a=t.mark("pie",{radius:i.radius,x:i.x,y:i.y,startAng:u*s,endAng:u+u*s,strokeColor:"#444444",fillColor:i.styles.fillColor});a.dataScope=o[s],a.classId=e.id,d.addChild(a)}c.removeChild(i),c.addChild(d),i==e&&(n=d)})),n}function densifyItem(t,e,i,s,a,n,r,l){let o=n?a.transformField(s,n):s,h=a.getFieldType(o);if(h!=DataType.String&&h!=DataType.Date&&h!=DataType.Number)throw new Error(Errors.DENSIFY_BY_NONCAT+": "+o+" is "+h);if(!_canDensify(e,o,t))throw new Error(Errors.COMPNT_NON_DENSIFIABLE);switch(e.type){case ItemType.Line:return _doLineDensify(t,e,o,a);case ItemType.Circle:return _doCircleDensify(t,e,o,a,r,l);case ItemType.Rect:case ItemType.Area:return _doAreaDensify(t,e,i,o,a)}}function _canDensify(t,e,i){if([ItemType.Line,ItemType.Circle,ItemType.Rect,ItemType.Area].indexOf(t.type)<0)return!1;if(t.dataScope){let e=getPeers(t,i);for(let t of e)if(t.dataScope.numTuples>1)return!0;return!1}return!0}function _doLineDensify(t,e,i,s){let a,n=getPeers(e,t);for(let r of n){let n=r.dataScope?r.dataScope:new DataScope(s),l=s.getFieldSummary(i).unique.map((t=>n.cross(i,t)));l=l.filter((t=>!t.isEmpty()));let o=Object.assign({},r.styles);for(let t of Vertex.styles)r[t]&&(o[t]=r[t]);let h=r.vertices[0].x,d=r.vertices[0].y,c=[],u=r.vertices[1].x-h,p=r.vertices[1].y-d;for(let t=0;t<l.length;t++)c.push([h+t*u/(l.length-1),d+t*p/(l.length-1)]);o.vertices=c;let g=t.mark("path",o);g.classId=e.id,g.dataScope=n;let _=r.parent;_.addChild(g),_.removeChild(r);for(let[t,e]of g.vertices.entries())e.dataScope?e.dataScope=e.dataScope.merge(l[t]):e.dataScope=l[t];r==e&&(a=g)}return a}function _doAreaDensify(t,e,i,s,a){let n,r=getPeers(e,t);for(let l of r){let r=a.getFieldType(s),o=l.dataScope?l.dataScope:new DataScope(a),h=a.getFieldSummary(s).unique.map((t=>o.cross(s,t)));h=r==DataType.Number?h:h.filter((t=>!t.isEmpty())),r!=DataType.Number&&r!=DataType.Date||h.sort(((t,e)=>t._field2value[s]>e._field2value[s]?1:-1));let d=Object.assign({},l.styles),c=l.vertices[0].x,u=l.vertices[0].y,p=l.vertices[l.vertices.length-2].x,g=l.vertices[l.vertices.length-2].y,_=[],f=p-c,m=g-u;for(let t=0;t<h.length;t++)_.push(i==Orientation.Vertical?[p,u+(h.length-1-t)*m/(h.length-1)]:[c+t*f/(h.length-1),u]);for(let t=0;t<h.length;t++)_.push(i==Orientation.Vertical?[c,u+t*m/(h.length-1)]:[c+(h.length-1-t)*f/(h.length-1),g]);d.vertices=_;let y=t.mark("area",d);y.classId="area"==l.type?l.classId:"area"+l.classId.substring(9),y.dataScope=o,y._orientation=i;let x=l.parent;x.addChild(y),x.removeChild(l);for(let[t,e]of y.vertices.entries())t>=h.length?e.dataScope=o.merge(h[2*h.length-1-t]):e.dataScope=o.merge(h[t]);l==e&&(n=y)}return n}function _doCircleDensify(t,e,i,s,a,n){let r;return getPeers(e,t).forEach((l=>{let o=l.dataScope?l.dataScope:new DataScope(s),h=s.getFieldSummary(i).unique.map((t=>o.cross(i,t)));h=h.filter((t=>!t.isEmpty()));let d=h.length;if(d<3)throw Error(Errors.INSUFFICIENT_DATA_SCOPES);let c=360/d,u=[],p=[],g="clockwise"==n?-1:1;for(let t=0;t<h.length;t++){let e=a+g*t*c;p[t]=e;let i=polar2Cartesian(l.x,l.y,l.radius,p[t]);u.push(i)}let _=t.mark("polygon",{x:l.x,y:l.y,radius:l.radius,vertices:u});_.dataScope=o,_.styles=Object.assign({},l.styles);for(let t of Vertex.styles)l[t]&&(_[t]=l[t]);let f=l.parent;f.addChild(_),f.removeChild(l);for(let[t,e]of _.vertices.entries())e.polarAngle=p[t],e.dataScope?e.dataScope=e.dataScope.merge(h[t]):e.dataScope=h[t];l==e&&(r=_)})),r}class RectPath extends Path{constructor(t){super(t),this.type=ItemType.Rect,this.closed=!0,t&&"vertices"in t&&this.segments.push(new Segment(this.vertices[3],this.vertices[0],this,this.segmentCounter++))}get width(){return this.vertices[1].x-this.vertices[0].x}get height(){return this.vertices[2].y-this.vertices[1].y}set height(t){this.resize(this.width,t)}set width(t){this.resize(t,this.height)}get left(){return this.vertices[0].x}get top(){return this.vertices[0].y}get right(){return this.vertices[1].x}get bottom(){return this.vertices[2].y}resize(t,e){this.vertices[1].x=this.vertices[0].x+t,this.vertices[2].x=this.vertices[1].x,this.vertices[0].y=this.vertices[3].y-e,this.vertices[1].y=this.vertices[0].y,this._updateBounds()}get leftSegment(){return this.segments[3]}get rightSegment(){return this.segments[1]}get topSegment(){return this.segments[0]}get bottomSegment(){return this.segments[2]}}class CirclePath extends Path{constructor(t){super(t),this.type=ItemType.Circle,this.closed=!0,this.attrs.x=t.hasOwnProperty("x")?t.x:0,this.attrs.y=t.hasOwnProperty("y")?t.y:0,this.attrs.radius=t.hasOwnProperty("radius")?t.radius:100}get radius(){return this.attrs.radius}get x(){return this.attrs.x}get y(){return this.attrs.y}set x(t){this.attrs.x=t,this._updateBounds()}set y(t){this.attrs.y=t,this._updateBounds()}set radius(t){this.attrs.radius=t,this._updateBounds()}set width(t){this.attrs.radius=t/2,this._updateBounds()}set height(t){this.attrs.radius=t/2,this._updateBounds()}resize(t,e){this.attrs.radius=t/2,this._updateBounds()}translate(t,e){this.attrs.x+=t,this.attrs.y+=e,this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this.attrs.x-this.attrs.radius,this.attrs.y-this.attrs.radius,2*this.attrs.radius,2*this.attrs.radius)}copyPropertiesTo(t){super.copyPropertiesTo(t),t.attrs.x=this.attrs.x,t.attrs.y=this.attrs.y,t.attrs.radius=this.attrs.radius}}function bindToSize(t){return t._query=function(){this.data=[];let t=this.field,e=this.items,i=this.aggregator;switch(this.datatable.getFieldType(t)){case DataType.Boolean:break;case DataType.Date:this.data=e.map((e=>e.dataScope.getFieldValue(t)));break;case DataType.String:break;default:this.data=e.map((e=>e.dataScope.aggregateNumericalField(t,i)))}},t._map=function(){let t,e=this.items,i=this.data,s=this.channel;if(t=createScale(this.scaleType?this.scaleType:"linear"),null==this.data.find((t=>t<0))||"width"!=s&&"height"!=s||0!=e[0].type.indexOf("rect")){let a,n;t.domain=[0,Math.max(...i)],"radius"==s||"outerRadius"==s||"innerRadius"==s?(a=0,n=Math.max(...e.map((t=>t[s]))),n<20&&(n=20)):"area"==s?(a=0,n=Math.max(...e.map((t=>Math.pow(t.bounds.width,2)))),n<400&&(n=400)):"fontSize"==s?(a=2,n=Math.max(...e.map((t=>parseFloat(t.styles.fontSize))))):"strokeWidth"==s?(a=1,n=Math.max(...e.map((t=>parseFloat(t.styles.strokeWidth)))),n==a&&(n=a+5)):(a=0,n=Math.max(...e.map((t=>t.bounds[s])))),this.rangeExtent&&(n=a+this.rangeExtent),this.range&&(a=this.range[0],n=this.range[1]),t._setRange([a,n])}else this._rectNegativeValues=!0,t.domain=[Math.min(...i),Math.max(...i)],"width"==s?t._setRange([0,Math.max(...e.map((t=>t.width)))]):t._setRange([0,Math.max(...e.map((t=>t.height)))]);this.scale||(this.scale=t),this.scale._addEncoding(this)},t._apply=function(){if("radius"==this.channel||"outerRadius"==this.channel||"innerRadius"==this.channel){for(let t=0;t<this.items.length;t++){this.items[t][this.channel]=this.scale.map(this.data[t])}this.scene._relayoutAncestors(this.anyItem,this.items)}else if(this._rectNegativeValues){if("width"==this.channel){let t=Math.min(...this.items.map((t=>t.bounds.left)));for(let e=0;e<this.items.length;e++){let i,s=this.items[e],a=s.leftSegment.vertex1.x,n=s.rightSegment.vertex1.x;i=s.parent&&s.parent.type==ItemType.Collection?s.parent.bounds.left:t,s.rightSegment.translate(i+this.scale.map(this.data[e])-n,0),s.leftSegment.translate(i+this.scale.map(0)-a,0),s._updateBounds()}}else if("height"==this.channel){let t=Math.min(...this.items.map((t=>t.bounds.top)))+this.scale.rangeExtent;for(let e=0;e<this.items.length;e++){let i,s=this.items[e],a=s.topSegment.vertex1.y,n=s.bottomSegment.vertex1.y;i=s.parent&&s.parent.type==ItemType.Collection?s.parent.bounds.bottom:t,s.topSegment.translate(0,i-this.scale.map(this.data[e])-a),s.bottomSegment.translate(0,i-this.scale.map(0)-n),s._updateBounds()}}}else if("area"==this.channel){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=Math.sqrt(this.scale.map(this.data[t]));e.resize(i,i)}this.scene._relayoutAncestors(this.anyItem,this.items)}else if("fontSize"==this.channel){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]);e.styles.fontSize=i+"px"}this.scene._relayoutAncestors(this.anyItem,this.items)}else if("strokeWidth"==this.channel){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]);e.styles.strokeWidth=i}this.scene._relayoutAncestors(this.anyItem,this.items)}else{for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]),s="width"==this.channel?i:e.bounds.width,a="height"==this.channel?i:e.bounds.height;e.resize(s,a)}this.scene._relayoutAncestors(this.anyItem,this.items)}},t.run(),t}function bindToPosition(t){return t._query=function(){this.data=[];let t=this.field,e=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?e.map((t=>t.dataScope)):e.map((t=>t.parent.dataScope));switch(this.datatable.getFieldType(t)){case DataType.Boolean:break;case DataType.Date:this.data=i.map((e=>e.getFieldValue(t)));break;case DataType.String:try{this.data=i.map((e=>e.getFieldValue(t)))}catch(e){throw new Error("Cannot bind "+this.channel+" to "+t+" : "+e)}break;default:this.data=i.map((e=>e.aggregateNumericalField(t,this.aggregator)))}},t._map=function(){let t,e,i,s,a,n=this.channel,r=this.datatable.getFieldType(this.field),l=getClosestLayout(this.anyItem);if(l&&l.type==LayoutType.Grid){let e=l.cellBounds;t="x"==n?e[0].width:e[0].height}else{let e=this.items.map((t=>t[n]));t=Math.max(...e)-Math.min(...e),t<100?t=100:t>500&&(t=500)}switch(this.rangeExtent&&(t=this.rangeExtent),r){case DataType.Boolean:break;case DataType.Date:if(e=Math.min(...this.data),i=Math.max(...this.data),s=[e,i],this.scale){let t=s.concat(this.scale.domain);s=[Math.min(...t),Math.max(...t)],a=this.scale.range}else this.scale=createScale("time"),a=this.invertScale?[t,0]:[0,t];break;case DataType.String:s=Array.from(new Set(this.data)),a=[0,t],this.scale?(s=Array.from(new Set(s.concat(this.scale.domain))),a=this.scale.range):(this.scale=createScale("point"),a=this.invertScale?[t,0]:[0,t]);break;default:if(e=Math.min(...this.data),i=Math.max(...this.data),s=this.includeZero?[0,i]:[e,i],this.scale){let t=s.concat(this.scale.domain);s=[Math.min(...t),Math.max(...t)],a=this.scale.range}else this.scale=createScale(this.scaleType?this.scaleType:"linear"),a=this.invertScale?[t,0]:[0,t];s[0]==s[1]&&(s[1]=1.1*s[0])}this.scale.domain=s,this.scale._setRange(a),this.scale._addEncoding(this)},t._apply=function(){let t=[],e=this.channel;for(let e of this.scale.encodings)t=t.concat(e.items);if("x"==e){let i=getClosestLayout(this.anyItem);if(i&&i.type==LayoutType.Grid)for(let t=0;t<this.items.length;t++){let i=this.items[t],s=getCellBoundsInLayout(i).left+this.scale.map(this.data[t])-i[e],a=0;i.translate(s,a)}else if("vertex"==this.anyItem.type||"segment"==this.anyItem.type){let t=getParents(this.items);void 0===this.scale.offset&&(this.scale.offset=Math.min(...t.map((t=>t.bounds.left))));for(let t=0;t<this.items.length;t++){let i=this.items[t],s=this.scale.offset+this.scale.map(this.data[t])-i[e],a=0;i.translate(s,a)}}else{void 0===this.scale.offset&&(this.scale.offset=Math.min(...t.map((t=>t[e]))));for(let t=0;t<this.items.length;t++){let i=this.items[t],s=this.scale.offset+this.scale.map(this.data[t])-i[e],a=0;i.translate(s,a)}}}else{let i=getClosestLayout(this.anyItem);if(i&&i.type==LayoutType.Grid){let t=this.items.map((t=>getCellBoundsInLayout(t)));for(let i=0;i<this.items.length;i++){let s=this.items[i],a=0,n=t[i].bottom-this.scale.map(this.data[i])-s[e];s.translate(a,n)}}else if("vertex"==this.anyItem.type||"segment"==this.anyItem.type){void 0===this.scale.offset&&(this.scale.offset=Math.min(...this.items.map((t=>t.y))));for(let t=0;t<this.items.length;t++){let i=this.items[t],s=0,a=this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[t])-i[e];i.translate(s,a)}}else{void 0===this.scale.offset&&(this.scale.offset=Math.min(...t.map((t=>t.bounds.y))));for(let t=0;t<this.items.length;t++){let i=this.items[t],s=0,a=this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[t])-i[e];i.translate(s,a)}}}},t.run(),t}function bindToRadialDistance(t){return t._query=function(){this.data=[];let t=this.field,e=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?e.map((t=>t.dataScope)):e.map((t=>t.parent.dataScope));switch(this.datatable.getFieldType(t)){case DataType.Boolean:break;case DataType.Date:this.data=i.map((e=>e.getFieldValue(t)));break;case DataType.String:try{this.data=i.map((e=>e.getFieldValue(t)))}catch(e){throw new Error("Cannot bind "+this.channel+" to "+t+" : "+e)}break;default:this.data=i.map((e=>e.aggregateNumericalField(t,this.aggregator)))}},t._map=function(){let t=this.data;this.scale||(this.scale=createScale("linear"),this.scale.domain=[0,Math.max(...t)],this.scale._setRange([0,this.radius]),this.scale._addEncoding(this))},t._apply=function(){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]),s=polar2Cartesian(this.x,this.y,i,e.polarAngle);e.x=s[0],e.y=s[1]}this.scene._relayoutAncestors(this.anyItem,this.items)},t.run(),t}function bindToColor(t){return t._query=function(){this.data=[];let t=this.field,e=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?e.map((t=>t.dataScope)):e.map((t=>t.parent.dataScope));switch(this.datatable.getFieldType(t)){case DataType.Boolean:this.data=[!0,!1];break;case DataType.Date:this.data=i.map((e=>e.getFieldValue(t)));break;case DataType.String:try{this.data=i.map((e=>e.getFieldValue(t)))}catch(e){throw new Error("Cannot bind "+this.channel+" to "+t+" : "+e)}break;default:this.data=i.map((e=>e.aggregateNumericalField(t,this.aggregator)))}},t._map=function(){switch(this.datatable.getFieldType(this.field)){case DataType.Date:break;case DataType.Boolean:case DataType.String:if(this.scale)this.scale.domain=Array.from(new Set(this.scale.domain.concat(this.data)));else if(this.scale=createScale("ordinalColor"),this.scale.domain=this.data,this.mapping){let t=this.scale.domain.map((t=>t in this.mapping?this.mapping[t]:"black"));this.scale._scale.range(t)}break;default:if(this.scale){let t=this.scale.domain.concat(this.data);this.scale.domain=[Math.min(...t),Math.max(...t)]}else this.mapping?this.scale=createScale("linear",this.mapping):(this.scale=createScale("sequentialColor",this.scheme?this.scheme:"interpolateTurbo"),this.scale.domain=[Math.min(...this.data),Math.max(...this.data)])}},t._apply=function(){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]);"vertex"==e.type||"segment"==e.type?e[this.channel]=i:e.styles[this.channel]=i,e.vertices&&"strokeColor"==this.channel&&e.vertices.forEach((t=>t.fillColor=i))}},t.run(),t}function bindToAngle(t){return t._query=function(){this.data=[];let t=this.field,e=this.items;switch(this.datatable.getFieldType(t)){case DataType.Boolean:break;case DataType.Date:this.data=e.map((e=>e.dataScope.getFieldValue(t)));break;case DataType.String:break;default:this.data=e.map((e=>e.dataScope.aggregateNumericalField(t,this.aggregator)))}},t._map=function(){this.scale||(this.scale=createScale("linear"),this.scale.domain=[0,this.data.reduce(((t,e)=>t+e),0)],this.scale._setRange([0,360]),this.scale._addEncoding(this))},t._apply=function(){let t,e=this.startAngle;for(let i=0;i<this.items.length;i++){t=this.items[i];let s=this.scale.map(this.data[i]);switch(this.angleDirection){case"clockwise":t.adjustAngle(e-s,e),e-=s;break;case"anticlockwise":t.adjustAngle(e,e+s),e+=s}}},t.run(),t}function bindToArea(t){return t._query=function(){this.data=[],this.areas=getPeers(this.items[0],this.scene);let t=this.areas.length;this.areaNum=t,this.items=[],this.indicator=[];for(let t of this.areas)for(let e=0;e<t.vertices.length;e++)this.items.push(t.vertices[e]),e<t.vertices.length/2?this.indicator.push(1):this.indicator.push(0);let e=this.field,i=this.items,s="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?i.map((t=>t.dataScope)):i.map((t=>t.parent.dataScope));switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:this.data=s.map((t=>t.getFieldValue(e)));break;case DataType.String:this.data=s.map((t=>0==this.indicator[s.indexOf(t)]?0:t.aggregateNumericalField(e,this.aggregator)));break;default:"x"==this.channel||"y"==this.channel?this.data=s.map((t=>t._field2value[e])):this.data=s.map((t=>0==this.indicator[s.indexOf(t)]?0:t.aggregateNumericalField(e,this.aggregator)))}},t._map=function(){let t,e,i;switch(this.datatable.getFieldType(this.field)){case DataType.Boolean:break;case DataType.Date:t=createScale("time"),e=Math.min(...this.data),i=Math.max(...this.data),t.domain=[e,i];break;case DataType.String:default:t=createScale("linear"),e=Math.min(...this.data),i=Math.max(...this.data),t.domain=this.includeZero||e<0?[0,i]:[e,i]}let s,a=CheckAreaOrien(this.areas[0]),n=getClosestLayout(this.anyItem);if(n){let t=n.cellBounds;s="width"==this.channel||"height"==this.channel?a==Orientation.Vertical?t[0].width:t[0].height:a==Orientation.Vertical?t[0].height:t[0].width}else if("width"==this.channel||"x"==this.channel){let t=this.items.map((t=>t.x));s=Math.max(...t)-Math.min(...t)}else{let t=this.items.map((t=>t.y));s=Math.max(...t)-Math.min(...t)}e<0?(t._scale.domain([e,i]),t._setRange([0,s])):t._setRange([0,s]),this.scale?this.scale._merge(t):this.scale=t,this.scale._addEncoding(this)},t._apply=function(){let t=[],e=this.channel;for(let e of this.scale.encodings)t=t.concat(e.items);let i=CheckAreaOrien(this.areas[0]);if("width"==e||"height"==e){let t=this.scale.domain[0]<this.scale.domain[1]?"default":"opposite",e=getAllLayouts(this.items);if(e[0]){let s=e[e.length-1].baseline==Alignment.Center||e[e.length-1].baseline==Alignment.Middle;for(let a=e.length-1;a>=0;a--){let n=e[a];if(i==Orientation.Vertical)switch(n.type){case LayoutType.Grid:if(s){n._cellHorzAlignment=Alignment.Center;break}n._cellHorzAlignment=n.baseline?n.baseline:e[e.length-1].type==LayoutType.Grid?e[e.length-1]._cellHorzAlignment:n._cellHorzAlignment;break;case LayoutType.Stack:if(s){n.baseline=s?Alignment.Center:void 0;break}n._horzCellAlignment=n.baseline?n.baseline:e[e.length-1].type==LayoutType.Grid?e[e.length-1]._cellHorzAlignment:"default"==t?Alignment.Left:Alignment.Right}else switch(n.type){case LayoutType.Grid:if(s){n._cellVertAlignment=Alignment.Middle;break}n._cellVertAlignment=n.baseline?n.baseline:e[e.length-1].type==LayoutType.Grid?e[e.length-1]._cellVertAlignment:n._cellVertAlignment;break;case LayoutType.Stack:if(s){n.baseline=s?Alignment.Middle:void 0;break}n._vertCellAlignment=n.baseline?n.baseline:e[e.length-1].type==LayoutType.Grid?e[e.length-1]._cellVertAlignment:"default"==t?Alignment.Bottom:Alignment.Top}}for(let t=0;t<this.items.length;t++){let e=this.items[t],s=getCellBoundsInLayout(e),a=getClosestLayout(e),n=i==Orientation.Vertical?a.type==LayoutType.Stack?a._horzCellAlignment==Alignment.Left:a._cellHorzAlignment==Alignment.Left:a.type==LayoutType.Stack?a._vertCellAlignment==Alignment.Bottom:a._cellVertAlignment==Alignment.Bottom,r=i==Orientation.Vertical?n?s.left+this.scale.map(this.data[t])-e.x:s.right-this.scale.map(this.data[t])-e.x:0,l=i==Orientation.Vertical?0:n?s.bottom-this.scale.map(this.data[t])-e.y:s.top+this.scale.map(this.data[t])-e.y;e.translate(r,l)}if("grid"==e[e.length-1].type&&s){let t=this.items.length/this.areaNum;for(let e=0;e<this.areaNum;e++)for(let s=0;s<t/2;s++){let a=e*t+s,n=(e+1)*t-s-1,r=this.items[a],l=this.items[n],o=getCellBoundsInLayout(r),h=i==Orientation.Vertical?r.x-l.x:l.y-r.y,d=i==Orientation.Vertical?o.x+h/2-r.x:0,c=i==Orientation.Vertical?0:o.y+h/2-r.y,u=i==Orientation.Vertical?o.x-h/2-l.x:0,p=i==Orientation.Vertical?0:o.y-h/2-l.y;r.translate(d,c),l.translate(u,p)}}}else{let t="center"==this.areas[0].baseline,e=getParents(this.items),s=i==Orientation.Vertical?this.areas[0].baseline!==Alignment.Right?Math.min(...e.map((t=>t.bounds.left))):Math.max(...e.map((t=>t.bounds.right))):this.areas[0].baseline!=Alignment.Top?Math.max(...e.map((t=>t.bounds.bottom))):Math.min(...e.map((t=>t.bounds.top)));for(let t=0;t<this.items.length;t++){let e=this.items[t],a=i==Orientation.Vertical?this.areas[0].baseline!==Alignment.Right?s+this.scale.map(this.data[t])-e.x:s-this.scale.map(this.data[t])-e.x:0,n=i==Orientation.Vertical?0:this.areas[0].baseline!=Alignment.Top?s-this.scale.map(this.data[t])-e.y:s+this.scale.map(this.data[t])-e.y;e.translate(a,n)}if(1==t){let t=this.items.length/this.areaNum,e=getParents(this.items),s=i==Orientation.Vertical?Math.min(...e.map((t=>t.bounds.x))):Math.max(...e.map((t=>t.bounds.y)));for(let e=0;e<this.areaNum;e++)for(let a=0;a<t/2;a++){let n=e*t+a,r=(e+1)*t-a-1,l=this.items[n],o=this.items[r],h=i==Orientation.Vertical?l.x-o.x:o.y-l.y,d=i==Orientation.Vertical?s+h/2-l.x:0,c=i==Orientation.Vertical?0:s+h/2-l.y,u=i==Orientation.Vertical?s-h/2-o.x:0,p=i==Orientation.Vertical?0:s-h/2-o.y;l.translate(d,c),o.translate(u,p)}}}}else{if(getClosestLayout(this.anyItem)){let t=getParents(this.items);void 0===this.scale.offset&&(this.scale.offset=i==Orientation.Horizontal?Math.min(...t.map((t=>t.bounds.left))):Math.max(...t.map((t=>t.bounds.top))));for(let t=0;t<this.items.length;t++){let e=this.items[t],s=getCellBoundsInLayout(e),a=i==Orientation.Vertical?0:s.left+this.scale.map(this.data[t])-e.x,n=i==Orientation.Vertical?s.bottom-this.scale.map(this.data[t])-e.y:0;e.translate(a,n)}}else{let t=getParents(this.items);void 0===this.scale.offset&&(this.scale.offset=i==Orientation.Horizontal?Math.min(...t.map((t=>t.bounds.left))):Math.max(...t.map((t=>t.bounds.top))));for(let t=0;t<this.items.length;t++){let e=this.items[t],s=i==Orientation.Horizontal?this.scale.offset+this.scale.map(this.data[t])-e.x:0,a=i==Orientation.Horizontal?0:this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[t])-e.y;e.translate(s,a)}}}for(let t of this.areas)t._updateBounds();"width"!=e&&"height"!=e||this.scene._relayoutAncestors(this.areas[0],this.areas)},t.run(),t}function bindToText(t){return t._query=function(){this.data=[];let t,e,i=this.items;if(this.field.startsWith("parent.")||this.field.startsWith("child.")){e=this.datatable.tree.nodeTable,t=this.field.split(".")[1];let s=this.field.split(".")[0],a=i.map((t=>t.dataScope)).map((t=>t.getFieldValue(s)));e.getFieldType(t)==DataType.Integer||e.getFieldType(t)==DataType.Number?this.data=a.map((i=>new DataScope(e).cross(nodeId,i).aggregateNumericalField(t))):this.data=a.map((i=>new DataScope(e).cross(nodeId,i).getFieldValue(t)))}else e=this.datatable,t=this.field,e.getFieldType(t)==DataType.Integer||e.getFieldType(t)==DataType.Number?this.data=i.map((e=>e.dataScope.aggregateNumericalField(t,this.aggregator))):this.data=i.map((e=>e.dataScope.getFieldValue(t)))},t._map=function(){if(this.scale);else switch(this.datatable.getFieldType(this.field)){case DataType.Boolean:case DataType.Date:break;case DataType.String:default:this.scale=createScale("ordinal"),this.scale.domain=[...new Set(this.data)],this.scale._scale.range(this.scale.domain.map((t=>t+"")))}},t._apply=function(){for(let t=0;t<this.items.length;t++){let e=this.items[t],i=this.scale.map(this.data[t]);e.text=i}},t.run(),t}class Encoding{constructor(t,e,i,s,a){this.items=t,this.anyItem=this.items[0],this.scene=e,this.channel=i,this.field=s,this.aggregator=a.aggregator,this.datatable=a.datatable,this.scale=a.scale,this.callback=a.callback,this.includeZero=a.includeZero,this.invertScale=a.invertScale,this.mapping=a.mapping,this.rangeExtent=a.rangeExtent,this.scheme=a.scheme,this.scaleType=a.scaleType,this.range=a.range,"angle"==this.channel&&(this.startAngle="startAngle"in a?a.startAngle:90,this.angleDirection="angleDirection"in a?a.angleDirection:"clockwise"),this._query=void 0,this._map=void 0,this._apply=void 0}toJSON(){let t={};return t.anyItem=this.anyItem.id,t.channel=this.channel,t.field=this.field,t.items=this.items.map((t=>t.id)),this.data&&(t.data=this.data),this._rectNegativeValues&&(t._rectNegativeValues=!0),t.args={},t.args.aggregator=this.aggregator,t.args.datatable=this.datatable.url,t.scale=this.scale.id,t.args.includeZero=this.includeZero,t.args.invertScale=this.invertScale,t.args.mapping=this.mapping,t.args.rangeExtent=this.rangeExtent,t.args.scheme=this.scheme,t.args.scaleType=this.scaleType,t.args.range=this.range,"angle"==this.channel&&(t.args.startAngle=this.startAngle,t.args.angleDirection=this.angleDirection),t}run(){this._query(),this._map(),this._apply()}getScaleRange(t){let e=t||this.anyItem;if(e.type!=ItemType.Area){if("x"==this.channel){let t=getClosestLayout(this.anyItem);if(t&&t.type==LayoutType.Grid){let i=t.cellBounds,s=e.parent.parent.children.findIndex((t=>e.parent==t||e.parent.parent==t));return[i[s].left,i[s].left+this.scale.rangeExtent]}if("vertex"==e.type||"segment"==e.type){let t=this.scale.offset;return[t,t+this.scale.rangeExtent]}{let t=this.scale.offset;return[t,t+this.scale.rangeExtent]}}if("y"==this.channel){let t=getClosestLayout(this.anyItem);if(t&&t.type==LayoutType.Grid){let i=t.cellBounds,s=e.parent.parent.children.findIndex((t=>e.parent==t||e.parent.parent==t));return[i[s].bottom,i[s].bottom-this.scale.rangeExtent]}if("vertex"==e.type||"segment"==e.type){let t=this.scale.offset;return[t+this.scale.rangeExtent,t]}{let t=this.scale.offset;return[t+this.scale.rangeExtent,t]}}if("width"==this.channel){let t=getPeers(e,this.scene),i=Math.min(...t.map((t=>t.bounds.left)));return[i,i+this.scale.rangeExtent]}if("height"==this.channel){let t=getPeers(e,this.scene),i=Math.max(...t.map((t=>t.bounds.bottom)));return[i,i-this.scale.rangeExtent]}if("radialDistance"==this.channel){let t=e.parent;return[t.x,t.x+this.scale.rangeExtent]}return this.scale.range}{let t,i=CheckAreaOrien(e),s=getClosestLayout(e);t=s?i==Orientation.Vertical?s.type==LayoutType.Stack?s._horzCellAlignment==Alignment.Left:s._cellHorzAlignment==Alignment.Left:s.type==LayoutType.Stack?s._vertCellAlignment==Alignment.Bottom:s._cellVertAlignment==Alignment.Bottom:i==Orientation.Vertical?e.baseline==Alignment.Left:e.baseline==Alignment.Bottom;let a=getCellBoundsInGridLayout(e);if(a)switch(this.channel){case"x":return[a.left,a.left+this.scale.rangeExtent];case"width":return t?[a.left,a.left+this.scale.rangeExtent]:[a.right,a.right-this.scale.rangeExtent];case"y":return[a.bottom,a.bottom-this.scale.rangeExtent];case"height":return t?[a.bottom,a.bottom-this.scale.rangeExtent]:[a.top,a.top+this.scale.rangeExtent]}if(i==Orientation.Horizontal)switch(this.channel){case"width":case"height":{let i=getPeers(e.firstVertex,this.scene),s=t?Math.max(...i.map((t=>t.y))):Math.min(...i.map((t=>t.y)));return t?[s,s-this.scale.rangeExtent]:[s+this.scale.rangeExtent,s]}case"x":case"y":{let t=getPeers(e.firstVertex,this.scene),i=Math.min(...t.map((t=>t.x)));return[i,i+this.scale.rangeExtent]}}else if(i==Orientation.Vertical)switch(this.channel){case"x":case"y":{let t=getPeers(e.firstVertex,this.scene),i=Math.max(...t.map((t=>t.y)));return[i,i-this.scale.rangeExtent]}case"height":case"width":{let i=getPeers(e.firstVertex,this.scene),s=t?Math.min(...i.map((t=>t.x))):Math.max(...i.map((t=>t.x)));return t?[s,s+this.scale.rangeExtent]:[s-this.scale.rangeExtent,s]}}}}}function bin(t,e,i){let s=e[0],a=t.nonNumericFields,n={};for(let e of t.data){let t=a.map((t=>String(e[t]))).join("_");n.hasOwnProperty(t)||(n[t]=a.map((t=>e[t])),n[t].push([])),n[t][n[t].length-1].push(e[s])}let r=[];for(let t in n){let e=n[t].pop(),i=d3__namespace.bin()(e);for(let e of i){let i={};n[t].forEach(((t,e)=>i[a[e]]=t)),i.x0=e.x0,i.x1=e.x1,i[s+"_count"]=e.length,r.push(i)}}let l={};a.forEach((e=>l[e]=t.getFieldType(e))),l.x0=DataType.Number,l.x1=DataType.Number,l[s+"_count"]=DataType.Number;let o=new DataTable(r,t.url,l);return o.sourceDataTable=t,o.transform={type:"bin",args:e},o}function kde(t,e,i){let s=e[0],a=t.nonNumericFields,n={};for(let e of t.data){let t=a.map((t=>String(e[t]))).join("_");t in n||(n[t]=a.map((t=>e[t])),n[t].push([])),n[t][n[t].length-1].push(e[s])}let r="min"in i?i.min:t.getFieldSummary(s).min,l="max"in i?i.max:t.getFieldSummary(s).max,o=r,h=[];for(;o<l;)h.push(o),o+=i.interval;h.push(o);let d=[];for(let t in n){let e=n[t].pop(),r=_kde(_epanechnikov(i.bandwidth),h,e);for(let e of r){let i={};n[t].forEach(((t,e)=>i[a[e]]=t)),i[s]=e[0],i[s+"_density"]=e[1],d.push(i)}}let c={};return a.forEach((e=>c[e]=t.getFieldType(e))),c[s]=DataType.Number,c[s+"_density"]=DataType.Number,new DataTable(d,t.url,c)}function _kde(t,e,i){return e.map((e=>[e,d3__namespace.mean(i,(i=>t(e-i)))]))}function _epanechnikov(t){return e=>Math.abs(e/=t)<=1?.75*(1-e*e)/t:0}function sort(t,e,i){t.data.sort(((t,i)=>compareRow(t,i,e))),t.summarize()}function compareRow(t,e,i,s){for(let s of i){if(t[s]<e[s])return-1;if(t[s]>e[s])return 1}return 0}function filter(t,e){let i=[];for(let s of t.data){let t=!0;for(let i of e)if(!satisfy(s,i)){t=!1;break}t&&i.push(s)}let s=new DataTable(i,t.url);return s.sourceDataTable=t,s.transform={type:"filter",args:e},s}function satisfy(row,p){if(p.hasOwnProperty("field")){let t=p.field;if(p.hasOwnProperty("value"))return row[t]==p.value;if(p.hasOwnProperty("range"))return row[t]>=p.range[0]&&row[t]<=p.range[1];if(p.hasOwnProperty("values"))return p.values.indexOf(row[t])>=0}else if(p.hasOwnProperty("fields")){let f1=p.fields[0],f2=p.fields[1];return 1==eval(row[f1]+p.operator+row[f2])}}class DataTable{constructor(t,e,i){if(this.url=e,this.id=ItemType.DataTable+ItemCounter[ItemType.DataTable]++,this.data=t,this._fields=Object.keys(this.data[0]),this._newField=0,i)this._fieldTypes=i;else{this._fieldTypes={};for(let t of this._fields)this._fieldTypes[t]=_inferType(this.data.map((e=>e[t]))),"year"==t.toLowerCase()&&this._fieldTypes[t]==DataType.Integer&&(this._fieldTypes[t]=DataType.Date);_validate(this.data,this._fieldTypes)}this._fieldSummaries={};for(let t of this._fields)this._fieldSummaries[t]=_summarize(this.data.map((e=>e[t])),this._fieldTypes[t]);this._addField(atlas_rowId,DataType.String,this.data.map(((t,e)=>"r"+e)))}get name(){return this.id}set sourceDataTable(t){this._sourceDataTable=t}get sourceDataTable(){return this._sourceDataTable}set transform(t){this._transform=t}get transform(){return this._transform}toJSON(){let t={};return t.data=this.data,t.fieldTypes=this._fieldTypes,t.url=this.url,t.id=this.id,t.sourceDataTable=this._sourceDataTable,t.transform=this._transform,t}transformField(t,e,i){let s=this.data.map((i=>e(i[t]))),a=_inferType(s),n=i||Date.now()+"_field"+this._newField++;return this._addField(n,a,s),n}setValueOrder(t,e){this._fieldSummaries[t].unique=e}_addField(t,e,i){this.data.forEach(((e,s)=>e[t]=i[s])),this._fieldTypes[t]=e,this._fields.push(t),this._fieldSummaries[t]=_summarize(i,e)}getFieldType(t){return this._fieldTypes[t]}get fields(){return this._fields}getFieldSummary(t){return this._fieldSummaries[t]}getFieldValues(t){return this.data.map((e=>e[t]))}getUniqueFieldValues(t){return this._fieldSummaries[t].unique}getRowCount(){return this.data.length}hasField(t){return this._fields.indexOf(t)>=0}parseFieldAsDate(t,e){let i=d3__namespace.timeParse(e);for(let e of this.data)null==e[t]||null==e[t]?e[t]=new Date(1899,11,31).getTime():e[t]=i(e[t]).getTime();this._fieldTypes[t]=DataType.Date,this._fieldSummaries[t]=_summarize(this.data.map((e=>e[t])),DataType.Date)}static get RowID(){return atlas_rowId}get nonNumericFields(){let t=[];for(let e in this._fieldTypes)this._fieldTypes[e]!=DataType.Number&&this._fieldTypes[e]!=DataType.Integer&&e!=DataTable.RowID&&t.push(e);return t}transform(t,e,i){let s=i||{};switch(t){case"kde":return kde(this,e,s);case"bin":return bin(this,e);case"sort":return sort(this,e);case"filter":return filter(this,e)}}summarize(){for(let t of this._fields)this._fieldSummaries[t]=_summarize(this.data.map((e=>e[t])),this._fieldTypes[t])}}function _summarize(t,e){var i={};switch(e){case DataType.Boolean:i.trueCount=t.filter((t=>t)).length,i.falseCount=t.filter((t=>!t)).length;break;case DataType.Date:i.min=d3__namespace.min(t),i.max=d3__namespace.max(t),i.extent=[i.min,i.max],i.unique=[...new Set(t)];break;case DataType.String:i.unique=[...new Set(t)];break;default:i.min=d3__namespace.min(t),i.max=d3__namespace.max(t),i.extent=[i.min,i.max],i.mean=d3__namespace.mean(t),i.median=d3__namespace.median(t),i.unique=[...new Set(t)]}return i}function _validate(t,e){for(let i of t)for(let t in e){let s,a=e[t],n=i[t];if(null==i[t]||null==i[t])switch(a){case DataType.Boolean:s=!1;break;case DataType.Date:s=new Date(1899,11,31).getTime();break;case DataType.String:s="";break;default:s=0}else switch(a){case DataType.Boolean:s=n;break;case DataType.Date:s=Number.isInteger(n)?new Date(n,0).getTime():new Date(n+"").getTime();break;case DataType.String:s=n.toString();break;default:s=n}i[t]=s}}var isValidType={boolean:function(t){return"true"===t||"false"===t||!0===t||!1===t||"[object Boolean]"==toString.call(t)},integer:function(t){return isValidType.number(t)&&(t=+t)==~~t},number:function(t){return!isNaN(+t)&&"[object Date]"!=toString.call(t)},date:function(t){return!isNaN(Date.parse(t))},string:function(t){return!0}};function _inferType(t){var e=Object.values(DataType);for(let i=0;i<t.length;i++){let s=t[i];if(null!=s){for(let t=0;t<e.length;t++)isValidType[e[t]](s)||(e.splice(t,1),t-=1);if(1==e.length)return e[0]}}return e[0]}class PointText extends Mark{constructor(t){super(t),this.type=ItemType.PointText,this.attrs.x=0,this.attrs.y=0,"fontSize"in this.styles||(this.styles.fontSize="12px"),"fontFamily"in this.styles||(this.styles.fontFamily="arial"),"fontWeight"in this.styles||(this.styles.fontWeight="regular"),"fillColor"in this.styles||(this.styles.fillColor="black"),void 0!==t&&("x"in t&&(this.attrs.x=t.x),"y"in t&&(this.attrs.y=t.y),this.attrs.text="text"in t?t.text:"",this.attrs.anchor="anchor"in t?t.anchor:["center","middle"]),this._updateBounds()}copyPropertiesTo(t){t.styles=Object.assign({},this.styles),this._dataScope&&(t._dataScope=this._dataScope.clone()),t.x=this.attrs.x,t.y=this.attrs.y,t.text=this.text,t.anchor=[this.anchor[0],this.anchor[1]]}get bounds(){return this._bounds||this._updateBounds(),this._bounds}set text(t){this.attrs.text=t,this._updateBounds()}get text(){return this.attrs.text}translate(t,e){this.attrs.x+=t,this.attrs.y+=e,this._updateBounds()}_updateBounds(){let t,e,i=getTextWidth(this.attrs.text,[this.fontWeight,this.fontSize,this.fontFamily].join(" ")),s=parseFloat(this.fontSize);switch(this.attrs.anchor[0]){case"left":t=this.attrs.x;break;case"right":t=this.attrs.x-i;break;case"center":t=this.attrs.x-i/2;break;default:t=this.attrs.x}switch(this.attrs.anchor[1]){case"top":e=this.attrs.y;break;case"bottom":e=this.attrs.y-s;break;case"middle":e=this.attrs.y-s/2}this._bounds=new Rectangle(t,e,i,s)}get center(){return{x:this.bounds.left+this.bounds.width/2,y:this.bounds.top+this.bounds.height/2}}get x(){return this.attrs.x}set x(t){this.attrs.x=t,this._updateBounds()}get y(){return this.attrs.y}set y(t){this.attrs.y=t,this._updateBounds()}get anchor(){return this.attrs.anchor}set anchor(t){this.attrs.anchor=t,this._updateBounds()}get fontSize(){return this.styles.fontSize}set fontSize(t){this.styles.fontSize=t,this._updateBounds()}get fontWeight(){return this.styles.fontWeight}set fontWeight(t){this.styles.fontWeight=t,this._updateBounds()}get fontFamily(){return this.styles.fontFamily}set fontFamily(t){this.styles.fontFamily=t,this._updateBounds()}}class Axis extends Group{constructor(t){super(),this.type=ItemType.Axis,this.id=this.type+ItemCounter[this.type]++,this._orientation="orientation"in t?t.orientation:"",this._strokeColor="strokeColor"in t?t.strokeColor:"#555",this._textColor="textColor"in t?t.textColor:"#555",this._tickOffset="tickOffset"in t?t.tickOffset:0,this._tickSize="tickSize"in t?t.tickSize:5,this._tickAnchor=t.tickAnchor?t.tickAnchor:"middle",this._tickVisible=!("tickVisible"in t)||t.tickVisible,this._pathVisible=!("pathVisible"in t)||t.pathVisible,this._labelOffset="labelOffset"in t?t.labelOffset:15,this._labelFormat="labelFormat"in t?t.labelFormat:"",this._titleOffset="titleOffset"in t?t.titleOffset:40,"titleAnchor"in t?this._titleAnchor=t.titleAnchor:"x"==this.channel||"width"==this.channel?this._titleAnchor="top"==this._orientation?["center","bottom"]:["center","top"]:this._titleAnchor="left"==this._orientation?["right","middle"]:["left","middle"],this._rotateYTitle=!("rotateTitle"in t&&!t.rotateTitle),this._titlePosition=t.titlePosition,"labelRotation"in t&&(this._labelRotation=t.labelRotation),this._flip="flip"in t&&t.flip}toJSON(){let t=super.toJSON();return t.field=this._field,t.channel=this._channel,"args"in t||(t.args={}),t.args.orientation=this._orientation,t.args.strokeColor=this._strokeColor,t.args.textColor=this._textColor,t.args.tickOffset=this._tickOffset,t.args.tickSize=this._tickSize,t.args.tickAnchor=this._tickAnchor,t.args.tickVisible=this._tickVisible,t.args.pathVisible=this._pathVisible,t.args.labelOffset=this._labelOffset,t.args.labelFormat=this._labelFormat,this._labelRotation&&(t.args.labelRotation=this._labelRotation),t.args.showTitle=this._showTitle,t.args.titleAnchor=this._titleAnchor,t.args.titleOffset=this._titleOffset,t.args.titlePosition=this._titlePosition,t.args.rotateTitle=this._rotateYTitle,t.args.flip=this._flip,t}get field(){return this._field}get orientation(){return this._orientation}set orientation(t){this._orientation=t}get x(){return"y"==this.channel?this._position:void 0}set x(t){"y"==this.channel&&(this._position=t)}get y(){return"x"==this.channel?this._position:void 0}set y(t){"x"==this.channel&&(this._position=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this._strokeColor=t}get textColor(){return this._textColor}set textColor(t){this._textColor=t}get tickOffset(){return this._tickOffset}set tickOffset(t){this._tickOffset=t}get titleOffset(){return this._titleOffset}set titleOffset(t){this._titleOffset=t}get tickSize(){return this._tickSize}set tickSize(t){this._tickSize=t}set tickValues(t){this._tickValues=t,this._generateTicks(),this._positionTicks()}get tickValues(){return this._tickValues}set labelValues(t){this._labelValues=t,this._generateLabels(),this._positionLabels()}get labelValues(){return this._labelValues}get tickAnchor(){return this._tickAnchor}set tickAnchor(t){this._tickAnchor=t}get tickVisible(){return this._tickVisible}set tickVisible(t){this._tickVisible=t}get pathVisible(){return this._pathVisible}set pathVisible(t){this._pathVisible=t}get labelOffset(){return this._labelOffset}set labelOffset(t){this._labelOffset=t}get labelFormat(){return this._labelFormat}set labelFormat(t){this._labelFormat=t}get labelRotation(){return this._labelRotation}set labelRotation(t){this._labelRotation=t}get showTitle(){return this._showTitle}set showTitle(t){this._showTitle=t}get titleAnchor(){return this._titleAnchor}set titleAnchor(t){this._titleAnchor=t}get titlePosition(){return this._titlePosition}set titlePosition(t){this._titlePosition=t}get rotateTitle(){return this._rotateYTitle}set rotateTitle(t){this._rotateYTitle=t}get title(){return this._titleText}set title(t){this._titleText=t}_generatePath(){}_generateTicks(){}_generateLables(){}_generateTitle(){this._title=new PointText({text:this._titleText,fillColor:this._textColor,fontWeight:"bold"}),this._title.id=this.id+"-title",this.addChild(this._title)}_positionPath(){}_positionTicks(){}_positionLabels(){}_positionTitle(){}reposition(){this._positionPath(),this._positionTicks(),this._positionLabels(),this._showTitle&&this._positionTitle(),this._updateBounds()}}class EncodingAxis extends Axis{constructor(t,e,i){super(i),this.encoding=t,this._field=this.encoding.field,this._channel=this.encoding.channel,this._position="x"==this._channel||"width"==this._channel?i.y:i.x,this._titleText="title"in i?i.title:this.encoding.field,this._item=e,this._ticks=new Group,this._ticks.id=this.id+"ticks",this.addChild(this._ticks),this._labels=new Group,this._labels.id=this.id+"labels",this.addChild(this._labels),"radialDistance"==this._channel&&(this._position=this._item.parent.y,"rotation"in i&&(this._rotate=[-i.rotation,this.encoding.x,this.encoding.y])),this._showTitle=!("showTitle"in i)||i.showTitle,this._generatePath(),this._positionPath(),this._showTitle&&(this._generateTitle(),this._positionTitle())}_updateBounds(){this._bounds=this._ticks.bounds,this._bounds=this._bounds.union(this._path.bounds),this._bounds=this._bounds.union(this._labels.bounds),this._title&&(this._bounds=this._bounds.union(this._title.bounds))}toJSON(){let t=super.toJSON();return t.item=this._item.id,this._rotate&&(t.args.rotation=this._rotate[0]),"x"==this._channel||"width"==this._channel?t.args.y=this._position:t.args.x=this._position,t}get ticks(){return this._ticks}get labels(){return this._labels}get path(){return this._path}_generatePath(){this._path=new Path({strokeColor:this._strokeColor}),this._pathVisible||(this._path.visibility="hidden"),this._path.type=ItemType.Line,this._path.id=this.id+"path",this.addChild(this._path)}_generateTicks(){this._ticks.removeAll();for(let t=0;t<this._tickValues.length;t++){let e=new Path({strokeColor:this._strokeColor});this._tickVisible||(e.visibility="hidden"),e.type=ItemType.Line,e.id=this.id+"tick"+t,this._ticks.addChild(e)}}_generateLabels(){let t;switch(this._labels.removeAll(),this.encoding.datatable.getFieldType(this.encoding.field)){case DataType.Date:t=d3__namespace.timeFormat(this._labelFormat);break;case DataType.String:t=function(t){return t};break;default:t=d3__namespace.format(this._labelFormat)}for(let[e,i]of this._labelValues.entries()){let s=new PointText({text:t(i),fillColor:this._textColor});s.id=this.id+"label"+e,this._labels.addChild(s)}}_positionPath(){this._range=this.encoding.getScaleRange(this._item),void 0===this._position&&this._computePosition();let t=[];if("x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let e=this._ticks.children.map((t=>t.vertices[0].x));t.push([Math.min(...e.concat(this._range)),this._position]),t.push([Math.max(...e.concat(this._range)),this._position])}else if("y"==this._channel||"height"==this._channel){let e=this._ticks.children.map((t=>t.vertices[0].y));t.push([this._position,Math.min(...e.concat(this._range))]),t.push([this._position,Math.max(...e.concat(this._range))])}this._path._setVertices(t),this._path._updateBounds(),this._showTitle&&this._title&&this._positionTitle(),this._updateBounds()}_positionLabels(){if(void 0===this._position&&this._computePosition(),"x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let t="bottom"==this._orientation?this._tickSize:-this._tickSize,e="bottom"==this._orientation?["center","top"]:["center","bottom"];if("area"==this._item.type&&"width"==this._channel){let t=getClosestLayout(this._item);if(t){let e=t.type==LayoutType.Stack?t._horzCellAlignment==Alignment.Left:t._cellHorzAlignment==Alignment.Left;this._flip=!e}else{let t=this._item.baseline==Alignment.Left||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!t}}if(this._flip)for(let[i,s]of this._labels.children.entries())s.x=this._range[1]-this.encoding.scale.map(this._labelValues[i]),s.y=this._position+t,s.anchor=e,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",e[1]]);else if(this.encoding.invertScale)for(let[i,s]of this._labels.children.entries())s.x=this._range[0]+this.encoding.scale.map(this._labelValues[i]),s.y=this._position+t,s.anchor=e,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",e[1]]);else for(let[i,s]of this._labels.children.entries())s.x=this._range[0]+this.encoding.scale.map(this._labelValues[i])-this.encoding.scale.range[0],s.y=this._position+t,s.anchor=e,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",e[1]])}else if("y"==this._channel||"height"==this._channel){let t="left"==this._orientation?-this._tickSize:this._tickSize,e="left"==this._orientation?["right","middle"]:["left","middle"];if("area"==this._item.type&&"height"==this._channel){let t=getClosestLayout(this._item);if("height"==this._channel&&t){let e=t.type==LayoutType.Stack?t._vertCellAlignment==Alignment.Bottom:t._cellVertAlignment==Alignment.Bottom;this._flip=!e}else{let t=this._item.baseline==Alignment.Bottom||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!t}}if(this._flip)for(let[i,s]of this._labels.children.entries())s.x=this._position+t,s.y=this._range[1]+this.encoding.scale.map(this._labelValues[i]),s.anchor=e;else if(this.encoding.invertScale)for(let[i,s]of this._labels.children.entries())s.x=this._position+t,s.y=this._range[1]-this.encoding.scale.map(this._labelValues[i])+this.encoding.scale.range[0],s.anchor=e;else for(let[i,s]of this._labels.children.entries())s.x=this._position+t,s.y=this._range[0]-this.encoding.scale.map(this._labelValues[i])+this.encoding.scale.range[0],s.anchor=e}this._labels._updateBounds(),this._updateBounds()}_computePosition(){let t;this._item.type==ItemType.Area&&(t=getCellBoundsInGridLayout(this._item)),void 0===t&&(t=getTopLevelGroup(this._item).bounds),"x"==this._channel||"width"==this._channel?this._position="top"==this._orientation?t.top-this._tickSize:t.bottom+this._tickSize:"y"!=this._channel&&"height"!=this._channel||(this._position="left"==this._orientation?t.left-this._tickSize:t.right+this._tickSize)}_positionTicks(){if(void 0===this._position&&this._computePosition(),this._range=this.encoding.getScaleRange(this._item),"x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let t="bottom"==this._orientation?this._tickSize:-this._tickSize;if("area"==this._item.type&&"width"==this._channel){let t=getClosestLayout(this._item);if(t){let e=t.type==LayoutType.Stack?t._horzCellAlignment==Alignment.Left:t._cellHorzAlignment==Alignment.Left;this._flip=!e}else{let t=this._item.baseline==Alignment.Left||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!t}}if(this._flip)for(let[e,i]of this._ticks.children.entries())i._setVertices([[this._range[1]-this.encoding.scale.map(this._tickValues[e]),this._position],[this._range[1]-this.encoding.scale.map(this._tickValues[e]),this._position+t]]),i._updateBounds();else if(this.encoding.invertScale)for(let[e,i]of this._ticks.children.entries())i._setVertices([[this._range[0]+this.encoding.scale.map(this._tickValues[e]),this._position],[this._range[0]+this.encoding.scale.map(this._tickValues[e]),this._position+t]]),i._updateBounds();else for(let[e,i]of this._ticks.children.entries())i._setVertices([[this._range[0]+this.encoding.scale.map(this._tickValues[e])-this.encoding.scale.range[0],this._position],[this._range[0]+this.encoding.scale.map(this._tickValues[e])-this.encoding.scale.range[0],this._position+t]]),i._updateBounds()}else if("y"==this._channel||"height"==this._channel){let t="left"==this._orientation?-this._tickSize:this._tickSize;if("area"==this._item.type&&"height"==this._channel){let t=getClosestLayout(this._item);if("height"==this._channel&&t){let e=t.type==LayoutType.Stack?t._vertCellAlignment==Alignment.Bottom:t._cellVertAlignment==Alignment.Bottom;this._flip=!e}else{let t=this._item.baseline==Alignment.Bottom||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!t}}if(this._flip)for(let[e,i]of this._ticks.children.entries())i._setVertices([[this._position+t,this._range[1]+this.encoding.scale.map(this._tickValues[e])],[this._position,this._range[1]+this.encoding.scale.map(this._tickValues[e])]]),i._updateBounds();else if(this.encoding.invertScale)for(let[e,i]of this._ticks.children.entries()){let s=this._range[1]-this.encoding.scale.map(this._tickValues[e])+this.encoding.scale.range[0];i._setVertices([[this._position+t,s],[this._position,s]]),i._updateBounds()}else for(let[e,i]of this._ticks.children.entries())i._setVertices([[this._position+t,this._range[0]-this.encoding.scale.map(this._tickValues[e])+this.encoding.scale.range[0]],[this._position,this._range[0]-this.encoding.scale.map(this._tickValues[e])+this.encoding.scale.range[0]]]),i._updateBounds()}this._positionPath(),this._ticks._updateBounds(),this._updateBounds()}_positionTitle(){let t=this._path.bounds;this._title.achor=this._titleAnchor,this._titlePosition?(this._title.x=this._titlePosition[0],this._title.y=this._titlePosition[1],"y"!=this._channel&&"height"!=this._channel||this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])):"x"==this._channel||"width"==this._channel?(this._title.x=t.x,this._title.y="top"==this._orientation?t.top-this._titleOffset:t.bottom+this._titleOffset):(this._title.x="left"==this._orientation?t.left-this._titleOffset:t.right+this._titleOffset,this._title.y=t.y,this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])),this._title._updateBounds(),this._updateBounds()}}class LayoutAxis extends Axis{constructor(t,e,i,s,a){super(a),this._channel=i,this._position="x"==this._channel||"width"==this._channel?a.y:a.x,this._item=t[0],this._items=t,this._layout=e,this._field=s,this._titleText="title"in a?a.title:this._field,this._showTitle="showTitle"in a&&a.showTitle,"labelRotation"in a&&(this._labelRotation=a.labelRotation),this._ticks=new Group,this._ticks.id=this.id+"ticks",this.addChild(this._ticks),this._labels=new Group,this._labels.id=this.id+"labels",this.addChild(this._labels),this._rules=new Group,this._rules.id=this.id+"paths",this.addChild(this._rules),this._generatePath(),this._generateTicks(),this._generateLabels(),this._positionPath(),this._positionTicks(),this._positionLabels(),this._showTitle&&(this._generateTitle(),this._positionTitle())}toJSON(){let t=super.toJSON();return t.item=this._item.id,"x"==this._channel||"width"==this._channel?t.args.y=this._position:t.args.x=this._position,this.classId&&(t.classId=this.classId),t}_updateBounds(){this._bounds=this._rules.bounds,this._bounds=this._bounds.union(this._ticks.bounds),this._bounds=this._bounds.union(this._labels.bounds),this._showTitle&&(this._bounds=this._bounds.union(this._title.bounds))}_generatePath(){if(this._rules.removeAll(),this._layout.type==LayoutType.Grid){let t="x"==this._channel?this._layout.numRows:this._layout.numCols;for(let e=0;e<t;e++){let t=new Path({strokeColor:this._strokeColor});this._pathVisible||(t.visibility="hidden"),t.type=ItemType.Line,t.id=this.id+"rule"+e,this._rules.addChild(t)}}}_generateTicks(){this._ticks.removeAll();for(let t=0;t<this._layout.group.children.length;t++){let e=new Path({strokeColor:this._strokeColor});this._tickVisible||(e.visibility="hidden"),e.type=ItemType.Line,e.id=this.id+"tick"+t,this._ticks.addChild(e)}}_generateLabels(){let t;switch(this._labels.removeAll(),this._item.dataScope.getFieldType(this._field)){case DataType.Date:t=d3__namespace.timeFormat(this._labelFormat);break;case DataType.String:t=function(t){return t};break;default:t=d3__namespace.format(this._labelFormat)}let e=this._layout.cellBounds;for(let i=0;i<e.length;i++){let e=new PointText({fillColor:this._textColor,text:t(this._items[i].dataScope.getFieldValue(this._field))});e.id=this.id+"label"+i,this._labels.addChild(e)}}_positionPath(){if(this._layout.type==LayoutType.Grid){let t=this._layout.cellBounds,e="x"==this._channel?this._layout.numRows:this._layout.numCols;if("x"==this._channel){let i=t[0].left,s=this._layout.numCols;for(let a=0;a<e;a++)this._rules.children[a]._setVertices([[i,this._position?this._position:t[a*s][this._orientation]],[i+t[0].width*s+this._layout.colGap*(s-1),this._position?this._position:t[a*s][this._orientation]]])}else{let i=t[0].top,s=this._layout.numRows;for(let a=0;a<e;a++)this._rules.children[a]._setVertices([[this._position?this._position:t[a*s][this._orientation],i],[this._position?this._position:t[a*s][this._orientation],i+t[0].height*s+this._layout.rowGap*(s-1)]])}}this._rules._updateBounds(),this._updateBounds()}_positionTicks(){let t=this._layout.cellBounds;if("x"==this._channel){let e="bottom"==this._orientation?1:-1;for(let[i,s]of this._ticks.children.entries()){let a=this._position?this._position+this._tickOffset*e:t[i][this._orientation]+this._tickOffset*e;s._setVertices([[t[i].x,a],[t[i].x,a+e*this._tickSize]]),s._updateBounds()}}else if("y"==this._channel){let e="left"==this._orientation?-1:1;for(let[i,s]of this._ticks.children.entries()){let a=this._position?this._position+this._tickOffset*e:t[i][this._orientation]+this._tickOffset*e,n="middle"==this._tickAnchor?t[i].y:t[i][this._tickAnchor];s._setVertices([[a,n],[a+e*this._tickSize,n]]),s._updateBounds()}}this._ticks._updateBounds(),this._updateBounds()}_positionLabels(){let t=this._layout.cellBounds;if("x"==this._channel){let e="bottom"==this._orientation?["center","top"]:["center","bottom"],i="bottom"==this._orientation?this._labelOffset:-this._labelOffset;for(let[s,a]of this._labels.children.entries())a.x=t[s].x,a.y=this._position?this._position+i:t[s][this._orientation]+i,a.anchor=e,this._labelRotation&&(a._rotate=[this._labelRotation,a.x,a.y],a.anchor=["right",e[1]])}else if("y"==this._channel){let e="left"==this._orientation?["right","middle"]:["left","middle"],i="left"==this._orientation?-this._labelOffset:this._labelOffset;for(let[s,a]of this._labels.children.entries())a.x=this._position?this._position+i:t[s][this._orientation]+i,a.y="middle"==this._tickAnchor?t[s].y:t[s][this._tickAnchor],a.anchor=e,this._labelRotation&&(a._rotate=[this._labelRotation,a.x,a.y])}this._labels._updateBounds(),this._updateBounds()}_positionTitle(){let t=this._rules.bounds;this._title.achor=this._titleAnchor,this._titlePosition?(this._title.x=this._titlePosition[0],this._title.y=this._titlePosition[1],"y"!=this._channel&&"height"!=this._channel||this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])):"x"==this._channel?(this._title.x=t.x,this._title.y="top"==this._orientation?t.top-this._titleOffset:t.bottom+this._titleOffset):(this._title.x="left"==this._orientation?t.left-this._titleOffset:t.right+this._titleOffset,this._title.y=t.y,this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])),this._title._updateBounds(),this._updateBounds()}}class Legend extends Group{constructor(t,e){super(),this.type=ItemType.Legend,this.id=this.type+ItemCounter[this.type]++,this.encoding=t,this._textColor="textColor"in e?e.textColor:"#555",this._strokeColor="strokeColor"in e?e.strokeColor:"#555",this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this._orientation="orientation"in e?e.orientation:Orientation.Vertical,this._initialize()}toJSON(){let t=super.toJSON();return"args"in t||(t.args={}),t.args.textColor=this._textColor,t.channel=this.encoding.channel,t.field=this.encoding.field,t.args.strokeColor=this._strokeColor,t.args.x=this._x,t.args.y=this._y,t.args.orientation=this._orientation,t}_initialize(){let t=this.encoding.scene,e=this.encoding.field;switch(this.encoding.datatable.getFieldType(e)){case DataType.String:this._createCategoricalColorLegend(t,e);break;case DataType.Number:case DataType.Integer:this._createNumericalColorLegend(t,e)}}_createNumericalColorLegend(t,e){let i,s;this._orientation==Orientation.Vertical?(i=15,s=300):(i=300,s=15);let a=t.mark("text",{fillColor:this._textColor,text:e,x:this._x+i/2,y:this._y,anchor:["center","middle"]});this.addChild(a);let n,r=t.mark("rect",{top:this._y+20,left:this._x,width:i,height:s,strokeWidth:0,opacity:this.encoding.anyItem.opacity}),l=[Math.min(...this.encoding.data),Math.max(...this.encoding.data)],o=this.encoding.mapping,h=[],d=[];if(o){let e=Object.keys(o).map((t=>parseFloat(t))).sort(((t,e)=>t-e));this._orientation==Orientation.Vertical?(n=new LinearGradient({x1:0,y1:100,x2:0,y2:0}),e.forEach((e=>{let a=(e-l[0])/(l[1]-l[0]);n.addStop(100*a,o[e],1);let r=t.mark("line",{x1:this._x-5,x2:this._x+i+5,y1:this._y+20+s-a*s,y2:this._y+20+s-a*s,strokeColor:this._strokeColor});d.push(r);let c=t.mark("text",{fillColor:this._textColor,text:e,x:this._x+i+5+5,y:this._y+20+s-a*s,anchor:["left","middle"]});h.push(c)}))):(n=new LinearGradient({x1:0,y1:0,x2:100,y2:0}),e.forEach((e=>{let a=(e-l[0])/(l[1]-l[0]);n.addStop(100*a,o[e],1);let r=t.mark("line",{x1:this._x+a*i,x2:this._x+a*i,y1:this._y+20-5,y2:this._y+20+s+5,strokeColor:this._strokeColor});d.push(r);let c=t.mark("text",{fillColor:this._textColor,text:e,x:this._x+a*i,y:this._y+s+5+20,anchor:["center","top"]});h.push(c)})))}else{let e=this.encoding.scale.domain,a=[];for(let t=0;t<11;t++)a.push(e[0]+(e[1]-e[0])*t/10);this._orientation==Orientation.Vertical?(n=new LinearGradient({x1:0,y1:100,x2:0,y2:0}),a.forEach((a=>{let r=(a-e[0])/(e[1]-e[0]);n.addStop(100*r,this.encoding.scale.map(a),1);let l=t.mark("line",{x1:this._x-5,x2:this._x+i+5,y1:this._y+20+s-r*s,y2:this._y+20+s-r*s,strokeColor:this._strokeColor});d.push(l);let o=t.mark("text",{fillColor:this._textColor,text:a,x:this._x+i+5+5,y:this._y+20+s-r*s,anchor:["left","middle"]});h.push(o)}))):(n=new LinearGradient({x1:0,y1:0,x2:100,y2:0}),a.forEach((a=>{let r=(a-e[0])/(e[1]-e[0]);n.addStop(100*r,this.encoding.scale.map(a),1);let l=t.mark("line",{x1:this._x+r*i,x2:this._x+r*i,y1:this._y+20-5,y2:this._y+20+s+5,strokeColor:this._strokeColor});d.push(l);let o=t.mark("text",{fillColor:this._textColor,text:a,x:this._x+r*i,y:this._y+s+5+20,anchor:["center","top"]});h.push(o)})))}r.styles.fillColor=n,this.addChild(r);for(let t of h)this.addChild(t);for(let t of d)this.addChild(t)}_createCategoricalColorLegend(t,e){this.addChild(new PointText({fillColor:this._textColor,text:e,x:this._x,y:this._y,anchor:["left","top"]}));let i=t.mark("rect",{top:this._y+25,left:this._x,width:10,height:10,strokeWidth:0,opacity:this.encoding.anyItem.opacity}),s=t.mark("text",{fillColor:this._textColor,x:this._x+20,y:this._y+23,anchor:["left","top"]}),a=t.glyph(i,s),n=this.encoding.scale,r=new DataTable(n.domain.map((t=>({category:t,value:n.map(t)})))),l=t.repeat(a,r);l.layout=layout("grid",{numCols:1,rowGap:8}),t.encode(s,{channel:"text",field:"category",_remember:!1}),t.encode(i,{channel:"fillColor",field:"category",_remember:!1,scale:n}),this.addChild(l)}}class Glyph extends Group{constructor(t){if(super(),this.type=ItemType.Glyph,this.id=this.type+ItemCounter[this.type]++,t)for(let e of t)this.addChild(e)}duplicate(){let t=this.getScene().glyph();for(let e of this.children)t.addChild(e.duplicate());return t.classId=this.classId,this._dataScope&&(t.dataScope=this._dataScope.clone()),t}}class PiePath extends Path{constructor(t){super(t),this.radius="radius"in t?t.radius:100,this._x="x"in t?t.x:0,this._y="y"in t?t.y:0,this.startAngleDeg="startAngle"in t?t.startAngle%360:0,this.endAngleDeg="endAngle"in t?t.endAngle%360:90,this.totalAng=this.endAngleDeg<this.startAngleDeg?this.endAngleDeg+360-this.startAngleDeg:this.endAngleDeg-this.startAngleDeg,this.startAngleRad=this.startAngleDeg*(Math.PI/180),this.endAngleRad=this.endAngleDeg*(Math.PI/180),this.type=ItemType.Pie,this.closed=!0;let e=[this._x,this._y],i=[this._x+this.radius*Math.cos(this.startAngleRad),this._y-this.radius*Math.sin(this.startAngleRad)],s=[this._x+this.radius*Math.cos(this.endAngleRad),this._y-this.radius*Math.sin(this.endAngleRad)];this._setVertices(new Array(e,i,s))}get x(){return this._x}get y(){return this._y}set x(t){this._x=t,this._updateBounds()}set y(t){this._y=t,this._updateBounds()}get quadrants(){let t=[];return this.startAngleDeg>=0&&this.startAngleDeg<90?t[0]=1:this.startAngleDeg>=90&&this.startAngleDeg<180?t[0]=2:this.startAngleDeg>=180&&this.startAngleDeg<270?t[0]=3:this.startAngleDeg>=270&&this.startAngleDeg<=360&&(t[0]=4),this.endAngleDeg>=0&&this.endAngleDeg<90?t[1]=1:this.endAngleDeg>=90&&this.endAngleDeg<180?t[1]=2:this.endAngleDeg>=180&&this.endAngleDeg<270?t[1]=3:this.endAngleDeg>=270&&this.endAngleDeg<360&&(t[1]=4),t}getSVGPathData(){let[[t,e],[i,s],[a,n]]=this.vertices.map((t=>[t.x,t.y])),r=this.radius;return`M ${t} ${e} L ${i} ${s} A ${r} ${r} ${this.totalAng} ${this.totalAng>180?1:0} 0 ${a} ${n} Z`}adjustAngle(t,e){this.startAngleDeg=t%360,this.endAngleDeg=e%360,this.startAngleRad=this.startAngleDeg*(Math.PI/180),this.endAngleRad=this.endAngleDeg*(Math.PI/180),this.totalAng=this.endAngleDeg-this.startAngleDeg,this.vertices[1].x=this.x+this.radius*Math.cos(this.startAngleRad),this.vertices[1].y=this.y-this.radius*Math.sin(this.startAngleRad),this.vertices[2].x=this.x+this.radius*Math.cos(this.endAngleRad),this.vertices[2].y=this.y-this.radius*Math.sin(this.endAngleRad)}_updateBounds(){const[t,e]=this.quadrants,i=this.vertices[1],s=this.vertices[2];let a=this.vertices[0],n=a.y,r=a.x,l=a.x,o=a.y;1===t?(i.x>r&&(r=i.x),i.y<n&&(n=i.y)):2===t?(i.x>r&&(r=i.x),i.y>o&&(o=i.y)):3===t?(i.x<l&&(l=i.x),i.y>o&&(o=i.y)):(i.x<l&&(l=i.x),i.y<n&&(n=i.y)),1===e?(s.x>r&&(r=s.x),s.y<n&&(n=s.y)):2===e?(s.x>r&&(r=s.x),s.y>o&&(o=s.y)):3===e?(s.x<l&&(l=s.x),s.y>o&&(o=s.y)):(s.x<l&&(l=s.x),s.y<n&&(n=s.y)),a.y-this.radius<n&&(n=a.y-this.radius),a.y+this.radius>o&&(o=a.y+this.radius),a.x+this.radius>r&&(r=a.x+this.radius),a.x-this.radius<l&&(l=a.x-this.radius),this._bounds=new Rectangle(l,n,r-l,o-n)}}class AreaPath extends Path{constructor(t){super(t),this.type=ItemType.Area,this.closed=!0,t&&"vertices"in t&&this.segments.push(new Segment(this.vertices[this.vertices.length-1],this.vertices[0],this,this.segmentCounter++))}get orientation(){return this._orientation}get firstVertexPair(){return[this.vertices[0],this.vertices[this.vertices.length-1]]}get width(){return this.vertices[this.vertices.length/2].x-this.vertices[0].x}get height(){return this.vertices[this.vertices.length/2].y-this.vertices[0].y}get left(){return this.vertices[0].x}get top(){return this.vertices[0].y}resizeArea(t,e){let i=this.vertices[this.vertices.length/2].x,s=this.vertices[this.vertices.length/2].y,a=this.width,n=this.height;for(let r of this.vertices)r.x=i+t/a*(r.x-i),r.y=s+e/n*(r.y-s);this._updateBounds()}getSVGPathData(){return super.getSVGPathData()+" z"}}class RingPath extends Path{constructor(t){super(t),this.type=ItemType.Ring,this.closed=!0,this._x=t.hasOwnProperty("x")?t.x:0,this._y=t.hasOwnProperty("y")?t.y:0,this._innerRadius=t.hasOwnProperty("innerRadius")?t.innerRadius:100,this._outerRadius=t.hasOwnProperty("outerRadius")?t.outerRadius:200}get innerRadius(){return this._innerRadius}set innerRadius(t){this._innerRadius=t}get outerRadius(){return this._outerRadius}set outerRadius(t){this._outerRadius=t,this._updateBounds()}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(t){this._x=t,this._updateBounds()}set y(t){this._y=t,this._updateBounds()}translate(t,e){this._x+=t,this._y+=e,this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this._x-this._outerRadius,this._y-this._outerRadius,2*this._outerRadius,2*this._outerRadius)}copyPropertiesTo(t){super.copyPropertiesTo(t),t._x=this._x,t._y=this._y,t._innerRadius=this._innerRadius,t._outerRadius=this._outerRadius}getSVGPathData(){return["M "+this._x+" "+this._y,"m 0, -"+this._outerRadius,"a "+this._outerRadius+","+this._outerRadius+", 0, 1, 0, 1, 0","Z","m 0 "+(this._outerRadius-this._innerRadius),"a "+this._innerRadius+", "+this._innerRadius+", 0, 1, 1, -1, 0","Z"].join(" ")}}class PolygonPath extends Path{constructor(t){super(t),this.type=ItemType.Polygon,this.closed=!0,t.hasOwnProperty("x")&&(this._x=t.x),t.hasOwnProperty("y")&&(this._y=t.y),t.hasOwnProperty("radius")&&(this._radius=t.radius)}get radius(){return this._radius}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(t){this._x=t,this._updateBounds()}set y(t){this._y=t,this._updateBounds()}set radius(t){this._radius=t,this._updateBounds()}copyPropertiesTo(t){super.copyPropertiesTo(t),t._x=this._x,t._y=this._y,t._radius=this._radius}translate(t,e){this._x+=t,this._y+=e,super.translate(t,e)}}class AlignConstraint{constructor(t,e){this.direction=e,this.items=t,this.type=ConstraintType.Align,this.id=this.type+"_"+[...new Set(this.items.map((t=>t.classId)))].join("_")}apply(){let t,e=this.direction;this.direction==Alignment.Top||this.direction==Alignment.Left?t=Math.min(...this.items.map((t=>t.bounds[e]))):this.direction!=Alignment.Bottom&&this.direction!=Alignment.Right||(t=Math.max(...this.items.map((t=>t.bounds[e]))));let i=this.items.map((i=>t-i.bounds[e])),s=e==Alignment.TOP||e==Alignment.Middle||e==Alignment.Bottom?"y":"x";this.items.forEach(((t,e)=>{if(t.parent&&t.parent.layout&&t.parent.layout.type==LayoutType.Stack){let a="x"==s?i[e]:0,n="y"==s?i[e]:0;t.parent.translate(a,n)}else{let a="x"==s?i[e]:0,n="y"==s?i[e]:0;t.translate(a,n)}}))}toJSON(){let t={};return t.items=this.items.map((t=>t.id)),t.direction=this.direction,t.type=this.type,t.id=this.id,t}}class AffixConstraint{constructor(t,e,i,s,a,n,r){this.item=t,this.baseItem=e,this.scene=i,this.channel=s,this.itemAnchor=a,this.baseAnchor=n,this.offset=r,this.type=ConstraintType.Affix,this.id=this.type+"_"+this.item.classId+"_"+this.baseItem.classId+"_"+s}apply(){let t=getPeers(this.item,this.scene),e=getPeers(this.baseItem,this.scene),i=this.itemAnchor,s=this.baseAnchor,a=this.item.type==ItemType.PointText;if("radialDistance"==this.channel)for(let a=0;a<t.length;a++){let n,r=e[a],l=t[a];r.type!=ItemType.Arc&&r.type!=ItemType.Ring||(n="top"==s?r.outerRadius+this.offset:"bottom"==s?r.innerRadius+this.offset:(r.outerRadius+r.innerRadius)/2+this.offset),l.translate(r.x-l.x,r.y-n-l.bounds[i]),l._rotate?l._rotate=[l._rotate[0],r.x,r.y]:l._rotate=[0,r.x,r.y]}else if("angle"==this.channel)for(let a=0;a<t.length;a++){let n=e[a],r=t[a],l="left"==s?n.endAngle+this.offset:"center"==s?(n.endAngle+n.startAngle)/2+this.offset:n.startAngle+this.offset;r._rotate?r._rotate[0]=90-l:(r.translate(n.x-r.bounds[i],n.y-t[a].y),r._rotate=[90-l,e[a].x,e[a].y])}else{let n;if(this.baseItem.type==ItemType.Link)switch(s){case"left":case"top":n=0;break;case"center":case"middle":n=.5;break;case"right":case"bottom":n=1}for(let r=0;r<t.length;r++){let l=this.baseItem.type==ItemType.Link?e[r].getPointAt(n)[this.channel]:e[r].bounds[s]+this.offset;a?(t[r].anchor["x"==this.channel?0:1]=this.itemAnchor,t[r][this.channel]=l):"x"==this.channel?t[r].translate(l-t[r].bounds[i],0):t[r].translate(0,l-t[r].bounds[i])}}}toJSON(){let t={};return t.item=this.item.id,t.baseItem=this.baseItem.id,t.channel=this.channel,t.itemAnchor=this.itemAnchor,t.baseAnchor=this.baseAnchor,t.offset=this.offset,t.type="affixation",t.id=this.id,t}}class Gridlines extends Group{constructor(t,e,i){super(),this.type=ItemType.Gridlines,this.id=this.type+ItemCounter[this.type]++,this.encoding=t,this.channel=this.encoding.channel,this._item=e,this._strokeColor=i.hasOwnProperty("strokeColor")?i.strokeColor:"#ddd",this._strokeWidth=i.hasOwnProperty("strokeWidth")?i.strokeWidth:1,"radialDistance"==this.channel&&i.hasOwnProperty("angle")&&(this._rotate=[-i.angle,this.encoding.x,this.encoding.y])}toJSON(){let t=super.toJSON();return t.hasOwnProperty("args")||(t.args={}),t.args.strokeColor=this._strokeColor,t.args.strokeWidth=this._strokeWidth,t.channel=this.encoding.channel,t.field=this.encoding.field,this._rotate&&(t.args.angle=this._rotate[0]),t}get values(){return this._values}set values(t){this._values=t,this._updateLines(),this._updateLinePositions()}_updateLinePositions(){if("x"==this.channel||"width"==this.channel){let t=getTopLevelGroup(this._item).bounds,e=this.encoding.getScaleRange(this._item);for(let[i,s]of this.children.entries()){let a=e[0]+this.encoding.scale.map(this._values[i])-this.encoding.scale.range[0];s._setVertices([[a,t.top],[a,t.bottom]])}}else if("y"==this.channel||"height"==this.channel){let t=getTopLevelGroup(this._item).bounds,e=this.encoding.getScaleRange(this._item);if(this.encoding.invertScale)for(let[i,s]of this.children.entries()){let a=e[1]-this.encoding.scale.map(this._values[i])+this.encoding.scale.range[0];s._setVertices([[t.left,a],[t.right,a]])}else for(let[i,s]of this.children.entries()){let a=e[0]-this.encoding.scale.map(this._values[i])+this.encoding.scale.range[0];s._setVertices([[t.left,a],[t.right,a]])}}else if("radialDistance"==this.channel)for(let[t,e]of this.children.entries())e.x=this._item.parent.x,e.y=this._item.parent.y,e.radius=this.encoding.scale.map(this._values[t])}_updateLines(){if(this.children=[],"x"==this.channel||"y"==this.channel||"width"==this.channel||"height"==this.channel)for(let[t,e]of this._values.entries()){let e=new Path({strokeColor:this._strokeColor,fillColor:"none",strokeWidth:this._strokeWidth});e.type=ItemType.Line,e.id=this.id+"line"+t,this.addChild(e)}else if("radialDistance"==this.channel)for(let[t,e]of this._values.entries()){let e=new CirclePath({strokeColor:this._strokeColor,fillColor:"none",strokeWidth:this._strokeWidth});e.type=ItemType.Circle,e.id=this.id+"line"+t,this.addChild(e)}}}class Collection extends Group{constructor(){super(),this.type=ItemType.Collection,this.id=this.type+ItemCounter[this.type]++,this.classId=this.id}duplicate(){let t=this.getScene().collection();for(let e=0;e<this.children.length;e++){let i=this.children[e];t.addChild(i.duplicate())}if(t.classId=this.classId,t.parent=this.parent,this._layout){let e=this._layout.clone();t.layout=e}return t}}class ArcPath extends Path{constructor(t){super(t),this.type=ItemType.Arc,this.closed=!0,this._x=t.hasOwnProperty("x")?t.x:0,this._y=t.hasOwnProperty("y")?t.y:0,this._innerRadius=t.hasOwnProperty("innerRadius")?t.innerRadius:100,this._outerRadius=t.hasOwnProperty("outerRadius")?t.outerRadius:200,this._startAngle=t.hasOwnProperty("startAngle")?t.startAngle:0,this._endAngle=t.hasOwnProperty("endAngle")?t.endAngle:90,this._sr=degree2radian(this._startAngle),this._er=degree2radian(this._endAngle);let e=this._x+this._innerRadius*Math.cos(this._sr),i=this._y-this._innerRadius*Math.sin(this._sr),s=this._x+this._innerRadius*Math.cos(this._er),a=this._y-this._innerRadius*Math.sin(this._er),n=this._x+this._outerRadius*Math.cos(this._sr),r=this._y-this._outerRadius*Math.sin(this._sr),l=this._x+this._outerRadius*Math.cos(this._er),o=this._y-this._outerRadius*Math.sin(this._er);this._setVertices([[e,i],[n,r],[l,o],[s,a]])}get innerRadius(){return this._innerRadius}set innerRadius(t){this._innerRadius=t,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}get outerRadius(){return this._outerRadius}set outerRadius(t){this._outerRadius=t,this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this._updateBounds()}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(t){this._x=t,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this._updateBounds()}set y(t){this._y=t,this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}get startAngle(){return this._startAngle}get endAngle(){return this._endAngle}translate(t,e){this._x+=t,this._y+=e,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this._x-this._outerRadius,this._y-this._outerRadius,2*this._outerRadius,2*this._outerRadius)}copyPropertiesTo(t){super.copyPropertiesTo(t),t._x=this._x,t._y=this._y,t._innerRadius=this._innerRadius,t._outerRadius=this._outerRadius,t._startAngle=this._startAngle,t._endAngle=this._endAngle,t._sr=this._sr,t._er=this._er}getSVGPathData(){let t=this._endAngle<this._startAngle?this._endAngle+360-this._startAngle:this._endAngle-this._startAngle,e=t>180?1:0;return["M "+this.vertices[0].x+", "+this.vertices[0].y,"L "+this.vertices[1].x+", "+this.vertices[1].y,"A "+[this._outerRadius,this._outerRadius,t,e,0,this.vertices[2].x,this.vertices[2].y].join(" "),"L "+this.vertices[3].x+", "+this.vertices[3].y,"A "+[this._innerRadius,this._innerRadius,t,e,1,this.vertices[0].x,this.vertices[0].y].join(" ")].join(" ")}adjustAngle(t,e){this._startAngle=t,this._endAngle=e,this._sr=degree2radian(this._startAngle),this._er=degree2radian(this._endAngle),this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er)}}class Image extends Mark{constructor(t){super(t),this.type=ItemType.Image,this._src=t.src,this._x=t.hasOwnProperty("x")?t.x:0,this._y=t.hasOwnProperty("y")?t.y:0,this._width=t.hasOwnProperty("width")?t.width:100,this._height=t.hasOwnProperty("height")?t.height:100}get src(){return this._src}set src(t){this._src=t}get width(){return this._width}set width(t){this._width=t,this._updateBounds()}get height(){return this._height}set height(t){this._height=t,this._updateBounds()}get x(){return this._x}set x(t){this._x=t,this._updateBounds()}get y(){return this._y}set y(t){this._y=t,this._updateBounds()}get bounds(){return this._bounds||this._updateBounds(),this._bounds}_updateBounds(){this._bounds=new Rectangle(this._x,this._y,this._width,this._height)}copyPropertiesTo(t){t.attrs=Object.assign({},this.attrs),t.styles=Object.assign({},this.styles),this._dataScope&&(t._dataScope=this._dataScope.clone()),t.x=this._x,t.y=this._y,t.width=this._width,t.height=this._height,t.src=this._src}translate(t,e){this._x+=t,this._y+=e,this._updateBounds()}}class Link extends Path{constructor(t){super(t),this.type=ItemType.Link,this.mode="mode"in t?t.mode:"linear",this.source=void 0,this.target=void 0,this.sourceAnchor="sourceAnchor"in t?t.sourceAnchor:["center","middle"],this.targetAnchor="targetAnchor"in t?t.targetAnchor:["center","middle"],this.sourceOffset="sourceOffset"in t?t.sourceOffset:[0,0],this.targetOffset="targetOffset"in t?t.targetOffset:[0,0]}radialvalue(t,e){let i=t-Math.PI/2;return[t=e*Math.cos(i),e*=Math.sin(t)]}bezierCurveHorizontal(t,e,i,s){return`M ${t} ${e} C ${(t+i)/2} ${e} ${t} ${s} ${i} ${s}`}bezierCurveVertical(t,e,i,s){return`M ${t} ${e} C ${t} ${(e+s)/2} ${i} ${e} ${i} ${s}`}bezierCurveRadial(t,e,i,s){let a=this.radialvalue(t,e),n=this.radialvalue(t,(e+s)/2),r=this.radialvalue(i,e),l=this.radialvalue(i,s);return`M ${a[0]} ${a[1]} C ${n[0]} ${n[1]} ${r[0]} ${r[1]} ${l[0]} ${l[1]}`}_updateBounds(){if(null!=this.source&&null!=this.target){let t=this.source.bounds[this.sourceAnchor[0]]+this.sourceOffset[0],e=this.source.bounds[this.sourceAnchor[1]]+this.sourceOffset[1],i=this.target.bounds[this.targetAnchor[0]]+this.targetOffset[0],s=this.target.bounds[this.targetAnchor[1]]+this.targetOffset[1];this._bounds=new Rectangle(Math.min(t,i),Math.min(e,s),Math.abs(t-i),Math.abs(e-s))}else this._bounds=new Rectangle(0,0,0,0)}getSVGPathData(){if(void 0===this.source||void 0===this.target)return"";let t=this.source.bounds[this.sourceAnchor[0]]+this.sourceOffset[0],e=this.source.bounds[this.sourceAnchor[1]]+this.sourceOffset[1],i=this.target.bounds[this.targetAnchor[0]]+this.targetOffset[0],s=this.target.bounds[this.targetAnchor[1]]+this.targetOffset[1];switch(this.mode){case"curveHorizontal":return this.bezierCurveHorizontal(t,e,i,s);case"curveVertical":return this.bezierCurveVertical(t,e,i,s);case"linear":default:return`M ${t} ${e} L ${i} ${s}`}}copyPropertiesTo(t){super.copyPropertiesTo(t),t.sourceAnchor=this.sourceAnchor.slice(),t.targetAnchor=this.targetAnchor.slice(),t.sourceOffset=this.sourceOffset.slice(),t.targetOffset=this.targetOffset.slice(),t.mode=this.mode}getPointAt(t){const e=SVGProvider.getSVG();let i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",this.getSVGPathData()),e.appendChild(i);let s=i.getTotalLength();return i.getPointAtLength(s*t)}}function bindToLink(t){return t._query=function(){let t=this.field,e=this.channel,i=this.items.map((t=>t.dataScope));if("source"==e||"target"==e){let e=i.map((e=>e.getFieldValue(t))),s=this.scene;this.data=e.map((t=>s.find([{field:nodeId,value:t}])[0]))}else if("strokeWidth"==e)if(this.datatable.hasField(t))this.data=i.map((e=>e.getFieldValue(t)));else if(t.startsWith("parent.")||t.startsWith("child.")){let e=this.datatable.tree.nodeTable,s=t.split(".")[0],a=t.split(".")[1],n=i.map((t=>t.getFieldValue(s)));this.data=n.map((t=>new DataScope(e).cross(nodeId,t).getFieldValue(a)))}},t._map=function(){let t,e=this.channel,i=this.items;if("strokeWidth"==e){let e,s;t=createScale(this.scaleType?this.scaleType:"linear"),t.domain=[0,Math.max(...this.data)],e=1,s=Math.max(...i.map((t=>parseFloat(t.styles.strokeWidth)))),s==e&&(s=e+5),this.rangeExtent&&(s=e+this.rangeExtent),this.range&&(e=this.range[0],s=this.range[1]),t._setRange([e,s]),this.scale||(this.scale=t),this.scale._addEncoding(this)}},t._apply=function(){let t=this.channel;if("source"==t||"target"==t)for(let t=0;t<this.data.length;t++)this.items[t][this.channel]=this.data[t],this.items[t]._updateBounds();else if("strokeWidth"==t)for(let t=0;t<this.data.length;t++)this.items[t].styles.strokeWidth=this.scale.map(this.data[t])},t.run(),t}class Scene extends Group{constructor(t){super(),t&&t.fillColor&&(this.fillColor=t.fillColor),this.type=ItemType.Scene,this.id=this.type+ItemCounter[this.type]++,this.encodings={},this.constraints={},this.itemMap={}}group(t){let e=new Group;if(e.classId=e.id,this.addChild(e),t&&t.length>0)for(let i of t)e.addChild(i);return this.itemMap[e.id]=e,e}mark(t,e){let i=void 0===e?{}:e,s=null;switch(t){case ItemType.Rect:{"top"in i||(i.top=0),"left"in i||(i.left=0),"width"in i||(i.width=100),"height"in i||(i.height=100);let t=i.top,e=i.left,a=i.width,n=i.height;i.vertices=[[e,t],[e+a,t],[e+a,t+n],[e,t+n]],delete i.top,delete i.left,delete i.width,delete i.height,s=new RectPath(i);break}case ItemType.Area:if(void 0!==i&&"x1"in i&&"y1"in i&&"x2"in i&&"y2"in i){let t=i.x1,e=i.y1,s=i.x2,a=i.y2;i.vertices=[[t,e],[s,e],[s,a],[t,a]],delete i.x1,delete i.y1,delete i.x2,delete i.y2}s=new AreaPath(i);break;case ItemType.Line:if(void 0!==i&&"x1"in i&&"y1"in i&&"x2"in i&&"y2"in i){let t=i.x1,e=i.y1,s=i.x2,a=i.y2;i.vertices=[[t,e],[s,a]],delete i.x1,delete i.y1,delete i.x2,delete i.y2}s=new Path(i),s.type=ItemType.Line;break;case ItemType.Path:s=new Path(i);break;case ItemType.Circle:s=new CirclePath(i);break;case ItemType.Ring:s=new RingPath(i);break;case ItemType.Arc:s=new ArcPath(i);break;case ItemType.Polygon:s=new PolygonPath(i);break;case ItemType.Pie:s=new PiePath(i);break;case"text":case ItemType.PointText:"anchor"in i||(i.anchor=["center","middle"]),s=new PointText(i);break;case ItemType.Image:s=new Image(i);break;case ItemType.Link:s=new Link(i)}return null!==s&&(s.id=s.type+ItemCounter[s.type]++,s.classId=s.id,this.addChild(s),this.itemMap[s.id]=s),s}glyph(...t){let e=new Glyph(t);return e.classId=e.id,this.addChild(e),this.itemMap[e.id]=e,e}collection(){let t=new Collection;return this.itemMap[t.id]=t,t}attach(t,e){t.dataScope=new DataScope(e)}repeat(t,e,i){if(!t||void 0===e)throw Errors.INCOMPLETE_REPEAT_INFO;let s=i||{},a=s.field?s.field:DataTable.RowID,n=s.callback;validateField(a,e);let r=repeatItem(this,t,a,e,n);return s.layout&&(r.layout=s.layout),r}densify(t,e,i){if(!t||void 0===e)throw Errors.INCOMPLETE_PARTITION_INFO;let s=i||{},a=s.orientation,n=s.field?s.field:DataTable.RowID,r="startAngle"in s?s.startAngle:90,l="direction"in s?s.direction:"clockwise",o=s.callback;return validateField(n,e),densifyItem(this,t,a,n,e,o,r,l)}divide(t,e,i){if(!t||null==e)throw Errors.INCOMPLETE_PARTITION_INFO;let s=i||{},a=s.orientation,n=s.field?s.field:DataTable.RowID,r=s.callback;validateField(n,e);let l=divideItem(this,t,a,n,e,r);return s.layout&&(l.layout=s.layout),l}_validateEncodeArgs(t,e){if(!t||!("channel"in e)||!("field"in e))throw Errors.INCOMPLETE_BINDING_INFO;let i=e.field;if("vertex"==t.type||"segment"==t.type){if(!t.parent.dataScope&&!t.dataScope)throw Errors.BIND_WITHOUT_DATASCOPE}else if(!t.dataScope)throw Errors.BIND_WITHOUT_DATASCOPE;validateField(i,e.table?e.table:t.dataScope?t.dataScope._dt:t.parent.dataScope._dt)}encode(t,e){let i;if(this._validateEncodeArgs(t,e),"vertex"==t.type&&t.parent.type==ItemType.Area){let e=getPeers(t.parent,this);i=[];let s=t.parent.vertices.indexOf(t)<t.parent.vertices.length/2;for(let t of e)i=s?i.concat(t.vertices.slice(0,t.vertices.length/2)):i.concat(t.vertices.slice(t.vertices.length/2))}else i=getPeers(t,this);return this._doEncode(i,e)}_doEncode(t,e){let i=t[0],s=e.channel,a=e.field;"datatable"in e||(e.datatable=i.dataScope?i.dataScope.dataTable:i.parent.dataScope.dataTable),"aggregator"in e||(e.aggregator="sum"),"invertScale"in e||(e.invertScale=!1),"includeZero"in e||(e.includeZero=!1);let n=new Encoding(t,this,s,a,e);switch(s){case"width":case"height":case"radius":case"outerRadius":case"innerRadius":case"area":case"fontSize":i.type==ItemType.Area?bindToArea(n):bindToSize(n);break;case"strokeWidth":i.type==ItemType.Link?bindToLink(n):bindToSize(n);break;case"x":case"y":i.type==ItemType.Area?bindToArea(n):bindToPosition(n);break;case"fillColor":case"strokeColor":bindToColor(n);break;case"angle":bindToAngle(n);break;case"text":bindToText(n);break;case"radialDistance":n.x=i.parent.x,n.y=i.parent.y,n.radius=i.parent.radius,bindToRadialDistance(n);break;case"source":case"target":bindToLink(n)}return"_remember"in e&&1!=e._remember||this._registerBinding(n),s.indexOf("Color")<0&&this._updateAncestorBounds(i,n.items),n}encodeWithinCollection(t,e){this._validateEncodeArgs(t,e);let i=getPeersGroupedByParent(t,this),s=[];for(let t of i){let i=this._doEncode(t,e);s.push(i)}return s}find(t){let e=[];for(let i of t)if("field"in i)"value"in i?e.push("d.dataScope && d.dataScope.getFieldValue('"+i.field+"') == '"+i.value+"'"):"range"in i?e.push("d.dataScope && d.dataScope.getFieldValue('"+i.field+"') >= "+i.range[0]+" && d.dataScope.getFieldValue('"+i.field+"') <= "+i.range[1]):"values"in i&&e.push("d.dataScope && ["+i.values.map((t=>"'"+t+"'")).join(",")+"].indexOf(d.dataScope.getFieldValue('"+i.field+"')) >= 0 ");else if("channel"in i)"value"in i?e.push("d."+i.channel+" == '"+i.value+"'"):"range"in i?e.push("d."+i.channel+" >= "+i.range[0]+" && d."+i.channel+" <= "+i.range[1]):"values"in i&&e.push("["+i.values.map((t=>"'"+t+"'")).join(",")+"].indexOf(d."+i.channel+") >= 0 ");else if("type"in i)e.push("d.type=='"+i.type+"'");else if("id"in i)e.push("d.id=='"+i.id+"'");else if("fields"in i){let t=i.fields[0],s=i.fields[1];e.push("d.dataScope && d.dataScope.getFieldValue('"+t+"')"+i.operator+"d.dataScope.getFieldValue('"+s+"')")}return findItems(this,new Function("d","return "+e.join(" && ")))}align(t,e){if(!canAlign(t,e,this))return!1;let i=new AlignConstraint(t,e);if(i.id in this.constraints)return console.warn("constraint has been added"),!1;this.constraints[i.id]=i,i.apply(),this._updateAncestorBounds(t[0])}affix(t,e,i,s){let a=s||{},n="offset"in a?a.offset:0,r="itemAnchor"in a?a.itemAnchor:"x"==i||"angle"==i?"center":"middle",l="baseAnchor"in a?a.baseAnchor:"x"==i||"angle"==i?"center":"middle",o=new AffixConstraint(t,e,this,i,r,l,n);o.id,this.constraints,this.constraints[o.id]=o,o.apply()}axis(t,e,i){let s=this.getEncodingByField(e,t),a=i||{};if(s){let t=new EncodingAxis(s,a.item?a.item:s.anyItem,a);return"tickValues"in a?(t.tickValues=a.tickValues,t.labelValues=a.tickValues):(t.tickValues=this._inferTickValues(s),t.labelValues=this._inferTickValues(s)),this.addChildAt(t,0),this.itemMap[t.id]=t,t}let n=findItems(this,(t=>t.dataScope&&t.dataScope.hasField(e)))[0];if(void 0===n)throw Errors.INCORRECT_AXIS_INFO+e;let r=getClosestLayout(n);if(!r||"x"!=t&&"y"!=t)throw Errors.INCORRECT_AXIS_INFO+e;{let i,s,n=getPeers(r.group,this);for(let r of n){let n=getPeers(findItems(r,(t=>t.dataScope&&t.dataScope.hasField(e)))[0],r);i=new LayoutAxis(n,r.layout,t,e,a),null==s&&(s=i.id),i.classId=s,this.addChildAt(i,0),this.itemMap[i.id]=i}return i}}legend(t,e,i){let s=i||{},a=this.getEncodingByField(e,t);if(!a)throw Errors.INCORRECT_LEGEND_INFO+e;"x"in s||(s.x=100),"y"in s||(s.y=100);let n=new Legend(a,s);this.addChild(n)}gridlines(t,e,i){let s=this.getEncodingByField(e,t),a=i||{};if(!s)return!1;let n=new Gridlines(s,s.anyItem,a);return n.values="values"in a?a.values:this._inferTickValues(s),this.addChildAt(n,0),n}_inferTickValues(t){let e,i=t.scale.domain,s=t.scale.range;switch(t.scale.type){case"linear":case"log":{let a=Math.abs(s[0]-s[1]);if("width"==t.channel||"height"==t.channel){let e=getClosestLayout(t.anyItem);if(e&&e.type==LayoutType.Stack){let s=getPeers(e.group,t.scene);a=Math.max(...s.map((e=>e.bounds[t.channel]))),i[1]=Math.ceil(t.scale.invert(a))}}e="width"==t.channel||"x"==t.channel?45:30;let n=Math.floor(a/e);return d3__namespace.ticks(i[0],i[1],n)}case"point":{e="width"==t.channel||"x"==t.channel?80:30;let s=Math.floor(t.scale.rangeExtent/i.length),a=Math.ceil(e/s);return"x"==t.channel?i.filter(((t,e)=>e%a==0)):i}case"time":{e="width"==t.channel||"x"==t.channel?80:30;let a,n,r=Math.floor((s[1]-s[0])/e),l=Math.ceil((i[1]-i[0])/r)/1e3,o=[1,60,3600,86400,2628003,31536e3],h=[d3__namespace.timeSeconds,d3__namespace.timeMinutes,d3__namespace.timeHours,d3__namespace.timeDays,d3__namespace.timeMonths,d3__namespace.timeYears];for(let t=0;t<o.length-1;t++)if(l>=o[t]&&l<o[t+1])return a=Math.floor(l/o[t]),n=h[t],n(i[0],i[1],a);return l>o[o.length-1]?(a=Math.floor(l/o[o.length-1]),n=h[o.length-1],n(i[0],i[1],a)):[]}default:return[]}}propagate(t,e,...i){let s=getPeers(t,this);for(let t of s)t[e](...i)}classify(t,e,i){let s,a={};for(let i of t){let t=i.dataScope.getFieldValue(e);t in a||(a[t]=[]),a[t].push(i)}let n=[],r=t[0].dataScope._dt;for(let t in a){let l=this.collection();i.addChild(l),void 0===s&&(s=l.id),l.classId=s,l.dataScope=new DataScope(r).cross(e,t);for(let e of a[t])l.addChild(e);n.push(l)}return n}getEncodingByItem(t,e){let i=this.encodings[getEncodingKey(t)];return i&&i[e]?i[e]:null}getEncodingByField(t,e){for(let i in this.encodings){let s=this.encodings[i];if(s[e]&&s[e].field==t)return s[e]}return null}positionBound(t,e){return!!this.getEncodingByItem(t,e)||!(!isMark(t)||!this.getEncodingByItem(t.vertices[0],e))}setProperties(t,e){if(Object.values(LayoutType).indexOf(t.type)>-1&&t.group){let i=getPeers(t.group,this);for(let t of i)for(let i in e)t.layout[i]=e[i]}else{let i=getPeers(t,this);if("vertex"==t.type)for(let t of i)for(let i in e)t[i]=e[i];else if(t instanceof Mark){for(let s in e){this.getEncodingByItem(t,s)?console.log(s+" is bound to data"):s in Style2SVG?i.forEach((t=>t.styles[s]=e[s])):i.forEach((t=>t[s]=e[s]))}("width"in e||"height"in e)&&this._relayoutAncestors(t,i)}else if("collection"==t.type)for(let t in e)i.forEach((i=>i[t]=e[t]))}}_updateAncestorBounds(t,e){let i=getParents(e||getPeers(t,this));for(;i.length>0;){for(let t of i)(t.children&&t.children.length>0||t.vertices)&&t._updateBounds();i=getParents(i)}}_relayoutAncestors(t,e){let i=getParents(e||getPeers(t,this));for(;i.length>0;){for(let t of i)t.layout&&t.layout.run(),t.children&&t.children.length>0&&t._updateBounds(),t.vertices&&t._updateBounds();i=getParents(i)}}updateAxes(t){for(let e of this.children){if(e.type!==ItemType.Axis)continue;if(t.classId===e._item.classId){e.reposition();continue}let i=e._item,s=!1;for(;i.children&&i.children.length>0;){for(let a of i.children)if(a.classId===t.classId){e.reposition(),s=!0;break}if(s)break;i=i.children[0]}}}_reapplySizeBindings(t){let e=["width","height"];for(let i in this.encodings){if(t.classId!=i)continue;let s=this.encodings[i],a=findItems(this,(t=>t.classId==i));for(let t of e){let e=s[t];e&&e.run()}this._relayoutAncestors(a[0],a)}}_registerBinding(t){let e=this.encodings,i=getEncodingKey(t.anyItem);return i in e||(e[i]={}),e[i][t.channel]=t,!0}toJSON(){let t=super.toJSON();this.fillColor&&(t.fillColor=this.fillColor);let e={};t.encodings=[];for(let i in this.encodings)for(let s in this.encodings[i]){let a=this.encodings[i][s];t.encodings.push(a.toJSON()),a.scale&&!(a.scale.id in e)&&(e[a.scale.id]=a.scale.toJSON())}t.scales=e,t.constraints={};for(let e in this.constraints)t.constraints[e]=this.constraints[e].toJSON();t.tables={};let i=this.getDataTables();for(let e in i)t.tables[e]=i[e].toJSON();return t}getDataTables(){let t={};for(let e in this.encodings)for(let i in this.encodings[e]){let s=this.encodings[e][i];s.datatable.id in t||(t[s.datatable.id]=s.datatable)}return t}getItem(t){return this.itemMap[t]}}class SVGRenderer{constructor(t){this._svgId=t,this._compMap={},this._decoMap={}}render(t,e){let i=e||{};this._renderItem(t,i)}clear(){let t=document.getElementById(this._svgId);for(;t.firstChild;)t.firstChild.remove();this._compMap={},this._decoMap={}}_renderItem(t,e){let i,s=t.id,a=t.parent;i=a&&a.id&&a.id in this._compMap?a.id:this._svgId,s in this._compMap||(this._compMap[s]=d3__namespace.select("#"+i).append(this._getSVGElementType(t)));let n=this._compMap[s];if(n.attr("id",s),t.type==ItemType.Scene&&d3__namespace.select("#"+this._svgId).style("background",t.fillColor?t.fillColor:"white"),"vertex"!=t.type){if(t.type==ItemType.Path||t.type==ItemType.Polygon||t.type==ItemType.Link)n.attr("d",t.getSVGPathData()),t.closed||n.style("fill","none"),0==s.indexOf("axis")&&n.style("shape-rendering","crispEdges");else if(t.type==ItemType.Line)n.attr("x1",t.vertices[0].x),n.attr("y1",t.vertices[0].y),n.attr("x2",t.vertices[1].x),n.attr("y2",t.vertices[1].y),0==s.indexOf("axis")&&n.style("shape-rendering","crispEdges");else if(t.type==ItemType.Circle)n.attr("cx",t.x),n.attr("cy",t.y),n.attr("r",t.radius);else if(t.type==ItemType.Rect){let e=t.bounds;n.attr("x",e.left).attr("y",e.top).attr("width",e.width).attr("height",e.height)}else t.type==ItemType.PointText?n.attr("text-anchor",this._getTextAnchor(t.anchor[0])).attr("alignment-baseline",this._getTextAnchor(t.anchor[1])).attr("dominant-baseline",this._getTextAnchor(t.anchor[1])).text(t.text).attr("x",t.x).attr("y",t.y):t.type==ItemType.Pie||t.type==ItemType.Area?(n.attr("d",t.getSVGPathData()),t.closed||n.style("fill","none"),0==s.indexOf("axis")&&n.style("shape-rendering","crispEdges")):t.type==ItemType.Ring||t.type==ItemType.Arc?n.attr("d",t.getSVGPathData()):t.type==ItemType.Image&&n.attr("href",t.src).attr("x",t.x).attr("y",t.y).attr("width",t.width).attr("height",t.height);for(let e in t.styles)if(void 0!==t.styles[e])if(e.indexOf("Color")>0&&t.styles[e].type==ItemType.LinearGradient){d3__namespace.select("#"+this._svgId).select("defs").empty()&&d3__namespace.select("#"+this._svgId).append("defs");let i=d3__namespace.select("defs"),s=t.styles[e];if(i.select("#"+s.id).empty()){let t=i.append("linearGradient").attr("id",s.id);t.attr("x1",s.x1+"%").attr("x2",s.x2+"%").attr("y1",s.y1+"%").attr("y2",s.y2+"%");for(let e of s.stops)t.append("stop").attr("offset",e.offset+"%").style("stop-color",e.color).style("stop-opacity",e.opacity)}n.style(Style2SVG[e],"url(#"+s.id+")")}else n.style(Style2SVG[e],t.styles[e]);if(t._rotate&&n.attr("transform","rotate("+t._rotate.join(" ")+")"),t.vertices){t.vertices.map((t=>t.shape)).filter((t=>void 0!==t)).length>0&&this._renderVertices(t)}if(t.type==ItemType.Collection&&e&&e.collectionBounds){let e=t.bounds;t.layout&&"grid"==t.layout.type?this._renderLayout(t):(t.id in this._decoMap||(this._decoMap[t.id]=d3__namespace.select("#"+this._svgId).append("rect").attr("class","deco")),this._decoMap[t.id].attr("x",e.left).attr("y",e.top).attr("width",e.width).attr("height",e.height).attr("fill","none").attr("stroke","#1ecb40").attr("stroke-width","1px").attr("stroke-dasharray","5,5"))}if(t.children)for(let i of t.children)this._renderItem(i,e)}}_renderVertices(t){let e=t.id+"-vertices";if(!(e in this._compMap)){let i=t.parent,s=i?i.id:this._svgId;this._compMap[e]=d3__namespace.select("#"+s).append("g").attr("id",e)}let i=t.vertices.filter((t=>void 0!==t.shape));for(let t of i){let i=e+"-"+t.id;i in this._compMap||(this._compMap[i]=d3__namespace.select("#"+e).append(t.shape).attr("id",i)),"rect"==t.shape?d3__namespace.select("#"+i).attr("x",t.x-t.width/2).attr("y",t.y-t.height/2).attr("width",t.width).attr("height",t.height):"circle"==t.shape&&d3__namespace.select("#"+i).attr("cx",t.x).attr("cy",t.y).attr("r",t.radius),d3__namespace.select("#"+i).style("fill",t.fillColor).style("opacity",t.opacity).style("stroke-width",t.strokeWidth).style("stroke",t.strokeColor)}}_renderLayout(t){let e=t.id+"-grid";e in this._decoMap||(this._decoMap[e]=d3__namespace.select("#"+this._svgId).append("g").attr("id",e).attr("class","deco"));let i=t.layout.cellBounds,s=t.layout.rowGap;this._decoMap[e].selectAll("rect").remove(),this._decoMap[e].selectAll("rect").data(i.slice(0,i.length-1)).enter().append("rect").attr("x",(t=>t.left)).attr("y",(t=>t.bottom)).attr("width",(t=>t.width)).attr("height",s).style("fill","pink").style("opacity",.5);let a=Math.min(...i.map((t=>t.left))),n=Math.min(...i.map((t=>t.top)));this._decoMap[e].append("rect").attr("x",a).attr("y",n).attr("width",t.bounds.width).attr("height",t.bounds.height).attr("stroke","#1ecb40").attr("stroke-width","1px").attr("stroke-dasharray","5,5").attr("fill","none")}_getTextAnchor(t){switch(t){case"top":return"text-before-edge";case"bottom":return"text-after-edge";case"left":return"start";case"right":return"end";case"center":case"middle":return"middle";default:return t}}_getSVGElementType(t){switch(t.type){case ItemType.Rect:return"rect";case ItemType.Collection:case ItemType.Group:case ItemType.Glyph:case ItemType.Scene:case ItemType.Axis:case ItemType.Legend:case ItemType.Gridlines:return"g";case ItemType.Area:case ItemType.Path:case ItemType.Polygon:case ItemType.Ring:case ItemType.Pie:case ItemType.Arc:case ItemType.Link:return"path";case ItemType.Circle:return"circle";case ItemType.Line:return"line";case ItemType.PointText:return"text";case"vertex":if("circle"==t.shape)return"circle";if("rect"==t.shape)return"rect";throw"argument exception";case"image":return"image"}}}class Scale{constructor(t,e){switch(this.type=t,this.offset=void 0,this.id="scale"+ItemCounter.scale++,t){case"linear":if(e){let t=Object.keys(e).map((t=>parseFloat(t))).sort(((t,e)=>t-e)),i=t.map((t=>e[t]));this._scale=d3__namespace.scaleLinear(t,i),"clamp"in e&&this._scale.clamp(e.clamp)}else this._scale=d3__namespace.scaleLinear();break;case"point":this._scale=d3__namespace.scalePoint();break;case"ordinal":this._scale=d3__namespace.scaleOrdinal();break;case"ordinalColor":this._scale=d3__namespace.scaleOrdinal(d3__namespace.schemeCategory10);break;case"power":case"log":this._scale=d3__namespace.scaleLog();break;case"identity":case"time":this._scale=d3__namespace.scaleTime();break;case"sequentialColor":this._scale=e&&"string"==typeof e?d3__namespace.scaleSequential(d3__namespace[e]):d3__namespace.scaleSequential()}this.encodings=[]}toJSON(){let t={};return t.type=this.type,t.id=this.id,t.offset=this.offset,t.domain=this.domain,t.range=this.range,t.clamp=this.clamp,t}_merge(t){if(this.type!=t.type)throw Errors.DIFFERENT_SCALE_TYPE;let e,i;switch(this.type){case"linear":case"time":e=[Math.min(this.domain[0],t.domain[0]),Math.max(this.domain[1],t.domain[1])],i=[0,this.map(e[1])-this.map(e[0])];break;case"point":case"ordinalColor":e=[...new Set(this.domain.concat(t.domain))],i=[];break;default:console.log("TODO: merge scale type",this.type)}this._scale.domain(e),this._scale.range(i)}get domain(){return this._scale.domain()}set domain(t){this._scale.domain(t);for(let t of this.encodings)t._apply()}get range(){return this._scale.range()}
//to support this, the argument should be in real screen coordinates and need to do internal conversion
set range(t){this._scale.range(t);for(let t of this.encodings)t._apply();for(let t of this.encodings)t.scene._updateAncestorBounds(t.item,t.items)}_setRange(t){this._scale.range(t);for(let t of this.encodings)t._apply();for(let t of this.encodings)t.scene._updateAncestorBounds(t.item,t.items)}get clamp(){return"linear"==this.type&&this._scale.clamp()}set clamp(t){"linear"==this.type&&this._scale.clamp(t)}set rangeExtent(t){let e=this._scale.range();e[0]<e[1]?this._setRange([e[0],e[0]+t]):this._setRange([e[1]+t,e[1]])}get rangeExtent(){let t=this._scale.range();return Math.abs(t[1]-t[0])}_addEncoding(t){this.encodings.indexOf(t)<0&&this.encodings.push(t)}map(t){return this._scale(t)}invert(t){return this._scale.invert(t)}}class PackingLayout extends Layout{constructor(t){super(t),this.type="packing",this.x=t.hasOwnProperty("x")?t.x:400,this.y=t.hasOwnProperty("y")?t.y:400,this.width=t.width,this.height=t.height}toJSON(){let t={args:{}};return t.type=this.type,t.args.x=this.x,t.args.y=this.y,t.args.width=this.width,t.args.height=this.height,t}clone(){return new PackingLayout({x:this.x,y:this.y,width:this.width,height:this.height})}run(){if(null==this.group)return;let t=this.group.children.map((t=>({name:t.id,radius:t.radius,itm:t}))),e=t.reduce(((t,e)=>t+Math.pow(e.radius,2)),0),i=Math.sqrt(e);void 0===this.width&&(this.width=i),void 0===this.height&&(this.height=i);let s=d3__namespace.hierarchy({name:"root",children:t}).sum((t=>t.radius?t.radius:0)).sort(((t,e)=>e.value-t.value));d3__namespace.pack().size([this.width,this.height]).radius((t=>t.value))(s);for(let t of s.children){let e=t.data.itm,i=this.x-s.x+t.x-e.x,a=this.y-s.y+t.y-e.y;e.translate(i,a)}}}class TreemapLayout extends Layout{constructor(t){super(t),this.type="treemap",this._width=t.width,this._height=t.height,this._top=t.top,this._left=t.left}toJSON(){let t={args:{}};return t.type=this.type,t.args.left=this._left,t.args.top=this._top,t.args.width=this._width,t.args.height=this._height,t}clone(){return new TreemapLayout({})}run(){if(null==this.group)return;let t=this.width?this.width:this.group.bounds.width,e=this.height?this.height:this.group.bounds.height,i=void 0===this.top?this.group.bounds.top:this.top,s=void 0===this.left?this.group.bounds.left:this.left,a=d3__namespace.hierarchy(this.group).sum((t=>"rect"==t.type?t.bounds.width*t.bounds.height:0));d3__namespace.treemap().size([t,e])(a),this._apply(a,s,i),this.group.getScene()._updateAncestorBounds(a.leaves()[0].data)}_apply(t,e,i){if("collection"==t.data.type)for(let s of t.children)this._apply(s,e,i);else"rect"==t.data.type&&(t.data.resize(t.x1-t.x0,t.y1-t.y0),t.data.translate(t.x0+e-t.data.bounds.left,t.y0+i-t.data.bounds.top))}get width(){return this._width}set width(t){this._width=t,this.run()}get height(){return this._width}set height(t){this._height=t,this.run()}get top(){return this._top}set top(t){this._top=t,this.run()}get left(){return this._left}set left(t){this._left=t,this.run()}}const depth="_depth";class Tree{constructor(t,e){let i=[],s=[];this._nodeHash={},this._traverse(t,i,s),this._nodeTable=new DataTable(i,"nodes"),this._linkTable=new DataTable(s,"links"),this._nodeTable.tree=this,this._linkTable.tree=this,this._data=t,this.aggregateFromLeaves("value","average")}_traverse(t,e,i,s=0){let a={};t.hasOwnProperty(nodeId)||(t[nodeId]="n"+e.length),e.push(a),t[depth]=s;for(let n in t)if("children"==n&&t[n]&&t[n].length>0)for(let a of t[n]){let n=this._traverse(a,e,i,s+1);i.push({parent:t[nodeId],child:n})}else a[n]=t[n];return this._nodeHash[a[nodeId]]=a,a[nodeId]}getParent(t){let e,i=t[nodeId],s=this._linkTable.data,a=this._nodeTable.data;for(let t in s)if(s[t].child==i){e=s[t].parent;let i=a.findIndex((t=>t[nodeId]==e));return a[i]}}getChildren(t){let e=t[nodeId],i=[],s=this._linkTable.data,a=this._nodeTable.data;for(let t in s)if(s[t].parent==e){let e=s[t].child,n=a.findIndex((t=>t[nodeId]==e));i.push(a[n])}return i}getMaxDepth(){return this._nodeTable._fieldSummaries[depth].max}getRoot(){return this._nodeTable.data[0]}get nodeTable(){return this._nodeTable}get linkTable(){return this._linkTable}getNode(t){return this._nodeTable.data.filter((e=>e[nodeId]==t))[0]}sumLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];if(s=this.getChildren(t),s&&s.length>0){let t=0;for(let i of s)t+=this.sumLeaves(i,e);this.getNode(i)["sum"+e]=t}else this.getNode(i)["sum"+e]=t[e];return t["sum"+e]}countLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];s=this.getChildren(t);let a=0;if(s&&s.length>0)for(let t of s)a+=this.countLeaves(t,e);else a=1;return this.getNode(i)["count"+e]=a,t["count"+e]}averageLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];s=this.getChildren(t);let a=0;if(s&&s.length>0){for(let t of s)a+=this.averageLeaves(t,e);a/=s.length,this.getNode(i)["average"+e]=a}else this.getNode(i)["average"+e]=t[e];return t["average"+e]}medianLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];s=this.getChildren(t);let a=[];if(s&&s.length>0){for(let t of s)a.push(this.medianLeaves(t,e));a.sort((function(t,e){return t-e}));let t=Math.floor(a.length/2);a.length%2?this.getNode(i)["median"+e]=a[t]:this.getNode(i)["median"+e]=(a[t-1]+a[t])/2}else this.getNode(i)["median"+e]=t[e];return t["median"+e]}maxLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];s=this.getChildren(t);let a=[];if(s&&s.length>0){for(let t of s)a.push(this.maxLeaves(t,e));this.getNode(i)["max"+e]=Math.max(...a)}else this.getNode(i)["max"+e]=t[e];return t["max"+e]}minLeaves(t,e){if(!t)return 0;let i=t[nodeId],s=[];s=this.getChildren(t);let a=[];if(s&&s.length>0){for(let t of s)a.push(this.minLeaves(t,e));this.getNode(i)["min"+e]=Math.min(...a)}else this.getNode(i)["min"+e]=t[e];return t["min"+e]}aggregateFromLeaves(t,e){let i=this.getRoot();switch(e){case"sum":this.sumLeaves(i,t);break;case"count":this.countLeaves(i,t);break;case"average":this.averageLeaves(i,t);break;case"median":this.medianLeaves(i,t);break;case"max":this.maxLeaves(i,t);break;case"min":this.minLeaves(i,t)}}}function merge(t,e){let i=[t[0]],s=[e[0]];for(let a=1;a<e.length;a++){let n=!1,r=e[a];for(let e=0;e<s.length;e++){let l=s[e],o=new Set(r);if(l.forEach((t=>o.add(t))),o.size<r.length+l.length){s[e]=[...o],i[e]=i[e].concat(t[a]),n=!0;break}}n||(s.push(r),i.push(t[a]))}return{grouping:i,subgraphs:s}}function partition(t){let e=t.nodes,i=t.links,s=i.map(((t,e)=>[e])),a=i.map((t=>[t.source,t.target])),n=merge(s,a);for(;n.grouping.length!=s.length;)s=n.grouping,a=n.subgraphs,n=merge(s,a);let r=[];for(let[t,s]of n.grouping.entries()){let a={nodes:[],links:[]};a.links=s.map((t=>i[t]));const l=n.subgraphs[t];a.nodes=e.filter((t=>l.indexOf(t[nodeId])>=0)),r.push(new Network(a))}return r}class Network{constructor(t,e){this._nodeTable=new DataTable(t.nodes,"nodes"),this._linkTable=new DataTable(t.links,"links"),this._nodeTable.graph=this,this._linkTable.graph=this,this._nodes=t.nodes,this._links=t.links,this._nodeHash={};for(let e of t.nodes)this._nodeHash[e[nodeId]]=e}get nodeTable(){return this._nodeTable}get linkTable(){return this._linkTable}get nodes(){return this._nodes}get links(){return this._links}getNode(t){return this._nodeHash[t]}getSources(t){let e,i=t[nodeId],s=this._links.data,a=this._nodes.data,n=[];for(let t in s)if(s[t].target==i){e=s[t].source;let i=a.findIndex((t=>t[nodeId]===e));n.push(a[i])}return n}getTargets(t){let e,i=t[nodeId],s=this._links.data,a=this._nodes.data,n=[];for(let t in s)if(s[t].source==i){e=s[t].target;let i=a.findIndex((t=>t[nodeId]===e));n.push(a[i])}return n}transform(t,e,i){switch(t){case"partition":return partition(this)}}isLinear(){let t={},e={};for(let i of this._links)i.source in e||(e[i.source]=0),i.target in t||(t[i.target]=0),e[i.source]++,t[i.target]++;for(let e in t)if(t[e]>1)return!1;for(let t in e)if(e[t]>1)return!1;return!0}}class TidyTreeLayout extends Layout{constructor(t){super(t),this.type=LayoutType.TidyTree,this._width="width"in t?t.width:500,this._height="height"in t?t.height:500,this._left="left"in t?t.left:100,this._top="top"in t?t.top:100,this._orientation="orientation"in t?t.orientation:Orientation.Horizontal}toJSON(){let t={args:{}};return t.args.type=this.type,t.args.orientation=this._orientation,t.args.left=this._left,t.args.top=this._top,t.args.width=this._width,t.args.height=this._height,t}run(){if(null==this.group)return;let t=this.group.children[0].dataScope._dt;if(t.tree){let e=d3__namespace.hierarchy(t.tree._data),i=Math.max(...this.group.children.map((t=>t.bounds.width))),s=Math.max(...this.group.children.map((t=>t.bounds.height))),a=this._orientation==Orientation.Horizontal?[this._height,this._width]:[this._width,this._height],n=d3__namespace.tree().nodeSize([i,s]).size(a)(e);this._apply(n,this.group)}}_apply(t,e){let i,s,a=e.children.filter((e=>e.dataScope.getFieldValue(nodeId)==t.data[nodeId]))[0];switch(this._orientation){case Orientation.Horizontal:i=t.y+this._left,s=t.x+this._top;break;case Orientation.Vertical:i=t.x+this._left,s=this._top+t.y}if(a.x=i,a.y=s,t.children&&t.children.length>0)for(let i of t.children)this._apply(i,e)}get orientation(){return this._orientation}set orientation(t){this._orientation=t,this.run()}get width(){return this._width}set width(t){this._width=t,this.run()}get height(){return this._width}set height(t){this._height=t,this.run()}get size(){return[this._width,this._height]}set size(t){this._width=t[0],this._height=t[1],this.run()}}class ForceLayout extends Layout{constructor(t){super(t),this.type=LayoutType.Force,this._x="x"in t?t.x:0,this._y="y"in t?t.y:0,this._iterations="iterations"in t?t.iterations:1,this._repulsion="repulsion"in t?t.repulsion:30,this._attraction="attraction"in t?t.attraction:1,this._linkDistance="linkDistance"in t?t.linkDistance:30}toJSON(){let t={args:{}};return t.type=this.type,t.args.x=this._x,t.args.y=this._y,t.args.iterations=this._iterations,t}run(){if(null==this.group)return;let t=this.group.children[0].dataScope._dt.graph;if(t){let e=t.links.map((e=>({source:t.getNode(e.source),target:t.getNode(e.target)}))),i=d3__namespace.forceSimulation(t.nodes).force("charge",d3__namespace.forceManyBody().strength(-this._repulsion)).force("link",d3__namespace.forceLink(e).id((t=>t.id)).distance(this._linkDistance)).force("x",d3__namespace.forceX()).force("y",d3__namespace.forceY()).force("center",d3__namespace.forceCenter(this._x,this._y).strength(this._attraction));i.stop(),i.tick(this._iterations);for(let e=0;e<this.group.children.length;e++)this.group.children[e].x=t.nodes[e].x,this.group.children[e].y=t.nodes[e].y}}}class SpecGenerator{constructor(){this.axes={},this.guideCmds=[],this.collectionCmds=[],this.glyphCmds=[],this.spec=[]}run(t){for(let e of t.children)switch(e.type){case ItemType.Axis:{let t=e.classId?e.classId:e.id;this.axes[t]=e;break}case ItemType.Gridlines:case ItemType.Legend:{let t=e.toJSON();this.guideCmds.push({cmd:e.type,channel:t.channel,field:t.field,args:t.args});break}case ItemType.Collection:case ItemType.Group:case ItemType.Glyph:{let t=[];this._analyze(e,t);for(let e=t.length-1;e>0;e--)for(let i of t[e].fields)t[e-1].fields.delete(i);for(let[e,i]of t.entries()){if(i.item instanceof Mark)this.collectionCmds.push({cmd:"mark",type:i.item.type,output:i.item,args:i.item.toJSON().args});else if(i.item instanceof Glyph)this.collectionCmds.push({cmd:"glyph",output:i.item,input:t.slice(0,e).map((t=>t.item)),args:{}});else if(i.item instanceof Collection){let s=[...t[e-1].fields][0],a={cmd:"join",input:t[e-1].item,output:i.item,data:t[e-1].item.dataScope.dataTable.id,args:{field:s}};s==atlas_rowId&&delete a.field,this.collectionCmds.push(a)}i.item.dataScope&&0==i.item.dataScope.fields.length&&!i.item.parent.dataScope&&this.collectionCmds.push({cmd:"attach",input:i.item,data:i.item.dataScope.dataTable.id})}break}default:if(e instanceof Mark){let i={cmd:"mark",type:e.type,output:e,args:e.toJSON().args};this._inferMarkArgs(i,t),this.glyphCmds.push(i)}}this._inferJoin(),this._inferArgs(t);for(let t in this.axes){let e=this.axes[t].toJSON();this.guideCmds.push({cmd:e.type,channel:e.channel,field:e.field,args:e.args})}return this._generateFullSpec(t),this.spec}_inferJoin(){for(let t of this.collectionCmds){if("join"!=t.cmd)continue;let e=t.input,i=e.parent;switch(e.type){case ItemType.Rect:i.layout&&i.layout.type==LayoutType.Stack?t.cmd="divide":t.cmd="repeat";break;default:t.cmd="repeat"}}}_inferArgs(t){for(let e of this.collectionCmds)switch(e.cmd){case"mark":this._inferMarkArgs(e,t);break;case"divide":this._inferDivideArgs(e,t)}}_inferDivideArgs(t){t.args.orientation=t.output.layout.orientation}_inferMarkArgs(t,e){let i=t.output,s=i.parent,a=getPeers(i,e),n=getPeers(s,e);switch(i.type){case ItemType.Rect:s.layout&&s.layout.type==LayoutType.Grid?(t.args.width=s.layout.cellBounds[0].width,t.args.height=s.layout.cellBounds[0].height):s.layout&&s.layout.type==LayoutType.Stack?(t.args.width=Math.max(...n.map((t=>t.bounds.width))),t.args.height=Math.max(...n.map((t=>t.bounds.height)))):(t.args.width=Math.max(...a.map((t=>t.bounds.width))),t.args.height=Math.max(...a.map((t=>t.bounds.height)))),t.args.left=Math.min(...a.map((t=>t.bounds.left))),t.args.top=Math.min(...a.map((t=>t.bounds.top)));break;case ItemType.Line:t.args.x1=Math.min(...a.map((t=>t.vertices[0].x))),t.args.y1=Math.min(...a.map((t=>t.vertices[0].y))),t.args.x2=Math.min(...a.map((t=>t.vertices[1].x))),t.args.y2=Math.min(...a.map((t=>t.vertices[1].y)))}for(let e in i.styles)t.args[e]=i.styles[e]}_analyze(t,e){if(t instanceof Glyph)for(let i of t.children)this._analyze(i,e);else t instanceof Group&&this._analyze(t.firstChild,e);let i={type:t.type,item:t};t.dataScope?i.fields=new Set(t.dataScope.fields):i.fields=new Set,e.push(i)}_generateFullSpec(t){this.spec=[],this.spec.push({cmd:"scene",args:{fillColor:t.fillColor}});let e=t.getDataTables(),i={},s=[];for(let t in e){let a=e[t];if(a.sourceDataTable)for(;a.sourceDataTable;)s.push({cmd:"transform",type:a.transform.type,args:a.transform.args,input:a.sourceDataTable.id,output:a.id}),a=a.sourceDataTable;a.id in i||(i[a.id]={cmd:"data",url:a.url,output:a.id})}this.spec=this.spec.concat(Object.values(i)),this.spec=this.spec.concat(s);let a=[];for(let t of this.collectionCmds){let e;t.output&&t.output.layout&&(e={cmd:"layout",type:t.output.layout.type,input:t.output.id,args:t.output.layout.toJSON().args}),this.spec.push(t),t.output&&t.output.childrenOrder&&a.push({cmd:"sortChildren",args:t.output.childrenOrder,input:t.output.id}),e&&this.spec.push(e),t.input&&Array.isArray(t.input)?t.input=t.input.map((t=>t.classId?t.classId:t.id)):t.input&&(t.input=t.input.classId?t.input.classId:t.input.id),t.output&&(t.output=t.output.classId?t.output.classId:t.output.id)}let n={},r=[];for(let e in t.encodings)for(let i in t.encodings[e]){let s=t.encodings[e][i];s.scale&&!(s.scale.id in n)&&(n[s.scale.id]=s.scale.toJSON());let a=s.toJSON().args;a.field=s.field,a.channel=s.channel,delete a.datatable,r.push({cmd:"encode",input:getEncodingKey(s.anyItem),scale:s.scale.id,args:a})}for(let t in n){let e=n[t];e.cmd="scale",this.spec.push(e)}this.spec=this.spec.concat(r),this.spec=this.spec.concat(a);for(let e in t.constraints){let i=t.constraints[e],s={cmd:"constraint",type:i.type,args:{}};switch(i.type){case ConstraintType.Affix:s.item=i.item.classId?i.item.classId:i.item.id,s.baseItem=i.baseItem.classId?i.baseItem.classId:i.baseItem.id,s.channel=i.channel,s.args.itemAnchor=i.itemAnchor,s.args.baseAnchor=i.baseAnchor,s.args.offset=i.offset;break;case ConstraintType.Align:s.items=i.items.map((t=>t.classId?t.classId:t.id)),s.anchor=i.anchor}this.spec.push(s)}for(let t of this.guideCmds)this.spec.push(t);for(let t of this.glyphCmds)t.output&&(t.output=t.output.classId?t.output.classId:t.output.id),this.spec.push(t)}}class SceneLoader{constructor(){this.axes={},this.legends=[],this.gridlines=[],this.scales={},this.tables={}}load(t){console.log("saved",t);let e={};t.fillColor&&(e.fillColor=t.fillColor);let i=scene(e);if(i.id=t.id,i.type=t.type,t.bounds&&(i._bounds=new Rectangle(t.bounds.left,t.bounds.top,t.bounds.width,t.bounds.height)),t.tables)for(let e in t.tables)this.tables[e]=new DataTable(t.tables[e].data,e,t.tables[e].fieldTypes);for(let e of t.children)this._processItem(i,e,i);if(t.scales)for(let e in t.scales)this._loadScale(t.scales[e],i);if(t.encodings)for(let e of t.encodings)this._loadEncoding(e,i);if(t.constraints)for(let e in t.constraints)this._loadConstraint(t.constraints[e],i);for(let t in this.axes)this._createGuide(i,this.axes[t]);for(let t of this.legends)this._createGuide(i,t);for(let t of this.gridlines)this._createGuide(i,t);return console.log("loaded",i),i}_loadScale(t){let e=createScale(t.type);e.id=t.id,e.domain="time"==t.type?t.domain.map((t=>new Date(t))):t.domain,e.range=t.range,"offset"in t&&(e.offset=t.offset),this.scales[e.id]=e}_loadEncoding(t,e){let i=t.items.map((t=>e.find([{id:t}])[0]));t.args.datatable&&(t.args.datatable=this.tables[t.args.datatable]);let s=new Encoding(i,e,t.channel,t.field,t.args);t.scale&&(s.scale=this.scales[t.scale],s.scale._addEncoding(s)),t.data&&(s.data=t.data),t._rectNegativeValues&&(s._rectNegativeValues=t._rectNegativeValues),e._registerBinding(s)}_createGuide(t,e){switch(e.type){case ItemType.Axis:t.axis(e.channel,e.field,e.args);break;case ItemType.Legend:t.legend(e.channel,e.field,e.args);break;case ItemType.Gridlines:t.gridlines(e.channel,e.field,e.args)}}_processItem(t,e,i){switch(e.type){case ItemType.Axis:{let t=e.classId?e.classId:e.id;this.axes[t]=e;break}case ItemType.Gridlines:this.gridlines.push(e);break;case ItemType.Legend:this.legends.push(e);break;case ItemType.Collection:{let s=i.collection();t.addChild(s),this._loadGroup(s,e,i);break}case ItemType.Group:{let s=i.group();t.addChild(s),this._loadGroup(s,e,i);break}case ItemType.Glyph:{let s=i.glyph();t.addChild(s),this._loadGroup(s,e,i);break}default:this._loadMark(t,e,i)}}_loadConstraint(t,e){switch(t.type){case"affixation":{let i=e.find([{id:t.item}])[0],s=e.find([{id:t.baseItem}])[0],a=new AffixConstraint(i,s,e,t.channel,t.itemAnchor,t.baseAnchor,t.offset);return a.id=t.id,e.constraints[t.id]=a,a}case"alignment":{let i=t.items.map((t=>e.find([{id:t}])[0])),s=new AlignConstraint(i,t.direction);return s.id=t.id,e.constraints[t.id]=s,s}}}_loadDataScope(t){let e=new DataScope(this.tables[t.dt]);for(let i in t.f2v)e._field2value[i]=t.f2v[i],e._updateTuples(i,t.f2v[i]);return e}_loadGroup(t,e,i){t.id=e.id,e.classId&&(t.classId=e.classId),e.dataScope&&(t.dataScope=this._loadDataScope(e.dataScope));for(let s of e.children)this._processItem(t,s,i);if(e.layout){let i=this._loadLayout(e.layout);i.group=t,t._layout=i}e.bounds&&(t._bounds=new Rectangle(e.bounds.left,e.bounds.top,e.bounds.width,e.bounds.height))}_loadMark(t,e,i){let s=i.mark(e.type,e.args);if(s.id=e.id,e.classId&&(s.classId=e.classId),e.dataScope&&(s.dataScope=this._loadDataScope(e.dataScope)),e.vertices){s.vertices=e.vertices.map((t=>Vertex.fromJSON(t,s)));for(let t=1;t<s.vertices.length;t++)s.segments.push(new Segment(s.vertices[t-1],s.vertices[t],s,s.segmentCounter++))}e.bounds&&(s._bounds=new Rectangle(e.bounds.left,e.bounds.top,e.bounds.width,e.bounds.height)),t.addChild(s)}_loadLayout(t){let e=layout(t.type,t.args);switch(t.type){case LayoutType.Grid:e._left=t.left,e._top=t.top}return e}}class SpecExecutor{constructor(){}async run(t){let e,i,s={},a={},n={};console.log("spec");for(let r of t)switch(console.log(r),r.cmd){case"scene":e=scene(r.args);break;case"data":i=await csv(r.url),a[r.output]=i;break;case"transform":a[r.output]=a[r.input].transform(r.type,r.args);break;case"mark":s[r.output]=e.mark(r.type,r.args);break;case"glyph":s[r.output]=e.glyph(...r.input.map((t=>s[t])));break;case"attach":e.attach(s[r.input],a[r.data]);break;case"repeat":{let t=e.repeat(s[r.input],a[r.data],r.args);s[r.output]=t;break}case"divide":{let t=e.divide(s[r.input],a[r.data],r.args);s[r.output]=t;break}case"layout":s[r.input].layout=layout(r.type,r.args);break;case"sortChildren":"field"in r.args?s[r.input].sortChildrenByData(r.args.field,r.args.reverse,r.args.order):"channel"in r.args&&s[r.input].sortChildren(r.args.channel,r.args.reverse);break;case"scale":{let t=createScale(r.type);t.id=r.id,t.domain="time"==r.type?r.domain.map((t=>new Date(t))):r.domain,t.range=r.range,t.clamp=r.clamp,"offset"in r&&(t.offset=r.offset),n[t.id]=t;break}case"encode":let t,l=r.input;if(l.indexOf("_v_")>0){let e=parseInt(l.split("_v_")[1]);t=s[l.split("_v_")[0]].vertices[e]}else if(l.indexOf("_v")>0);else if(l.indexOf("_s_")>0){let e=parseInt(l.split("_s_")[1]);t=s[l.split("_s_")[0]].segments[e]}else l.indexOf("_s")>0||(t=s[r.input]);r.scale&&n[r.scale]&&(r.args.scale=n[r.scale]),e.encode(t,r.args);break;case"constraint":switch(r.type){case ConstraintType.Affix:e.affix(s[r.item],s[r.baseItem],r.channel,r.args)}break;case"axis":e.axis(r.channel,r.field,r.args);break;case"legend":e.legend(r.channel,r.field,r.args);break;case"gridlines":e.gridlines(r.channel,r.field,r.args)}return e}}let DEG2RAD=Math.PI/180;class WebGLRenderer{constructor(t){this._canvasId=t,this._doesCollectionHaveBounds=!1,this._app=new PIXI__namespace.Application({antialias:!0,width:1600,height:1e3,view:document.getElementById(this._canvasId)}),this._app.renderer.autoResize=!0}render(t,e){let i=e||{};this._app.renderer.backgroundColor=toHexColor(t.fillColor?t.fillColor:"#fff"),this._doesCollectionHaveBounds=!!i.collectionBounds,this._app.stage.removeChildren(),this._app.renderer.clear();let s=this._renderItem(t);this._app.stage.addChild(s)}_renderItem(t){switch(t.type){case ItemType.Ellipse:case ItemType.LinearGradient:throwError("mark",t,Errors.FEATURE_NOT_IMPLEMENTED);break;case ItemType.Circle:return this._renderCircle(t);case ItemType.Pie:return this._renderPiePath(t);case ItemType.Area:return this._renderArea(t);case ItemType.Polygon:return this._renderPolygon(t);case ItemType.Axis:return this._renderAxis(t);case ItemType.Collection:return this._renderCollection(t);case ItemType.Glyph:case ItemType.Group:case ItemType.Gridlines:case ItemType.Legend:case ItemType.Scene:return this._renderGroup(t);case ItemType.Path:return this._renderPath(t);case ItemType.Line:return this._renderLinearPath(t);case ItemType.Rect:return this._renderRectangle(t);case ItemType.PointText:return this._renderText(t);case ItemType.Arc:return this._renderArc(t);case ItemType.Image:return this._renderImage(t);case ItemType.Link:return this._renderLink(t);default:throw new Error(`Expect: itemType, Actual: ${t}\nWait that's illegal`)}}_renderRectangle(t){let e=new PIXI.Graphics;return decorate(e,t.styles),e.lineStyle(t.styles.strokeWidth,toHexColor(t.styles.strokeColor)),beginGradientOrColorFill(t.styles,e,t.height),e.drawRect(0,0,t.width,t.height),e.x=t.left,e.y=t.top,e.endFill(),e}_renderText(t){let e=new PIXI.TextStyle({fontSize:t.styles.fontSize,fontFamily:t.styles.fontFamily,fontWeight:styleFontWeight2PixiFontWeight(t.styles.fontWeight),fill:toHexColor(t.styles.fillColor)}),i=new PIXI__namespace.Text(t.text,e),s=new PIXI.Container;decorate(i,t.styles),i.x=t.x,i.y=t.y,i.anchor.set(...styleAnchor2PixiAnchor(t.anchor)),s.addChild(i);let a=rotation2PixiPivot(t._rotate);return s.pivot.set(a[0],a[1]),s.angle=rotation2PixiAngle(t._rotate),s.position.set(a[0],a[1]),s}_renderGroup(t){let e=new PIXI.Container;for(const i of t.children){let t=this._renderItem(i);if(null==t)throw new Error;e.addChild(t)}return e}_renderAxis(t){let e=this._renderGroup(t),i=rotation2PixiPivot(t._rotate);return e.pivot.set(i[0],i[1]),e.angle=rotation2PixiAngle(t._rotate),e.position.set(i[0],i[1]),e}_renderCollection(t){let e=new PIXI.Container,i=this._renderGroup(t);if(e.addChild(i),!this._doesCollectionHaveBounds)return e;let s=new PIXI.Graphics,a=0,n=t.bounds,r=n.left,l=n.right,o=n.top,h=n.bottom,d={strokeWidth:1,color:2018112,dashLength:5,dashSpacing:5};return a=c(r,l,o,a,d,s),a=c(o,h,-l,a,d,s),a=c(l,r,h,a,d,s),c(h,o,-r,a,d,s),e.addChild(s),e;function c(t,e,i,s,a,n){let r=t<=e?1:-1,l=s>=0?{point:t+s*r}:{point:t},o=i>0?[l,{point:i}]:[{point:-i},l];n.lineStyle({width:a.strokeWidth,color:a.color}),n.moveTo(o[0].point,o[1].point),l.point=s*r+t+a.dashLength*r,n.lineTo(o[0].point,o[1].point);let h=!1;for(l.point+=a.dashLength*r;l.point*r<=e*r;)h?(n.lineTo(o[0].point,o[1].point),h=!1,l.point+=a.dashSpacing*r):(n.moveTo(o[0].point,o[1].point),h=!0,l.point+=a.dashLength*r);return h?(i>0?n.lineTo(e,i):n.lineTo(-i,e),(e-l.point)*r):(l.point-e)*r}}_renderArea(t){switch(t.curveMode){case"linear":return this._renderPolygon(t);case"basis":return this._renderBezierArea(t);default:return throwError("areaPath",t,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderBezierArea(t){let e=new PIXI.Graphics;decorate(e,t.styles),e.lineStyle({width:t.styles.strokeWidth,color:toHexColor(t.styles.strokeColor)});let i=parseDPath(t.getSVGPathData());return beginGradientOrColorFill(t.styles,e,t.bounds.height),drawOnGraphicsFromJSONData(e,i),e.endFill(),e}_renderPolygon(t){let e=new PIXI__namespace.Container,i=this._renderLinearPath(t);i.getChildAt(0).lineTo(t.vertices[0].x,t.vertices[0].y);let s=new PIXI__namespace.Graphics;decorate(s,t.styles);let a=[];for(const e of t.vertices)a.push(e.x-t.bounds.left),a.push(e.y-t.bounds.top);return beginGradientOrColorFill(t.styles,s,t.bounds.height),s.drawPolygon(a),s.x+=t.bounds.left,s.y+=t.bounds.top,s.endFill(),e.addChild(s),e.addChild(i),e}_renderPath(t){switch(t.curveMode){case"linear":return this._renderLinearPath(t);case"bumpX":case"natural":return this._renderBezierPath(t);default:throwError("path",t,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderLinearPath(t){let e=new PIXI.Container,i=new PIXI.Graphics,s="none"==t.styles.strokeDash;decorate(i,t.styles);let a=t.vertices[0];if(i.lineStyle({width:t.styles.strokeWidth,color:toHexColor(t.styles.strokeColor)}),i.moveTo(a.x,a.y),s)for(let e=1;e<t.vertices.length;e++){const s=t.vertices[e];i.lineTo(s.x,s.y)}else drawDashLine(t.vertices,t.styles.strokeDash,i);e.addChild(i);for(let i=0;i<t.vertices.length;i++){let s=t.vertices[i],a=this._renderVertex(s);null!=a&&e.addChild(a)}return e}_renderBezierPath(t){let e=new PIXI.Container,i=new PIXI.Graphics;decorate(i,t.styles),i.lineStyle({width:t.styles.strokeWidth,color:toHexColor(t.styles.strokeColor)}),drawOnGraphicsFromJSONData(i,parseDPath(t.getSVGPathData())),e.addChild(i);for(let i=0;i<t.vertices.length;i++){let s=t.vertices[i],a=this._renderVertex(s);null!=a&&e.addChild(a)}return e}_renderVertex(t){switch(t.shape){case"rect":return function(t){let e=new PIXI__namespace.Graphics;return e.lineStyle({width:t.strokeWidth,color:toHexColor(t.strokeColor)}),e.beginFill(toHexColor(t.fillColor)),e.drawRect(t.x-t.width/2,t.y-t.height/2,t.width,t.height),e.endFill(),e}(t);case"circle":return function(t){let e=new PIXI__namespace.Graphics;return e.lineStyle({width:t.strokeWidth,color:toHexColor(t.strokeColor)}),e.beginFill(toHexColor(t.fillColor)),e.drawCircle(t.x,t.y,t.radius),e.endFill(),e}(t);case void 0:return null;default:throwError("vertex shape",t.shape,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderCircle(t){let e=new PIXI.Graphics;return decorate(e,t.styles),e.lineStyle(t.styles.strokeWidth,toHexColor(t.styles.strokeColor)),beginGradientOrColorFill(t.styles,e,t.height),e.drawCircle(t.x,t.y,t.radius),e.endFill(),e}_renderPiePath(t){let e=new PIXI__namespace.Graphics;return e.lineStyle({color:toHexColor(t.styles.strokeColor),width:t.styles.strokeWidth}),e.beginFill(toHexColor(t.styles.fillColor)),e.moveTo(t.x,t.y),e.arc(t.x,t.y,t.radius,-t.endAngleRad,-t.startAngleRad),e.lineTo(t.x,t.y),e.endFill(),e}_renderArc(t){let e=new PIXI.Graphics;return e.lineStyle({color:toHexColor(t.styles.strokeColor),width:t.styles.strokeWidth}),e.beginFill(toHexColor(t.styles.fillColor)),e.arc(t.x,t.y,t.outerRadius,-t.endAngle*DEG2RAD,-t.startAngle*DEG2RAD),e.arc(t.x,t.y,t.innerRadius,-t.startAngle*DEG2RAD,-t.endAngle*DEG2RAD,!0),e.endFill(),e}_renderImage(t){let e=PIXI__namespace.Sprite.from(t.src);return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}_renderLink(t){switch(t.curveMode){case"linear":return function(t){let e=new PIXI.Graphics;return decorate(e,t.styles),e.lineStyle({color:toHexColor(t.styles.strokeColor),width:t.styles.strokeWidth}),drawOnGraphicsFromJSONData(e,parseDPath(t.getSVGPathData())),e}(t);default:throwError("link",t.curveMode,"unexpected curvemode")}}}function decorate(t,e){t.visible=styleVisiblity2PixiVisible(e.visibility),t.alpha=styleOpacity2PixiAlpha(e.opacity)}function styleFontWeight2PixiFontWeight(t){switch(t){case"regular":return"normal";case"bold":return"bold";default:throwError("font weight",t,Errors.FEATURE_NOT_IMPLEMENTED)}}function styleAnchor2PixiAnchor(t){let e,i;switch(t[0]){case"left":e=0;break;case"center":e=.5;break;case"right":e=1;break;default:throwError("x anchor",t[0],Errors.UNKNOWN_ANCHOR)}switch(t[1]){case"hanging":case"top":i=0;break;case"central":case"middle":i=.5;break;case"bottom":i=1;break;default:throwError("y anchor",t[1],Errors.UNKNOWN_ANCHOR)}return[e,i]}function toHexColor(t){let e=d3__namespace.color(t);if(null==e)return null;{let t=e.formatHex();return PIXI__namespace.utils.string2hex(t)}}function styleVisiblity2PixiVisible(t){switch(t){case"hidden":return!1;case null:case void 0:case"visible":default:return!0}}function rotation2PixiAngle(t){return void 0===t||"number"!=typeof t[0]?0:t[0]}function rotation2PixiPivot(t){return void 0===t||"number"!=typeof t[0]?[0,0]:t.slice(1)}function styleOpacity2PixiAlpha(t){switch(t){case void 0:case null:return 1;default:return t}}function throwError(t,e,i){throw console.log(e),new Error(`${i}. Source: ${t}, Actual: `)}function beginGradientOrColorFill(t,e,i){let s=t.fillColor;if("none"==s)return;let a=toHexColor(s);null!=a?e.beginFill(a):e.beginTextureFill({color:16777215,texture:createLinearGradientTexture(i,s.stops,s.y1>s.y2)})}function createLinearGradientTexture(t,e,i){const s=document.createElement("canvas");s.height=t,s.width=1;const a=s.getContext("2d"),n=a.createLinearGradient(0,0,0,t);for(let t=0;t<e.length;t++)i?n.addColorStop(1-e[t].offset/100,e[t].color):n.addColorStop(e[t].offset/100,e[t].color);return a.fillStyle=n,a.fillRect(0,0,1,t),PIXI__namespace.Texture.from(s)}function drawOnGraphicsFromJSONData(t,e){let i=e.pop(),s=()=>{};"Z"==i.code.toUpperCase()?s=()=>t.lineTo(e[0].end.x,e[0].end.y):e.push(i);for(const i of e)draw(i,t);s()}function draw(t,e){switch(t.code.toUpperCase()){case"M":e.moveTo(t.end.x,t.end.y);break;case"L":e.lineTo(t.end.x,t.end.y);break;case"Q":e.bezierCurveTo(t.cp1.x,t.cp1.y,t.cp1.x,t.cp1.y,t.end.x,t.end.y);break;case"C":e.bezierCurveTo(t.cp1.x,t.cp1.y,t.cp2.x,t.cp2.y,t.end.x,t.end.y);break;case"Z":throw new Error('Unexpected "z" marker. There\'s something wrong, I can feel it');default:return throwError("data",t,Errors.FEATURE_NOT_IMPLEMENTED)}}function drawDashLine(t,e,i){let s,a,n,r=0,l=0,o=e.split(" "),h=Number(o[0]),d=Number(o[1]);for(s=0;s<t.length&&(a=t[s],s!=t.length-1);s++){n=t[s+1];let e=n.x-a.x,o=n.y-a.y,c=Math.sqrt(e*e+o*o),u={x:e/c,y:o/c},p=0;for(i.moveTo(a.x+l*u.x,a.y+l*u.y);p<=c;)p+=l,p+=r>0?r:h,p>c?(r=p-c,p=c):r=0,i.lineTo(a.x+p*u.x,a.y+p*u.y),p+=d,p>c&&0==r?l=p-c:(l=0,i.moveTo(a.x+p*u.x,a.y+p*u.y))}}function parseDPath(t){let e={command:/\s*([achlmqstvz])/gi,number:/\s*([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/gi,comma:/\s*(?:(,)|\s)/g,flag:/\s*([01])/g},i={number:function(t){return+r("number",t)},"coordinate pair":function(t){let e=r("number",t);return null!==e||t?(r("comma"),{x:+e,y:+r("number",!0)}):null},"arc definition":function(t){let e=i["coordinate pair"](t);if(!e&&!t)return null;r("comma");let s=+r("number",!0);r("comma",!0);let a=!!+r("flag",!0);r("comma");let n=!!+r("flag",!0);return r("comma"),{radii:e,rotation:s,large:a,clockwise:n,end:i["coordinate pair"](!0)}}},s=0,a=[];for(;s<t.length;){let t,e=r("command"),i=e.toUpperCase(),o=e!==i;switch(i){case"M":t=l("coordinate pair").map((function(t,i){return 1===i&&(e=o?"l":"L"),n({end:t},e,o)}));break;case"L":case"T":t=l("coordinate pair").map((function(t){return n({end:t},e,o)}));break;case"C":if(t=l("coordinate pair"),t.length%3)throw Error("Expected coordinate pair triplet at position "+s);t=t.reduce((function(t,i,s){let a=s%3;if(a){t[t.length-1][1===a?"cp2":"end"]=i}else t.push(n({cp1:i},e,o));return t}),[]);break;case"Q":case"S":if(t=l("coordinate pair"),1&t.length)throw Error("Expected coordinate pair couple at position "+s);t=t.reduce((function(t,i,s){if(1&s){t[t.length-1].end=i}else t.push(n({cp:i},e,o));return t}),[]);break;case"H":case"V":t=l("number").map((function(t){return n({value:t},e,o)}));break;case"A":t=l("arc definition").map(n,e,o);break;case"Z":t=[{code:"Z"}]}a.push.apply(a,t)}return a;function n(t,e,i){return t.code=e,t.relative=i,t}function r(i,a){e[i].lastIndex=s;let n=e[i].exec(t);if(!n||n.index!==s){if(!a)return null;throw Error("Expected "+i+" at position "+s)}return s=e[i].lastIndex,n[1]}function l(t){let e,s=[],a=!0;for(;null!==(e=i[t](a));)s.push(e),a=!!r("comma");return s}}var pixiRenderers={};function scene(t){return new Scene(t)}function renderer(t,e){switch(t){case"svg":return new SVGRenderer(e);case"webgl":return e in pixiRenderers||(pixiRenderers[e]=new WebGLRenderer(e)),pixiRenderers[e]}}function createScale(t,e){if(ScaleType.indexOf(t)<0)throw new Error(Errors.UNKOWNN_SCALE_TYPE+": "+t);return new Scale(t,e)}function layout(t,e){let i=e||{};switch(t.toLowerCase()){case"grid":return new GridLayout(i);case"packing":return new PackingLayout(i);case"treemap":return new TreemapLayout(i);case"stack":return new StackLayout(i);case"tidytree":return new TidyTreeLayout(i);case"force":return new ForceLayout(i)}}function linearGradient(t){return new LinearGradient(t||{})}function sceneLoader(){return new SceneLoader}function specGenerator(){return new SpecGenerator}function specExecutor(){return new SpecExecutor}function makeRequest(t,e){return new Promise((function(i,s){let a=new XMLHttpRequest;a.open(t,e),a.onload=function(){this.status>=200&&this.status<300?i(a.response):s({status:this.status,statusText:a.statusText})},a.onerror=function(){s({status:this.status,statusText:a.statusText})},a.send()}))}async function csv(t){let e=await makeRequest("GET",t),i=d3__namespace.csvParse(e.trim(),d3__namespace.autoType);return new DataTable(i,t)}async function treejson(t){let e=await makeRequest("GET",t);return new Tree(JSON.parse(e),t)}async function graphjson(t){let e=await makeRequest("GET",t);return new Network(JSON.parse(e),t)}function csvSync(t,e){let i=!!e;var s=new XMLHttpRequest;if(s.open("GET",t,i),s.send(),!i&&validResponse(s)){let e=d3__namespace.csvParse(s.responseText.trim(),d3__namespace.autoType);return new DataTable(e,t)}}function validResponse(t){var e=t.responseType;return e&&"text"!==e?t.response:t.responseText}function cartesianToPolar(t,e,i,s){return cartesian2Polar(t,e,i,s)}function polarToCartesian(t,e,i,s){return polar2Cartesian(t,e,i,s)}function hitTest(t,e,i){if(!t.children||0==t.children.length)return t.contains(e,i)?t:null;for(let s=t.children.length-1;s>=0;s--){let a=t.children[s];if(a.contains(e,i))return a}return null}function hitTestAll(t,e,i){let s=getLeafItems(t);for(let t=s.length-1;t>=0;t--){let a=s[t];if(a.contains(e,i))return a}return null}exports.cartesianToPolar=cartesianToPolar,exports.createScale=createScale,exports.csv=csv,exports.csvSync=csvSync,exports.graphjson=graphjson,exports.hitTest=hitTest,exports.hitTestAll=hitTestAll,exports.layout=layout,exports.linearGradient=linearGradient,exports.polarToCartesian=polarToCartesian,exports.renderer=renderer,exports.scene=scene,exports.sceneLoader=sceneLoader,exports.specExecutor=specExecutor,exports.specGenerator=specGenerator,exports.treejson=treejson,Object.defineProperty(exports,"__esModule",{value:!0})}));
