/* version: 1.6.4 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3"),require("pixi.js")):"function"==typeof define&&define.amd?define(["exports","d3","pixi.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).atlas={},e.d3,e.PIXI)}(this,(function(exports,d3,PIXI){"use strict";function _interopNamespace(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,s.get?s:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var d3__namespace=_interopNamespace(d3),PIXI__namespace=_interopNamespace(PIXI);class Rectangle{constructor(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}toJSON(){let e={};return e.left=this.left,e.top=this.top,e.width=this.width,e.height=this.height,e}union(e){let t=Math.min(this.left,e.left),i=Math.min(this.top,e.top),s=Math.max(this.right,e.right),a=Math.max(this.bottom,e.bottom);return new Rectangle(t,i,s-t,a-i)}clone(){return new Rectangle(this.left,this.top,this.width,this.height)}get right(){return this.left+this.width}get bottom(){return this.top+this.height}get x(){return(this.left+this.right)/2}get y(){return(this.top+this.bottom)/2}get center(){return(this.left+this.right)/2}get middle(){return(this.top+this.bottom)/2}contains(e,t){return this.left<=e&&this.right>=e&&this.top<=t&&this.bottom>=t}overlap(e){return!(this.right<e.left||this.bottom<e.top||this.left>e.right||this.top>e.bottom)}}const nodeId="id",atlas_rowId="atlas_rowId",ScaleType=["linear","power","log","sqrt","symlog","identity","time","ordinal","band","point","ordinalColor","sequentialColor"],CurveMode={Natural:"natural",Basis:"basis",BumpX:"bumpX",BumpY:"bumpY",Linear:"linear",Step:"step",CatmullRom:"CatmullRom",Cardinal:"cardinal"},LayoutType={Grid:"grid",Circular:"circular",Stack:"stack",Treemap:"treemap",Packing:"packing",Force:"force",TidyTree:"tidytree",Sugiyama:"sugiyama"},Orientation={Vertical:"vertical",Horizontal:"horizontal",Angular:"angular",Radial:"radial"},Alignment={Top:"top",Left:"left",Bottom:"bottom",Right:"right",Center:"center",Middle:"middle"},ConstraintType={Align:"alignment",Distribute:"distribution",Affix:"affixation"},ItemType={Area:"area",Rect:"rect",Ellipse:"ellipse",Circle:"circle",Pie:"pie",Ring:"ring",Arc:"arc",Line:"line",Path:"path",Image:"image",PointText:"pointText",Collection:"collection",Group:"group",Scene:"scene",Axis:"axis",Glyph:"glyph",Legend:"legend",Polygon:"polygon",Gridlines:"gridlines",LinearGradient:"LinearGradient",Link:"link",DataTable:"datatable"},DataType={Boolean:"boolean",Integer:"integer",Number:"number",Date:"date",String:"string"},Aggregator={Max:"max",Min:"min",Avg:"avg",Median:"median",Sum:"sum",Count:"count",Mean:"mean",Percentile25:"percentile 25",Percentile75:"percentile 75"},Style2SVG={fillColor:"fill",strokeColor:"stroke",strokeWidth:"stroke-width",fillOpacity:"fill-opacity",strokeOpacity:"stroke-opacity",strokeDash:"stroke-dasharray",opacity:"opacity",fontSize:"font-size",fontFamily:"font-family",fontWeight:"font-weight",visibility:"visibility"},Warnings={INCORRECT_AXIS_INFO:"Cannot find relevant information to create an axis for ",INCORRECT_LEGEND_INFO:"Cannot find relevant information to create a legend for "},Errors={FIELD_NONEXISTENT:"Data field does not exist in the data table",INCOMPLETE_REPEAT_INFO:"Incomplete information to do repeat. You must specify an item, a categorical data field and a data table",REPEAT_BY_NONCAT:"Repeat only works on a string or date field",PARTITION_BY_NONCAT:"Divide only works on a string or date field",DENSIFY_BY_NONCAT:"Densify only works on a string or date field",INCOMPLETE_REPOPULATE_INFO:"Incomplete information to re-populate. You must specify an item, a categorical data field and a data table",REPOPULATE_BY_NONCAT:"Repopulate only works on a string or date field",REPOPULATE_DT_MISMATCH:"Cannot repopulate with a data table that is different from the item's parent's data table",COMPNT_NON_REPEATABLE:"Item not repeatable",INCOMPLETE_PARTITION_INFO:"Incomplete information to divide. You must specify an item, a categorical data field and a data table",COMPNT_NON_PARTITIONABLE:"Item cannot be divided",INCOMPLETE_DENSIFY_INFO:"Incomplete information to densify. You must specify an item, a categorical data field and a data table",COMPNT_NON_DENSIFIABLE:"Item cannot be densified",BIND_WITHOUT_DATASCOPE:"Item must be repeated or divided by data first before applyng binding",UNKNOWN_ALIGNMENT:"Unkown alignment",UNKOWNN_SCALE_TYPE:"Unknown scale type",UNKNOWN_ANCHOR:"Unknown anchor",INCOMPLETE_BINDING_INFO:"Incomplete binding information. You must specify an item, a data field and a visual channel",MULTIPLE_VALUES_PER_FIELD:"Multiple distinct field values exist",DIFFERENT_SCALE_TYPE:"Cannot merge different types of scale",INSUFFICIENT_DATA_SCOPES:"Insufficient data to divide or densify a mark",INCORRECT_CONSTRAINT_INFO:"Constrain information is incorreclty passed",FEATURE_NOT_IMPLEMENTED:"This feature has not been implemented yet"};class Layout{constructor(e){this.group=void 0}run(){}clone(){}}class GridLayout extends Layout{constructor(e){super(),this.type="grid",this._numCols=e.numCols,this._numRows=e.numRows,this._dir="dir"in e?e.dir:[GridLayout.direction.Left2Right,GridLayout.direction.Top2Bottom],this._rowGap="rowGap"in e&&void 0!==e.rowGap?e.rowGap:5,this._colGap="colGap"in e&&void 0!==e.colGap?e.colGap:5,this._cellHorzAlignment="horzCellAlignment"in e?e.horzCellAlignment:Alignment.Left,this._cellVertAlignment="vertCellAlignment"in e?e.vertCellAlignment:Alignment.Bottom}toJSON(){let e={args:{}};return e.type=this.type,e.args.numCols=this._numCols,e.args.numRows=this._numRows,e.args.colGap=this._colGap,e.args.rowGap=this._rowGap,e.args.horzCellAlignment=this._cellHorzAlignment,e.args.vertCellAlignment=this._cellVertAlignment,e.left=this._left,e.top=this._top,e.args.dir=this._dir,e}clone(){return new GridLayout({numCols:this._numCols,numRows:this._numRows,dir:this._dir,colGap:this._colGap,rowGap:this._rowGap})}get cellBounds(){let e,t=this.group,i=this._colGap,s=this._rowGap;this._numRows?e=Math.ceil(this.group.children.length/this._numRows):this._numCols&&(e=this._numCols);let a=t.children.map((e=>e.bounds));if(void 0===this._left){let e=a.map((e=>e.left)),t=a.map((e=>e.top));this._left=Math.min(...e),this._top=Math.min(...t)}let r=a.map((e=>e.width)),n=a.map((e=>e.height)),o=Math.max(...r),l=Math.max(...n),h=t.getInternalEncodings("x"),c=t.getInternalEncodings("y"),d=t.getInternalEncodings("width"),u=t.getInternalEncodings("height"),p=0;switch(h.length>0?(o=h[h.length-1].scale.rangeExtent,p=h[h.length-1].scale.range[0]):d.length>0&&d[d.length-1]._rectNegativeValues&&(o=d[d.length-1].scale.rangeExtent,p=d[d.length-1].scale.range[0]),c.length>0?l=c[c.length-1].scale.rangeExtent:u.length>0&&u[u.length-1]._rectNegativeValues&&(l=u[u.length-1].scale.rangeExtent),this._dir[0]){case GridLayout.direction.Left2Right:switch(this._dir[1]){case GridLayout.direction.Top2Bottom:return t.children.map(((t,a)=>new Rectangle(this._left+(o+i)*(a%e)+p,this._top+(l+s)*Math.floor(a/e),o,l)));case GridLayout.direction.Bottom2Top:return t.children.map(((t,a)=>new Rectangle(this._left+(o+i)*(a%e)+p,this._top+(this.numRows-1-Math.floor(a/e))*(l+s),o,l)))}break;case GridLayout.direction.Right2Left:switch(this._dir[1]){case GridLayout.direction.Top2Bottom:return t.children.map(((t,a)=>new Rectangle(p+this._left+(e-1)*(o+i)-(o+i)*(a%e),this._top+(l+s)*Math.floor(a/e),o,l)));case GridLayout.direction.Bottom2Top:return t.children.map(((t,a)=>new Rectangle(p+this._left+(e-1-a%e)*(o+i),this._top+(this.numRows-1-Math.floor(a/e))*(l+s),o,l)))}break;case GridLayout.direction.Top2Bottom:switch(this._dir[1]){case GridLayout.direction.Left2Right:return t.children.map(((e,t)=>new Rectangle(p+this._left+(o+i)*Math.floor(t/this.numRows),this._top+(l+s)*(t%this.numRows),o,l)));case GridLayout.direction.Right2Left:return t.children.map(((e,t)=>new Rectangle(p+this._left+(o+i)*(this.numCols-1)-(o+i)*Math.floor(t/this.numRows),this._top+(l+s)*(t%this.numRows),o,l)))}break;case GridLayout.direction.Bottom2Top:switch(this._dir[1]){case GridLayout.direction.Left2Right:return t.children.map(((e,t)=>new Rectangle(p+this._left+(o+i)*Math.floor(t/this.numRows),this._top+(l+s)*(this.numRows-1)-(l+s)*(t%this.numRows),o,l)));case GridLayout.direction.Right2Left:return t.children.map(((e,t)=>new Rectangle(p+this._left+(o+i)*(this.numCols-1)-(o+i)*Math.floor(t/this.numRows),this._top+(l+s)*(this.numRows-1)-(l+s)*(t%this.numRows),o,l)))}}return[]}run(){if(null==this.group||!this.group.children||0===this.group.children.length)return;let e=this.cellBounds,t=this.group.getInternalEncodings("x"),i=this.group.getInternalEncodings("y"),s=this.group.getInternalEncodings("width"),a=this.group.getInternalEncodings("height");for(let s=0;s<this.group.children.length;s++){let a=this.group.children[s],r=e[s],n=r.x-a.bounds.x,o=r.y-a.bounds.y;a._doTranslate(n,o);let l=0,h=0;if(0==t.length)switch(this._cellHorzAlignment){case Alignment.Left:l=r.left-a.bounds.left;break;case Alignment.Center:l=r.x-a.bounds.x;break;case Alignment.Right:l=r.right-a.bounds.right}if(0==i.length)switch(this._cellVertAlignment){case Alignment.Top:h=r.top-a.bounds.top;break;case Alignment.Middle:h=r.y-a.bounds.y;break;case Alignment.Bottom:h=r.bottom-a.bounds.bottom}a._doTranslate(l,h)}if(t.length>0)for(let e of t)e._apply();else if(s.length>0){let e=s[s.length-1];e._rectNegativeValues&&e._apply()}if(i.length>0)for(let e of i)e._apply();else if(a.length>0){let e=a[a.length-1];e._rectNegativeValues&&e._apply()}this.group._updateBounds()}set rowGap(e){this._rowGap=e,this.run(),this.group.getScene()._relayoutAncestors(this.group)}get rowGap(){return this._rowGap}set colGap(e){this._colGap=e,this.run(),this.group.getScene()._relayoutAncestors(this.group)}get colGap(){return this._colGap}set numCols(e){this._numCols=e,this._numRows=Math.ceil(this.group.children.length/e),this.run(),this.group.getScene()._relayoutAncestors(this.group)}get numCols(){return this._numCols?this._numCols:this._numRows?Math.ceil(this.group.children.length/this._numRows):0}set numRows(e){this._numRows=e,this._numCols=Math.ceil(this.group.children.length/e),this.run(),this.group.getScene()._relayoutAncestors(this.group)}get numRows(){return this._numRows?this._numRows:this._numCols?Math.ceil(this.group.children.length/this._numCols):0}set vertCellAlignment(e){if(e!=Alignment.Top&&e!=Alignment.Bottom&&e!=Alignment.Middle)throw Errors.UNKOWN_ALIGNMENT;this._cellVertAlignment=e,this.run()}get vertCellAlignment(){return this._cellVertAlignment}set horzCellAlignment(e){if(e!=Alignment.Left&&e!=Alignment.Center&&e!=Alignment.Right)throw Errors.UNKOWN_ALIGNMENT;this._cellHorzAlignment=e,this.run()}get horzCellAlignment(){return this._cellHorzAlignment}}GridLayout.direction={Left2Right:"l2r",Right2Left:"r2l",Top2Bottom:"t2b",Bottom2Top:"b2t"};class LinearGradient{constructor(e){this._stops=[],this.type=ItemType.LinearGradient,this.id=this.type+ItemCounter[this.type]++,this.x1="x1"in e?e.x1:0,this.x2="x2"in e?e.x2:100,this.y1="y1"in e?e.y1:0,this.y2="y2"in e?e.y2:0}toJSON(){let e={};return e.type=this.type,e.id=this.id,e.x1=this.x1,e.x2=this.x2,e.y1=this.y1,e.y2=this.y2,e.stops=this._stops,e}addStop(e,t,i){this._stops.push({offset:e,color:t,opacity:i})}get stops(){return this._stops}}class Mark{constructor(e){if(this._dataScope=void 0,this._id=void 0,this.attrs={},this.styles={},void 0!==e)for(let t in Style2SVG)t in e&&(this.styles[t]=e[t])}get id(){return this._id}set id(e){this.getScene()?(delete this.getScene()._itemMap[this._id],this._id=e,this.getScene()._itemMap[e]=this):this._id=e}contains(e,t){if(!this._bounds)return!1;if(!this._bounds.contains(e,t))return!1;switch(this.type){case ItemType.Rect:case ItemType.PointText:return!0;case ItemType.Circle:return Math.sqrt(Math.pow(e-this.x,2)+Math.pow(t-this.y,2))<=this.radius+this.strokeWidth;case ItemType.Line:{let i=CanvasProvider.getContext(),s=new Path2D(this.getSVGPathData());return i.lineWidth=Math.max(this.strokeWidth,2.5),i.stroke(s),i.isPointInStroke(s,e,t)}default:{let i=CanvasProvider.getContext(),s=new Path2D(this.getSVGPathData());return i.isPointInPath(s,e,t)}}}toJSON(){let e={};e.type=this.type,e.id=this.id,this.classId&&(e.classId=this.classId),this._dataScope&&(e.dataScope=this._dataScope.toJSON()),e.args={};for(let t in this.attrs)e.args[t]=this.attrs[t];for(let t in this.styles)t.indexOf("Color")>0&&this.styles[t]instanceof LinearGradient?e.args[t]=this.styles[t].toJSON():e.args[t]=this.styles[t];return e}getScene(){let e=this;for(;e;){if(e.type==ItemType.Scene)return e;e=e.parent}}set dataScope(e){this._dataScope=e}get dataScope(){return this._dataScope}duplicate(){let e=this.getScene().mark(this.type);return this.copyPropertiesTo(e),e.classId=this.classId,this._dataScope&&(e._dataScope=this._dataScope.clone()),e}_doTranslate(e,t){}set visibility(e){this.styles.visibility=e}get visibility(){return this.styles.visibility?this.styles.visibility:"visible"}get opacity(){return"opacity"in this.styles?this.styles.opacity:1}set opacity(e){this.styles.opacity=e}}const EPSILON=1e-12,TRIGONOMETRIC_EPSILON=1e-8;function isZero(e){return e>=-EPSILON&&e<=EPSILON}class Point{constructor(e,t){this.x=e,this.y=t}transform(e){return e?e._transformPoint(this):this}negate(){return new Point(-this.x,-this.y)}subtract(e){return new Point(this.x-e.x,this.y-e.y)}isZero(){return isZero(this.x)&&isZero(this.y)}isCollinear(e){let t=this.x,i=this.y,s=e.x,a=e.y;return Math.abs(t*a-i*s)<=Math.sqrt((t*t+i*i)*(s*s+a*a))*TRIGONOMETRIC_EPSILON}}class Vertex{constructor(e,t,i){this.type="vertex",this._id=i,this.x=e.x,this.y=e.y,this.dataScope=void 0,this.parent=t,this.shape=void 0,this.width=0,this.height=0,this.radius=0,this.fillColor="#555",this.opacity=1,this.strokeWidth=0,this.strokeColor="#aaa",this._polarAngle=void 0}get id(){return this.parent.id+"_v_"+this._id}toJSON(){let e={};return e.type=this.type,e.id=this._id,e.x=this.x,e.y=this.y,this.dataScope&&(e.dataScope=this.dataScope.toJSON()),void 0!==this._polarAngle&&(e.polarAngle=this._polarAngle),e.shape=this.shape,e.width=this.width,e.height=this.height,e.radius=this.radius,e.fillColor=this.fillColor,e.opacity=this.opacity,e.strokeWidth=this.strokeWidth,e.strokeColor=this.strokeColor,e}static fromJSON(e,t){let i=new Vertex(e,t,e.id);return e.dataScope&&(i.dataScope=e.dataScope),"polarAngle"in e&&(i.polarAngle=e.polarAngle),i.shape=e.shape,i.width=e.width,i.height=e.height,i.radius=e.radius,i.fillColor=e.fillColor,i.opacity=e.opacity,i.strokeWidth=e.strokeWidth,i.strokeColor=e.strokeColor,i}_doTranslate(e,t){this.x+=e,this.y+=t}_clone(e){let t=new Vertex(new Point(this.x,this.y),e,this._id);return this.dataScope&&(t.dataScope=this.dataScope.clone()),t.shape=this.shape,t.width=this.width,t.height=this.height,t.radius=this.radius,t.fillColor=this.fillColor,t.opacity=this.opacity,t.strokeWidth=this.strokeWidth,t.strokeColor=this.strokeColor,t}set polarAngle(e){this._polarAngle=e}get polarAngle(){return this._polarAngle}}Vertex.styles=["vxShape","vxWidth","vxHeight","vxRadius","vxFillColor","vxStrokeColor","vxStrokeWidth","vxOpacity"];class Segment{constructor(e,t,i,s){this.type="segment",this._id=s,this.vertex1=e,this.vertex2=t,this.dataScope=void 0,this.parent=i}get id(){return this.parent.id+"_s_"+this._id}_doTranslate(e,t){this.vertex1._doTranslate(e,t),this.vertex2._doTranslate(e,t)}get x(){return(this.vertex1.x+this.vertex2.x)/2}get y(){return(this.vertex1.y+this.vertex2.y)/2}}class Path extends Mark{constructor(e){if(super(e),this.type=ItemType.Path,"strokeColor"in this.styles||(this.styles.strokeColor="#ccc"),"strokeWidth"in this.styles||(this.styles.strokeWidth=1),"strokeDash"in this.styles||(this.styles.strokeDash="none"),this.vertices=[],this.vertexCounter=0,this.segmentCounter=0,this.segments=[],this.anchor=void 0,this.closed=!1,this.curveMode="linear",this._vxShape=void 0,this._vxWidth=0,this._vxHeight=0,this._vxRadius=0,this._vxFillColor="#555555",this._vxStrokeColor="#aaaaaa",this._vxStrokeWidth=0,this._vxOpacity=1,void 0!==e){for(let t of Vertex.styles)t in e&&(this["_"+t]=e[t]);"vertices"in e&&this._setVertices(e.vertices)}}toJSON(){let e=super.toJSON();if(e.type=this.type,e.id=this.id,this.type===ItemType.Rect)e.args.width=this.width,e.args.height=this.height,e.args.top=this.top,e.args.left=this.left;else if(this.type===ItemType.Circle)e.args.x=this.x,e.args.y=this.y,e.args.radius=this.radius;else if(this.type===ItemType.Arc)e.args.x=this._x,e.args.y=this._y,e.args.innerRadius=this._innerRadius,e.args.outerRadius=this._outerRadius,e.args.startAngle=this._startAngle,e.args.endAngle=this._endAngle;else if(this.type===ItemType.Pie)e.args.x=this._x,e.args.y=this._y,e.args.radius=this.radius,e.args.startAngle=this.startAngleDeg,e.args.endAngle=this.endAngleDeg;else{e.vertices=[];for(let t of this.vertices)e.vertices.push(t.toJSON());this.type===ItemType.Polygon?(e.args.x=this._x,e.args.y=this._y,e.args.radius=this._radius):this.type===ItemType.Area&&(e.args.baseline=this._baseline,e.args.orientation=this._orientation)}e.vertexCounter=this.vertexCounter,e.segmentCounter=this.segmentCounter,e.curveMode=this.curveMode,this._bounds&&(e.bounds=this._bounds.toJSON());for(let t of Vertex.styles)e.args[t]=this[t];return e}_setVertices(e){let t,i;this.vertices=[],this.segments=[];for(let s=0;s<e.length;s++){i=new Point(e[s][0],e[s][1]),t=new Vertex(i,this,this.vertexCounter++);for(let e of Vertex.styles)if(this[e]){let i=e.replace("vx","");t[i[0].toLowerCase()+i.slice(1)]=this[e]}this.vertices.push(t),s>0&&this.segments.push(new Segment(this.vertices[s-1],this.vertices[s],this,this.segmentCounter++))}}copyPropertiesTo(e){e.attrs=Object.assign({},this.attrs),e.styles=Object.assign({},this.styles);for(let t of Vertex.styles)this["_"+t]&&(e["_"+t]=this["_"+t]);this._dataScope&&(e._dataScope=this._dataScope.clone()),e.closed=this.closed,e.curveMode=this.curveMode,e.vertices=[],e.segments=[];for(let t of this.vertices)e.vertices.push(t._clone(e));e.segmentCounter=0;for(let t=1;t<e.vertices.length;t++)e.segments.push(new Segment(e.vertices[t-1],e.vertices[t],e,e.segmentCounter++));e.closed&&e.segments.push(new Segment(e.vertices[e.vertices.length-1],e.vertices[0],e,e.segmentCounter++))}get bounds(){return this._bounds||this._updateBounds(),this._bounds}get x(){return this.bounds.x}get y(){return this.bounds.y}get strokeColor(){return this.styles.strokeColor}set strokeColor(e){this.styles.strokeColor=e}get strokeWidth(){return this.styles.strokeWidth}set strokeWidth(e){this.styles.strokeWidth=e}get fillColor(){return this.styles.fillColor}set fillColor(e){this.styles.fillColor=e}get strokeDash(){return this.styles.strokeDash}set strokeDash(e){this.styles.strokeDash=e}_doTranslate(e,t){for(let i of this.vertices)i._doTranslate(e,t);this._updateBounds()}resize(e,t,i,s){let a=this.bounds,r=0===a.width?1:a.width,n=0===a.height?1:a.height;if("right"===i)for(let t of this.vertices)t.x=a.right-e/r*(a.right-t.x);else for(let t of this.vertices)t.x=a.left+e/r*(t.x-a.left);if("top"===s)for(let e of this.vertices)e.y=a.top+t/n*(e.y-a.top);else for(let e of this.vertices)e.y=a.bottom-t/n*(a.bottom-e.y);this._updateBounds()}_updateBounds(){let e=this.vertices.map((e=>e.x)),t=this.vertices.map((e=>e.y)),i=Math.min(...e),s=Math.min(...t),a=Math.max(...e),r=Math.max(...t);this._bounds=new Rectangle(i,s,a-i,r-s)}addVertex(e,t,i){let s=new Vertex(new Point(e,t),this,this.vertexCounter++);this.vertices.splice(i,0,s)}sortVertices(e,t){this.vertices.sort(((t,i)=>t[e]-i[e])),t&&this.vertices.reverse();for(let e=0;e<this.segments.length;e++){let t=this.segments[e];t.vertex1=this.vertices[e],t.vertex2=this.vertices[(e+1)%this.vertices.length]}}sortVerticesByData(e,t,i){let s;s=i?(t,s)=>i.indexOf(t.dataScope.getFieldValue(e))-i.indexOf(s.dataScope.getFieldValue(e)):(t,i)=>t.dataScope.getFieldValue(e)<i.dataScope.getFieldValue(e)?-1:1,this.vertices.sort(s),t&&this.vertices.reverse();for(let e=0;e<this.segments.length;e++){let t=this.segments[e];t.vertex1=this.vertices[e],t.vertex2=this.vertices[(e+1)%this.vertices.length]}}getSVGPathData(){let e=d3__namespace.path(),t=this._getD3CurveFunction(this.curveMode)(e);t.lineStart();for(let e of this.vertices)t.point(e.x,e.y);return this.closed&&t.point(this.vertices[0].x,this.vertices[0].y),t.lineEnd(),e._}get firstVertex(){return this.vertices[0]}get firstSegment(){return this.segments[0]}_getD3CurveFunction(e){switch(e){case CurveMode.Natural:return d3__namespace.curveNatural;case CurveMode.Basis:return d3__namespace.curveBasis;case CurveMode.BumpX:return d3__namespace.curveBumpX;case CurveMode.BumpY:return d3__namespace.curveBumpY;case CurveMode.Linear:return d3__namespace.curveLinear;case CurveMode.Step:return d3__namespace.curveStep;case CurveMode.CatmullRom:return d3__namespace.curveCatmullRom;case CurveMode.Cardinal:return d3__namespace.curveCardinal;default:return d3__namespace.curveLinear}}get vxShape(){return this._vxShape}set vxShape(e){this._vxShape=e;for(let t of this.vertices)t.shape=e}get vxWidth(){return this._vxWidth}set vxWidth(e){this._vxWidth=e;for(let t of this.vertices)t.width=e}get vxHeight(){return this._vxHeight}set vxHeight(e){this._vxHeight=e;for(let t of this.vertices)t.height=e}get vxRadius(){return this._vxRadius}set vxRadius(e){this._vxRadius=e;for(let t of this.vertices)t.radius=e}get vxFillColor(){return this._vxFillColor}set vxFillColor(e){this._vxFillColor=e;for(let t of this.vertices)t.fillColor=e}get vxStrokeColor(){return this._vxStrokeColor}set vxStrokeColor(e){this._vxStrokeColor=e;for(let t of this.vertices)t.strokeColor=e}get vxStrokeWidth(){return this._vxStrokeWidth}set vxStrokeWidth(e){this._vxStrokeWidth=e;for(let t of this.vertices)t.strokeWidth=e}get vxOpacity(){return this._vxOpacity}set vxOpacity(e){this._vxOpacity=e;for(let t of this.vertices)t.opacity=e}}function findItems(e,t){let i=[];return _findItemsRecursive(e,t,i),i}function getPeers(e,t){return"vertex"==e.type?_getPeerVertices(e,t):"segment"==e.type?_getPeerSegments(e,t):e.classId?findItems(t,(t=>t.classId==e.classId)):[]}function getPeersGroupedByParent(e,t){let i={},s=getPeers(e,t);for(let e of s){let t=e.parent.id;t in i||(i[t]=[]),i[t].push(e)}return Object.keys(i).map((e=>i[e]))}function _getPeerSegments(e,t){if(e.dataScope){let i=e.parent;if(!i)throw new Error("segment has no parent mark");let s=findItems(t,(e=>e.classId==i.classId)),a=[];for(let e of s)a=a.concat(e.segments);return a}{let i=e.parent;if(!i)throw new Error("segment has no parent mark");let s=i.segments.indexOf(e),a=findItems(t,(e=>e.classId==i.classId)),r=[];for(let e of a)r.push(e.segments[s]);return r}}function _getPeerVertices(e,t){if(!e.classId){if(e.dataScope){let i=e.parent;if(!i)throw new Error("vertex has no parent mark");let s=findItems(t,(e=>e.classId==i.classId)),a=[];if(i.type===ItemType.Area){let t=i.vertices.indexOf(e)<i.vertices.length/2;for(let e of s){let i=t?e.vertices.slice(0,e.vertices.length/2):e.vertices.slice(e.vertices.length/2);a=a.concat(i.filter((e=>e.dataScope)))}}else for(let e of s)a=a.concat(e.vertices.filter((e=>e.dataScope)));return a}{let i=e.parent;if(!i)throw new Error("vertex has no parent mark");let s=i.vertices.indexOf(e),a=findItems(t,(e=>e.classId==i.classId)),r=[];for(let e of a)r.push(e.vertices[s]);return r}}}function _findItemsRecursive(e,t,i){if(e&&"axis"!=e.type&&"legend"!=e.type&&"gridlines"!=e.type)if(_matchCriteria(e,t)&&i.push(e),e.vertices)for(let s of e.vertices.concat(e.segments))_matchCriteria(s,t)&&i.push(s);else if(e.children&&e.children.length>0)for(let s of e.children)_findItemsRecursive(s,t,i)}function _matchCriteria(e,t){return t(e)}function getClosestLayout(e,t){let i=e.parent;for(;i&&i.type!=ItemType.Scene;){if(i.layout&&(!t||t&&i.layout.type===t))return i.layout;i=i.parent}}function getCellBoundsInLayout(e){let t=e,i=e.parent;for(;i&&i.type!=ItemType.Scene;){if(i.layout){let e=i.children.findIndex((e=>e==t));return i.layout.cellBounds[e]}t=t.parent,i=t.parent}}function getCellBoundsInGridLayout(e){let t=e,i=e.parent;for(;i&&i.type!=ItemType.Scene;){if(i.layout&&i.layout.type==LayoutType.Grid){let e=i.children.findIndex((e=>e==t));return i.layout.cellBounds[e]}t=t.parent,i=t.parent}}function getTopLevelLayout(e,t){let i,s=e.parent;for(;s&&s.type!==ItemType.Scene;)s.layout&&(!t||t&&s.layout.type===t)&&(i=s.layout),s=s.parent;return i}function getEncodingKey(e){if(e.classId)return e.classId;if("vertex"==e.type&&e.dataScope){if(e.parent.type===ItemType.Area){let t=e.parent.vertices.indexOf(e)<e.parent.vertices.length/2;return e.parent.classId+"_v_"+(t?0:e.parent.vertices.length-1)}return e.parent.classId+"_v"}return"vertex"==e.type?e.parent.classId+"_v_"+e.parent.vertices.indexOf(e):"segment"==e.type&&e.dataScope?e.parent.classId+"_s":"segment"==e.type?e.parent.classId+"_s_"+e.parent.segments.indexOf(e):null}function getParents(e){let t=[];for(let i of e)i.parent&&t.indexOf(i.parent)<0&&t.push(i.parent);return t}function getLeafItems(e){let t=[];if(e.children&&e.children.length>0)for(let i of e.children)t=t.concat(getLeafItems(i));else t.push(e);return t}function isGuide(e){return e.type===ItemType.Axis||e.type===ItemType.Legend||e.type===ItemType.Gridlines}function isMark(e){return e instanceof Mark}function isPath(e){return e instanceof Path}const ItemCounter={area:0,rect:0,circle:0,pie:0,line:0,path:0,ring:0,arc:0,image:0,pointText:0,collection:0,group:0,scene:0,axis:0,glyph:0,legend:0,polygon:0,gridlines:0,LinearGradient:0,link:0,scale:0,datatable:0};function canAlign(e,t,i){if(t==Alignment.Top||t==Alignment.Bottom||t==Alignment.Middle){for(let t of e)if(!canMoveVertically(t,i))return!1;return!0}if(t==Alignment.Left||t==Alignment.Right||t==Alignment.Center){for(let t of e)if(!canMoveHorizontally(t,i))return!1;return!0}}function canMoveHorizontally(e,t){if(t.getEncodingByItem(e,"x"))return!1;if(e.parent&&e.parent.layout){let t=e.parent.layout;if(t.type==LayoutType.Grid&&t.numCols>1)return!1}return!e.parent||e.parent.type==ItemType.Scene||canMoveHorizontally(e.parent,t)}function canMoveVertically(e,t){if(t.getEncodingByItem(e,"y"))return!1;if(e.parent&&e.parent.layout){let t=e.parent.layout;if(t.type==LayoutType.Grid&&t.numRows>1)return!1}return!e.parent||e.parent.type==ItemType.Scene||canMoveVertically(e.parent,t)}var CanvasProvider={canvas:void 0,getCanvas:function(){return window?(void 0===this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas):null},getContext:function(){var e=this.getCanvas();return e?e.getContext("2d"):null}},SVGProvider={svg:void 0,getSVG:function(){return window?(void 0===this.svg&&(this.svg=document.createElement("svg")),this.svg):null}};function getTextSize(e,t,i){let s=CanvasProvider.getContext();s.font=t;let a=s.measureText(e);return a.actualBoundingBoxAscent?{width:a.width,height:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent}:{width:a.width,height:i}}function getTopLevelGroup(e){let t=e.parent;return t.type==ItemType.Scene?e:getTopLevelGroup(t)}function polar2Cartesian(e,t,i,s){return[i*Math.cos(degree2radian(s))+e,t-i*Math.sin(degree2radian(s))]}function cartesian2Polar(e,t,i,s){let a=radian2degree(Math.atan2(s-t,e-i));a=Math.round(10*a+Number.EPSILON)/10,a<0&&(a+=360);let r=Math.sqrt(Math.pow(e-i,2)+Math.pow(t-s,2));return r=Math.round(10*r+Number.EPSILON)/10,[a,r]}function degree2radian(e){return e*Math.PI/180}function radian2degree(e){return 180*e/Math.PI}function CheckAreaOrien(e){let t=e.vertices.length;for(let i=0;i<e.vertices.length/2;i++){let s=i,a=t-i-1,r=e.vertices[s],n=e.vertices[a];if(r.x!=n.x||r.y!=n.y)return r.x==n.x?"horizontal":"vertical"}}class Group{constructor(){this.children=[],this._dataScope=void 0,this._layout=void 0,this.type=ItemType.Group,this._id=this.type+ItemCounter[this.type]++}get id(){return this._id}set id(e){this.type!==ItemType.Scene&&this.getScene()?(delete this.getScene()._itemMap[this._id],this._id=e,this.getScene()._itemMap[e]=this):this._id=e}contains(e,t){return this._bounds||this._updateBounds(),this._bounds.contains(e,t)}toJSON(){let e={};if(e.type=this.type,e.id=this.id,this._dataScope&&(e.dataScope=this._dataScope.toJSON()),this.classId&&(e.classId=this.classId),this._layout&&(e.layout=this._layout.toJSON()),this._bounds&&(e.bounds=this._bounds.toJSON()),this.children.length>0&&this.type!=ItemType.Axis){e.children=[];for(let t of this.children)e.children.push(t.toJSON())}return this.childrenOrder&&(e.childrenOrder=this.childrenOrder),e}addChild(e){e.parent&&e.parent.removeChild(e),this.children.push(e),e.parent=this}addChildAt(e,t){e.parent&&e.parent.removeChild(e),this.children.splice(t,0,e),e.parent=this}removeChild(e){let t=this.children.indexOf(e);t>=0&&this.children.splice(t,1),e.parent=null}removeChildAt(e){this.children[e].parent=null,this.children.splice(e,1)}removeAll(){for(let e of this.children)e.parent=null;this.children=[]}getScene(){let e=this;for(;e;){if(e.type==ItemType.Scene)return e;e=e.parent}}get dataScope(){return this._dataScope}set dataScope(e){if(this._dataScope=e,void 0===e)for(let t of this.children)t.dataScope=e;else for(let t of this.children)t.dataScope?t.dataScope=t.dataScope.merge(e):t.dataScope=e}_doTranslate(e,t){for(let i of this.children)i._doTranslate(e,t);this._updateBounds(),this._layout&&(void 0!==this._layout._left&&(this._layout._left+=e),void 0!==this._layout._top&&(this._layout._top+=t),void 0!==this._layout.x&&(this._layout.x+=e),void 0!==this._layout.y&&(this._layout.y+=t)),this._updateBounds()}getInternalEncodings(e){if(0==this.children.length)return[];let t=this.children[0],i=this.getScene(),s=Object.keys(i.encodings),a=[];for(;t&&(t.classId&&a.indexOf(t.classId)<0&&a.push(t.classId),t.children);)t=t.children[0];let r=[];for(let t of s){let s=t.split("_");for(let n of a)s[0]==n&&i.encodings[t][e]&&r.push(i.encodings[t][e])}return r}get firstChild(){return this.children[0]}get lastChild(){return this.children[this.children.length-1]}set layout(e){if(this._layout=e,e)e.group=this,this._layout.run();else{let e=this.getInternalEncodings("x"),t=this.getInternalEncodings("y");for(let t of e)t._map(),t._apply();for(let e of t)e._map(),e._apply()}}get layout(){return this._layout}get bounds(){return this._bounds||this._updateBounds(),this._bounds}get x(){return this.bounds.x}get y(){return this.bounds.y}_updateBounds(){if(this.children.length>0){this._bounds=this.children[0].bounds.clone();for(let e=1;e<this.children.length;e++)"hidden"!=this.children[e].visibility&&(this._bounds=this._bounds.union(this.children[e].bounds));if(this._layout&&"grid"==this._layout.type){let e=this._layout.cellBounds;for(let t=0;t<e.length;t++)this._bounds=this._bounds.union(e[t])}}else this._bounds=new Rectangle(0,0,0,0)}sortChildrenByData(e,t,i){let s;switch(this.children[0].dataScope.getFieldType(e)){case DataType.Date:break;case DataType.Number:case DataType.Integer:s=(t,i)=>t.dataScope.aggregateNumericalField(e)-i.dataScope.aggregateNumericalField(e);break;case DataType.String:s=i?(t,s)=>i.indexOf(t.dataScope.getFieldValue(e))-i.indexOf(s.dataScope.getFieldValue(e)):(t,i)=>t.dataScope.getFieldValue(e)<i.dataScope.getFieldValue(e)?-1:1}this.children.sort(s),t&&this.children.reverse(),this.layout&&this.layout.run(),this.childrenOrder={field:e,reverse:t,order:i}}sortChildren(e,t){let i;switch(e){case"x":case"y":case"width":case"height":i=(t,i)=>t.bounds[e]-i.bounds[e];break;default:i=(t,i)=>t[e]-i[e]}this.children.sort(i),t&&this.children.reverse(),this.layout&&this.layout.run(),this.childrenOrder={channel:e,reverse:t}}set visibility(e){this._visibility="hidden"==e?e:"visible";for(let t of this.children)t.visibility=e}get visibility(){return this._visibility?this._visibility:"visible"}}function uniqueNumbers(e){return[...new Set(e)]}function validateField(e,t){if(t.hasField(e))return!0;if(t.tree&&t.tree.nodeTable.hasField(e.split(".")[1]))return!0;throw new Error(Errors.FIELD_NONEXISTENT+", field: "+e+", data table: "+t.name)}class DataScope{constructor(e){this._field2value={},this._dt=e,this._tuples=this._dt.data}toJSON(){let e={};return e.dt=this._dt.id,e.f2v=Object.assign({},this._field2value),e}isFullTable(){return 0===Object.keys(this._field2value).length}isEmpty(){return 0==this._tuples.length}get numTuples(){return this._tuples.length}get fields(){return Object.keys(this._field2value)}get dataTable(){return this._dt}get filters(){return this._field2value}merge(e){let t=new DataScope(this._dt);for(let i in e._field2value)t=t.cross(i,e._field2value[i]);for(let e in this._field2value)t=t.cross(e,this._field2value[e]);return t}cross(e,t){let i=this.clone();return i._field2value[e]=t,i._updateTuples(e,t),i}clone(){let e=new DataScope(this._dt);return e._field2value=Object.assign({},this._field2value),e._tuples=this._tuples.map((e=>e)),e}getFieldValue(e){let t=this._tuples.map((t=>t[e]));return t=[...new Set(t)],t.length,t[0]}getUniqueFieldValues(e){let t=this._tuples.map((t=>t[e]));return[...new Set(t)]}hasField(e){return e in this._field2value}getFieldType(e){return this._dt.getFieldType(e)}aggregateNumericalField(e,t){let i=this._tuples.map((t=>t[e]));switch(t){case Aggregator.Max:return Math.max(...i);case Aggregator.Min:return Math.min(...i);case Aggregator.Avg:case Aggregator.Mean:return d3__namespace.mean(i);case Aggregator.Median:return d3__namespace.median(i);case Aggregator.Count:return i.length;case Aggregator.Percentile25:return d3__namespace.quantile(i,.25);case Aggregator.Percentile75:return d3__namespace.quantile(i,.75);case Aggregator.Sum:default:return d3__namespace.sum(i)}}_updateTuples(e,t){this._tuples=this._tuples.filter((i=>i[e]==t))}}function repeatItem(e,t,i,s,a){let r=a?s.transformField(i,a):i,n=s.getFieldType(r);if(n!=DataType.String&&n!=DataType.Date&&n!=DataType.Integer)throw new Error(Errors.REPEAT_BY_NONCAT+": "+r+" is "+n);if(!canRepeat(t))throw new Error(Errors.COMPNT_NON_REPEATABLE);return _doRepeat(e,t,r,s)}function _doRepeat(e,t,i,s){let a=s.getFieldSummary(i).unique.map((e=>t.dataScope?t.dataScope.cross(i,e):new DataScope(s).cross(i,e))),r=e.collection();r.dataScope=t.dataScope?t.dataScope.clone():new DataScope(s),e.addChild(r),r.addChild(t);for(let e=1;e<a.length;e++){let e=t.duplicate();r.addChild(e)}return r.children.forEach(((e,t)=>e.dataScope=a[t])),e._reapplySizeBindings(t),r}class StackLayout extends Layout{constructor(e){super(e),this.type=LayoutType.Stack,this._orientation=e.orientation,this._left=e.left,this._top=e.top,this._horzCellAlignment="horzCellAlignment"in e&&e.horzCellAlignment?e.horzCellAlignment:Alignment.Left,this._vertCellAlignment="vertCellAlignment"in e&&e.vertCellAlignment?e.vertCellAlignment:Alignment.Bottom,this._gap="gap"in e?e.gap:0}toJSON(){let e={args:{}};return e.type=this.type,e.args.orientation=this._orientation,e.args.left=this._left,e.args.top=this._top,e.args.gap=this._gap,e.args.horzCellAlignment=this._horzCellAlignment,e.args.vertCellAlignment=this._vertCellAlignment,e}clone(){let e=new StackLayout({orientation:this._orientation,left:this._left,top:this._top});return e._horzCellAlignment=this._horzCellAlignment,e._vertCellAlignment=this._vertCellAlignment,e}_stackAreasVert(){let e=this.group.children,t=this.group.bounds,i=this._vertCellAlignment===Alignment.Top?t.top:t.bottom,s=this._vertCellAlignment===Alignment.Top?1:-1,a=e[0].vertices.length/2,r=new Array(a).fill(0);for(let t of e){for(let e=0;e<a;e++){let n=t.vertices[e],o=t.vertices[2*a-e-1],l=Math.abs(n.y-o.y),h=i+r[e]*s,c=i+(r[e]+l)*s;n._doTranslate(0,h-n.y),o._doTranslate(0,c-o.y),r[e]+=l}t._updateBounds()}if(this.vertCellAlignment===Alignment.Middle)for(let i of e){for(let e=0;e<a;e++){let s=i.vertices[e],n=i.vertices[2*a-e-1],o=t.middle+r[e]/2;s._doTranslate(0,o-t.bottom),n._doTranslate(0,o-t.bottom)}i._updateBounds()}this.group._updateBounds()}_stackAreasHorz(){let e=this.group.children,t=this.group.bounds,i=this._horzCellAlignment===Alignment.Right?t.right:t.left,s=this._horzCellAlignment===Alignment.Right?-1:1,a=e[0].vertices.length/2,r=new Array(a).fill(0);for(let t of e){for(let e=0;e<a;e++){let n=t.vertices[e],o=t.vertices[2*a-e-1],l=Math.abs(n.x-o.x),h=i+r[e]*s,c=i+(r[e]+l)*s;n._doTranslate(0,h-n.y),o._doTranslate(0,c-o.y),r[e]+=l}t._updateBounds()}if(this._horzCellAlignment===Alignment.Center)for(let i of e){for(let e=0;e<a;e++){let s=i.vertices[e],n=i.vertices[2*a-e-1],o=t.center-r[e]/2;s._doTranslate(0,o-t.left),n._doTranslate(0,o-t.left)}i._updateBounds()}this.group._updateBounds()}_stackAreas(){this.group.children[0].orientation===Orientation.Horizontal?this._stackAreasVert():this._stackAreasHorz()}_stackRects(){let e=this.group.getScene(),t=this.group,i=this._orientation,s=t.children.map((e=>e.bounds)),a=s.map((e=>e.left)),r=s.map((e=>e.top)),n=s.map((e=>e.width)),o=s.map((e=>e.height)),l=null==this._left?Math.min(...a):this._left,h=null==this._top?Math.min(...r):this._top,c=Math.max(...n),d=Math.max(...o);if(i==Orientation.Vertical){let i=l+c/2;for(let s=0;s<t.children.length;s++){let a=t.children[s],r=i-a.bounds.x,n=h+a.bounds.height/2-a.bounds.y;h+=a.bounds.height+this._gap,a._doTranslate(r,n);let o=0,d=0;if(!e.getEncodingByItem(a,"x"))switch(this._horzCellAlignment){case Alignment.Left:o=l-a.bounds.left;break;case Alignment.Center:o=l+c/2-a.bounds.x;break;case Alignment.Right:o=l+c-a.bounds.right}a._doTranslate(o,d)}}else{let i=h+d/2;for(let s=0;s<t.children.length;s++){let a=t.children[s],r=l+a.bounds.width/2-a.bounds.x,n=i-a.bounds.y;l+=a.bounds.width+this._gap,a._doTranslate(r,n);let o=0,c=0;if(!e.getEncodingByItem(a,"y"))switch(this._vertCellAlignment){case Alignment.Top:c=h-a.bounds.top;break;case Alignment.Middle:c=h+d/2-a.bounds.y;break;case Alignment.Bottom:c=h+d-a.bounds.bottom}a._doTranslate(o,c)}}this.group._updateBounds()}run(){null!=this.group&&this.group.children&&0!==this.group.children.length&&("area"==this.group.children[0].type?this._stackAreas():this._stackRects())}set vertCellAlignment(e){if(e!=Alignment.Top&&e!=Alignment.Bottom&&e!=Alignment.Middle)throw Errors.UNKOWN_ALIGNMENT;this._vertCellAlignment=e,this.run()}get vertCellAlignment(){return this._vertCellAlignment}set horzCellAlignment(e){if(e!=Alignment.Left&&e!=Alignment.Center&&e!=Alignment.Right)throw Errors.UNKOWN_ALIGNMENT;this._horzCellAlignment=e,this.run()}get horzCellAlignment(){return this._horzCellAlignment}get cellBounds(){return this.group.children.map((e=>e.bounds))}get orientation(){return this._orientation}set orientation(e){this._orientation=e,this.run()}}function divideItem(e,t,i,s,a,r){let n=r?a.transformField(s,r):s,o=a.getFieldType(n);if(o!=DataType.String&&o!=DataType.Date)throw new Error(Errors.PARTITION_BY_NONCAT+": "+n+" is "+o);if(!canDivide(t))throw new Error(Errors.COMPNT_NON_PARTITIONABLE);switch(t.type){case ItemType.Line:return _doLineDivide(e,t,n,a);case ItemType.Circle:return _doCircleDivide(e,t,i,n,a);case ItemType.Rect:return _doRectDivide(e,t,i,n,a);case ItemType.Area:return _doAreaDivide(e,t,i,n,a);case ItemType.Ring:return _doRingDivide(e,t,i,n,a)}}function _doLineDivide(e,t,i,s){let a,r,n=getPeers(t,e),o=s.getFieldSummary(i).unique.map((e=>new DataScope(s).cross(i,e))),l={},h=0;for(let e of n){let t=o;e.dataScope&&(t=o.map((t=>t.merge(e.dataScope))),t=t.filter((e=>!e.isEmpty()))),t.length>h&&(h=t.length),l[e.id]=t}for(let i of n){let s=e.collection();null==r&&(r=s.id),s.classId=r,s.dataScope=i.dataScope,i.parent.addChild(s);let n=l[i.id],o=i.vertices[0].x,c=i.vertices[0].y,d=i.vertices[1].x,u=i.vertices[1].y;i.classId=t.id,i.vertices[0].x=o,i.vertices[0].y=c,i.vertices[1].x=o+(d-o)/h,i.vertices[1].y=c+(u-c)/h,i.dataScope=n[0],s.addChild(i);for(let e=1;e<n.length;e++){let t=i.duplicate();t.vertices[0].x=o+(d-o)*e/h,t.vertices[0].y=c+(u-c)*e/h,t.vertices[1].x=o+(d-o)*(e+1)/h,t.vertices[1].y=c+(u-c)*(e+1)/h,t.dataScope=n[e],s.addChild(t)}i==t&&(a=s)}return a}function _doRectDivide(e,t,i,s,a){let r,n,o=getPeers(t,e),l=i||Orientation.Horizontal,h=a.getFieldSummary(s).unique.map((e=>new DataScope(a).cross(s,e))),c={},d=0;for(let e of o){let t=h;e.dataScope&&(t=h.map((t=>t.merge(e.dataScope))),t=t.filter((e=>!e.isEmpty()))),t.length>d&&(d=t.length),c[e.id]=t}for(let i of o){let s=e.collection();null==n&&(n=s.id),s.classId=n,s.dataScope=i.dataScope?i.dataScope:new DataScope(a),i.parent.addChild(s);let o=c[i.id],h=i.bounds,u=h.left,p=h.top,_=l==Orientation.Horizontal?h.width/d:h.width,g=l==Orientation.Horizontal?h.height:h.height/d;i.classId=t.id,i.resize(_,g),i.dataScope=o[0],s.addChild(i);for(let e=1;e<o.length;e++){let t=i.duplicate();t.resize(_,g),t.dataScope=o[e],s.addChild(t)}s.layout=new StackLayout({orientation:l,left:u,top:p}),i==t&&(r=s)}return e._reapplySizeBindings(r),r}function _doAreaDivide(e,t,i,s,a){let r,n=getPeers(t,e),o=n[0];if(4==o.vertices.length&&i==Orientation.Horizontal&&o.vertices[0].x!==o.vertices[1].x)for(let e of n){let t=e.vertices[1];e.vertices[1]=e.vertices[3],e.vertices[3]=t}let l,h=a.getFieldSummary(s).unique.map((e=>new DataScope(a).cross(s,e)));for(let s of n){let n=e.collection();null==l&&(l=n.id),n.classId=l,n.dataScope=s.dataScope?s.dataScope:new DataScope(a),s.parent.addChild(n);let o=s.left,c=s.top,d=i==Orientation.Horizontal?s.width/h.length:s.width,u=i==Orientation.Horizontal?s.height:s.height/h.length;s.classId=t.id,s.resizeArea(d,u),n.addChild(s);for(let e=1;e<h.length;e++){let e=s.duplicate();e.resizeArea(d,u),n.addChild(e)}for(let e=0;e<n.children.length;e++){let t=n.children[e];t.dataScope?t.dataScope=t.dataScope.merge(h[e]):t.dataScope=h[e];for(let e of t.vertices)e.dataScope?e.dataScope=t.dataScope.merge(e.dataScope):e.dataScope=t.dataScope}n.layout=new StackLayout({orientation:i,left:o,top:c}),s==t&&(r=n)}return e._reapplySizeBindings(r),r}function _doRingDivide(e,t,i,s,a){let r,n,o=i||Orientation.Angular,l=getPeers(t,e);if(o==Orientation.Angular)return l.forEach((i=>{let o=i.dataScope?i.dataScope:new DataScope(a),l=a.getFieldSummary(s).unique.map((e=>o.cross(s,e)));l=l.filter((e=>!e.isEmpty()));let h=l.length,c=e.collection();c.dataScope=o,null==n&&(n=c.id),c.classId=n;let d=i.parent,u=360/h;for(let s=0;s<h;s++){let a=e.mark("arc",{innerRadius:i.innerRadius,outerRadius:i.outerRadius,x:i.x,y:i.y,startAngle:_normalizeAngle(90-u*(s+1)),endAngle:_normalizeAngle(90-u*s),strokeColor:i.strokeColor,fillColor:i.fillColor,strokeWidth:i.strokeWidth,opacity:i.opacity});a.dataScope=l[s],a.classId=t.id,c.addChild(a)}d.removeChild(i),d.addChild(c),i==t&&(r=c)})),r}function _normalizeAngle(e){return e<0?e+360:e>360?e-360:e}function _doCircleDivide(e,t,i,s,a){let r,n,o=i||Orientation.Angular,l=getPeers(t,e);return o==Orientation.Angular?l.forEach((i=>{let o=i.dataScope?i.dataScope:new DataScope(a),l=a.getFieldSummary(s).unique.map((e=>o.cross(s,e)));l=l.filter((e=>!e.isEmpty()));let h=l.length,c=e.collection();c.dataScope=o,null==n&&(n=c.id),c.classId=n;let d=i.parent,u=360/h;for(let s=0;s<h;s++){let a=e.mark("pie",{radius:i.radius,x:i.x,y:i.y,startAngle:_normalizeAngle(90-u*(s+1)),endAngle:_normalizeAngle(90-u*s),strokeColor:"#444444",fillColor:i.styles.fillColor});a.dataScope=l[s],a.classId=t.id,c.addChild(a)}d.removeChild(i),d.addChild(c),i==t&&(r=c)})):l.forEach((i=>{let o=i.dataScope?i.dataScope:new DataScope(a),l=a.getFieldSummary(s).unique.map((e=>o.cross(s,e)));l=l.filter((e=>!e.isEmpty()));let h=l.length,c=e.collection();c.dataScope=o,null==n&&(n=c.id),c.classId=n;let d=i.parent,u=i.radius/h;for(let s=0;s<h;s++){let a=e.mark("ring",{x:i.x,y:i.y,innerRadius:s*u,outerRadius:(s+1)*u,strokeColor:i.strokeColor,fillColor:i.styles.fillColor});a.dataScope=l[s],a.classId=t.id,c.addChild(a)}d.removeChild(i),d.addChild(c),i==t&&(r=c)})),r}function densifyItem(e,t,i,s,a,r,n,o){let l=r?a.transformField(s,r):s,h=a.getFieldType(l);if(h!=DataType.String&&h!=DataType.Date&&h!=DataType.Number)throw new Error(Errors.DENSIFY_BY_NONCAT+": "+l+" is "+h);if(!canDensify(t))throw new Error(Errors.COMPNT_NON_DENSIFIABLE);switch(t.type){case ItemType.Line:return _doLineDensify(e,t,l,a);case ItemType.Circle:return _doCircleDensify(e,t,l,a,n,o);case ItemType.Rect:case ItemType.Area:return _doAreaDensify(e,t,i,l,a)}}function _doLineDensify(e,t,i,s){let a,r=getPeers(t,e);for(let n of r){let r=n.dataScope?n.dataScope:new DataScope(s),o=s.getFieldSummary(i).unique.map((e=>r.cross(i,e)));o=o.filter((e=>!e.isEmpty()));let l=Object.assign({},n.styles);for(let e of Vertex.styles)n[e]&&(l[e]=n[e]);let h=n.vertices[0].x,c=n.vertices[0].y,d=[],u=n.vertices[1].x-h,p=n.vertices[1].y-c;for(let e=0;e<o.length;e++)d.push([h+e*u/(o.length-1),c+e*p/(o.length-1)]);l.vertices=d;let _=e.mark("path",l);_.classId=t.id,_.dataScope=r;let g=n.parent;g.addChild(_),g.removeChild(n);for(let[e,t]of _.vertices.entries())t.dataScope?t.dataScope=t.dataScope.merge(o[e]):t.dataScope=o[e];n==t&&(a=_)}return a}function _doAreaDensify(e,t,i,s,a){let r,n=getPeers(t,e);for(let o of n){let n=a.getFieldType(s),l=o.dataScope?o.dataScope:new DataScope(a),h=a.getFieldSummary(s).unique.map((e=>l.cross(s,e)));h=n==DataType.Number?h:h.filter((e=>!e.isEmpty())),n!=DataType.Number&&n!=DataType.Date||h.sort(((e,t)=>e._field2value[s]>t._field2value[s]?1:-1));let c=Object.assign({},o.styles),d=o.vertices[0].x,u=o.vertices[0].y,p=o.vertices[o.vertices.length-2].x,_=o.vertices[o.vertices.length-2].y,g=[],f=p-d,y=_-u;for(let e=0;e<h.length;e++)g.push(i==Orientation.Vertical?[p,u+(h.length-1-e)*y/(h.length-1)]:[d+e*f/(h.length-1),u]);for(let e=0;e<h.length;e++)g.push(i==Orientation.Vertical?[d,u+e*y/(h.length-1)]:[d+(h.length-1-e)*f/(h.length-1),_]);c.vertices=g;let m=e.mark("area",c);m.classId="area"==o.type?o.classId:"area"+o.classId.substring(9),m.dataScope=l,m.orientation=i,m.baseline=i===Orientation.Horizontal?Alignment.Bottom:Alignment.Left;let b=o.parent;b.addChild(m),b.removeChild(o);for(let[e,t]of m.vertices.entries())e>=h.length?t.dataScope=l.merge(h[2*h.length-1-e]):t.dataScope=l.merge(h[e]);o==t&&(r=m)}return r}function _doCircleDensify(e,t,i,s,a,r){let n;return getPeers(t,e).forEach((o=>{let l=o.dataScope?o.dataScope:new DataScope(s),h=s.getFieldSummary(i).unique.map((e=>l.cross(i,e)));h=h.filter((e=>!e.isEmpty()));let c=h.length;if(c<3)throw Error(Errors.INSUFFICIENT_DATA_SCOPES);let d=360/c,u=[],p=[],_="clockwise"==r?-1:1;for(let e=0;e<h.length;e++){let t=a+_*e*d;p[e]=t;let i=polar2Cartesian(o.x,o.y,o.radius,p[e]);u.push(i)}let g=e.mark("polygon",{x:o.x,y:o.y,radius:o.radius,vertices:u});g.dataScope=l,g.styles=Object.assign({},o.styles);for(let e of Vertex.styles)o[e]&&(g[e]=o[e]);let f=o.parent;f.addChild(g),f.removeChild(o);for(let[e,t]of g.vertices.entries())t.polarAngle=p[e],t.dataScope?t.dataScope=t.dataScope.merge(h[e]):t.dataScope=h[e];o==t&&(n=g)})),n}class RectPath extends Path{constructor(e){super(e),this.type=ItemType.Rect,this.closed=!0,e&&"vertices"in e&&this.segments.push(new Segment(this.vertices[3],this.vertices[0],this,this.segmentCounter++))}get width(){return this.vertices[1].x-this.vertices[0].x}get height(){return this.vertices[2].y-this.vertices[1].y}set height(e){this.resize(this.width,e)}set width(e){this.resize(e,this.height)}get left(){return this.vertices[0].x}get top(){return this.vertices[0].y}get right(){return this.vertices[1].x}get bottom(){return this.vertices[2].y}get area(){return this.width*this.height}resize(e,t,i,s){"right"===i?(this.vertices[0].x=this.vertices[1].x-e,this.vertices[3].x=this.vertices[0].x):(this.vertices[1].x=this.vertices[0].x+e,this.vertices[2].x=this.vertices[1].x),"top"===s?(this.vertices[3].y=this.vertices[0].y+t,this.vertices[2].y=this.vertices[3].y):(this.vertices[0].y=this.vertices[3].y-t,this.vertices[1].y=this.vertices[0].y),this._updateBounds()}get leftSegment(){return this.segments[3]}get rightSegment(){return this.segments[1]}get topSegment(){return this.segments[0]}get bottomSegment(){return this.segments[2]}}class CirclePath extends Path{constructor(e){super(e),this.type=ItemType.Circle,this.closed=!0,this.attrs.x="x"in e?e.x:0,this.attrs.y="y"in e?e.y:0,this.attrs.radius="radius"in e?e.radius:100}get radius(){return this.attrs.radius}get x(){return this.attrs.x}get y(){return this.attrs.y}get area(){return Math.PI*Math.pow(this.radius,2)}set x(e){this.attrs.x=e,this._updateBounds()}set y(e){this.attrs.y=e,this._updateBounds()}set radius(e){this.attrs.radius=e,this._updateBounds()}resize(e,t){this.attrs.radius=Math.min(e,t)/2,this._updateBounds()}_doTranslate(e,t){this.attrs.x+=e,this.attrs.y+=t,this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this.attrs.x-this.attrs.radius,this.attrs.y-this.attrs.radius,2*this.attrs.radius,2*this.attrs.radius)}copyPropertiesTo(e){super.copyPropertiesTo(e),e.attrs.x=this.attrs.x,e.attrs.y=this.attrs.y,e.attrs.radius=this.attrs.radius}getSVGPathData(){return["M",this.x,this.y,"m",-this.radius,", 0 a",this.radius,",",this.radius,"0 1,0",2*this.radius,",0 a",this.radius,",",this.radius,"0 1,0",-2*this.radius,",0"].join(" ")}}function bindToSize(e){return e._query=function(){this.data=[];let e=this.field,t=this.items,i=this.aggregator;switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:this.data=t.map((t=>t.dataScope.getFieldValue(e)));break;case DataType.String:break;default:this.data=t.map((t=>t.dataScope.aggregateNumericalField(e,i)))}},e._map=function(){let e,t=this.items,i=this.data,s=this.channel;if(e=createScale(this.scaleType?this.scaleType:"linear"),null==this.data.find((e=>e<0))||"width"!=s&&"height"!=s||0!=t[0].type.indexOf("rect")){let a,r;e.domain=[0,Math.max(...i)],"radius"==s||"outerRadius"==s||"innerRadius"==s?(a=0,r=Math.max(...t.map((e=>e[s]))),r<20&&(r=20)):"area"==s?(a=0,r=Math.max(...t.map((e=>Math.pow(e.bounds.width,2)))),r<400&&(r=400)):"fontSize"==s?(a=2,r=Math.max(...t.map((e=>parseFloat(e.styles.fontSize))))):"strokeWidth"==s?(a=1,r=Math.max(...t.map((e=>parseFloat(e.styles.strokeWidth)))),r==a&&(r=a+5)):(a=0,r=Math.max(...t.map((e=>e.bounds[s])))),this.rangeExtent&&(r=a+this.rangeExtent),this.range&&(a=this.range[0],r=this.range[1]),e._setRange([a,r])}else this._rectNegativeValues=!0,e.domain=[Math.min(...i),Math.max(...i)],"width"==s?e._setRange([0,Math.max(...t.map((e=>e.width)))]):e._setRange([0,Math.max(...t.map((e=>e.height)))]);this.scale||(this.scale=e),this.scale._addEncoding(this)},e._apply=function(){if("radius"==this.channel||"outerRadius"==this.channel||"innerRadius"==this.channel){for(let e=0;e<this.items.length;e++){this.items[e][this.channel]=this.scale.map(this.data[e])}this.scene._relayoutAncestors(this.anyItem,this.items)}else if(this._rectNegativeValues){if("width"==this.channel){let e=Math.min(...this.items.map((e=>e.bounds.left)));for(let t=0;t<this.items.length;t++){let i,s=this.items[t],a=s.leftSegment.vertex1.x,r=s.rightSegment.vertex1.x;i=s.parent&&s.parent.type==ItemType.Collection?s.parent.bounds.left:e,s.rightSegment._doTranslate(i+this.scale.map(this.data[t])-r,0),s.leftSegment._doTranslate(i+this.scale.map(0)-a,0),s._updateBounds()}}else if("height"==this.channel){let e=Math.min(...this.items.map((e=>e.bounds.top)))+this.scale.rangeExtent;for(let t=0;t<this.items.length;t++){let i,s=this.items[t],a=s.topSegment.vertex1.y,r=s.bottomSegment.vertex1.y;if(s.parent&&s.parent.type===ItemType.Collection){let e=s.parent.parent;if(e.type===ItemType.Collection&&e.layout&&e.layout.type===LayoutType.Grid){let t=e.children.indexOf(s.parent);i=e.layout.cellBounds[t].bottom}else i=s.parent.bounds.bottom}else i=e;s.topSegment._doTranslate(0,i-this.scale.map(this.data[t])-a),s.bottomSegment._doTranslate(0,i-this.scale.map(0)-r),s._updateBounds()}}}else if("area"==this.channel){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=Math.sqrt(this.scale.map(this.data[e]));t.resize(i,i)}this.scene._relayoutAncestors(this.anyItem,this.items)}else if("fontSize"==this.channel){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=this.scale.map(this.data[e]);t.styles.fontSize=i+"px"}this.scene._relayoutAncestors(this.anyItem,this.items)}else if("strokeWidth"==this.channel){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=this.scale.map(this.data[e]);t.styles.strokeWidth=i}this.scene._relayoutAncestors(this.anyItem,this.items)}else{let e="left",t="bottom";if(this.anyItem.parent&&this.anyItem.parent.type==ItemType.Glyph){let i=this.anyItem.parent.children;1==uniqueNumbers(i.map((e=>e.bounds.right))).length&&(e="right"),1==uniqueNumbers(i.map((e=>e.bounds.top))).length&&(t="top")}for(let i=0;i<this.items.length;i++){let s=this.items[i],a=this.scale.map(this.data[i]),r="width"==this.channel?a:s.bounds.width,n="height"==this.channel?a:s.bounds.height;s.resize(r,n,e,t)}this.scene._relayoutAncestors(this.anyItem,this.items)}},e.run(),e}function bindToPosition(e){return e._query=function(){this.data=[];let e=this.field,t=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?t.map((e=>e.dataScope)):t.map((e=>e.parent.dataScope));switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:this.data=i.map((t=>t.getFieldValue(e)));break;case DataType.String:try{this.data=i.map((t=>t.getFieldValue(e)))}catch(t){throw new Error("Cannot bind "+this.channel+" to "+e+" : "+t)}break;default:this.data=i.map((t=>t.aggregateNumericalField(e,this.aggregator)))}},e._map=function(){let e,t,i,s,a,r=this.channel,n=this.datatable.getFieldType(this.field),o=getClosestLayout(this.anyItem);if(o&&o.type==LayoutType.Grid){let t=o.cellBounds;e="x"==r?t[0].width:t[0].height}else{let t=this.items.map((e=>e[r]));e=Math.max(...t)-Math.min(...t),e<100?e=100:e>500&&(e=500)}switch(this.rangeExtent&&(e=this.rangeExtent),n){case DataType.Boolean:break;case DataType.Date:if(t=Math.min(...this.data),i=Math.max(...this.data),s=[t,i],this.scale){let e=s.concat(this.scale.domain);s=[Math.min(...e),Math.max(...e)],a=this.scale.range}else this.scale=createScale("time"),this.scale.isFlipped=this._flipScale,a=[0,e];break;case DataType.String:if(s=Array.from(new Set(this.data)),a=[0,e],this.scale){let e=this.scale.domain;for(let t of s)e.indexOf(t)<0&&e.push(t);s=e,a=this.scale.range}else this.scale=createScale("point"),this.scale.isFlipped=this._flipScale,a=[0,e];break;default:if(t=Math.min(...this.data),i=Math.max(...this.data),s=[t,i],this.scale){let e=s.concat(this.scale._scale.domain());s=[Math.min(...e),Math.max(...e)],a=this.scale.range}else this.scale=createScale(this.scaleType?this.scaleType:"linear"),this.scale.isFlipped=this._flipScale,this.scale.includeZero=this._includeZero,a=[0,e];s[0]==s[1]&&(s[1]=1.1*s[0])}this.scale._scale.domain(s),this.scale._setRange(a),this.scale._addEncoding(this)},e._apply=function(){let e=[],t=this.channel;for(let t of this.scale.encodings)e=e.concat(t.items);if("x"==t){let i=getClosestLayout(this.anyItem);if(i&&i.type==LayoutType.Grid)for(let e=0;e<this.items.length;e++){let i=this.items[e],s=getCellBoundsInLayout(i).left+this.scale.map(this.data[e])-i[t],a=0;i._doTranslate(s,a),"vertex"!=i.type&&"segment"!=i.type||i.parent._updateBounds()}else if("vertex"==this.anyItem.type||"segment"==this.anyItem.type){let e=getParents(this.items);void 0===this.scale.offset&&(this.scale.offset=Math.min(...e.map((e=>e.bounds.left))));for(let e=0;e<this.items.length;e++){let i=this.items[e],s=this.scale.offset+this.scale.map(this.data[e])-i[t],a=0;i._doTranslate(s,a),i.parent._updateBounds()}}else{void 0===this.scale.offset&&(this.scale.offset=Math.min(...e.map((e=>e[t]))));for(let e=0;e<this.items.length;e++){let i=this.items[e],s=this.scale.offset+this.scale.map(this.data[e])-i[t],a=0;i._doTranslate(s,a)}}}else{let i=getClosestLayout(this.anyItem);if(i&&i.type==LayoutType.Grid){let e=this.items.map((e=>getCellBoundsInLayout(e)));for(let i=0;i<this.items.length;i++){let s=this.items[i],a=0,r=e[i].bottom-this.scale.map(this.data[i])-s[t];s._doTranslate(a,r),"vertex"!=s.type&&"segment"!=s.type||s.parent._updateBounds()}}else if("vertex"==this.anyItem.type||"segment"==this.anyItem.type){void 0===this.scale.offset&&(this.scale.offset=Math.min(...this.items.map((e=>e.y))));for(let e=0;e<this.items.length;e++){let i=this.items[e],s=0,a=this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[e])-i[t];i._doTranslate(s,a),i.parent._updateBounds()}}else{void 0===this.scale.offset&&(this.scale.offset=Math.min(...e.map((e=>e.bounds.y))));for(let e=0;e<this.items.length;e++){let i=this.items[e],s=0,a=this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[e])-i[t];i._doTranslate(s,a)}}}},e.run(),e}function bindToRadialDistance(e){return e._query=function(){this.data=[];let e=this.field,t=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?t.map((e=>e.dataScope)):t.map((e=>e.parent.dataScope));switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:this.data=i.map((t=>t.getFieldValue(e)));break;case DataType.String:try{this.data=i.map((t=>t.getFieldValue(e)))}catch(t){throw new Error("Cannot bind "+this.channel+" to "+e+" : "+t)}break;default:this.data=i.map((t=>t.aggregateNumericalField(e,this.aggregator)))}},e._map=function(){let e=this.data;this.scale||(this.scale=createScale("linear"),this.scale.domain=[0,Math.max(...e)],this.scale._setRange([0,this.anyItem.parent.radius])),this.scale._addEncoding(this)},e._apply=function(){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=this.scale.map(this.data[e]),s=polar2Cartesian(this.anyItem.parent.x,this.anyItem.parent.y,i,t.polarAngle);t.x=s[0],t.y=s[1]}this.scene._relayoutAncestors(this.anyItem,this.items)},e.run(),e}function bindToColor(e){return e._query=function(){this.data=[];let e=this.field,t=this.items,i="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?t.map((e=>e.dataScope)):t.map((e=>e.parent.dataScope));switch(this.datatable.getFieldType(e)){case DataType.Boolean:this.data=[!0,!1];break;case DataType.Date:this.data=i.map((t=>t.getFieldValue(e)));break;case DataType.String:try{this.data=i.map((t=>t.getFieldValue(e)))}catch(t){throw new Error("Cannot bind "+this.channel+" to "+e+" : "+t)}break;default:this.data=i.map((t=>t.aggregateNumericalField(e,this.aggregator)))}},e._map=function(){switch(this.datatable.getFieldType(this.field)){case DataType.Date:break;case DataType.Boolean:if(!this.scale&&(this.scale=createScale("ordinalColor"),this.scale.domain=this.data,this.mapping)){let e=this.scale.domain.map((e=>e in this.mapping?this.mapping[e]:"black"));this.scale._scale.range(e)}break;case DataType.String:if(this.scale)this.scale.domain=Array.from(new Set(this.scale.domain.concat(this.data)));else if(this.scale=createScale("ordinalColor"),this.scale.domain=this.data,this.mapping){let e=this.scale.domain.map((e=>e in this.mapping?this.mapping[e]:"black"));this.scale._scale.range(e)}break;default:if(this.scale){if(!this.mapping){let e=this.scale.domain.concat(this.data);this.scale.domain=[Math.min(...e),Math.max(...e)]}}else this.mapping?this.scale=createScale("linear",this.mapping):(this.scale=createScale("sequentialColor",this.scheme?this.scheme:"interpolateTurbo"),this.scale.domain=[Math.min(...this.data),Math.max(...this.data)])}this.scale._addEncoding(this)},e._apply=function(){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=this.scale.map(this.data[e]);"vertex"==t.type||"segment"==t.type?t[this.channel]=i:t.styles[this.channel]=i,t.vertices&&"strokeColor"==this.channel&&t.vertices.forEach((e=>e.fillColor=i))}},e.run(),e}function bindToAngle(e){return e._query=function(){this.data=[];let e=this.field,t=this.items;switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:this.data=t.map((t=>t.dataScope.getFieldValue(e)));break;case DataType.String:break;default:this.data=t.map((t=>t.dataScope.aggregateNumericalField(e,this.aggregator)))}},e._map=function(){this.scale||(this.scale=createScale("linear"),this.scale.domain=[0,this.data.reduce(((e,t)=>e+t),0)],this.scale._setRange([0,360]),this.scale._addEncoding(this))},e._apply=function(){let e,t=this.startAngle;for(let i=0;i<this.items.length;i++){e=this.items[i];let s=this.scale.map(this.data[i]);switch(this.angleDirection){case"clockwise":e.adjustAngle(t-s,t),t-=s;break;case"anticlockwise":e.adjustAngle(t,t+s),t+=s}}},e.run(),e}function bindToArea(e){return e._query=function(){this.data=[],this.areas=getPeers(this.items[0],this.scene);let e=this.areas.length;this.areaNum=e,this._vertices=[],this.indicator=[];for(let e of this.areas)for(let t=0;t<e.vertices.length;t++)this._vertices.push(e.vertices[t]),t<e.vertices.length/2?this.indicator.push(1):this.indicator.push(0);let t=this.field,i=this._vertices,s="vertex"!=this.anyItem.type&&"segment"!=this.anyItem.type||this.anyItem.dataScope?i.map((e=>e.dataScope)):i.map((e=>e.parent.dataScope));switch(this.datatable.getFieldType(t)){case DataType.Boolean:break;case DataType.Date:this.data=s.map((e=>e.getFieldValue(t)));break;case DataType.String:this.data=s.map(((e,i)=>0==this.indicator[i]?0:e.aggregateNumericalField(t,this.aggregator)));break;default:"x"==this.channel||"y"==this.channel?this.data=s.map((e=>e._field2value[t])):this.data=s.map(((e,i)=>0==this.indicator[i]?0:e.aggregateNumericalField(t,this.aggregator)))}},e._map=function(){let e,t,i;switch(this.datatable.getFieldType(this.field)){case DataType.Boolean:break;case DataType.Date:e=createScale("time"),t=Math.min(...this.data),i=Math.max(...this.data),e.domain=[t,i];break;case DataType.String:e=createScale("linear"),t=Math.min(...this.data),i=Math.max(...this.data),e.domain=this._includeZero||t<0?[0,i]:[t,i];break;default:e=createScale("linear"),t=Math.min(...this.data),i=Math.max(...this.data),e.domain=t<0?[0,i]:[t,i]}let s,a=CheckAreaOrien(this.areas[0]),r=getClosestLayout(this.anyItem);if(r){let e=r.cellBounds;s="width"==this.channel||"height"==this.channel?a==Orientation.Vertical?e[0].width:e[0].height:a==Orientation.Vertical?e[0].height:e[0].width}else if("width"==this.channel||"x"==this.channel){let e=this._vertices.map((e=>e.x));s=Math.max(...e)-Math.min(...e)}else{let e=this._vertices.map((e=>e.y));s=Math.max(...e)-Math.min(...e)}t<0?(e._scale.domain([t,i]),e._setRange([0,s])):e._setRange([0,s]),this.scale?this.scale._merge(e):this.scale=e,this.scale._addEncoding(this)},e._apply=function(){let e=[],t=this.channel;for(let t of this.scale.encodings)e=e.concat(t.items);let i=this.areas[0].orientation;if("width"===t||"height"===t){if(getClosestLayout(this.areas[0])){let e=0;for(let t of this.areas){let s=getCellBoundsInLayout(t),a=getClosestLayout(t);for(let r=0;r<t.vertices.length;r++){let n,o,l=this._vertices[r+e];if(i===Orientation.Horizontal)if(n=0,a.type===LayoutType.Stack)o=s.bottom-this.scale.map(this.data[r+e])-l.y;else if(a.type===LayoutType.Grid){switch(t.baseline){case"top":o=s.top+this.scale.map(this.data[r+e])-l.y;break;case"bottom":o=s.bottom-this.scale.map(this.data[r+e])-l.y;break;case"middle":{let i=t.vertices.length-1-r,a=Math.abs(this.scale.map(this.data[r+e])-this.scale.map(this.data[i+e]));o=this.indicator[r+e]?s.middle-a/2-l.y:s.middle+a/2-l.y;break}}}else o=0;else if(o=0,a.type===LayoutType.Stack)n=s.left+this.scale.map(this.data[r+e])-l.x;else if(a.type===LayoutType.Grid){switch(t.baseline){case"left":n=s.left+this.scale.map(this.data[r+e])-l.x;break;case"right":n=s.right-this.scale.map(this.data[r+e])-l.x;break;case"center":{let i=t.vertices.length-1-r,a=Math.abs(this.scale.map(this.data[r+e])-this.scale.map(this.data[i+e]));n=this.indicator[r+e]?s.center-a/2-l.x:s.center+a/2-l.x;break}}}else n=0;l._doTranslate(n,o)}e+=t.vertices.length}}else{let e="center"==this.areas[0].baseline||"middle"==this.areas[0].baseline,t=getParents(this._vertices),s=i==Orientation.Vertical?this.areas[0].baseline!==Alignment.Right?Math.min(...t.map((e=>e.bounds.left))):Math.max(...t.map((e=>e.bounds.right))):this.areas[0].baseline!=Alignment.Top?Math.max(...t.map((e=>e.bounds.bottom))):Math.min(...t.map((e=>e.bounds.top)));for(let e=0;e<this._vertices.length;e++){let t=this._vertices[e],a=i==Orientation.Vertical?this.areas[0].baseline!==Alignment.Right?s+this.scale.map(this.data[e])-t.x:s-this.scale.map(this.data[e])-t.x:0,r=i==Orientation.Vertical?0:this.areas[0].baseline!=Alignment.Top?s-this.scale.map(this.data[e])-t.y:s+this.scale.map(this.data[e])-t.y;t._doTranslate(a,r)}if(1==e){let e=this._vertices.length/this.areaNum,t=getParents(this._vertices),s=i==Orientation.Vertical?Math.min(...t.map((e=>e.bounds.x))):Math.max(...t.map((e=>e.bounds.y)));for(let t=0;t<this.areaNum;t++)for(let a=0;a<e/2;a++){let r=t*e+a,n=(t+1)*e-a-1,o=this._vertices[r],l=this._vertices[n],h=i==Orientation.Vertical?o.x-l.x:l.y-o.y,c=i==Orientation.Vertical?s+h/2-o.x:0,d=i==Orientation.Vertical?0:s+h/2-o.y,u=i==Orientation.Vertical?s-h/2-l.x:0,p=i==Orientation.Vertical?0:s-h/2-l.y;o._doTranslate(c,d),l._doTranslate(u,p)}}}}else{if(getClosestLayout(this.anyItem)){let e=getParents(this._vertices);void 0===this.scale.offset&&(this.scale.offset=i==Orientation.Horizontal?Math.min(...e.map((e=>e.bounds.left))):Math.max(...e.map((e=>e.bounds.top))));for(let e=0;e<this._vertices.length;e++){let t=this._vertices[e],s=getCellBoundsInLayout(t),a=i==Orientation.Vertical?0:s.left+this.scale.map(this.data[e])-t.x,r=i==Orientation.Vertical?s.bottom-this.scale.map(this.data[e])-t.y:0;t._doTranslate(a,r)}}else{let e=getParents(this._vertices);void 0===this.scale.offset&&(this.scale.offset=i==Orientation.Horizontal?Math.min(...e.map((e=>e.bounds.left))):Math.max(...e.map((e=>e.bounds.top))));for(let e=0;e<this._vertices.length;e++){let t=this._vertices[e],s=i==Orientation.Horizontal?this.scale.offset+this.scale.map(this.data[e])-t.x:0,a=i==Orientation.Horizontal?0:this.scale.offset+this.scale.rangeExtent-this.scale.map(this.data[e])-t.y;t._doTranslate(s,a)}}}for(let e of this.areas)e._updateBounds();"width"!=t&&"height"!=t||this.scene._relayoutAncestors(this.areas[0],this.areas)},e.run(),e}function bindToText(e){return e._query=function(){this.data=[];let e,t,i=this.items;if(this.field.startsWith("parent.")||this.field.startsWith("child.")){t=this.datatable.tree.nodeTable,e=this.field.split(".")[1];let s=this.field.split(".")[0],a=i.map((e=>e.dataScope)).map((e=>e.getFieldValue(s)));t.getFieldType(e)==DataType.Integer||t.getFieldType(e)==DataType.Number?this.data=a.map((i=>new DataScope(t).cross(nodeId,i).aggregateNumericalField(e))):this.data=a.map((i=>new DataScope(t).cross(nodeId,i).getFieldValue(e)))}else t=this.datatable,e=this.field,t.getFieldType(e)==DataType.Integer||t.getFieldType(e)==DataType.Number?this.data=i.map((t=>t.dataScope.aggregateNumericalField(e,this.aggregator))):this.data=i.map((t=>t.dataScope.getFieldValue(e)))},e._map=function(){if(this.scale);else switch(this.datatable.getFieldType(this.field)){case DataType.Boolean:case DataType.Date:break;case DataType.String:default:this.scale=createScale("ordinal"),this.scale.domain=[...new Set(this.data)],this.scale._scale.range(this.scale.domain.map((e=>e+"")))}},e._apply=function(){for(let e=0;e<this.items.length;e++){let t=this.items[e],i=this.scale.map(this.data[e]);t.text=i}},e.run(),e}class Encoding{constructor(e,t,i,s,a){this.items=e,this.anyItem=this.items[0],this.scene=t,this.channel=i,this.field=s,this.aggregator=a.aggregator,this.datatable=a.datatable,this.scale=a.scale,this.scale?(this._flipScale=this.scale.isFlipped,this.scaleType=this.scale.type,this._includeZero=this.scale.includeZero):(this._flipScale=a.flipScale,this.scaleType=a.scaleType,this._includeZero=a.includeZero),this.mapping=a.mapping,this.rangeExtent=a.rangeExtent,this.scheme=a.scheme,this.range=a.range,"angle"==this.channel&&(this.startAngle="startAngle"in a?a.startAngle:90,this.angleDirection="angleDirection"in a?a.angleDirection:"clockwise"),this._query=void 0,this._map=void 0,this._apply=void 0}get id(){return["enc",getEncodingKey(this.anyItem),this.channel,this.field].join("-")}toJSON(){let e={};return e.anyItem=this.anyItem.id,e.items=this.items.map((e=>e.id)),this.data&&(e.data=this.data),this._rectNegativeValues&&(e._rectNegativeValues=!0),e.args={},e.args.channel=this.channel,e.args.field=this.field,e.args.aggregator=this.aggregator,e.args.datatable=this.datatable.id,e.args.scale=this.scale.id,e.args.mapping=this.mapping,e.args.rangeExtent=this.rangeExtent,e.args.scheme=this.scheme,e.args.scaleType=this.scaleType,e.args.range=this.range,"angle"==this.channel&&(e.args.startAngle=this.startAngle,e.args.angleDirection=this.angleDirection),e}run(){this._query(),this._map(),this._apply()}get dataTable(){return this.datatable}getScaleRange(e){let t=e||this.anyItem;if(t.type!=ItemType.Area){if("x"==this.channel){let e=getClosestLayout(t);if(e&&e.type==LayoutType.Grid){let i=e.cellBounds,s=t.parent.parent.children.findIndex((e=>t.parent==e||t.parent.parent==e));return[i[s].left,i[s].left+this.scale.rangeExtent]}if("vertex"==t.type||"segment"==t.type){let e=this.scale.offset;return[e,e+this.scale.rangeExtent]}{let e=this.scale.offset;return[e,e+this.scale.rangeExtent]}}if("y"==this.channel){let e=getClosestLayout(t);if(e&&e.type==LayoutType.Grid){let i=e.cellBounds,s=t.parent.parent.children.findIndex((e=>t.parent==e||t.parent.parent==e));return[i[s].bottom,i[s].bottom-this.scale.rangeExtent]}if("vertex"==t.type||"segment"==t.type){let e=this.scale.offset;return[e+this.scale.rangeExtent,e]}{let e=this.scale.offset;return[e+this.scale.rangeExtent,e]}}if("width"==this.channel){let e=getTopLevelLayout(t,"grid");if(e){let i=e.cellBounds,s=t.parent.parent.children.findIndex((e=>t.parent==e||t.parent.parent==e));return[i[s].left,i[s].left+this.scale.rangeExtent]}{let e=getPeers(t,this.scene),i=Math.min(...e.map((e=>e.bounds.left)));return[i,i+this.scale.rangeExtent]}}if("height"==this.channel){let e=getTopLevelLayout(t,"grid");if(e){let i=e.cellBounds,s=t.parent.parent.children.findIndex((e=>t.parent===e||t.parent.parent===e));return[i[s].bottom,i[s].bottom-this.scale.rangeExtent]}{let e=getPeers(t,this.scene),i=Math.max(...e.map((e=>e.bounds.bottom)));return[i,i-this.scale.rangeExtent]}}if("radialDistance"==this.channel){let e=t.parent;return[e.x,e.x+this.scale.rangeExtent]}return this.scale.range}{let e,i=CheckAreaOrien(t),s=getClosestLayout(t);e=s?i==Orientation.Vertical?s.horzCellAlignment===Alignment.Left:s.vertCellAlignment===Alignment.Bottom:i==Orientation.Vertical?t.baseline==Alignment.Left:t.baseline==Alignment.Bottom;let a=getCellBoundsInGridLayout(t);if(a)switch(this.channel){case"x":return[a.left,a.left+this.scale.rangeExtent];case"width":return e?[a.left,a.left+this.scale.rangeExtent]:[a.right,a.right-this.scale.rangeExtent];case"y":return[a.bottom,a.bottom-this.scale.rangeExtent];case"height":return e?[a.bottom,a.bottom-this.scale.rangeExtent]:[a.top,a.top+this.scale.rangeExtent]}if(i==Orientation.Horizontal)switch(this.channel){case"width":case"height":{let i=getPeers(t.firstVertex,this.scene),s=e?Math.max(...i.map((e=>e.y))):Math.min(...i.map((e=>e.y)));return e?[s,s-this.scale.rangeExtent]:[s+this.scale.rangeExtent,s]}case"x":case"y":{let e=getPeers(t.firstVertex,this.scene),i=Math.min(...e.map((e=>e.x)));return[i,i+this.scale.rangeExtent]}}else if(i==Orientation.Vertical)switch(this.channel){case"x":case"y":{let e=getPeers(t.firstVertex,this.scene),i=Math.max(...e.map((e=>e.y)));return[i,i-this.scale.rangeExtent]}case"height":case"width":{let i=getPeers(t.firstVertex,this.scene),s=e?Math.min(...i.map((e=>e.x))):Math.max(...i.map((e=>e.x)));return e?[s,s+this.scale.rangeExtent]:[s-this.scale.rangeExtent,s]}}}}}function bin(e,t,i){let s=t[0],a=e.nonNumericFields,r={};for(let t of e.data){let e=a.map((e=>String(t[e]))).join("_");r.hasOwnProperty(e)||(r[e]=a.map((e=>t[e])),r[e].push([])),r[e][r[e].length-1].push(t[s])}let n=[];for(let e in r){let t=r[e].pop(),i=d3__namespace.bin()(t);for(let t of i){let i={};r[e].forEach(((e,t)=>i[a[t]]=e)),i.x0=t.x0,i.x1=t.x1,i[s+"_count"]=t.length,n.push(i)}}let o={};a.forEach((t=>o[t]=e.getFieldType(t))),o.x0=DataType.Number,o.x1=DataType.Number,o[s+"_count"]=DataType.Number;let l=new DataTable(n,e.url,o);return l.sourceDataTable=e,l.transform={type:"bin",args:t},l}function kde(e,t,i){let s=t[0],a=e.nonNumericFields,r={};for(let t of e.data){let e=a.map((e=>String(t[e]))).join("_");e in r||(r[e]=a.map((e=>t[e])),r[e].push([])),r[e][r[e].length-1].push(t[s])}let n="min"in i?i.min:e.getFieldSummary(s).min,o="max"in i?i.max:e.getFieldSummary(s).max,l=n,h=[];for(;l<o;)h.push(l),l+=i.interval;h.push(l);let c=[];for(let e in r){let t=r[e].pop(),n=_kde(_epanechnikov(i.bandwidth),h,t);for(let t of n){let i={};r[e].forEach(((e,t)=>i[a[t]]=e)),i[s]=t[0],i[s+"_density"]=t[1],c.push(i)}}let d={};return a.forEach((t=>d[t]=e.getFieldType(t))),d[s]=DataType.Number,d[s+"_density"]=DataType.Number,new DataTable(c,e.url,d)}function _kde(e,t,i){return t.map((t=>[t,d3__namespace.mean(i,(i=>e(t-i)))]))}function _epanechnikov(e){return t=>Math.abs(t/=e)<=1?.75*(1-t*t)/e:0}function sort$1(e,t,i){e.data.sort(((e,i)=>compareRow(e,i,t))),e.summarize()}function compareRow(e,t,i,s){for(let s of i){if(e[s]<t[s])return-1;if(e[s]>t[s])return 1}return 0}function filter$1(e,t){let i=[];for(let s of e.data){let e=!0;for(let i of t)if(!satisfy(s,i)){e=!1;break}e&&i.push(s)}let s=new DataTable(i,e.url);return s.sourceDataTable=e,s.transform={type:"filter",args:t},s}function satisfy(row,p){if("field"in p){let e=p.field;if("value"in p)return row[e]==p.value;if("range"in p)return row[e]>=p.range[0]&&row[e]<=p.range[1];if("values"in p)return p.values.indexOf(row[e])>=0}else if("fields"in p){let f1=p.fields[0],f2=p.fields[1];return 1==eval(row[f1]+p.operator+row[f2])}}class DataTable{constructor(e,t,i){if(this.url=t,this.id=ItemType.DataTable+ItemCounter[ItemType.DataTable]++,this.data=e,this.rawData=JSON.parse(JSON.stringify(e)),this._dateMap=new Map,this._fields=Object.keys(this.data[0]),this._newField=0,i)this._fieldTypes=i;else{this._fieldTypes={};for(let e of this._fields)this._fieldTypes[e]=_inferType(this.data.map((t=>t[e]))),"year"==e.toLowerCase()&&this._fieldTypes[e]==DataType.Integer&&(this._fieldTypes[e]=DataType.Date)}this._validate(this.data,this._fieldTypes),this._fieldSummaries={};for(let e of this._fields)this._fieldSummaries[e]=_summarize(this.data.map((t=>t[e])),this._fieldTypes[e]);this._fields.indexOf(atlas_rowId)<0&&this._addField(atlas_rowId,DataType.String,this.data.map(((e,t)=>"r"+t)))}get name(){return this.url?_getFileName(this.url):this.id}set sourceDataTable(e){this._sourceDataTable=e}get sourceDataTable(){return this._sourceDataTable}getEncodableFields(e){switch(e){case"x":case"y":case"width":case"height":case"radius":case"fillColor":case"strokeColor":return this.numericFields.concat(this.nonNumericFields);case"area":case"strokeWidth":default:return this.numericFields}}toJSON(){let e={};return e.data=this.rawData,e.fieldTypes=this._fieldTypes,e.url=this.url,e.id=this.id,e.sourceDataTable=this._sourceDataTable,e.transform=this._transform,e.dateMap={},e}transformField(e,t,i){let s=this.data.map((i=>t(i[e]))),a=_inferType(s),r=i||Date.now()+"_field"+this._newField++;return this._addField(r,a,s),r}setValueOrder(e,t){this._fieldSummaries[e].unique=t}_addField(e,t,i){this.data.forEach(((t,s)=>t[e]=i[s])),this._fieldTypes[e]=t,this._fields.push(e),this._fieldSummaries[e]=_summarize(i,t)}getFieldType(e){return this._fieldTypes[e]}get fields(){return this._fields}getFieldSummary(e){return this._fieldSummaries[e]}getFieldValues(e){return this.data.map((t=>t[e]))}getUniqueFieldValues(e){return this._fieldSummaries[e].unique}getRowCount(){return this.data.length}hasField(e){return this._fields.indexOf(e)>=0}parseFieldAsDate(e,t){let i=d3__namespace.timeParse(t);for(let t of this.data){let s=t[e];null==s||null==s?(s="",t[e]=new Date(1899,11,31).getTime()):t[e]=i(s).getTime(),this._dateMap.set(t[e],s)}this._fieldTypes[e]=DataType.Date,this._fieldSummaries[e]=_summarize(this.data.map((t=>t[e])),DataType.Date)}getRawValue(e,t){return this.getFieldType(e)===DataType.Date?this._dateMap.get(t).toString():t}static get RowID(){return atlas_rowId}get nonNumericFields(){let e=[];for(let t in this._fieldTypes)this._fieldTypes[t]!=DataType.Number&&this._fieldTypes[t]!=DataType.Integer&&t!=DataTable.RowID&&e.push(t);return e}get numericFields(){let e=[];for(let t in this._fieldTypes)this._fieldTypes[t]!==DataType.Number&&this._fieldTypes[t]!==DataType.Integer||t==DataTable.RowID||e.push(t);return e}getFieldsByType(e){let t=[];for(let i in this._fieldTypes)this._fieldTypes[i]===e&&i!=DataTable.RowID&&t.push(i);return t}transform(e,t,i){let s=i||{};switch(e){case"kde":return kde(this,t,s);case"bin":return bin(this,t);case"sort":return sort$1(this,t);case"filter":return filter$1(this,t)}}summarize(){for(let e of this._fields)this._fieldSummaries[e]=_summarize(this.data.map((t=>t[e])),this._fieldTypes[e])}_validate(e,t){for(let i of e)for(let e in t){let s,a=t[e],r=i[e];if(null==i[e]||null==i[e])switch(a){case DataType.Boolean:s=!1;break;case DataType.Date:s=new Date(1899,11,31).getTime();break;case DataType.String:s="";break;default:s=0}else switch(a){case DataType.Boolean:s=r;break;case DataType.Date:s=Number.isInteger(r)?new Date(r,0).getTime():new Date(r+"").getTime(),this._dateMap.set(s,r);break;case DataType.String:s=r.toString();break;default:s=r}i[e]=s}}}function _summarize(e,t){var i={};switch(t){case DataType.Boolean:i.trueCount=e.filter((e=>e)).length,i.falseCount=e.filter((e=>!e)).length;break;case DataType.Date:i.min=d3__namespace.min(e),i.max=d3__namespace.max(e),i.extent=[i.min,i.max],i.unique=[...new Set(e)];break;case DataType.String:i.unique=[...new Set(e)];break;default:i.min=d3__namespace.min(e),i.max=d3__namespace.max(e),i.extent=[i.min,i.max],i.mean=d3__namespace.mean(e),i.median=d3__namespace.median(e),i.unique=[...new Set(e)]}return i}var isValidType={boolean:function(e){return"true"===e||"false"===e||!0===e||!1===e||"[object Boolean]"==toString.call(e)},integer:function(e){return isValidType.number(e)&&(e=+e)==~~e},number:function(e){return!isNaN(+e)&&"[object Date]"!=toString.call(e)},date:function(e){let t=new Date(e);return null!=t&&!isNaN(t)},string:function(e){return!0}};function _inferType(e){var t=Object.values(DataType);for(let i=0;i<e.length;i++){let s=e[i];if(null!=s){for(let e=0;e<t.length;e++)isValidType[t[e]](s)||(t.splice(e,1),e-=1);if(1==t.length)return t[0]}}return t[0]}function _getFileName(e){var t=e.indexOf("\\")>=0?e.lastIndexOf("\\"):e.lastIndexOf("/"),i=e.substring(t);return 0!==i.indexOf("\\")&&0!==i.indexOf("/")||(i=i.substring(1)),i}class PointText extends Mark{constructor(e){super(e),this.type=ItemType.PointText,this.attrs.x=0,this.attrs.y=0,"fontSize"in this.styles||(this.styles.fontSize="12px"),"fontFamily"in this.styles||(this.styles.fontFamily="Arial, sans-serif"),"fontWeight"in this.styles||(this.styles.fontWeight="normal"),"fillColor"in this.styles||(this.styles.fillColor="black"),void 0!==e&&("x"in e&&(this.attrs.x=e.x),"y"in e&&(this.attrs.y=e.y),this.attrs.text="text"in e?e.text:"",this.attrs.anchor="anchor"in e?e.anchor:["center","middle"]),this._updateBounds()}copyPropertiesTo(e){e.styles=Object.assign({},this.styles),this._dataScope&&(e._dataScope=this._dataScope.clone()),e.x=this.attrs.x,e.y=this.attrs.y,e.text=this.text,e.anchor=[this.anchor[0],this.anchor[1]]}get bounds(){return this._bounds||this._updateBounds(),this._bounds}set text(e){this.attrs.text=e,this._updateBounds()}get text(){return this.attrs.text}_doTranslate(e,t){this.attrs.x+=e,this.attrs.y+=t,this._updateBounds()}_updateBounds(){let e,t,i=getTextSize(this.attrs.text,[this.fontWeight,this.styles.fontSize,this.fontFamily].join(" "),parseFloat(this.fontSize)),s=i.width,a=i.height;switch(this.attrs.anchor[0]){case"left":e=this.attrs.x;break;case"right":e=this.attrs.x-s;break;case"center":e=this.attrs.x-s/2;break;default:e=this.attrs.x}switch(this.attrs.anchor[1]){case"top":t=this.attrs.y;break;case"bottom":t=this.attrs.y-a;break;case"middle":t=this.attrs.y-a/2}this._bounds=new Rectangle(e,t,s,a)}get center(){return{x:this.bounds.left+this.bounds.width/2,y:this.bounds.top+this.bounds.height/2}}get x(){return this.attrs.x}set x(e){this.attrs.x=e,this._updateBounds()}get y(){return this.attrs.y}set y(e){this.attrs.y=e,this._updateBounds()}get anchor(){return this.attrs.anchor}set anchor(e){this.attrs.anchor=e,this._updateBounds()}get fontSize(){return parseFloat(this.styles.fontSize)}set fontSize(e){this.styles.fontSize="number"==typeof e?e+"px":e,this._updateBounds()}get fontWeight(){return this.styles.fontWeight}set fontWeight(e){this.styles.fontWeight=e,this._updateBounds()}get fontFamily(){return this.styles.fontFamily}set fontFamily(e){this.styles.fontFamily=e,this._updateBounds()}get fillColor(){return this.styles.fillColor}set fillColor(e){this.styles.fillColor=e}}class Axis extends Group{constructor(e){super(),this.type=ItemType.Axis,this.id=this.type+ItemCounter[this.type]++,this._strokeColor="strokeColor"in e?e.strokeColor:"#555",this._textColor="textColor"in e?e.textColor:"#555",this._tickOffset="tickOffset"in e?e.tickOffset:0,this._tickSize="tickSize"in e?e.tickSize:5,this._tickAnchor=e.tickAnchor?e.tickAnchor:"middle",this._tickVisible=!("tickVisible"in e)||e.tickVisible,this._pathVisible=!("pathVisible"in e)||e.pathVisible,this._labelOffset="labelOffset"in e?e.labelOffset:15,this._labelFormat="labelFormat"in e?e.labelFormat:"",this._titleOffset="titleOffset"in e?e.titleOffset:40,"titleAnchor"in e?this._titleAnchor=e.titleAnchor:"x"==this.channel||"width"==this.channel?this._titleAnchor="top"==this._orientation?["center","bottom"]:["center","top"]:this._titleAnchor="left"==this._orientation?["right","middle"]:["left","middle"],this._rotateYTitle=!("rotateTitle"in e&&!e.rotateTitle),this._titlePosition=e.titlePosition,"labelRotation"in e&&(this._labelRotation=e.labelRotation)}toJSON(){let e={args:{}};return e.type=this.type,e.id=this.id,e.field=this._field,e.channel=this._channel,"args"in e||(e.args={}),e.args.orientation=this._orientation,e.args.strokeColor=this._strokeColor,e.args.textColor=this._textColor,e.args.tickOffset=this._tickOffset,e.args.tickSize=this._tickSize,e.args.tickAnchor=this._tickAnchor,e.args.tickVisible=this._tickVisible,e.args.pathVisible=this._pathVisible,e.args.labelOffset=this._labelOffset,e.args.labelFormat=this._labelFormat,this._labelRotation&&(e.args.labelRotation=this._labelRotation),e.args.showTitle=this._showTitle,e.args.tickValues=this._tickValues,e.args.titleAnchor=this._titleAnchor,e.args.titleOffset=this._titleOffset,e.args.titlePosition=this._titlePosition,e.args.rotateTitle=this._rotateYTitle,e}get field(){return this._field}get channel(){return this._channel}get orientation(){return this._orientation}set orientation(e){this._orientation=e,this.reposition()}get pathX(){if("y"==this.channel||"height"==this.channel){if(void 0!==this._position)return this._position;if(this._path)return this._path.vertices[0].x;if(this._rules&&this._rules.firstChild)return this._rules.firstChild.vertices[0].x}}set pathX(e){"y"!=this.channel&&"height"!=this.channel||(this._posArg=e),this.reposition()}get pathPosition(){return"x"==this.channel||"width"==this.channel?this.pathY:this.pathX}set pathPosition(e){"x"==this.channel||"width"==this.channel?this.pathY=e:"y"!=this.channel&&"height"!=this.channel||(this.pathX=e)}get pathY(){if("x"==this.channel||"width"==this.channel){if(void 0!==this._position)return this._position;if(this._path)return this._path.vertices[0].y;if(this._rules&&this._rules.firstChild)return this._rules.firstChild.vertices[0].y}}set pathY(e){"x"!=this.channel&&"width"!=this.channel||(this._posArg=e),this.reposition()}get tickOffset(){return this._tickOffset}set tickOffset(e){this._tickOffset=e,this._positionTicks()}get titleOffset(){return this._titleOffset}set titleOffset(e){this._titleOffset=e}get tickSize(){return this._tickSize}set tickSize(e){this._tickSize=e,this._positionTicks()}set tickValues(e){this._tickValues=e,this._generateTicks(),this._positionTicks()}get tickValues(){return this._tickValues}set labelValues(e){this._labelValues=e,this._generateLabels(),this._positionLabels()}get labelValues(){return this._labelValues}get tickAnchor(){return this._tickAnchor}set tickAnchor(e){this._tickAnchor=e}get tickVisible(){return this._tickVisible}set tickVisible(e){this._tickVisible=e;for(let t of this._ticks.children)t.visibility=e?"visible":"hidden"}get pathVisible(){return this._pathVisible}set pathVisible(e){this._pathVisible=e;let t=[];this._path&&t.push(this._path),this._rules&&this._rules.children.forEach((e=>t.push(e)));for(let i of t)i.visibility=e?"visible":"hidden"}get labelOffset(){return this._labelOffset}set labelOffset(e){this._labelOffset=e,this._positionLabels()}get labelFormat(){return this._labelFormat}set labelFormat(e){this._labelFormat=e,this._generateLabels(),this._positionLabels()}get labelRotation(){return this._labelRotation}set labelRotation(e){this._labelRotation=e}get showTitle(){return this._showTitle}set showTitle(e){this._showTitle=e,this._title||(this._generateTitle(),this._positionTitle()),this._title.visibility=e?"visible":"hidden"}get titleAnchor(){return this._titleAnchor}set titleAnchor(e){this._titleAnchor=e}get titlePosition(){return this._titlePosition}set titlePosition(e){this._titlePosition=e}get rotateTitle(){return this._rotateYTitle}set rotateTitle(e){this._rotateYTitle=e}get title(){return this._titleText}set title(e){this._titleText=e}get includeZero(){return!!this.encoding&&this.encoding.scale.includeZero}set includeZero(e){this.encoding&&(this.encoding.scale.includeZero=e)}_generatePath(){}_generateTicks(){}_generateLabels(){}_generateTitle(){this._title=new PointText({text:this._titleText,fillColor:this._textColor,fontWeight:"bold"}),this._title.id=this.id+"-title",this.addChild(this._title)}_positionPath(){}_positionTicks(){}_positionLabels(){}_positionTitle(){}matches(e){}reposition(){this._positionPath(),this._positionTicks(),this._positionLabels(),this._showTitle&&this._positionTitle(),"radialDistance"===this._channel&&this._rotate&&(this._rotate=[this._rotate[0],this._item.parent.x,this._item.parent.y]),this._updateBounds()}}class EncodingAxis extends Axis{constructor(e,t,i){super(i),this.encoding=e,this._field=this.encoding.field,this._channel=this.encoding.channel,this._orientation="orientation"in i?i.orientation:"x"===this._channel||"width"==this._channel?"bottom":"left",this._posArg="x"==this._channel||"width"==this._channel?i.pathY:i.pathX,this._position=this._posArg,this._titleText="title"in i?i.title:this.encoding.field,this._item=t,this._ticks=new Group,this._ticks.id=this.id+"ticks",this.addChild(this._ticks),this._labels=new Group,this._labels.id=this.id+"labels",this.addChild(this._labels),"radialDistance"===this._channel&&"rotation"in i&&(this._rotate=[-i.rotation,this._item.parent.x,this._item.parent.y]),this._showTitle=!("showTitle"in i)||i.showTitle,this._generatePath(),this._positionPath(),this._showTitle&&this._generateTitle(),this._showTitle&&this._positionTitle()}_updateBounds(){this._bounds=this._ticks.bounds,this._bounds=this._bounds.union(this._path.bounds),this._bounds=this._bounds.union(this._labels.bounds),this._title&&(this._bounds=this._bounds.union(this._title.bounds))}toJSON(){let e=super.toJSON();return e.args.item=this._item.id,"time"===this.encoding.scale.type&&(e.args.isDate=!0),this._rotate&&(e.args.rotation=this._rotate[0]),"x"==this._channel||"width"==this._channel?e.args.pathY=this._posArg:e.args.pathX=this._posArg,e}get ticks(){return this._ticks}get labels(){return this._labels}get path(){return this._path}set strokeColor(e){this._strokeColor=e;for(let t of this._ticks.children)t.strokeColor=e;this._path.strokeColor=e}get strokeColor(){return this._strokeColor}set textColor(e){this._textColor=e;for(let t of this._labels.children)t.fillColor=e;this._title&&(this._title.fillColor=e)}get textColor(){return this._textColor}_generatePath(){this._path=new Path({strokeColor:this._strokeColor}),this._pathVisible||(this._path.visibility="hidden"),this._path.type=ItemType.Line,this._path.id=this.id+"path",this.addChild(this._path)}_generateTicks(){this._ticks.removeAll();for(let e=0;e<this._tickValues.length;e++){let t=new Path({strokeColor:this._strokeColor});this._tickVisible||(t.visibility="hidden"),t.type=ItemType.Line,t.id=this.id+"tick"+e,this._ticks.addChild(t)}}_generateLabels(){let e;switch(this._labels.removeAll(),this.encoding.datatable.getFieldType(this.encoding.field)){case DataType.Date:e=d3__namespace.timeFormat(this._labelFormat);break;case DataType.String:e=function(e){return e};break;default:e=d3__namespace.format(this._labelFormat)}for(let[t,i]of this._labelValues.entries()){let s=new PointText({text:e(i),fillColor:this._textColor});s.id=this.id+"label"+t,this._labels.addChild(s)}}_positionPath(){this._range=this.encoding.getScaleRange(this._item),void 0===this._posArg?this._position=this._computePosition():this._position=this._posArg;let e=[];if("x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let t=this._ticks.children.map((e=>e.vertices[0].x));e.push([Math.min(...t.concat(this._range)),this._position]),e.push([Math.max(...t.concat(this._range)),this._position])}else if("y"==this._channel||"height"==this._channel){let t=this._ticks.children.map((e=>e.vertices[0].y));e.push([this._position,Math.min(...t.concat(this._range))]),e.push([this._position,Math.max(...t.concat(this._range))])}this._path._setVertices(e),this._path._updateBounds(),this._showTitle&&this._title&&this._positionTitle(),this._updateBounds()}_positionLabels(){if(void 0===this._posArg?this._position=this._computePosition():this._position=this._posArg,"x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let e="bottom"==this._orientation?this._tickSize:-this._tickSize,t="bottom"==this._orientation?["center","top"]:["center","bottom"];if("area"==this._item.type&&"width"==this._channel){let e=getClosestLayout(this._item);if(e){let t=e.type==LayoutType.Stack?e._horzCellAlignment==Alignment.Left:e._cellHorzAlignment==Alignment.Left;this._flip=!t}else{let e=this._item.baseline==Alignment.Left||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!e}}if(this._flip)for(let[i,s]of this._labels.children.entries())s.x=this._range[1]-this.encoding.scale.map(this._labelValues[i]),s.y=this._position+e,s.anchor=t,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",t[1]]);else if(this.encoding.scale.isFlipped)for(let[i,s]of this._labels.children.entries())s.x=this._range[0]+this.encoding.scale.map(this._labelValues[i]),s.y=this._position+e,s.anchor=t,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",t[1]]);else for(let[i,s]of this._labels.children.entries())s.x=this._range[0]+this.encoding.scale.map(this._labelValues[i])-this.encoding.scale.range[0],s.y=this._position+e,s.anchor=t,this._labelRotation&&(s._rotate=[this._labelRotation,s.x,s.y],s.anchor=["right",t[1]])}else if("y"==this._channel||"height"==this._channel){let e="left"==this._orientation?-this._tickSize:this._tickSize,t="left"==this._orientation?["right","middle"]:["left","middle"];if("area"==this._item.type&&"height"==this._channel){let e=getClosestLayout(this._item);if("height"==this._channel&&e){let t=e.type==LayoutType.Stack?e._vertCellAlignment==Alignment.Bottom:e._cellVertAlignment==Alignment.Bottom;this._flip=!t}else{let e=this._item.baseline==Alignment.Bottom||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!e}}if(this._flip)for(let[i,s]of this._labels.children.entries())s.x=this._position+e,s.y=this._range[0]+this.encoding.scale.map(this._labelValues[i]),s.anchor=t;else if(this.encoding.scale.isFlipped)for(let[i,s]of this._labels.children.entries())s.x=this._position+e,s.y=this._range[1]-this.encoding.scale.map(this._labelValues[i])+this.encoding.scale.range[1],s.anchor=t;else for(let[i,s]of this._labels.children.entries())s.x=this._position+e,s.y=this._range[0]-this.encoding.scale.map(this._labelValues[i])+this.encoding.scale.range[0],s.anchor=t}this._labels._updateBounds(),this._updateBounds()}_computePosition(){let e;return this._item.type==ItemType.Area&&(e=getCellBoundsInGridLayout(this._item)),void 0===e&&(e=getTopLevelGroup(this._item).bounds),"x"===this._channel||"width"===this._channel?"top"==this._orientation?e.top-this._tickSize:e.bottom+this._tickSize:"y"===this._channel||"height"===this._channel?"left"==this._orientation?e.left-this._tickSize:e.right+this._tickSize:"radialDistance"===this._channel?this._item.parent.y:void 0}_positionTicks(){if(void 0===this._posArg?this._position=this._computePosition():this._position=this._posArg,this._range=this.encoding.getScaleRange(this._item),"x"==this._channel||"radialDistance"==this._channel||"width"==this._channel){let e="bottom"==this._orientation?this._tickSize:-this._tickSize;if("width"==this._channel){let e=getClosestLayout(this._item);if(e){let t=e.type==LayoutType.Stack?e._horzCellAlignment==Alignment.Left:e._cellHorzAlignment==Alignment.Left;this._flip=!t}else if("area"==this._item.type){let e=this._item.baseline==Alignment.Left||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!e}}if(this._flip)for(let[t,i]of this._ticks.children.entries())i._setVertices([[this._range[1]-this.encoding.scale.map(this._tickValues[t]),this._position],[this._range[1]-this.encoding.scale.map(this._tickValues[t]),this._position+e]]),i._updateBounds();else if(this.encoding.scale.isFlipped)for(let[t,i]of this._ticks.children.entries())i._setVertices([[this._range[0]+this.encoding.scale.map(this._tickValues[t]),this._position],[this._range[0]+this.encoding.scale.map(this._tickValues[t]),this._position+e]]),i._updateBounds();else for(let[t,i]of this._ticks.children.entries())i._setVertices([[this._range[0]+this.encoding.scale.map(this._tickValues[t])-this.encoding.scale.range[0],this._position],[this._range[0]+this.encoding.scale.map(this._tickValues[t])-this.encoding.scale.range[0],this._position+e]]),i._updateBounds()}else if("y"==this._channel||"height"==this._channel){let e="left"==this._orientation?-this._tickSize:this._tickSize;if("height"==this._channel){let e=getClosestLayout(this._item);if(e)this._flip=e.vertCellAlignment!==Alignment.Bottom;else if("area"==this._item.type){let e=this._item.baseline==Alignment.Bottom||this._item.baseline==Alignment.Center||this._item.baseline==Alignment.Middle||null==this._item.baseline;this._flip=!e}}if(this._flip)for(let[t,i]of this._ticks.children.entries())i._setVertices([[this._position+e,this._range[0]+this.encoding.scale.map(this._tickValues[t])],[this._position,this._range[0]+this.encoding.scale.map(this._tickValues[t])]]),i._updateBounds();else if(this.encoding.scale.isFlipped)for(let[t,i]of this._ticks.children.entries()){let s=this._range[1]-this.encoding.scale.map(this._tickValues[t])+this.encoding.scale.range[1];i._setVertices([[this._position+e,s],[this._position,s]]),i._updateBounds()}else for(let[t,i]of this._ticks.children.entries())i._setVertices([[this._position+e,this._range[0]-this.encoding.scale.map(this._tickValues[t])+this.encoding.scale.range[0]],[this._position,this._range[0]-this.encoding.scale.map(this._tickValues[t])+this.encoding.scale.range[0]]]),i._updateBounds()}this._positionPath(),this._ticks._updateBounds(),this._updateBounds()}_positionTitle(){let e=this._path.bounds;this._title.achor=this._titleAnchor,this._titlePosition?(this._title.x=this._titlePosition[0],this._title.y=this._titlePosition[1],"y"!=this._channel&&"height"!=this._channel||this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])):"x"==this._channel||"width"==this._channel?(this._title.x=e.x,this._title.y="top"==this._orientation?e.top-this._titleOffset:e.bottom+this._titleOffset):(this._title.x="left"==this._orientation?e.left-this._titleOffset:e.right+this._titleOffset,this._title.y=e.y,this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])),this._title._updateBounds(),this._updateBounds()}matches(e){let t=getEncodingKey(e).split("_")[0],i=this.encoding.scale.encodings;for(let e of i){if(getEncodingKey(e.anyItem).split("_")[0]===t)return!0}return!1}get isFlipped(){return!!this._flip||!!this.encoding.scale.isFlipped}}class LayoutAxis extends Axis{constructor(e,t,i,s,a){super(a),this._channel=i,this._orientation="orientation"in a?a.orientation:"x"===this._channel||"width"==this._channel?"bottom":"left",this._posArg="x"==this._channel||"width"==this._channel?a.pathY:a.pathX,this._item=e[0],this._items=e,this._mlayout=t,this._field=s,this._titleText="title"in a?a.title:this._field,this._showTitle="showTitle"in a&&a.showTitle,"labelRotation"in a&&(this._labelRotation=a.labelRotation),this._ticks=new Group,this._ticks.id=this.id+"ticks",this.addChild(this._ticks),this._labels=new Group,this._labels.id=this.id+"labels",this.addChild(this._labels),this._rules=new Group,this._rules.id=this.id+"paths",this.addChild(this._rules),this._generatePath(),this._generateTicks(),this._generateLabels(),this._showTitle&&this._generateTitle(),this._positionPath(),this._positionTicks(),this._positionLabels(),this._showTitle&&this._positionTitle()}toJSON(){let e=super.toJSON();return e.args.item=this._item.id,"x"==this._channel||"width"==this._channel?e.args.pathY=this._posArg:e.args.pathX=this._posArg,this.classId&&(e.classId=this.classId),e}set strokeColor(e){this._strokeColor=e;for(let t of this._ticks.children)t.strokeColor=e;for(let t of this._rules.children)t.strokeColor=e}get strokeColor(){return this._strokeColor}set textColor(e){this._textColor=e;for(let t of this._labels.children)t.fillColor=e;this._title&&(this._title.fillColor=e)}get textColor(){return this._textColor}_updateBounds(){this._bounds=this._rules.bounds.clone(),this._bounds=this._bounds.union(this._ticks.bounds),this._bounds=this._bounds.union(this._labels.bounds),this._showTitle&&(this._bounds=this._bounds.union(this._title.bounds))}_generatePath(){if(this._rules.removeAll(),this._mlayout.type==LayoutType.Grid){let e="x"==this._channel?this._mlayout.numRows:this._mlayout.numCols;for(let t=0;t<e;t++){let e=new Path({strokeColor:this._strokeColor});this._pathVisible||(e.visibility="hidden"),e.type=ItemType.Line,e.id=this.id+"rule"+t,this._rules.addChild(e)}}else if(this._mlayout.type===LayoutType.Stack){let e=new Path({strokeColor:this._strokeColor});this._pathVisible||(e.visibility="hidden"),e.type=ItemType.Line,e.id=this.id+"rule",this._rules.addChild(e)}}_generateTicks(){this._ticks.removeAll();for(let e=0;e<this._mlayout.group.children.length;e++){let t=new Path({strokeColor:this._strokeColor});this._tickVisible||(t.visibility="hidden"),t.type=ItemType.Line,t.id=this.id+"tick"+e,this._ticks.addChild(t)}}_generateLabels(){let e;switch(this._labels.removeAll(),this._item.dataScope.getFieldType(this._field)){case DataType.Date:e=d3__namespace.timeFormat(this._labelFormat);break;case DataType.String:e=function(e){return e};break;default:e=d3__namespace.format(this._labelFormat)}let t=this._mlayout.cellBounds;for(let i=0;i<t.length;i++){let t=new PointText({fillColor:this._textColor,text:e(this._items[i].dataScope.getFieldValue(this._field))});t.id=this.id+"label"+i,this._labels.addChild(t)}}_positionPath(){if(this._mlayout.type==LayoutType.Grid){let e=this._mlayout.cellBounds,t="x"==this._channel?this._mlayout.numRows:this._mlayout.numCols;if("x"==this._channel){let i=e[0].left,s=this._mlayout.numCols;for(let a=0;a<t;a++)this._rules.children[a]._setVertices([[i,this._posArg?e[a*s][this._orientation]+this._posArg-e[0][this._orientation]:e[a*s][this._orientation]],[i+e[0].width*s+this._mlayout.colGap*(s-1),this._posArg?e[a*s][this._orientation]+this._posArg-e[0][this._orientation]:e[a*s][this._orientation]]])}else{let i=e[0].top,s=this._mlayout.numRows;for(let a=0;a<t;a++)this._rules.children[a]._setVertices([[this._posArg?e[a*s][this._orientation]+this._posArg-e[0][this._orientation]:this._mlayout.group.bounds[this._orientation],i],[this._posArg?e[a*s][this._orientation]+this._posArg-e[0][this._orientation]:this._mlayout.group.bounds[this._orientation],i+e[0].height*s+this._mlayout.rowGap*(s-1)]])}}else if(this._mlayout.type===LayoutType.Stack){let e=this._mlayout.group.bounds;"x"==this._channel?this._rules.children[0]._setVertices([[e.left,this._posArg?this._posArg:e[this._orientation]],[e.right,this._posArg?this._posArg:e[this._orientation]]]):this._rules.children[0]._setVertices([[this._posArg?this._posArg:e[this._orientation],e.top],[this._posArg?this._posArg:e[this._orientation],e.bottom]])}this._rules.children.forEach((e=>e._updateBounds())),this._rules._updateBounds(),this._updateBounds()}_positionTicks(){let e=this._mlayout.cellBounds;if("x"==this._channel){let t="bottom"==this._orientation?1:-1;for(let[i,s]of this._ticks.children.entries()){let a=this._posArg?e[i][this._orientation]+this._posArg-e[0][this._orientation]+this._tickOffset*t:e[i][this._orientation]+this._tickOffset*t;s._setVertices([[e[i].x,a],[e[i].x,a+t*this._tickSize]]),s._updateBounds()}}else if("y"==this._channel){let t="left"==this._orientation?-1:1;for(let[i,s]of this._ticks.children.entries()){let a=this._posArg?e[i][this._orientation]+this._posArg-e[0][this._orientation]+this._tickOffset*t:this._mlayout.group.bounds[this._orientation]+this._tickOffset*t,r="middle"==this._tickAnchor?e[i].y:e[i][this._tickAnchor];s._setVertices([[a,r],[a+t*this._tickSize,r]]),s._updateBounds()}}this._ticks._updateBounds(),this._updateBounds()}_positionLabels(){let e=this._mlayout.cellBounds;if("x"==this._channel){let t="bottom"==this._orientation?["center","top"]:["center","bottom"],i="bottom"==this._orientation?this._labelOffset:-this._labelOffset;for(let[s,a]of this._labels.children.entries())a.x=e[s].x,a.y=this._posArg?e[s][this._orientation]+this._posArg-e[0][this._orientation]+i:e[s][this._orientation]+i,a.anchor=t,this._labelRotation&&(a._rotate=[this._labelRotation,a.x,a.y],a.anchor=["right",t[1]])}else if("y"==this._channel){let t="left"==this._orientation?["right","middle"]:["left","middle"],i="left"==this._orientation?-this._labelOffset:this._labelOffset;for(let[s,a]of this._labels.children.entries())a.x=this._posArg?e[s][this._orientation]+this._posArg-e[0][this._orientation]+i:this._mlayout.group.bounds[this._orientation]+i,a.y="middle"==this._tickAnchor?e[s].y:e[s][this._tickAnchor],a.anchor=t,this._labelRotation&&(a._rotate=[this._labelRotation,a.x,a.y])}this._labels._updateBounds(),this._updateBounds()}_positionTitle(){let e=this._rules.bounds;this._title.achor=this._titleAnchor,this._titlePosition?(this._title.x=this._titlePosition[0],this._title.y=this._titlePosition[1],"y"!=this._channel&&"height"!=this._channel||this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])):"x"==this._channel?(this._title.x=e.x,this._titleOffset=this._labels.bounds.height+this._labelOffset+15,this._title.y="top"==this._orientation?e.top-this._titleOffset:e.bottom+this._titleOffset):(this._titleOffset=this._labels.bounds.width+this._labelOffset+15,this._title.x="left"==this._orientation?e.left-this._titleOffset:e.right+this._titleOffset,this._title.y=e.y,this._rotateYTitle&&(this._title._rotate="left"==this._orientation?[-90,this._title.bounds.x,this._title.bounds.y]:[90,this._title.bounds.x,this._title.bounds.y])),this._title._updateBounds(),this._updateBounds()}matches(e){return getEncodingKey(this._item).split("_")[0]===getEncodingKey(e).split("_")[0]}}class Legend extends Group{constructor(e,t){super(),this.type=ItemType.Legend,this.id=this.type+ItemCounter[this.type]++,this.encoding=e,this._textColor="textColor"in t?t.textColor:"#555",this._strokeColor="strokeColor"in t?t.strokeColor:"#555",this._x="x"in t?t.x:0,this._y="y"in t?t.y:0,this._showTitle=!("showTitle"in t)||t.showTitle,"numCols"in t||"numRows"in t?(this._numCols=t.numCols,this._numRows=t.numRows):this._numCols=1,this._orientation="orientation"in t?t.orientation:Orientation.Vertical,this._initialize()}toJSON(){let e=super.toJSON();return"args"in e||(e.args={}),e.args.textColor=this._textColor,e.channel=this.encoding.channel,e.field=this.encoding.field,e.args.strokeColor=this._strokeColor,e.args.x=this._x,e.args.y=this._y,e.args.orientation=this._orientation,e}get field(){return this.encoding.field}get channel(){return this.encoding.channel}get fieldType(){return this.encoding.datatable.getFieldType(this.field)}_initialize(){let e=this.encoding.scene,t=this.encoding.field;switch(this.encoding.datatable.getFieldType(t)){case DataType.String:this._createCategoricalColorLegend(e,t);break;case DataType.Number:case DataType.Integer:this._createNumericalColorLegend(e,t)}}_createNumericalColorLegend(e,t){let i,s,a;if(this._orientation==Orientation.Vertical?(i=15,s=300):(i=300,s=15),this._showTitle){let s=e.mark("text",{fillColor:this._textColor,text:t,x:this._x+i/2,y:this._y,anchor:["center","middle"]});this.addChild(s),a=20}else a=0;let r,n=e.mark("rect",{top:this._y+a,left:this._x,width:i,height:s,strokeWidth:0,opacity:this.encoding.anyItem.opacity}),o=[Math.min(...this.encoding.data),Math.max(...this.encoding.data)],l=this.encoding.mapping,h=[],c=[];if(l){let t=Object.keys(l).map((e=>parseFloat(e))).sort(((e,t)=>e-t));this._orientation==Orientation.Vertical?(r=new LinearGradient({x1:0,y1:100,x2:0,y2:0}),t.forEach((t=>{let n=(t-o[0])/(o[1]-o[0]);r.addStop(100*n,l[t],1);let d=e.mark("line",{x1:this._x-5,x2:this._x+i+5,y1:this._y+s-n*s+a,y2:this._y+s-n*s+a,strokeColor:this._strokeColor});c.push(d);let u=e.mark("text",{fillColor:this._textColor,text:t.toFixed(0),x:this._x+i+5+5,y:this._y+s-n*s+a,anchor:["left","middle"]});h.push(u)}))):(r=new LinearGradient({x1:0,y1:0,x2:100,y2:0}),t.forEach((t=>{let n=(t-o[0])/(o[1]-o[0]);r.addStop(100*n,l[t],1);let d=e.mark("line",{x1:this._x+n*i,x2:this._x+n*i,y1:this._y+20-5+a,y2:this._y+s+5+a,strokeColor:this._strokeColor});c.push(d);let u=e.mark("text",{fillColor:this._textColor,text:t.toFixed(0),x:this._x+n*i,y:this._y+s+5+a,anchor:["center","top"]});h.push(u)})))}else{let t=this.encoding.scale.domain,n=[];for(let e=0;e<11;e++)n.push(t[0]+(t[1]-t[0])*e/10);this._orientation==Orientation.Vertical?(r=new LinearGradient({x1:0,y1:100,x2:0,y2:0}),n.forEach((n=>{let o=(n-t[0])/(t[1]-t[0]);r.addStop(100*o,this.encoding.scale.map(n),1);let l=e.mark("line",{x1:this._x-5,x2:this._x+i+5,y1:this._y+s-o*s+a,y2:this._y+s-o*s+a,strokeColor:this._strokeColor});c.push(l);let d=e.mark("text",{fillColor:this._textColor,text:n.toFixed(0),x:this._x+i+5+5,y:this._y+s-o*s+a,anchor:["left","middle"]});h.push(d)}))):(r=new LinearGradient({x1:0,y1:0,x2:100,y2:0}),n.forEach((n=>{let o=(n-t[0])/(t[1]-t[0]);r.addStop(100*o,this.encoding.scale.map(n),1);let l=e.mark("line",{x1:this._x+o*i,x2:this._x+o*i,y1:this._y+s+a,y2:this._y+s+5+a,strokeColor:this._strokeColor});c.push(l);let d=e.mark("text",{fillColor:this._textColor,text:n.toFixed(0),x:this._x+o*i,y:this._y+s+5+a,anchor:["center","top"]});h.push(d)})))}n.styles.fillColor=r,this.addChild(n);for(let e of h)this.addChild(e);for(let e of c)this.addChild(e)}_createCategoricalColorLegend(e,t){let i=0;this._showTitle&&(this.addChild(new PointText({fillColor:this._textColor,text:t,x:this._x,y:this._y,anchor:["left","top"]})),i=20);let s=e.mark("rect",{top:this._y+2+i,left:this._x,width:10,height:10,strokeWidth:0,opacity:this.encoding.anyItem.opacity}),a=e.mark("text",{fillColor:this._textColor,x:this._x+20,y:this._y+i,anchor:["left","top"]}),r=e.glyph(s,a),n=this.encoding.scale,o=new DataTable(n.domain.map((e=>({category:e,value:n.map(e)})))),l=e.repeat(r,o);e.encode(a,{channel:"text",field:"category",_remember:!1}),e.encode(s,{channel:"fillColor",field:"category",_remember:!1,scale:n}),l.layout=layout("grid",{numCols:this._numCols,numRows:this._numRows}),this.addChild(l)}pathHitTest(e,t){let i=getLeafItems(this);for(let s=i.length-1;s>=0;s--){let a=i[s];if(isPath(a)&&a.contains(e,t))return a}return null}}class Glyph extends Group{constructor(e){if(super(),this.type=ItemType.Glyph,this._id=this.type+ItemCounter[this.type]++,e)for(let t of e)this.addChild(t)}duplicate(){let e=this.getScene().glyph();for(let t of this.children)e.addChild(t.duplicate());return e.classId=this.classId,this._dataScope&&(e.dataScope=this._dataScope.clone()),e}}class PiePath extends Path{constructor(e){super(e),this.radius="radius"in e?e.radius:100,this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this.startAngleDeg="startAngle"in e?e.startAngle%360:0,this.endAngleDeg="endAngle"in e?e.endAngle%360:90,this.totalAng=this.endAngleDeg<this.startAngleDeg?this.endAngleDeg+360-this.startAngleDeg:this.endAngleDeg-this.startAngleDeg,this.startAngleRad=this.startAngleDeg*(Math.PI/180),this.endAngleRad=this.endAngleDeg*(Math.PI/180),this.type=ItemType.Pie,this.closed=!0;let t=[this._x,this._y],i=[this._x+this.radius*Math.cos(this.startAngleRad),this._y-this.radius*Math.sin(this.startAngleRad)],s=[this._x+this.radius*Math.cos(this.endAngleRad),this._y-this.radius*Math.sin(this.endAngleRad)];this._setVertices(new Array(t,i,s))}get x(){return this._x}get y(){return this._y}set x(e){this._x=e,this._updateBounds()}set y(e){this._y=e,this._updateBounds()}get angle(){return this.totalAng}get quadrants(){let e=[];return this.startAngleDeg>=0&&this.startAngleDeg<90?e[0]=1:this.startAngleDeg>=90&&this.startAngleDeg<180?e[0]=2:this.startAngleDeg>=180&&this.startAngleDeg<270?e[0]=3:this.startAngleDeg>=270&&this.startAngleDeg<=360&&(e[0]=4),this.endAngleDeg>=0&&this.endAngleDeg<90?e[1]=1:this.endAngleDeg>=90&&this.endAngleDeg<180?e[1]=2:this.endAngleDeg>=180&&this.endAngleDeg<270?e[1]=3:this.endAngleDeg>=270&&this.endAngleDeg<360&&(e[1]=4),e}getSVGPathData(){let[[e,t],[i,s],[a,r]]=this.vertices.map((e=>[e.x,e.y])),n=this.radius;return`M ${e} ${t} L ${i} ${s} A ${n} ${n} ${this.totalAng} ${this.totalAng>180?1:0} 0 ${a} ${r} Z`}adjustAngle(e,t){this.startAngleDeg=e%360,this.endAngleDeg=t%360,this.startAngleRad=this.startAngleDeg*(Math.PI/180),this.endAngleRad=this.endAngleDeg*(Math.PI/180),this.totalAng=this.endAngleDeg-this.startAngleDeg,this.vertices[1].x=this.x+this.radius*Math.cos(this.startAngleRad),this.vertices[1].y=this.y-this.radius*Math.sin(this.startAngleRad),this.vertices[2].x=this.x+this.radius*Math.cos(this.endAngleRad),this.vertices[2].y=this.y-this.radius*Math.sin(this.endAngleRad)}_updateBounds(){const[e,t]=this.quadrants,i=this.vertices[1],s=this.vertices[2];let a=this.vertices[0],r=a.y,n=a.x,o=a.x,l=a.y;1===e?(i.x>n&&(n=i.x),i.y<r&&(r=i.y)):2===e?(i.x>n&&(n=i.x),i.y>l&&(l=i.y)):3===e?(i.x<o&&(o=i.x),i.y>l&&(l=i.y)):(i.x<o&&(o=i.x),i.y<r&&(r=i.y)),1===t?(s.x>n&&(n=s.x),s.y<r&&(r=s.y)):2===t?(s.x>n&&(n=s.x),s.y>l&&(l=s.y)):3===t?(s.x<o&&(o=s.x),s.y>l&&(l=s.y)):(s.x<o&&(o=s.x),s.y<r&&(r=s.y)),a.y-this.radius<r&&(r=a.y-this.radius),a.y+this.radius>l&&(l=a.y+this.radius),a.x+this.radius>n&&(n=a.x+this.radius),a.x-this.radius<o&&(o=a.x-this.radius),this._bounds=new Rectangle(o,r,n-o,l-r)}}class AreaPath extends Path{constructor(e){super(e),this.type=ItemType.Area,this.closed=!0,this._orientation="orientation"in e?e.orientation:void 0,this._baseline="baseline"in e?e.baseline:void 0,e&&"vertices"in e&&this.segments.push(new Segment(this.vertices[this.vertices.length-1],this.vertices[0],this,this.segmentCounter++))}get baseline(){return this._baseline}set baseline(e){this._baseline=e}get orientation(){return this._orientation}set orientation(e){this._orientation=e}get firstVertexPair(){return[this.vertices[0],this.vertices[this.vertices.length-1]]}get width(){return this.vertices[this.vertices.length/2].x-this.vertices[0].x}get height(){return this.vertices[this.vertices.length/2].y-this.vertices[0].y}get left(){return this.vertices[0].x}get top(){return this.vertices[0].y}copyPropertiesTo(e){super.copyPropertiesTo(e),e._baseline=this._baseline}resizeArea(e,t){let i=this.vertices[this.vertices.length/2].x,s=this.vertices[this.vertices.length/2].y,a=this.width,r=this.height;for(let n of this.vertices)n.x=i+e/a*(n.x-i),n.y=s+t/r*(n.y-s);this._updateBounds()}getSVGPathData(){return super.getSVGPathData()+" z"}}class RingPath extends Path{constructor(e){super(e),this.type=ItemType.Ring,this.closed=!0,this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this._innerRadius="innerRadius"in e?e.innerRadius:100,this._outerRadius="outerRadius"in e?e.outerRadius:200}get innerRadius(){return this._innerRadius}set innerRadius(e){this._innerRadius=e}get outerRadius(){return this._outerRadius}set outerRadius(e){this._outerRadius=e,this._updateBounds()}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(e){this._x=e,this._updateBounds()}set y(e){this._y=e,this._updateBounds()}get thickness(){return this._outerRadius-this._innerRadius}_doTranslate(e,t){this._x+=e,this._y+=t,this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this._x-this._outerRadius,this._y-this._outerRadius,2*this._outerRadius,2*this._outerRadius)}copyPropertiesTo(e){super.copyPropertiesTo(e),e._x=this._x,e._y=this._y,e._innerRadius=this._innerRadius,e._outerRadius=this._outerRadius}getSVGPathData(){return["M "+this._x+" "+this._y,"m 0, -"+this._outerRadius,"a "+this._outerRadius+","+this._outerRadius+", 0, 1, 0, 1, 0","Z","m 0 "+(this._outerRadius-this._innerRadius),"a "+this._innerRadius+", "+this._innerRadius+", 0, 1, 1, -1, 0","Z"].join(" ")}}class PolygonPath extends Path{constructor(e){super(e),this.type=ItemType.Polygon,this.closed=!0,"x"in e&&(this._x=e.x),"y"in e&&(this._y=e.y),"radius"in e&&(this._radius=e.radius)}get radius(){return this._radius}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(e){this._x=e,this._updateBounds()}set y(e){this._y=e,this._updateBounds()}set radius(e){this._radius=e,this._updateBounds()}copyPropertiesTo(e){super.copyPropertiesTo(e),e._x=this._x,e._y=this._y,e._radius=this._radius}_doTranslate(e,t){this._x+=e,this._y+=t,super._doTranslate(e,t)}}class AlignConstraint{constructor(e,t){this.direction=t,this.items=e,this.type=ConstraintType.Align,this.id=this.type+"_"+[...new Set(this.items.map((e=>e.classId)))].join("_")}apply(){let e,t=this.direction;this.direction==Alignment.Top||this.direction==Alignment.Left?e=Math.min(...this.items.map((e=>e.bounds[t]))):this.direction==Alignment.Bottom||this.direction==Alignment.Right?e=Math.max(...this.items.map((e=>e.bounds[t]))):this.direction!=Alignment.Center&&this.direction!=Alignment.Middle||(e=d3__namespace.mean(this.items.map((e=>e.bounds[t]))));let i=this.items.map((i=>e-i.bounds[t])),s=t==Alignment.TOP||t==Alignment.Middle||t==Alignment.Bottom?"y":"x";this.items.forEach(((e,t)=>{if(e.parent&&e.parent.layout&&e.parent.layout.type==LayoutType.Stack){let a="x"==s?i[t]:0,r="y"==s?i[t]:0;e.parent._doTranslate(a,r)}else{let a="x"==s?i[t]:0,r="y"==s?i[t]:0;e._doTranslate(a,r)}}));let a={};this.items.forEach((e=>a[e.classId]=e)),Object.values(a).forEach((e=>e.getScene()._updateAncestorBounds(e)))}toJSON(){let e={};return e.items=this.items.map((e=>e.id)),e.direction=this.direction,e.type=this.type,e.id=this.id,e}}class AffixConstraint{constructor(e,t,i,s,a,r,n){this.item=e,this.baseItem=t,this.scene=i,this.channel=s,this.itemAnchor=a,this.baseAnchor=r,this.offset=n,this.type=ConstraintType.Affix,this.id=this.type+"_"+this.item.classId+"_"+this.baseItem.classId+"_"+s}apply(){let e=getPeers(this.item,this.scene),t=getPeers(this.baseItem,this.scene),i=this.itemAnchor,s=this.baseAnchor,a=this.item.type==ItemType.PointText;if("radialDistance"==this.channel)for(let a=0;a<e.length;a++){let r,n=t[a],o=e[a];n.type!=ItemType.Arc&&n.type!=ItemType.Ring||(r="top"==s?n.outerRadius+this.offset:"bottom"==s?n.innerRadius+this.offset:(n.outerRadius+n.innerRadius)/2+this.offset),o._doTranslate(n.x-o.x,n.y-r-o.bounds[i]),o._rotate?o._rotate=[o._rotate[0],n.x,n.y]:o._rotate=[0,n.x,n.y]}else if("angle"==this.channel)for(let a=0;a<e.length;a++){let r=t[a],n=e[a],o="left"==s?r.endAngle+this.offset:"center"==s?(r.endAngle+r.startAngle)/2+this.offset:r.startAngle+this.offset;n._rotate?n._rotate[0]=90-o:(n._doTranslate(r.x-n.bounds[i],r.y-e[a].y),n._rotate=[90-o,t[a].x,t[a].y])}else{let r;if(this.baseItem.type==ItemType.Link)switch(s){case"left":case"top":r=0;break;case"center":case"middle":r=.5;break;case"right":case"bottom":r=1}for(let n=0;n<e.length;n++){let o=this.baseItem.type==ItemType.Link?t[n].getPointAt(r)[this.channel]:t[n].bounds[s]+this.offset;a?(e[n].anchor["x"==this.channel?0:1]=this.itemAnchor,e[n][this.channel]=o):"x"==this.channel?e[n]._doTranslate(o-e[n].bounds[i],0):e[n]._doTranslate(0,o-e[n].bounds[i])}}this.item.getScene()._updateAncestorBounds(this.item),this.baseItem.getScene()._updateAncestorBounds(this.baseItem)}toJSON(){let e={};return e.item=this.item.id,e.baseItem=this.baseItem.id,e.channel=this.channel,e.itemAnchor=this.itemAnchor,e.baseAnchor=this.baseAnchor,e.offset=this.offset,e.type="affixation",e.id=this.id,e}}class Gridlines extends Group{constructor(e,t,i){super(),this.type=ItemType.Gridlines,this.id=this.type+ItemCounter[this.type]++,this.encoding=e,this.channel=this.encoding.channel,this._item=t,this._strokeColor="strokeColor"in i?i.strokeColor:"#ddd",this._strokeWidth="strokeWidth"in i?i.strokeWidth:1,"radialDistance"==this.channel&&"angle"in i&&(this._rotate=[-i.angle,this.encoding.x,this.encoding.y])}toJSON(){let e={args:{}};return e.type=this.type,e.id=this.id,e.args.strokeColor=this._strokeColor,e.args.strokeWidth=this._strokeWidth,e.args.values=this._values,"time"===this.encoding.scale.type&&(e.args.isDate=!0),e.channel=this.encoding.channel,e.field=this.encoding.field,this._rotate&&(e.args.angle=this._rotate[0]),e}get values(){return this._values}set values(e){this._values=e,this.updateLines(),this.updateLinePositions()}get strokeColor(){return this._strokeColor}set strokeColor(e){this._strokeColor=e;for(let t of this.children)t.strokeColor=e}get strokeWidth(){return this._strokeWidth}set strokeWidth(e){this._strokeWidth=e;for(let t of this.children)t.strokeWidth=e}matches(e){let t=getEncodingKey(e).split("_")[0],i=this.encoding.scale.encodings;for(let e of i){if(getEncodingKey(e.anyItem).split("_")[0]===t)return!0}return!1}updateLinePositions(){if("x"==this.channel||"width"==this.channel){let e=getTopLevelGroup(this._item).bounds,t=this.encoding.getScaleRange(this._item);for(let[i,s]of this.children.entries()){let a=t[0]+this.encoding.scale.map(this._values[i])-this.encoding.scale.range[0];s._setVertices([[a,e.top],[a,e.bottom]])}}else if("y"==this.channel||"height"==this.channel){let e=getTopLevelGroup(this._item).bounds,t=this.encoding.getScaleRange(this._item);if(this.encoding.flip)for(let[i,s]of this.children.entries()){let a=t[1]-this.encoding.scale.map(this._values[i])+this.encoding.scale.range[0];s._setVertices([[e.left,a],[e.right,a]])}else for(let[i,s]of this.children.entries()){let a=t[0]-this.encoding.scale.map(this._values[i])+this.encoding.scale.range[0];s._setVertices([[e.left,a],[e.right,a]])}}else if("radialDistance"==this.channel)for(let[e,t]of this.children.entries())t.x=this._item.parent.x,t.y=this._item.parent.y,t.radius=this.encoding.scale.map(this._values[e]);for(let e of this.children)e._updateBounds();this._updateBounds()}updateLines(){if(this.children=[],"x"==this.channel||"y"==this.channel||"width"==this.channel||"height"==this.channel)for(let e=0;e<this._values.length;e++){let t=new Path({strokeColor:this._strokeColor,fillColor:"none",strokeWidth:this._strokeWidth});t.type=ItemType.Line,t.id=this.id+"line"+e,this.addChild(t)}else if("radialDistance"==this.channel)for(let e=0;e<this._values.length;e++){let t=new CirclePath({strokeColor:this._strokeColor,fillColor:"none",strokeWidth:this._strokeWidth});t.type=ItemType.Circle,t.id=this.id+"line"+e,this.addChild(t)}}}class Collection extends Group{constructor(){super(),this.type=ItemType.Collection,this._id=this.type+ItemCounter[this.type]++,this.classId=this.id}duplicate(){let e=this.getScene().collection();for(let t=0;t<this.children.length;t++){let i=this.children[t];e.addChild(i.duplicate())}if(e.classId=this.classId,e.parent=this.parent,this._layout){let t=this._layout.clone();e.layout=t}return e}}class ArcPath extends Path{constructor(e){super(e),this.type=ItemType.Arc,this.closed=!0,this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this._innerRadius="innerRadius"in e?e.innerRadius:100,this._outerRadius="outerRadius"in e?e.outerRadius:200,this._startAngle="startAngle"in e?e.startAngle:0,this._endAngle="endAngle"in e?e.endAngle:90,this._sr=degree2radian(this._startAngle),this._er=degree2radian(this._endAngle);let t=this._x+this._innerRadius*Math.cos(this._sr),i=this._y-this._innerRadius*Math.sin(this._sr),s=this._x+this._innerRadius*Math.cos(this._er),a=this._y-this._innerRadius*Math.sin(this._er),r=this._x+this._outerRadius*Math.cos(this._sr),n=this._y-this._outerRadius*Math.sin(this._sr),o=this._x+this._outerRadius*Math.cos(this._er),l=this._y-this._outerRadius*Math.sin(this._er);this._setVertices([[t,i],[r,n],[o,l],[s,a]])}get innerRadius(){return this._innerRadius}set innerRadius(e){this._innerRadius=e,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}get outerRadius(){return this._outerRadius}get thickness(){return this._outerRadius-this._innerRadius}set outerRadius(e){this._outerRadius=e,this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this._updateBounds()}get x(){return this._x}get y(){return this._y}get center(){return new Point(this._x,this._y)}set x(e){this._x=e,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this._updateBounds()}set y(e){this._y=e,this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}get startAngle(){return this._startAngle}get endAngle(){return this._endAngle}contains(e){let t=this.startAngle,i=this.endAngle;i<t&&(i+=360);let s=e.startAngle,a=e.endAngle;return a<s&&(a+=360),s>=t&&s<=i&&a>=t&&a<=i}_doTranslate(e,t){this._x+=e,this._y+=t,this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er),this._updateBounds()}_updateBounds(){this._bounds=new Rectangle(this._x-this._outerRadius,this._y-this._outerRadius,2*this._outerRadius,2*this._outerRadius)}copyPropertiesTo(e){super.copyPropertiesTo(e),e._x=this._x,e._y=this._y,e._innerRadius=this._innerRadius,e._outerRadius=this._outerRadius,e._startAngle=this._startAngle,e._endAngle=this._endAngle,e._sr=this._sr,e._er=this._er}getSVGPathData(){let e=this._endAngle<this._startAngle?this._endAngle+360-this._startAngle:this._endAngle-this._startAngle,t=e>180?1:0;return["M "+this.vertices[0].x+", "+this.vertices[0].y,"L "+this.vertices[1].x+", "+this.vertices[1].y,"A "+[this._outerRadius,this._outerRadius,e,t,0,this.vertices[2].x,this.vertices[2].y].join(" "),"L "+this.vertices[3].x+", "+this.vertices[3].y,"A "+[this._innerRadius,this._innerRadius,e,t,1,this.vertices[0].x,this.vertices[0].y].join(" ")].join(" ")}adjustAngle(e,t){this._startAngle=e,this._endAngle=t,this._sr=degree2radian(this._startAngle),this._er=degree2radian(this._endAngle),this.vertices[0].x=this._x+this._innerRadius*Math.cos(this._sr),this.vertices[0].y=this._y-this._innerRadius*Math.sin(this._sr),this.vertices[1].x=this._x+this._outerRadius*Math.cos(this._sr),this.vertices[1].y=this._y-this._outerRadius*Math.sin(this._sr),this.vertices[2].x=this._x+this._outerRadius*Math.cos(this._er),this.vertices[2].y=this._y-this._outerRadius*Math.sin(this._er),this.vertices[3].x=this._x+this._innerRadius*Math.cos(this._er),this.vertices[3].y=this._y-this._innerRadius*Math.sin(this._er)}}class Image extends Mark{constructor(e){super(e),this.type=ItemType.Image,this._src=e.src,this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this._width="width"in e?e.width:100,this._height="height"in e?e.height:100}toJSON(){let e=super.toJSON();return e.src=this._src,e.x=this._x,e.y=this._y,e.width=this._width,e.height=this._height,e}get src(){return this._src}set src(e){this._src=e}get width(){return this._width}set width(e){this._width=e,this._updateBounds()}get height(){return this._height}set height(e){this._height=e,this._updateBounds()}get x(){return this._x}set x(e){this._x=e,this._updateBounds()}get y(){return this._y}set y(e){this._y=e,this._updateBounds()}get bounds(){return this._bounds||this._updateBounds(),this._bounds}_updateBounds(){this._bounds=new Rectangle(this._x,this._y,this._width,this._height)}copyPropertiesTo(e){e.attrs=Object.assign({},this.attrs),e.styles=Object.assign({},this.styles),this._dataScope&&(e._dataScope=this._dataScope.clone()),e.x=this._x,e.y=this._y,e.width=this._width,e.height=this._height,e.src=this._src}_doTranslate(e,t){this._x+=e,this._y+=t,this._updateBounds()}}class Link extends Path{constructor(e){super(e),this.type=ItemType.Link,this.mode="mode"in e?e.mode:"linear",this.source=void 0,this.target=void 0,this.sourceAnchor="sourceAnchor"in e?e.sourceAnchor:["center","middle"],this.targetAnchor="targetAnchor"in e?e.targetAnchor:["center","middle"],this.sourceOffset="sourceOffset"in e?e.sourceOffset:[0,0],this.targetOffset="targetOffset"in e?e.targetOffset:[0,0]}radialvalue(e,t){let i=e-Math.PI/2;return[e=t*Math.cos(i),t*=Math.sin(e)]}bezierCurveHorizontal(e,t,i,s){return`M ${e} ${t} C ${(e+i)/2} ${t} ${e} ${s} ${i} ${s}`}bezierCurveVertical(e,t,i,s){return`M ${e} ${t} C ${e} ${(t+s)/2} ${i} ${t} ${i} ${s}`}bezierCurveRadial(e,t,i,s){let a=this.radialvalue(e,t),r=this.radialvalue(e,(t+s)/2),n=this.radialvalue(i,t),o=this.radialvalue(i,s);return`M ${a[0]} ${a[1]} C ${r[0]} ${r[1]} ${n[0]} ${n[1]} ${o[0]} ${o[1]}`}_updateBounds(){if(null!=this.source&&null!=this.target){let e=this.source.bounds[this.sourceAnchor[0]]+this.sourceOffset[0],t=this.source.bounds[this.sourceAnchor[1]]+this.sourceOffset[1],i=this.target.bounds[this.targetAnchor[0]]+this.targetOffset[0],s=this.target.bounds[this.targetAnchor[1]]+this.targetOffset[1];this._bounds=new Rectangle(Math.min(e,i),Math.min(t,s),Math.abs(e-i),Math.abs(t-s))}else this._bounds=new Rectangle(0,0,0,0)}getSVGPathData(){if(void 0===this.source||void 0===this.target)return"";let e=this.source.bounds[this.sourceAnchor[0]]+this.sourceOffset[0],t=this.source.bounds[this.sourceAnchor[1]]+this.sourceOffset[1],i=this.target.bounds[this.targetAnchor[0]]+this.targetOffset[0],s=this.target.bounds[this.targetAnchor[1]]+this.targetOffset[1];switch(this.mode){case"curveHorizontal":return this.bezierCurveHorizontal(e,t,i,s);case"curveVertical":return this.bezierCurveVertical(e,t,i,s);case"linear":default:return`M ${e} ${t} L ${i} ${s}`}}copyPropertiesTo(e){super.copyPropertiesTo(e),e.sourceAnchor=this.sourceAnchor.slice(),e.targetAnchor=this.targetAnchor.slice(),e.sourceOffset=this.sourceOffset.slice(),e.targetOffset=this.targetOffset.slice(),e.mode=this.mode}getPointAt(e){const t=SVGProvider.getSVG();let i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",this.getSVGPathData()),t.appendChild(i);let s=i.getTotalLength();return i.getPointAtLength(s*e)}}function bindToLink(e){return e._query=function(){let e=this.field,t=this.channel,i=this.items.map((e=>e.dataScope));if("source"==t||"target"==t){let t=i.map((t=>t.getFieldValue(e))),s=this.scene;this.data=[];for(let e of t){let t=s.find([{field:nodeId,value:e}]);t=t.filter((e=>e.type!==ItemType.Collection)),this.data.push(t[0])}}else if("strokeWidth"==t)if(this.datatable.hasField(e))this.data=i.map((t=>t.getFieldValue(e)));else if(e.startsWith("parent.")||e.startsWith("child.")){let t=this.datatable.tree.nodeTable,s=e.split(".")[0],a=e.split(".")[1],r=i.map((e=>e.getFieldValue(s)));this.data=r.map((e=>new DataScope(t).cross(nodeId,e).getFieldValue(a)))}},e._map=function(){let e,t=this.channel,i=this.items;if("strokeWidth"==t){let t,s;e=createScale(this.scaleType?this.scaleType:"linear"),e.domain=[0,Math.max(...this.data)],t=1,s=Math.max(...i.map((e=>parseFloat(e.styles.strokeWidth)))),s==t&&(s=t+5),this.rangeExtent&&(s=t+this.rangeExtent),this.range&&(t=this.range[0],s=this.range[1]),e._setRange([t,s]),this.scale||(this.scale=e),this.scale._addEncoding(this)}},e._apply=function(){let e=this.channel;if("source"==e||"target"==e)for(let e=0;e<this.data.length;e++)this.items[e][this.channel]=this.data[e],this.items[e]._updateBounds();else if("strokeWidth"==e)for(let e=0;e<this.data.length;e++)this.items[e].styles.strokeWidth=this.scale.map(this.data[e])},e.run(),e}const SceneValidator={itemTranslated:function(e,t,i){let s=e.getScene();isGuide(e)||s._reapplyConstraints(e),s.getRelatedAxes(e).forEach((e=>{e.encoding&&void 0!==e.encoding.scale.offset&&(e.encoding.scale.offset+="x"===e.channel||"width"===e.channel?t:i),0===i||"x"!==e.channel&&"width"!==e.channel||void 0===e._posArg||(e._posArg=e._posArg+i),0===t||"y"!==e.channel&&"height"!==e.channel||void 0===e._posArg||(e._posArg=e._posArg+t),e.reposition()})),s.getRelatedGridlines(e).forEach((e=>e.updateLinePositions()))},layoutChanged:function(e,t,i){let s=e.getScene();s._relayoutAncestors(e,t);let a=[e],r=e.firstChild;for(;r;)a.push(r),r=r.firstChild;for(let e of a)e.getScene()._reapplyConstraints(e);if(i)s.reCreateRelatedAxes(e);else{s.getRelatedAxes(e).forEach((e=>e.reposition()))}s.getRelatedGridlines(e).forEach((e=>e.updateLinePositions()))},scaleDomainSet:function(e){for(let t of e.encodings)t._map(),t._apply();for(let t of e.encodings)t.scene._updateAncestorBounds(t.item,t.items);let t=e.encodings.map((e=>e.anyItem)),i={};for(let e of t)"vertex"===e.type||"segment"===e.type?i[e.parent.classId]=e.parent:i[e.classId]=e;for(let e of Object.values(i))e.getScene()._reapplyConstraints(e);for(let t of e.encodings){let i=t.anyItem,s=t.scene.getRelatedAxes(i);for(let i of s)i.encoding&&i.encoding.scale===e&&(i.tickValues=t.scene._inferTickValues(t),i.labelValues=t.scene._inferTickValues(t),i._positionPath(),i._showTitle&&i._positionTitle(),"radialDistance"===i._channel&&i._rotate&&(i._rotate=[i._rotate[0],i._item.parent.x,i._item.parent.y]),i._updateBounds());t.scene.getRelatedGridlines(i).forEach((e=>e.updateLinePositions()))}},scaleRangeSet:function(e){for(let t of e.encodings)t._apply();for(let t of e.encodings)t.scene._updateAncestorBounds(t.item,t.items);let t=e.encodings.map((e=>e.anyItem)),i={};for(let e of t)"vertex"===e.type||"segment"===e.type?i[e.parent.classId]=e.parent:i[e.classId]=e;for(let e of Object.values(i))e.getScene()._reapplyConstraints(e);for(let t of e.encodings){let e=t.anyItem;t.scene.getRelatedAxes(e).forEach((e=>e.reposition())),t.scene.getRelatedGridlines(e).forEach((e=>e.updateLinePositions()))}},itemResized:function(e,t){let i=e.getScene();i._relayoutAncestors(e,t),i._reapplyConstraints(e),i.getRelatedAxes(e).forEach((e=>e.reposition())),i.getRelatedGridlines(e).forEach((e=>e.updateLinePositions()))},markDivided:function(e,t){let i=t.getScene(),s=i.encodings[getEncodingKey(e)];if(s){i.encodings[getEncodingKey(t)]={};for(let a of["x","y"]){const r=s[a];r&&(r.anyItem=t,r.items=getPeers(t,i),i.encodings[getEncodingKey(t)][a]=r,delete i.encodings[getEncodingKey(e)][a])}0===Object.keys(s)&&delete i.encodings[getEncodingKey(e)]}},areaRebased:function(e){let t=e.getScene(),i=t.encodings[getEncodingKey(e)];for(let e in i)i[e]._apply();t.getRelatedAxes(e).forEach((e=>e.reposition())),t.getRelatedGridlines(e).forEach((e=>e.updateLinePositions()))}};function repopulateItem(e,t,i,s){let a=s.getFieldType(i);if(a!=DataType.String&&a!=DataType.Date&&a!=DataType.Integer)throw new Error(Errors.REPOPULATE_BY_NONCAT+": "+i+" is "+a);if(t.parent&&t.parent.dataScope&&!t.parent.dataScope.isFullTable()&&t.parent.dataScope.dataTable!=s)throw new Error(Errors.REPOPULATE_DT_MISMATCH);return _doRopulate(e,t,i,s)}function _doRopulate(e,t,i,s){let a=getPeers(t.parent,e);1===a.length&&(t.parent.dataScope=void 0);for(let e of a){let t=s.getFieldSummary(i).unique.map((t=>e.dataScope?e.dataScope.cross(i,t):new DataScope(s).cross(i,t)));t=t.filter((e=>!e.isEmpty()));const a=t.length-e.children.length,r=e.children.length-t.length;for(let t=0;t<r;t++)e.removeChildAt(e.children.length-1);const n=e.children.length;for(let t=0;t<a;t++){let t=e.children[Math.floor(Math.random()*n)].duplicate();e.addChild(t)}e.children.forEach(((e,i)=>e.dataScope=t[i]))}e._relayoutAncestors(t)}function addToTree(e,t){let i=e.item;if(t.innerRadius===i.outerRadius&&i.contains(t))e.children.push({item:t,children:[]});else if(e.children&&e.children.length>0&&t.innerRadius>i.outerRadius&&i.contains(t))for(let i of e.children)addToTree(i,t)}function accumulateThickness(e,t,i,s){let a=e.item;if(a.innerRadius=t,a.outerRadius=t+s.map(i[a.id]),e.children&&e.children.length>0)for(let t of e.children)accumulateThickness(t,a.outerRadius,i,s)}function bindToThickness(e){return e._query=function(){this.data={};let e=this.field,t=this.items,i=t.map((e=>e.dataScope));switch(this.datatable.getFieldType(e)){case DataType.Boolean:break;case DataType.Date:for(let s=0;s<t.length;s++)this.data[t[s].id]=i[s].getFieldValue(e);break;case DataType.String:try{for(let s=0;s<t.length;s++)this.data[t[s].id]=i[s].getFieldValue(e)}catch(t){throw new Error("Cannot bind "+this.channel+" to "+e+" : "+t)}break;default:for(let s=0;s<t.length;s++)this.data[t[s].id]=i[s].aggregateNumericalField(e,this.aggregator)}},e._map=function(){let e=this.data;if(!this.scale){this.scale=createScale("linear"),this.scale.domain=[0,Math.max(...Object.values(e))];let t=1,i=this.rangeExtent?t+this.rangeExtent:Math.max(...this.items.map((e=>e.thickness)));this.scale._setRange([t,i])}this.scale._addEncoding(this)},e._apply=function(){this.items.sort(((e,t)=>(e.innerRadius+e.outerRadius)/2-(t.innerRadius+t.outerRadius)/2));let e={item:new ArcPath({outerRadius:0,startAngle:0,endAngle:360}),children:[]};for(let t of this.items)addToTree(e,t);for(let t of e.children)accumulateThickness(t,t.item.innerRadius,this.data,this.scale)},e.run(),e}class Scene extends Group{constructor(e){super(),e&&e.fillColor&&(this.fillColor=e.fillColor),this.type=ItemType.Scene,this._id=this.type+ItemCounter[this.type]++,this.encodings={},this.constraints={},this._itemMap={}}group(e){let t=new Group;if(t.classId=t.id,this.addChild(t),e&&e.length>0)for(let i of e)t.addChild(i);return this._itemMap[t.id]=t,t}mark(e,t){let i=void 0===t?{}:t,s=null;switch(e){case ItemType.Rect:{"top"in i||(i.top=0),"left"in i||(i.left=0),"width"in i||(i.width=100),"height"in i||(i.height=100);let e=i.top,t=i.left,a=i.width,r=i.height;i.vertices=[[t,e],[t+a,e],[t+a,e+r],[t,e+r]],delete i.top,delete i.left,delete i.width,delete i.height,"fillColor"in i||(i.fillColor="none"),s=new RectPath(i);break}case ItemType.Area:if(void 0!==i&&"x1"in i&&"y1"in i&&"x2"in i&&"y2"in i){let e=i.x1,t=i.y1,s=i.x2,a=i.y2;i.vertices=[[e,t],[s,t],[s,a],[e,a]],delete i.x1,delete i.y1,delete i.x2,delete i.y2}s=new AreaPath(i);break;case ItemType.Line:if(void 0!==i&&"x1"in i&&"y1"in i&&"x2"in i&&"y2"in i){let e=i.x1,t=i.y1,s=i.x2,a=i.y2;i.vertices=[[e,t],[s,a]],delete i.x1,delete i.y1,delete i.x2,delete i.y2}s=new Path(i),s.type=ItemType.Line;break;case ItemType.Path:s=new Path(i);break;case ItemType.Circle:s=new CirclePath(i);break;case ItemType.Ring:s=new RingPath(i);break;case ItemType.Arc:s=new ArcPath(i);break;case ItemType.Polygon:s=new PolygonPath(i);break;case ItemType.Pie:s=new PiePath(i);break;case"text":case ItemType.PointText:"anchor"in i||(i.anchor=["center","middle"]),s=new PointText(i);break;case ItemType.Image:s=new Image(i);break;case ItemType.Link:s=new Link(i)}return null!==s&&(s.id="id"in i?i.id:s.type+ItemCounter[s.type]++,s.classId=s.id,this.addChild(s),this._itemMap[s.id]=s),s}glyph(...e){let t=new Glyph(e);return t.classId=t.id,this.addChild(t),this._itemMap[t.id]=t,t}collection(){let e=new Collection;return this._itemMap[e.id]=e,e}attach(e,t){e.dataScope=new DataScope(t)}repeat(e,t,i){if(!e||void 0===t)throw Errors.INCOMPLETE_REPEAT_INFO;let s=i||{},a=s.field?s.field:DataTable.RowID,r=s.callback;validateField(a,t);let n=repeatItem(this,e,a,t,r);return s.layout&&(n.layout=s.layout),n}repopulate(e,t,i){if(!e||void 0===t)throw Errors.INCOMPLETE_REPEAT_INFO;let s=i||{},a=s.field?s.field:DataTable.RowID;validateField(a,t),repopulateItem(this,e,a,t)}densify(e,t,i){if(!e||void 0===t)throw Errors.INCOMPLETE_PARTITION_INFO;let s=i||{},a=s.orientation,r=s.field?s.field:DataTable.RowID,n="startAngle"in s?s.startAngle:90,o="direction"in s?s.direction:"clockwise",l=s.callback;return validateField(r,t),densifyItem(this,e,a,r,t,l,n,o)}divide(e,t,i){if(!e||null==t)throw Errors.INCOMPLETE_PARTITION_INFO;let s=i||{},a=s.orientation,r=s.field?s.field:DataTable.RowID,n=s.callback;validateField(r,t);let o=divideItem(this,e,a,r,t,n);return s.layout&&(o.layout=s.layout),SceneValidator.markDivided(e,o),o}_validateEncodeArgs(e,t){if(!e||!("channel"in t)||!("field"in t))throw Errors.INCOMPLETE_BINDING_INFO;let i=t.field;if("vertex"==e.type||"segment"==e.type){if(!e.parent.dataScope&&!e.dataScope)throw Errors.BIND_WITHOUT_DATASCOPE}else if(!e.dataScope)throw Errors.BIND_WITHOUT_DATASCOPE;validateField(i,t.table?t.table:e.dataScope?e.dataScope._dt:e.parent.dataScope._dt)}encode(e,t){let i;if(this._validateEncodeArgs(e,t),"vertex"==e.type&&e.parent.type==ItemType.Area){let t=getPeers(e.parent,this);i=[];let s=e.parent.vertices.indexOf(e)<e.parent.vertices.length/2;for(let e of t)i=s?i.concat(e.vertices.slice(0,e.vertices.length/2)):i.concat(e.vertices.slice(e.vertices.length/2))}else i=getPeers(e,this);return this._doEncode(i,t)}_doEncode(e,t){let i=e[0],s=t.channel,a=t.field;"datatable"in t||(t.datatable=i.dataScope?i.dataScope.dataTable:i.parent.dataScope.dataTable),"aggregator"in t||(t.aggregator="sum"),"flipScale"in t||(t.flipScale=!1),"includeZero"in t||(t.includeZero=!1);let r=new Encoding(e,this,s,a,t);switch(s){case"width":case"height":case"radius":case"outerRadius":case"innerRadius":case"area":case"fontSize":i.type==ItemType.Area?bindToArea(r):bindToSize(r);break;case"strokeWidth":i.type==ItemType.Link?bindToLink(r):bindToSize(r);break;case"x":case"y":i.type==ItemType.Area?bindToArea(r):bindToPosition(r);break;case"fillColor":case"strokeColor":bindToColor(r);break;case"angle":bindToAngle(r);break;case"text":bindToText(r);break;case"radialDistance":bindToRadialDistance(r);break;case"thickness":bindToThickness(r);break;case"source":case"target":bindToLink(r)}return"_remember"in t&&1!=t._remember||this._registerBinding(r),s.indexOf("Color")<0&&this._updateAncestorBounds(i,r.items),r}encodeWithinCollection(e,t){this._validateEncodeArgs(e,t);let i=getPeersGroupedByParent(e,this),s=[];for(let e of i){let i=this._doEncode(e,t);s.push(i)}return s}getPeers(e){return getPeers(e,this)}find(e){let t=[];for(let i of e)if("field"in i)"value"in i?t.push("d.dataScope && d.dataScope.getFieldValue('"+i.field+"') == '"+i.value+"'"):"range"in i?t.push("d.dataScope && d.dataScope.getFieldValue('"+i.field+"') >= "+i.range[0]+" && d.dataScope.getFieldValue('"+i.field+"') <= "+i.range[1]):"values"in i&&t.push("d.dataScope && ["+i.values.map((e=>"'"+e+"'")).join(",")+"].indexOf(d.dataScope.getFieldValue('"+i.field+"')) >= 0 ");else if("channel"in i)"value"in i?t.push("d."+i.channel+" == '"+i.value+"'"):"range"in i?t.push("d."+i.channel+" >= "+i.range[0]+" && d."+i.channel+" <= "+i.range[1]):"values"in i&&t.push("["+i.values.map((e=>"'"+e+"'")).join(",")+"].indexOf(d."+i.channel+") >= 0 ");else if("type"in i)t.push("d.type=='"+i.type+"'");else if("id"in i)t.push("d.id=='"+i.id+"'");else if("fields"in i){let e=i.fields[0],s=i.fields[1];t.push("d.dataScope && d.dataScope.getFieldValue('"+e+"')"+i.operator+"d.dataScope.getFieldValue('"+s+"')")}return findItems(this,new Function("d","return "+t.join(" && ")))}align(e,t){if(!canAlign(e,t,this))return!1;let i=new AlignConstraint(e,t);if(i.id in this.constraints)return console.warn("constraint has been added"),!1;this.constraints[i.id]=i,i.apply(),this._updateAncestorBounds(e[0])}removeAllConstraints(){this.constraints={}}affix(e,t,i,s){let a=s||{},r="offset"in a?a.offset:0,n="itemAnchor"in a?a.itemAnchor:"x"==i||"angle"==i?"center":"middle",o="baseAnchor"in a?a.baseAnchor:"x"==i||"angle"==i?"center":"middle",l=new AffixConstraint(e,t,this,i,n,o,r);l.id,this.constraints,this.constraints[l.id]=l,l.apply()}axis(e,t,i){let s=this.getEncodingByField(t,e),a=i||{};if(s){s.datatable.getFieldType(t)!==DataType.Date||"labelFormat"in a||(a.labelFormat="%m/%d/%y");let e=new EncodingAxis(s,a.item?a.item:s.anyItem,a);return"tickValues"in a?(e.tickValues=a.tickValues,e.labelValues=a.tickValues):(e.tickValues=this._inferTickValues(s),e.labelValues=this._inferTickValues(s)),this.addChildAt(e,0),this._itemMap[e.id]=e,this._updateBounds(),e}let r=findItems(this,(e=>e.dataScope&&e.dataScope.hasField(t)))[0];void 0===r&&console.warn(Warnings.INCORRECT_AXIS_INFO+t);let n=getClosestLayout(r);if(n&&("x"==e||"y"==e)){let i,s,r=getPeers(n.group,this);for(let n of r){let r=findItems(n,(e=>e.dataScope&&e.dataScope.hasField(t)))[0],o=getPeers(r,n);r.dataScope.dataTable.getFieldType(t)!==DataType.Date||"labelFormat"in a||(a.labelFormat="%m/%d/%y"),i=new LayoutAxis(o,n.layout,e,t,a),null==s&&(s=i.id),i.classId=s,this.addChildAt(i,0),this._itemMap[i.id]=i}return this._updateBounds(),i}console.warn(Warnings.INCORRECT_AXIS_INFO+t)}getRelatedAxes(e){let t=[];if(isGuide(e))return t;for(let i of this.children){if(i.type!==ItemType.Axis)continue;if(i.matches(e)){t.push(i);continue}let s=i._item,a=!1;for(;s.children&&s.children.length>0;){for(let r of s.children)if(r.classId===e.classId){a=!0,t.push(i);break}if(a)break;s=s.children[0]}for(s=e,a=!1;s.children&&s.children.length>0;){for(let e of s.children)if(i.matches(e)){a=!0,t.push(i);break}if(a)break;s=s.children[0]}}return t}removeItem(e){if(!isGuide(e)){let t=this.getRelatedAxes(e);for(let e of t)this.removeItem(e);for(let t of this.getRelatedGridlines(e))this.removeItem(t)}delete this._itemMap[e.id],this.removeChild(e),this._updateBounds()}removeAllEncodings(){this.encodings={},this.removeAllItemsByType(ItemType.Axis),this.removeAllItemsByType(ItemType.Legend),this.removeAllItemsByType(ItemType.Gridlines)}removeEncoding(e){let t=getEncodingKey(e.anyItem);delete this.encodings[t][e.channel];let i=[];for(let t of this.children)isGuide(t)&&t.encoding&&t.encoding===e&&i.push(t);for(let e of i)this.removeItem(e);this._updateBounds()}removeAllItemsByType(e){let t=[];for(let i of this.children)i.type===e&&t.push(i);for(let e of t)this.removeItem(e);this._updateBounds()}reCreateRelatedAxes(e){this.getRelatedAxes(e).forEach((e=>{let t=e.toJSON().args;t.item&&(t.item=this.getItem(t.item)),this.removeItem(e),this.axis(e.channel,e.field,t)})),this._updateBounds()}legend(e,t,i){let s=i||{},a=this.getEncodingByField(t,e);if(!a)throw Errors.INCORRECT_LEGEND_INFO+t;"x"in s||(s.x=100),"y"in s||(s.y=100);let r=new Legend(a,s);return this.addChild(r),this._itemMap[r.id]=r,this._updateBounds(),r}gridlines(e,t,i){let s=this.getEncodingByField(t,e),a=i||{};if(!s)return!1;let r=new Gridlines(s,s.anyItem,a);return r.values="values"in a?a.values:this._inferTickValues(s),this.addChildAt(r,0),this._itemMap[r.id]=r,this._updateBounds(),r}getRelatedGridlines(e){let t=[];if(isGuide(e))return t;for(let i of this.children){if(i.type!==ItemType.Gridlines)continue;if(i.matches(e)){t.push(i);continue}let s=i._item,a=!1;for(;s.children&&s.children.length>0;){for(let r of s.children)if(r.classId===e.classId){a=!0,t.push(i);break}if(a)break;s=s.children[0]}for(s=e,a=!1;s.children&&s.children.length>0;){for(let e of s.children)if(i.matches(e)){a=!0,t.push(i);break}if(a)break;s=s.children[0]}}return t}_inferTickValues(e){let t,i=e.scale.domain,s=e.scale.range;switch(e.scale.type){case"linear":case"log":{let a=Math.abs(s[0]-s[1]);if("width"==e.channel||"height"==e.channel){let t=getClosestLayout(e.anyItem);if(t&&t.type==LayoutType.Stack){let s=getPeers(t.group,e.scene);a=Math.max(...s.map((t=>t.bounds[e.channel]))),i[1]=Math.ceil(e.scale.invert(a))}}t="width"==e.channel||"x"==e.channel?45:30;let r=Math.floor(a/t);return d3__namespace.ticks(i[0],i[1],r)}case"point":{t="width"==e.channel||"x"==e.channel?80:30;let s=Math.floor(e.scale.rangeExtent/i.length),a=Math.ceil(t/s);return"x"==e.channel?i.filter(((e,t)=>t%a==0)):i}case"time":{t="width"==e.channel||"x"==e.channel?80:30;let a,r,n=Math.floor((s[1]-s[0])/t),o=Math.ceil((i[1]-i[0])/n)/1e3,l=[1,60,3600,86400,2628003,31536e3],h=[d3__namespace.timeSeconds,d3__namespace.timeMinutes,d3__namespace.timeHours,d3__namespace.timeDays,d3__namespace.timeMonths,d3__namespace.timeYears];for(let e=0;e<l.length-1;e++)if(o>=l[e]&&o<l[e+1])return a=Math.floor(o/l[e]),r=h[e],r(i[0],i[1],a);return o>l[l.length-1]?(a=Math.floor(o/l[l.length-1]),r=h[l.length-1],r(i[0],i[1],a)):[]}default:return[]}}propagate(e,t,...i){let s=getPeers(e,this);for(let e of s)e[t](...i)}classify(e,t,i){let s,a={},r=e[0].parent;for(let i of e){let e=i.dataScope.getFieldValue(t);e in a||(a[e]=[]),a[e].push(i)}let n=[],o=e[0].dataScope._dt;for(let e in a){let r=this.collection();i.addChild(r),void 0===s&&(s=r.id),r.classId=s,r.dataScope=new DataScope(o).cross(t,e);for(let t of a[e])r.addChild(t);n.push(r)}return 0===r.children.length&&r.parent.removeChild(r),n}getEncodingByItem(e,t){let i=this.encodings[getEncodingKey(e)];return i&&i[t]?i[t]:null}getEncodingByField(e,t){for(let i in this.encodings){let s=this.encodings[i];if(s[t]&&s[t].field==e)return s[t]}return null}positionBound(e,t){let i=this.getEncodingByItem(e,t);if(i)return i;if(!isPath(e))return null;for(let i in this.encodings){if(i.split("_")[0]===e.classId&&t in this.encodings[i])return this.encodings[i][t]}}sizeBound(e,t){let i=this.getEncodingByItem(e,t);if(i)return i;if(isPath(e)){let i="width"===t||"height"===t||"radius"===t?["area"]:["width","height"],s="width"===t?["x"]:"height"===t?["y"]:["x","y"];for(let t in this.encodings){let a=t.split("_")[0];if(t.indexOf("_")<0){for(let s of i)if(a===e.classId&&s in this.encodings[t])return this.encodings[t][s]}else for(let i of s)if(a===e.classId&&i in this.encodings[t])return this.encodings[t][i]}}return null}setProperties(e,t){let i,s={};for(let e in t)s[e]=!0;if(Object.values(LayoutType).indexOf(e.type)>-1&&e.group){i=getPeers(e.group,this);for(let e of i)for(let i in t)e.layout[i]=t[i]}else if(i=getPeers(e,this),"vertex"===e.type)for(let e of i)for(let i in t)e[i]=t[i];else if(e instanceof Mark)for(let a in t)("x"!==a&&"y"!==a||!this.positionBound(e,a))&&("width"!==a&&"height"!==a&&"radius"!==a||!this.sizeBound(e,a))?e.type!==ItemType.Rect&&e.type!==ItemType.Line||"width"!==a&&"height"!==a?i.forEach((e=>e[a]=t[a])):"width"===a?i.forEach((e=>e.resize(t[a],e.bounds.height,t.xRef))):i.forEach((e=>e.resize(e.bounds.width,t[a],void 0,t.yRef))):s[a]=!1;else if("collection"==e.type)for(let e of i)for(let i in t)e[i]="layout"===i&&void 0!==t[i]?t[i].clone():t[i];let a=Object.keys(s).filter((e=>s[e])),r=["width","height","fontSize","area","radius"];for(let t of r)if(a.indexOf(t)>=0&&isMark(e)){SceneValidator.itemResized(e,i);break}a.indexOf("baseline")>=0&&e.type===ItemType.Area&&SceneValidator.areaRebased(e,i);let n=["layout","rowGap","colGap","numRows","numCols","vertCellAlignment","horzCellAlignment"];for(let e of n)if(a.indexOf(e)>=0){let e=a.indexOf("numRows")>=0||a.indexOf("numCols")>=0||a.indexOf("layout")>=0;SceneValidator.layoutChanged(i[0],i,e);break}return s}_canTranslate(e){let t={x:!0,y:!0};return e.type==ItemType.Axis?("x"===e.channel||"width"===e.channel?t.x=!1:"y"!==e.channel&&"height"!==e.channel||(t.y=!1),t):(e.parent.type===ItemType.Collection&&e.parent.layout&&(t.x=!1,t.y=!1),this.positionBound(e,"x")&&(t.x=!1),this.positionBound(e,"y")&&(t.y=!1),t)}translate(e,t,i){let s=this._canTranslate(e);if(!s.x&&!s.y)return s;const a=s.x?t:0,r=s.y?i:0;return e._doTranslate(a,r),SceneValidator.itemTranslated(e,a,r),s}_updateAncestorBounds(e,t){let i=getParents(t||getPeers(e,this));for(;i.length>0;){for(let e of i)(e.children&&e.children.length>0||e.vertices)&&e._updateBounds();i=getParents(i)}}_reapplyConstraints(e){let t=e,i=[e];for(;t.children;)t.type==ItemType.Collection?i.push(t.firstChild):i=i.concat(t.children),t=t.firstChild;for(t=e.parent;t&&t.type!==ItemType.Scene;)i.push(t),t=t.parent;const s=i.map((e=>e.classId));for(let e in this.constraints){const t=this.constraints[e];switch(t.type){case ConstraintType.Affix:(s.indexOf(t.item.classId)>=0||s.indexOf(t.baseItem.classId)>=0)&&t.apply();break;case ConstraintType.Align:for(let e of t.items)if(s.indexOf(e.classId)>=0){t.apply();break}}}}_relayoutAncestors(e,t){let i=getParents(t||getPeers(e,this));for(;i.length>0;){for(let e of i)e.layout&&e.layout.run(),e.children&&e.children.length>0&&e._updateBounds(),e.vertices&&e._updateBounds();i=getParents(i)}}_reapplySizeBindings(e){let t=["width","height"];for(let i in this.encodings){if(e.classId!=i)continue;let s=this.encodings[i],a=findItems(this,(e=>e.classId==i));for(let e of t){let t=s[e];t&&t.run()}this._relayoutAncestors(a[0],a)}}_registerBinding(e){let t=this.encodings,i=getEncodingKey(e.anyItem);return i in t||(t[i]={}),t[i][e.channel]=e,!0}toJSON(){let e=super.toJSON();this.fillColor&&(e.fillColor=this.fillColor);let t={};e.encodings=[],e.itemCounter=ItemCounter;for(let i in this.encodings)for(let s in this.encodings[i]){let a=this.encodings[i][s];e.encodings.push(a.toJSON()),a.scale&&!(a.scale.id in t)&&(t[a.scale.id]=a.scale.toJSON())}e.scales=t,e.constraints={};for(let t in this.constraints)e.constraints[t]=this.constraints[t].toJSON();e.tables={};let i=this.getDataTables();for(let t in i)e.tables[t]=i[t].toJSON();return e}getDataTables(){let e={};for(let t in this.encodings)for(let i in this.encodings[t]){let s=this.encodings[t][i];s.datatable.id in e||(e[s.datatable.id]=s.datatable)}for(let t of this.children)if(!isGuide(t)){if(t.dataScope){e[t.dataScope.dataTable.id]=t.dataScope.dataTable;break}if(t.children&&t.children.length>0){let i=t.firstChild;for(;i;){if(i.dataScope){e[i.dataScope.dataTable.id]=i.dataScope.dataTable;break}i=i.children&&i.children.length>0?i.firstChild:void 0}}}return e}getItem(e){let t=e.split("_")[0];if(e.indexOf("_v_")>0){let i=parseInt(e.split("_v_")[1]);return this._itemMap[t].vertices.find((e=>e._id===i))}if(e.indexOf("_s_")>0){let i=parseInt(e.split("_s_")[1]);return this._itemMap[t].segments.find((e=>e._id===i))}return this._itemMap[e]}}class SVGRenderer{constructor(e){this._svgId=e,this._compMap={},this._decoMap={}}render(e,t){let i=t||{};this._removed={};for(let e in this._compMap)this._removed[e]=1;this._renderItem(e,i);for(let e in this._removed)this._compMap[e].remove(),delete this._compMap[e]}clear(){let e=document.getElementById(this._svgId);for(;e.firstChild;)e.firstChild.remove();this._compMap={},this._decoMap={}}_renderItem(e,t){let i,s=e.id,a=e.parent;i=a&&a.id&&a.id in this._compMap?d3__namespace.select("#"+this._svgId).select("#"+a.id):d3__namespace.select("#"+this._svgId),s in this._compMap?delete this._removed[s]:this._compMap[s]=i.append(this._getSVGElementType(e)),e.type==ItemType.Gridlines&&this._compMap[s].lower();let r=this._compMap[s];if(r.attr("id",s),e.type==ItemType.Scene&&d3__namespace.select("#"+this._svgId).style("background",e.fillColor?e.fillColor:"#fff"),"vertex"!=e.type){if(e.type==ItemType.Path||e.type==ItemType.Polygon||e.type==ItemType.Link)r.attr("d",e.getSVGPathData()),e.closed||r.style("fill","none"),0==s.indexOf("axis")&&r.style("shape-rendering","crispEdges");else if(e.type==ItemType.Line)r.attr("x1",e.vertices[0].x),r.attr("y1",e.vertices[0].y),r.attr("x2",e.vertices[1].x),r.attr("y2",e.vertices[1].y),0==s.indexOf("axis")&&r.style("shape-rendering","crispEdges");else if(e.type==ItemType.Circle)r.attr("cx",e.x),r.attr("cy",e.y),r.attr("r",e.radius);else if(e.type==ItemType.Rect){let t=e.bounds;r.attr("x",t.left).attr("y",t.top).attr("width",t.width).attr("height",t.height)}else e.type==ItemType.PointText?r.attr("text-anchor",this._getTextAnchor(e.anchor[0])).attr("alignment-baseline",this._getTextAnchor(e.anchor[1])).attr("dominant-baseline",this._getTextAnchor(e.anchor[1])).text(e.text).attr("x",e.x).attr("y",e.y):e.type==ItemType.Pie||e.type==ItemType.Area?(r.attr("d",e.getSVGPathData()),e.closed||r.style("fill","none"),0==s.indexOf("axis")&&r.style("shape-rendering","crispEdges")):e.type==ItemType.Ring||e.type==ItemType.Arc?r.attr("d",e.getSVGPathData()):e.type==ItemType.Image&&r.attr("href",e.src).attr("x",e.x).attr("y",e.y).attr("width",e.width).attr("height",e.height);for(let t in e.styles)if(void 0!==e.styles[t])if(t.indexOf("Color")>0&&e.styles[t].type==ItemType.LinearGradient){d3__namespace.select("#"+this._svgId).select("defs").empty()&&d3__namespace.select("#"+this._svgId).append("defs");let i=d3__namespace.select("defs"),s=e.styles[t];if(i.select("#"+s.id).empty()){let e=i.append("linearGradient").attr("id",s.id);e.attr("x1",s.x1+"%").attr("x2",s.x2+"%").attr("y1",s.y1+"%").attr("y2",s.y2+"%");for(let t of s.stops)e.append("stop").attr("offset",t.offset+"%").style("stop-color",t.color).style("stop-opacity",t.opacity)}r.style(Style2SVG[t],"url(#"+s.id+")")}else r.style(Style2SVG[t],e.styles[t]);if(e._rotate&&r.attr("transform","rotate("+e._rotate.join(" ")+")"),e.vertices&&this._renderVertices(e),e.type==ItemType.Collection&&t&&t.collectionBounds){let t=e.bounds;e.layout&&"grid"==e.layout.type?this._renderLayout(e):(e.id in this._decoMap||(this._decoMap[e.id]=d3__namespace.select("#"+this._svgId).append("rect").attr("class","deco")),this._decoMap[e.id].attr("x",t.left).attr("y",t.top).attr("width",t.width).attr("height",t.height).attr("fill","none").attr("stroke","#1ecb40").attr("stroke-width","1px").attr("stroke-dasharray","5,5"))}if(e.children)for(let i of e.children)this._renderItem(i,t)}}_renderVertices(e){let t=e.id+"-vertices";if(t in this._compMap)delete this._removed[t];else{let i=e.parent,s=i?i.id:this._svgId;this._compMap[t]=d3__namespace.select("#"+s).append("g").attr("id",t)}if(0===e.vertices.map((e=>e.shape)).filter((e=>void 0!==e)).length)return void this._compMap[t].style("visible","hidden");this._compMap[t].style("visible","visible");let i=e.vertices.filter((e=>void 0!==e.shape));for(let e of i){let i=t+"-"+e.id;i in this._compMap?e.shape!==this._compMap[i].node().tagName?(this._compMap[i].remove(),this._compMap[i]=d3__namespace.select("#"+t).append(e.shape).attr("id",i),delete this._removed[i]):delete this._removed[i]:this._compMap[i]=d3__namespace.select("#"+t).append(e.shape).attr("id",i),"rect"==e.shape?d3__namespace.select("#"+i).attr("x",e.x-e.width/2).attr("y",e.y-e.height/2).attr("width",e.width).attr("height",e.height):"circle"==e.shape&&d3__namespace.select("#"+i).attr("cx",e.x).attr("cy",e.y).attr("r",e.radius),d3__namespace.select("#"+i).style("fill",e.fillColor).style("opacity",e.opacity).style("stroke-width",e.strokeWidth).style("stroke",e.strokeColor)}}_renderLayout(e){let t=e.id+"-grid";t in this._decoMap||(this._decoMap[t]=d3__namespace.select("#"+this._svgId).append("g").attr("id",t).attr("class","deco"));let i=e.layout.cellBounds,s=e.layout.rowGap;this._decoMap[t].selectAll("rect").remove(),this._decoMap[t].selectAll("rect").data(i.slice(0,i.length-1)).enter().append("rect").attr("x",(e=>e.left)).attr("y",(e=>e.bottom)).attr("width",(e=>e.width)).attr("height",s).style("fill","pink").style("opacity",.5);let a=Math.min(...i.map((e=>e.left))),r=Math.min(...i.map((e=>e.top)));this._decoMap[t].append("rect").attr("x",a).attr("y",r).attr("width",e.bounds.width).attr("height",e.bounds.height).attr("stroke","#1ecb40").attr("stroke-width","1px").attr("stroke-dasharray","5,5").attr("fill","none")}_getTextAnchor(e){switch(e){case"top":return"text-before-edge";case"bottom":return"text-after-edge";case"left":return"start";case"right":return"end";case"center":case"middle":return"middle";default:return e}}_getSVGElementType(e){switch(e.type){case ItemType.Rect:return"rect";case ItemType.Collection:case ItemType.Group:case ItemType.Glyph:case ItemType.Scene:case ItemType.Axis:case ItemType.Legend:case ItemType.Gridlines:return"g";case ItemType.Area:case ItemType.Path:case ItemType.Polygon:case ItemType.Ring:case ItemType.Pie:case ItemType.Arc:case ItemType.Link:return"path";case ItemType.Circle:return"circle";case ItemType.Line:return"line";case ItemType.PointText:return"text";case"vertex":if("circle"==e.shape)return"circle";if("rect"==e.shape)return"rect";throw"argument exception";case"image":return"image"}}}class Scale{constructor(e,t){switch(this.type=e,this._offset=void 0,this.id="scale"+ItemCounter.scale++,this._flipped=!1,this._includeZero=!1,e){case"linear":if(t){let e=Object.keys(t).map((e=>parseFloat(e))).sort(((e,t)=>e-t)),i=e.map((e=>t[e]));this._scale=d3__namespace.scaleLinear(e,i),"clamp"in t&&this._scale.clamp(t.clamp)}else this._scale=d3__namespace.scaleLinear();break;case"point":this._scale=d3__namespace.scalePoint();break;case"ordinal":this._scale=d3__namespace.scaleOrdinal();break;case"ordinalColor":this._scale=d3__namespace.scaleOrdinal(d3__namespace.schemeCategory10);break;case"power":case"log":this._scale=d3__namespace.scaleLog();break;case"identity":case"time":this._scale=d3__namespace.scaleTime();break;case"sequentialColor":t&&"string"==typeof t?(this._scale=d3__namespace.scaleSequential(d3__namespace[t]),this._scheme=t):this._scale=d3__namespace.scaleSequential()}this.encodings=[]}toJSON(){let e={};return e.type=this.type,e.id=this.id,e.offset=this._offset,e.domain=this._scale.domain(),e.range=this.range,e.clamp=this.clamp,e.isFlipped=this.isFlipped,e.includeZero=this.includeZero,this._scheme&&(e.scheme=this._scheme),e}_merge(e){if(this.type!=e.type)throw Errors.DIFFERENT_SCALE_TYPE;let t,i;switch(this.type){case"linear":case"time":t=[Math.min(this.domain[0],e.domain[0]),Math.max(this.domain[1],e.domain[1])],i=[0,this.map(t[1])-this.map(t[0])];break;case"point":case"ordinalColor":t=[...new Set(this.domain.concat(e.domain))],i=[];break;default:console.log("TODO: merge scale type",this.type)}this._scale.domain(t),this._scale.range(i)}get domain(){if(this._includeZero){return[0,this._scale.domain()[1]]}return this._scale.domain()}set domain(e){this._scale.domain(e);for(let e of this.encodings)e._apply()}get range(){return this._scale.range()}
//to support this, the argument should be in real screen coordinates and need to do internal conversion
set range(e){this._scale.range(e);for(let e of this.encodings)e._apply();for(let e of this.encodings)e.scene._updateAncestorBounds(e.item,e.items)}_setRange(e){this._scale.range(e),SceneValidator.scaleRangeSet(this)}get clamp(){return"linear"==this.type&&this._scale.clamp()}set clamp(e){"linear"==this.type&&this._scale.clamp(e)}set rangeExtent(e){let t=this._scale.range();this._setRange([t[0],t[0]+e])}get rangeExtent(){let e=this._scale.range();return Math.abs(e[1]-e[0])}_addEncoding(e){this.encodings.indexOf(e)<0&&this.encodings.push(e)}map(e){let t=this._scale.copy();return t.domain(this.domain),this._flipped?(t.range(this._scale.range().reverse()),t(e)):t(e)}invert(e){return this._scale.invert(e)}get offset(){return this._offset}set offset(e){this._offset=e;for(let e of this.encodings)e._apply()}get isFlipped(){return this._flipped}set isFlipped(e){this._flipped=e}get includeZero(){return this._includeZero}set includeZero(e){this._includeZero=e,SceneValidator.scaleDomainSet(this)}getEncodedChannels(){let e={};for(let t of this.encodings)e[t.channel]=!0;return Object.keys(e)}}class PackingLayout extends Layout{constructor(e){super(e),this.type="packing",this.x="x"in e?e.x:400,this.y="y"in e?e.y:400,this.width=e.width,this.height=e.height}toJSON(){let e={args:{}};return e.type=this.type,e.args.x=this.x,e.args.y=this.y,e.args.width=this.width,e.args.height=this.height,e}clone(){return new PackingLayout({x:this.x,y:this.y,width:this.width,height:this.height})}run(){if(null==this.group)return;let e=this.group.children.map((e=>({name:e.id,radius:e.radius,itm:e}))),t=e.reduce(((e,t)=>e+Math.pow(t.radius,2)),0),i=Math.sqrt(t);void 0===this.width&&(this.width=i),void 0===this.height&&(this.height=i);let s=d3__namespace.hierarchy({name:"root",children:e}).sum((e=>e.radius?e.radius:0)).sort(((e,t)=>t.value-e.value));d3__namespace.pack().size([this.width,this.height]).radius((e=>e.value))(s);for(let e of s.children){let t=e.data.itm,i=this.x-s.x+e.x-t.x,a=this.y-s.y+e.y-t.y;t._doTranslate(i,a)}this.group._updateBounds()}}class TreemapLayout extends Layout{constructor(e){super(e),this.type="treemap",this._width=e.width,this._height=e.height,this._top=e.top,this._left=e.left}toJSON(){let e={args:{}};return e.type=this.type,e.args.left=this._left,e.args.top=this._top,e.args.width=this._width,e.args.height=this._height,e}clone(){return new TreemapLayout({})}run(){if(null==this.group||!this.group.children||0==this.group.children.length)return;let e=this._width?this._width:this.group.bounds.width,t=this._height?this._height:this.group.bounds.height,i=void 0===this._top?this.group.bounds.top:this._top,s=void 0===this._left?this.group.bounds.left:this._left,a=d3__namespace.hierarchy(this.group).sum((e=>"rect"==e.type?e.bounds.width*e.bounds.height:0));d3__namespace.treemap().size([e,t])(a),this._apply(a,s,i),this.group.getScene()._updateAncestorBounds(a.leaves()[0].data)}_apply(e,t,i){if("collection"==e.data.type&&e.children)for(let s of e.children)this._apply(s,t,i);else"rect"==e.data.type&&(e.data.resize(e.x1-e.x0,e.y1-e.y0),e.data._doTranslate(e.x0+t-e.data.bounds.left,e.y0+i-e.data.bounds.top))}get width(){return this._width}set width(e){this._width=e,this.run()}get height(){return this._width}set height(e){this._height=e,this.run()}get top(){return this._top}set top(e){this._top=e,this.run()}get left(){return this._left}set left(e){this._left=e,this.run()}}const depth="_depth";class Tree{constructor(e,t){let i=[],s=[];this._nodeHash={},this._traverse(e,i,s),this._nodeTable=new DataTable(i,"nodes"),this._linkTable=new DataTable(s,"links"),this._nodeTable.tree=this,this._linkTable.tree=this,this._data=e,this.aggregateFromLeaves("value","average")}_traverse(e,t,i,s=0){let a={};nodeId in e||(e[nodeId]="n"+t.length),t.push(a),e[depth]=s;for(let r in e)if("children"==r&&e[r]&&e[r].length>0)for(let a of e[r]){let r=this._traverse(a,t,i,s+1);i.push({parent:e[nodeId],child:r})}else a[r]=e[r];return this._nodeHash[a[nodeId]]=a,a[nodeId]}getParent(e){let t,i=e[nodeId],s=this._linkTable.data,a=this._nodeTable.data;for(let e in s)if(s[e].child==i){t=s[e].parent;let i=a.findIndex((e=>e[nodeId]==t));return a[i]}}getChildren(e){let t=e[nodeId],i=[],s=this._linkTable.data,a=this._nodeTable.data;for(let e in s)if(s[e].parent==t){let t=s[e].child,r=a.findIndex((e=>e[nodeId]==t));i.push(a[r])}return i}getMaxDepth(){return this._nodeTable._fieldSummaries[depth].max}getRoot(){return this._nodeTable.data[0]}get nodeTable(){return this._nodeTable}get linkTable(){return this._linkTable}getNode(e){return this._nodeTable.data.filter((t=>t[nodeId]==e))[0]}sumLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];if(s=this.getChildren(e),s&&s.length>0){let e=0;for(let i of s)e+=this.sumLeaves(i,t);this.getNode(i)["sum"+t]=e}else this.getNode(i)["sum"+t]=e[t];return e["sum"+t]}countLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];s=this.getChildren(e);let a=0;if(s&&s.length>0)for(let e of s)a+=this.countLeaves(e,t);else a=1;return this.getNode(i)["count"+t]=a,e["count"+t]}averageLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];s=this.getChildren(e);let a=0;if(s&&s.length>0){for(let e of s)a+=this.averageLeaves(e,t);a/=s.length,this.getNode(i)["average"+t]=a}else this.getNode(i)["average"+t]=e[t];return e["average"+t]}medianLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];s=this.getChildren(e);let a=[];if(s&&s.length>0){for(let e of s)a.push(this.medianLeaves(e,t));a.sort((function(e,t){return e-t}));let e=Math.floor(a.length/2);a.length%2?this.getNode(i)["median"+t]=a[e]:this.getNode(i)["median"+t]=(a[e-1]+a[e])/2}else this.getNode(i)["median"+t]=e[t];return e["median"+t]}maxLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];s=this.getChildren(e);let a=[];if(s&&s.length>0){for(let e of s)a.push(this.maxLeaves(e,t));this.getNode(i)["max"+t]=Math.max(...a)}else this.getNode(i)["max"+t]=e[t];return e["max"+t]}minLeaves(e,t){if(!e)return 0;let i=e[nodeId],s=[];s=this.getChildren(e);let a=[];if(s&&s.length>0){for(let e of s)a.push(this.minLeaves(e,t));this.getNode(i)["min"+t]=Math.min(...a)}else this.getNode(i)["min"+t]=e[t];return e["min"+t]}aggregateFromLeaves(e,t){let i=this.getRoot();switch(t){case"sum":this.sumLeaves(i,e);break;case"count":this.countLeaves(i,e);break;case"average":this.averageLeaves(i,e);break;case"median":this.medianLeaves(i,e);break;case"max":this.maxLeaves(i,e);break;case"min":this.minLeaves(i,e)}}}function merge$1(e,t){let i=[e[0]],s=[t[0]];for(let a=1;a<t.length;a++){let r=!1,n=t[a];for(let t=0;t<s.length;t++){let o=s[t],l=new Set(n);if(o.forEach((e=>l.add(e))),l.size<n.length+o.length){s[t]=[...l],i[t]=i[t].concat(e[a]),r=!0;break}}r||(s.push(n),i.push(e[a]))}return{grouping:i,subgraphs:s}}function partition$1(e){let t=e.nodes,i=e.links,s=i.map(((e,t)=>[t])),a=i.map((e=>[e.source,e.target])),r=merge$1(s,a);for(;r.grouping.length!=s.length;)s=r.grouping,a=r.subgraphs,r=merge$1(s,a);let n=[];for(let[e,s]of r.grouping.entries()){let a={nodes:[],links:[]};a.links=s.map((e=>i[e]));const o=r.subgraphs[e];a.nodes=t.filter((e=>o.indexOf(e[nodeId])>=0)),n.push(new Network(a))}return n}class Network{constructor(e,t){this._nodeTable=new DataTable(e.nodes,"nodes"),this._linkTable=new DataTable(e.links,"links"),this._nodeTable.graph=this,this._linkTable.graph=this,this._nodes=e.nodes,this._links=e.links,this._name=t,this._nodeHash={};for(let t of e.nodes)this._nodeHash[t[nodeId]]=t}get nodeTable(){return this._nodeTable}get linkTable(){return this._linkTable}get nodes(){return this._nodes}get links(){return this._links}getNode(e){return this._nodeHash[e]}getSources(e){let t,i=e[nodeId],s=this._links.data,a=this._nodes.data,r=[];for(let e in s)if(s[e].target==i){t=s[e].source;let i=a.findIndex((e=>e[nodeId]===t));r.push(a[i])}return r}getTargets(e){let t,i=e[nodeId],s=this._links.data,a=this._nodes.data,r=[];for(let e in s)if(s[e].source==i){t=s[e].target;let i=a.findIndex((e=>e[nodeId]===t));r.push(a[i])}return r}transform(e,t,i){switch(e){case"partition":return partition$1(this)}}isLinear(){let e={},t={};for(let i of this._links)i.source in t||(t[i.source]=0),i.target in e||(e[i.target]=0),t[i.source]++,e[i.target]++;for(let t in e)if(e[t]>1)return!1;for(let e in t)if(t[e]>1)return!1;return!0}}class TidyTreeLayout extends Layout{constructor(e){super(e),this.type=LayoutType.TidyTree,this._width="width"in e?e.width:500,this._height="height"in e?e.height:500,this._left="left"in e?e.left:100,this._top="top"in e?e.top:100,this._orientation="orientation"in e?e.orientation:Orientation.Horizontal}toJSON(){let e={args:{}};return e.args.type=this.type,e.args.orientation=this._orientation,e.args.left=this._left,e.args.top=this._top,e.args.width=this._width,e.args.height=this._height,e}run(){if(null==this.group)return;let e=this.group.children[0].dataScope._dt;if(e.tree){let t=d3__namespace.hierarchy(e.tree._data),i=Math.max(...this.group.children.map((e=>e.bounds.width))),s=Math.max(...this.group.children.map((e=>e.bounds.height))),a=this._orientation==Orientation.Horizontal?[this._height,this._width]:[this._width,this._height],r=d3__namespace.tree().nodeSize([i,s]).size(a)(t);this._apply(r,this.group)}}_apply(e,t){let i,s,a=t.children.filter((t=>t.dataScope.getFieldValue(nodeId)==e.data[nodeId]))[0];switch(this._orientation){case Orientation.Horizontal:i=e.y+this._left,s=e.x+this._top;break;case Orientation.Vertical:i=e.x+this._left,s=this._top+e.y}if(a.x=i,a.y=s,e.children&&e.children.length>0)for(let i of e.children)this._apply(i,t)}get orientation(){return this._orientation}set orientation(e){this._orientation=e,this.run()}get width(){return this._width}set width(e){this._width=e,this.run()}get height(){return this._width}set height(e){this._height=e,this.run()}get size(){return[this._width,this._height]}set size(e){this._width=e[0],this._height=e[1],this.run()}}class ForceLayout extends Layout{constructor(e){super(e),this.type=LayoutType.Force,this._x="x"in e?e.x:0,this._y="y"in e?e.y:0,this._iterations="iterations"in e?e.iterations:1,this._repulsion="repulsion"in e?e.repulsion:30,this._attraction="attraction"in e?e.attraction:1,this._linkDistance="linkDistance"in e?e.linkDistance:30}toJSON(){let e={args:{}};return e.type=this.type,e.args.x=this._x,e.args.y=this._y,e.args.iterations=this._iterations,e}run(){if(null==this.group)return;let e=this.group.children[0].dataScope._dt.graph;if(e){let t=e.links.map((t=>({source:e.getNode(t.source),target:e.getNode(t.target)}))),i=d3__namespace.forceSimulation(e.nodes).force("charge",d3__namespace.forceManyBody().strength(-this._repulsion)).force("link",d3__namespace.forceLink(t).id((e=>e.id)).distance(this._linkDistance)).force("x",d3__namespace.forceX()).force("y",d3__namespace.forceY()).force("center",d3__namespace.forceCenter(this._x,this._y).strength(this._attraction));i.stop(),i.tick(this._iterations);for(let t=0;t<this.group.children.length;t++)this.group.children[t].x=e.nodes[t].x,this.group.children[t].y=e.nodes[t].y}}}class SpecGenerator{constructor(){this.axes={},this.guideCmds=[],this.collectionCmds=[],this.glyphCmds=[],this.spec=[]}run(e){for(let t of e.children)switch(t.type){case ItemType.Axis:{let e=t.classId?t.classId:t.id;this.axes[e]=t;break}case ItemType.Gridlines:case ItemType.Legend:{let e=t.toJSON();this.guideCmds.push({cmd:t.type,channel:e.channel,field:e.field,args:e.args});break}case ItemType.Collection:case ItemType.Group:case ItemType.Glyph:{let i=[];this._analyze(t,i);for(let e=i.length-1;e>0;e--)for(let t of i[e].fields)i[e-1].fields.delete(t);for(let[t,s]of i.entries()){if(s.item instanceof Mark){let t={cmd:"mark",type:s.item.type,output:s.item,args:s.item.toJSON().args};this._inferMarkArgs(t,e),this.collectionCmds.push(t)}else if(s.item instanceof Glyph)this.collectionCmds.push({cmd:"glyph",output:s.item,input:i.slice(0,t).map((e=>e.item)),args:{}});else if(s.item instanceof Collection){let e=[...i[t-1].fields][0],a={cmd:"join",input:i[t-1].item,output:s.item,data:i[t-1].item.dataScope.dataTable.id,args:{field:e}};e==atlas_rowId&&delete a.field,this.collectionCmds.push(a)}s.item.dataScope&&0==s.item.dataScope.fields.length&&!s.item.parent.dataScope&&this.collectionCmds.push({cmd:"attach",input:s.item,data:s.item.dataScope.dataTable.id})}break}default:if(t instanceof Mark){let i={cmd:"mark",type:t.type,output:t,args:t.toJSON().args};this._inferMarkArgs(i,e),this.glyphCmds.push(i)}}this._inferJoin(),this._inferArgs(e);for(let e in this.axes){let t=this.axes[e].toJSON();this.guideCmds.push({cmd:t.type,channel:t.channel,field:t.field,args:t.args})}return this._generateFullSpec(e),this.spec}_inferJoin(){for(let e of this.collectionCmds){if("join"!=e.cmd)continue;let t=e.input,i=t.parent;switch(t.type){case ItemType.Rect:i.layout&&i.layout.type==LayoutType.Stack?e.cmd="divide":e.cmd="repeat";break;default:e.cmd="repeat"}}}_inferArgs(e){for(let t of this.collectionCmds)switch(t.cmd){case"mark":this._inferMarkArgs(t,e);break;case"divide":this._inferDivideArgs(t,e)}}_inferDivideArgs(e){e.args.orientation=e.output.layout.orientation}_inferMarkArgs(e,t){let i=e.output,s=i.parent,a=getPeers(i,t),r=getPeers(s,t);switch(i.type){case ItemType.Rect:s.layout&&s.layout.type==LayoutType.Grid?(e.args.width=s.layout.cellBounds[0].width,e.args.height=s.layout.cellBounds[0].height):s.layout&&s.layout.type==LayoutType.Stack?(e.args.width=Math.max(...r.map((e=>e.bounds.width))),e.args.height=Math.max(...r.map((e=>e.bounds.height)))):(e.args.width=Math.max(...a.map((e=>e.bounds.width))),e.args.height=Math.max(...a.map((e=>e.bounds.height)))),e.args.left=Math.min(...a.map((e=>e.bounds.left))),e.args.top=Math.min(...a.map((e=>e.bounds.top)));break;case ItemType.Line:e.args.x1=Math.min(...a.map((e=>e.vertices[0].x))),e.args.y1=Math.min(...a.map((e=>e.vertices[0].y))),e.args.x2=Math.min(...a.map((e=>e.vertices[1].x))),e.args.y2=Math.min(...a.map((e=>e.vertices[1].y)));break;case ItemType.Arc:e.args.x=i.x,e.args.y=i.y,e.args.innerRadius=i.innerRadius,e.args.outerRadius=i.outerRadius}for(let t in i.styles)e.args[t]=i.styles[t]}_analyze(e,t){if(e instanceof Glyph)for(let i of e.children)this._analyze(i,t);else e instanceof Group&&this._analyze(e.firstChild,t);let i={type:e.type,item:e};e.dataScope?i.fields=new Set(e.dataScope.fields):i.fields=new Set,t.push(i)}_generateFullSpec(e){this.spec=[],this.spec.push({cmd:"scene",args:{fillColor:e.fillColor}});let t=e.getDataTables(),i={},s=[];for(let e in t){let a=t[e];if(a.sourceDataTable)for(;a.sourceDataTable;)s.push({cmd:"transform",type:a.transform.type,args:a.transform.args,input:a.sourceDataTable.id,output:a.id}),a=a.sourceDataTable;a.id in i||(i[a.id]={cmd:"data",url:a.url,output:a.id})}this.spec=this.spec.concat(Object.values(i)),this.spec=this.spec.concat(s);let a=[];for(let e of this.collectionCmds){let t;e.output&&e.output.layout&&(t={cmd:"layout",type:e.output.layout.type,input:e.output.id,args:e.output.layout.toJSON().args}),this.spec.push(e),e.output&&e.output.childrenOrder&&a.push({cmd:"sortChildren",args:e.output.childrenOrder,input:e.output.id}),t&&this.spec.push(t),e.input&&Array.isArray(e.input)?e.input=e.input.map((e=>e.classId?e.classId:e.id)):e.input&&(e.input=e.input.classId?e.input.classId:e.input.id),e.output&&(e.output=e.output.classId?e.output.classId:e.output.id)}let r={},n=[];for(let t in e.encodings)for(let i in e.encodings[t]){let s=e.encodings[t][i];s.scale&&!(s.scale.id in r)&&(r[s.scale.id]=s.scale.toJSON());let a=s.toJSON().args;a.field=s.field,a.channel=s.channel,delete a.datatable,n.push({cmd:"encode",input:getEncodingKey(s.anyItem),scale:s.scale.id,args:a})}for(let e in r){let t=r[e];t.cmd="scale",this.spec.push(t)}this.spec=this.spec.concat(n),this.spec=this.spec.concat(a);for(let t in e.constraints){let i=e.constraints[t],s={cmd:"constraint",type:i.type,args:{}};switch(i.type){case ConstraintType.Affix:s.item=i.item.classId?i.item.classId:i.item.id,s.baseItem=i.baseItem.classId?i.baseItem.classId:i.baseItem.id,s.channel=i.channel,s.args.itemAnchor=i.itemAnchor,s.args.baseAnchor=i.baseAnchor,s.args.offset=i.offset;break;case ConstraintType.Align:s.items=i.items.map((e=>e.classId?e.classId:e.id)),s.anchor=i.anchor}this.spec.push(s)}for(let e of this.guideCmds)this.spec.push(e);for(let e of this.glyphCmds)e.output&&(e.output=e.output.classId?e.output.classId:e.output.id),this.spec.push(e)}}class SceneLoader{constructor(){this.axes={},this.legends=[],this.gridlines=[],this.scales={},this.tables={}}load(e){let t={};if(e.fillColor&&(t.fillColor=e.fillColor),e.itemCounter)for(let t in e.itemCounter)ItemCounter[t]=e.itemCounter[t];let i=scene(t);if(i.id=e.id,i.type=e.type,e.bounds&&(i._bounds=new Rectangle(e.bounds.left,e.bounds.top,e.bounds.width,e.bounds.height)),e.tables)for(let t in e.tables)this.tables[t]=new DataTable(e.tables[t].data,e.tables[t].url,e.tables[t].fieldTypes),this.tables[t].id=e.tables[t].id;for(let t of e.children)this._processItem(i,t,i);if(e.scales)for(let t in e.scales)this._loadScale(e.scales[t],i);if(e.encodings)for(let t of e.encodings)this._loadEncoding(t,i);if(e.constraints)for(let t in e.constraints)this._loadConstraint(e.constraints[t],i);for(let e in this.axes)this._createGuide(i,this.axes[e]);for(let e of this.legends)this._createGuide(i,e);for(let e of this.gridlines)this._createGuide(i,e);return i}_loadScale(e){let t;"sequentialColor"===e.type&&e.scheme?t=createScale(e.type,e.scheme):(t=createScale(e.type),t.range=e.range),t.domain="time"==e.type?e.domain.map((e=>new Date(e))):e.domain,t.id=e.id,"offset"in e&&(t.offset=e.offset),t.isFlipped=e.isFlipped,t.clamp=e.clamp,"includeZero"in e&&(t.includeZero=e.includeZero),this.scales[t.id]=t}_loadEncoding(e,t){e.args.datatable&&(e.args.datatable=this.tables[e.args.datatable]),e.args.scale&&(e.args.scale=this.scales[e.args.scale]);let i=e.items.map((e=>t.getItem(e)));t._doEncode(i,e.args)}_createGuide(e,t){switch(t.type){case ItemType.Axis:t.args.item&&(t.args.item=e.getItem(t.args.item)),e.axis(t.channel,t.field,t.args);break;case ItemType.Legend:e.legend(t.channel,t.field,t.args);break;case ItemType.Gridlines:e.gridlines(t.channel,t.field,t.args)}}_processItem(e,t,i){switch(t.type){case ItemType.Axis:{let e=t.classId?t.classId:t.id;t.args.tickValues&&t.args.isDate&&(t.args.tickValues=t.args.tickValues.map((e=>new Date(e)))),this.axes[e]=t;break}case ItemType.Gridlines:t.args.values&&t.args.isDate&&(t.args.values=t.args.values.map((e=>new Date(e)))),this.gridlines.push(t);break;case ItemType.Legend:this.legends.push(t);break;case ItemType.Collection:{let s=i.collection();e.addChild(s),this._loadGroup(s,t,i);break}case ItemType.Group:{let s=i.group();e.addChild(s),this._loadGroup(s,t,i);break}case ItemType.Glyph:{let s=i.glyph();e.addChild(s),this._loadGroup(s,t,i);break}default:this._loadMark(e,t,i)}}_loadConstraint(e,t){switch(e.type){case"affixation":{let i=t.getItem(e.item),s=t.getItem(e.baseItem),a=new AffixConstraint(i,s,t,e.channel,e.itemAnchor,e.baseAnchor,e.offset);return a.id=e.id,t.constraints[e.id]=a,a.apply(),a}case"alignment":{let i=e.items.map((e=>t.getItem(e))),s=new AlignConstraint(i,e.direction);return s.id=e.id,t.constraints[e.id]=s,s.apply(),s}}}_loadDataScope(e){let t=new DataScope(this.tables[e.dt]);for(let i in e.f2v)t._field2value[i]=e.f2v[i],t._updateTuples(i,e.f2v[i]);return t}_loadGroup(e,t,i){if(e.id=t.id,t.classId&&(e.classId=t.classId),t.dataScope&&(e.dataScope=this._loadDataScope(t.dataScope)),t.children)for(let s of t.children)this._processItem(e,s,i);if(t.layout){let i=this._loadLayout(t.layout);i.group=e,e._layout=i}t.bounds&&(e._bounds=new Rectangle(t.bounds.left,t.bounds.top,t.bounds.width,t.bounds.height))}_loadMark(e,t,i){if(t.args.fillColor&&"LinearGradient"===t.args.fillColor.type){let e=t.args.fillColor;t.args.fillColor=linearGradient(e),t.args.fillColor.id=e.id,t.args.fillColor._stops=e.stops}"id"in t&&(t.args.id=t.id);let s=i.mark(t.type,t.args);if(t.classId&&(s.classId=t.classId),t.dataScope&&(s.dataScope=this._loadDataScope(t.dataScope)),t.vertices){const e=[];for(let i of t.vertices){const t=Vertex.fromJSON(i,s);t.dataScope&&(t.dataScope=this._loadDataScope(t.dataScope)),e.push(t)}s.vertices=e,s.segments=[];for(let e=1;e<s.vertices.length;e++)s.segments.push(new Segment(s.vertices[e-1],s.vertices[e],s,s.segmentCounter++))}t.bounds&&(s._bounds=new Rectangle(t.bounds.left,t.bounds.top,t.bounds.width,t.bounds.height)),isPath(s)?(s.vertexCounter=t.vertexCounter,s.segmentCounter=t.segmentCounter,s.curveMode=t.curveMode):t.type===ItemType.Image&&(s.src=t.src,s.width=t.width,s.height=t.height,s.x=t.x,s.y=t.y),e.addChild(s)}_loadLayout(e){let t=layout(e.type,e.args);switch(e.type){case LayoutType.Grid:t._left=e.left,t._top=e.top}return t}}class SpecExecutor{constructor(){}async run(e){let t,i,s={},a={},r={};for(let n of e)switch(n.cmd){case"scene":t=scene(n.args);break;case"data":i=await csv(n.url),a[n.output]=i;break;case"transform":a[n.output]=a[n.input].transform(n.type,n.args);break;case"mark":s[n.output]=t.mark(n.type,n.args);break;case"glyph":s[n.output]=t.glyph(...n.input.map((e=>s[e])));break;case"attach":t.attach(s[n.input],a[n.data]);break;case"repeat":{let e=t.repeat(s[n.input],a[n.data],n.args);s[n.output]=e;break}case"divide":{let e=t.divide(s[n.input],a[n.data],n.args);s[n.output]=e;break}case"layout":s[n.input].layout=layout(n.type,n.args);break;case"sortChildren":"field"in n.args?s[n.input].sortChildrenByData(n.args.field,n.args.reverse,n.args.order):"channel"in n.args&&s[n.input].sortChildren(n.args.channel,n.args.reverse);break;case"scale":{let e=createScale(n.type);e.id=n.id,e.domain="time"==n.type?n.domain.map((e=>new Date(e))):n.domain,e.range=n.range,e.clamp=n.clamp,e.isFlipped=n.isFlipped,"offset"in n&&(e.offset=n.offset),r[e.id]=e;break}case"encode":let e,o=n.input;if(o.indexOf("_v_")>0){let t=parseInt(o.split("_v_")[1]);e=s[o.split("_v_")[0]].vertices[t]}else if(o.indexOf("_v")>0);else if(o.indexOf("_s_")>0){let t=parseInt(o.split("_s_")[1]);e=s[o.split("_s_")[0]].segments[t]}else o.indexOf("_s")>0||(e=s[n.input]);n.scale&&r[n.scale]&&(n.args.scale=r[n.scale]),t.encode(e,n.args);break;case"constraint":switch(n.type){case ConstraintType.Affix:t.affix(s[n.item],s[n.baseItem],n.channel,n.args)}break;case"axis":t.axis(n.channel,n.field,n.args);break;case"legend":t.legend(n.channel,n.field,n.args);break;case"gridlines":t.gridlines(n.channel,n.field,n.args)}return t}}let DEG2RAD=Math.PI/180;class WebGLRenderer{constructor(e){this._canvasId=e,this._doesCollectionHaveBounds=!1,this._app=new PIXI__namespace.Application({antialias:!0,width:1600,height:1e3,view:document.getElementById(this._canvasId)}),this._app.renderer.autoResize=!0}render(e,t){let i=t||{};this._app.renderer.backgroundColor=toHexColor(e.fillColor?e.fillColor:"#fff"),this._doesCollectionHaveBounds=!!i.collectionBounds,this._app.stage.removeChildren(),this._app.renderer.clear();let s=this._renderItem(e);this._app.stage.addChild(s)}_renderItem(e){switch(e.type){case ItemType.Ellipse:case ItemType.LinearGradient:throwError("mark",e,Errors.FEATURE_NOT_IMPLEMENTED);break;case ItemType.Circle:return this._renderCircle(e);case ItemType.Pie:return this._renderPiePath(e);case ItemType.Area:return this._renderArea(e);case ItemType.Polygon:return this._renderPolygon(e);case ItemType.Axis:return this._renderAxis(e);case ItemType.Collection:return this._renderCollection(e);case ItemType.Glyph:case ItemType.Group:case ItemType.Gridlines:case ItemType.Legend:case ItemType.Scene:return this._renderGroup(e);case ItemType.Path:return this._renderPath(e);case ItemType.Line:return this._renderLinearPath(e);case ItemType.Rect:return this._renderRectangle(e);case ItemType.PointText:return this._renderText(e);case ItemType.Arc:return this._renderArc(e);case ItemType.Image:return this._renderImage(e);case ItemType.Link:return this._renderLink(e);default:throw new Error(`Expect: itemType, Actual: ${e}\nWait that's illegal`)}}_renderRectangle(e){let t=new PIXI.Graphics;return decorate(t,e.styles),t.lineStyle(e.styles.strokeWidth,toHexColor(e.styles.strokeColor)),beginGradientOrColorFill(e.styles,t,e.height),t.drawRect(0,0,e.width,e.height),t.x=e.left,t.y=e.top,t.endFill(),t}_renderText(e){let t=new PIXI.TextStyle({fontSize:e.styles.fontSize,fontFamily:e.styles.fontFamily,fontWeight:styleFontWeight2PixiFontWeight(e.styles.fontWeight),fill:toHexColor(e.styles.fillColor)}),i=new PIXI__namespace.Text(e.text,t),s=new PIXI.Container;decorate(i,e.styles),i.x=e.x,i.y=e.y,i.anchor.set(...styleAnchor2PixiAnchor(e.anchor)),s.addChild(i);let a=rotation2PixiPivot(e._rotate);return s.pivot.set(a[0],a[1]),s.angle=rotation2PixiAngle(e._rotate),s.position.set(a[0],a[1]),s}_renderGroup(e){let t=new PIXI.Container;for(const i of e.children){let e=this._renderItem(i);if(null==e)throw new Error;t.addChild(e)}return t}_renderAxis(e){let t=this._renderGroup(e),i=rotation2PixiPivot(e._rotate);return t.pivot.set(i[0],i[1]),t.angle=rotation2PixiAngle(e._rotate),t.position.set(i[0],i[1]),t}_renderCollection(e){let t=new PIXI.Container,i=this._renderGroup(e);if(t.addChild(i),!this._doesCollectionHaveBounds)return t;let s=new PIXI.Graphics,a=0,r=e.bounds,n=r.left,o=r.right,l=r.top,h=r.bottom,c={strokeWidth:1,color:2018112,dashLength:5,dashSpacing:5};return a=d(n,o,l,a,c,s),a=d(l,h,-o,a,c,s),a=d(o,n,h,a,c,s),d(h,l,-n,a,c,s),t.addChild(s),t;function d(e,t,i,s,a,r){let n=e<=t?1:-1,o=s>=0?{point:e+s*n}:{point:e},l=i>0?[o,{point:i}]:[{point:-i},o];r.lineStyle({width:a.strokeWidth,color:a.color}),r.moveTo(l[0].point,l[1].point),o.point=s*n+e+a.dashLength*n,r.lineTo(l[0].point,l[1].point);let h=!1;for(o.point+=a.dashLength*n;o.point*n<=t*n;)h?(r.lineTo(l[0].point,l[1].point),h=!1,o.point+=a.dashSpacing*n):(r.moveTo(l[0].point,l[1].point),h=!0,o.point+=a.dashLength*n);return h?(i>0?r.lineTo(t,i):r.lineTo(-i,t),(t-o.point)*n):(o.point-t)*n}}_renderArea(e){switch(e.curveMode){case"linear":return this._renderPolygon(e);case"basis":return this._renderBezierArea(e);default:return throwError("areaPath",e,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderBezierArea(e){let t=new PIXI.Graphics;decorate(t,e.styles),t.lineStyle({width:e.styles.strokeWidth,color:toHexColor(e.styles.strokeColor)});let i=parseDPath(e.getSVGPathData());return beginGradientOrColorFill(e.styles,t,e.bounds.height),drawOnGraphicsFromJSONData(t,i),t.endFill(),t}_renderPolygon(e){let t=new PIXI__namespace.Container,i=this._renderLinearPath(e);i.getChildAt(0).lineTo(e.vertices[0].x,e.vertices[0].y);let s=new PIXI__namespace.Graphics;decorate(s,e.styles);let a=[];for(const t of e.vertices)a.push(t.x-e.bounds.left),a.push(t.y-e.bounds.top);return beginGradientOrColorFill(e.styles,s,e.bounds.height),s.drawPolygon(a),s.x+=e.bounds.left,s.y+=e.bounds.top,s.endFill(),t.addChild(s),t.addChild(i),t}_renderPath(e){switch(e.curveMode){case"linear":return this._renderLinearPath(e);case"bumpX":case"natural":return this._renderBezierPath(e);default:throwError("path",e,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderLinearPath(e){let t=new PIXI.Container,i=new PIXI.Graphics,s="none"==e.styles.strokeDash;decorate(i,e.styles);let a=e.vertices[0];if(i.lineStyle({width:e.styles.strokeWidth,color:toHexColor(e.styles.strokeColor)}),i.moveTo(a.x,a.y),s)for(let t=1;t<e.vertices.length;t++){const s=e.vertices[t];i.lineTo(s.x,s.y)}else drawDashLine(e.vertices,e.styles.strokeDash,i);t.addChild(i);for(let i=0;i<e.vertices.length;i++){let s=e.vertices[i],a=this._renderVertex(s);null!=a&&t.addChild(a)}return t}_renderBezierPath(e){let t=new PIXI.Container,i=new PIXI.Graphics;decorate(i,e.styles),i.lineStyle({width:e.styles.strokeWidth,color:toHexColor(e.styles.strokeColor)}),drawOnGraphicsFromJSONData(i,parseDPath(e.getSVGPathData())),t.addChild(i);for(let i=0;i<e.vertices.length;i++){let s=e.vertices[i],a=this._renderVertex(s);null!=a&&t.addChild(a)}return t}_renderVertex(e){switch(e.shape){case"rect":return function(e){let t=new PIXI__namespace.Graphics;return t.lineStyle({width:e.strokeWidth,color:toHexColor(e.strokeColor)}),t.beginFill(toHexColor(e.fillColor)),t.drawRect(e.x-e.width/2,e.y-e.height/2,e.width,e.height),t.endFill(),t}(e);case"circle":return function(e){let t=new PIXI__namespace.Graphics;return t.lineStyle({width:e.strokeWidth,color:toHexColor(e.strokeColor)}),t.beginFill(toHexColor(e.fillColor)),t.drawCircle(e.x,e.y,e.radius),t.endFill(),t}(e);case void 0:return null;default:throwError("vertex shape",e.shape,Errors.FEATURE_NOT_IMPLEMENTED)}}_renderCircle(e){let t=new PIXI.Graphics;return decorate(t,e.styles),t.lineStyle(e.styles.strokeWidth,toHexColor(e.styles.strokeColor)),beginGradientOrColorFill(e.styles,t,e.height),t.drawCircle(e.x,e.y,e.radius),t.endFill(),t}_renderPiePath(e){let t=new PIXI__namespace.Graphics;return t.lineStyle({color:toHexColor(e.styles.strokeColor),width:e.styles.strokeWidth}),t.beginFill(toHexColor(e.styles.fillColor)),t.moveTo(e.x,e.y),t.arc(e.x,e.y,e.radius,-e.endAngleRad,-e.startAngleRad),t.lineTo(e.x,e.y),t.endFill(),t}_renderArc(e){let t=new PIXI.Graphics;return t.lineStyle({color:toHexColor(e.styles.strokeColor),width:e.styles.strokeWidth}),t.beginFill(toHexColor(e.styles.fillColor)),t.arc(e.x,e.y,e.outerRadius,-e.endAngle*DEG2RAD,-e.startAngle*DEG2RAD),t.arc(e.x,e.y,e.innerRadius,-e.startAngle*DEG2RAD,-e.endAngle*DEG2RAD,!0),t.endFill(),t}_renderImage(e){let t=PIXI__namespace.Sprite.from(e.src);return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t}_renderLink(e){switch(e.curveMode){case"linear":return function(e){let t=new PIXI.Graphics;return decorate(t,e.styles),t.lineStyle({color:toHexColor(e.styles.strokeColor),width:e.styles.strokeWidth}),drawOnGraphicsFromJSONData(t,parseDPath(e.getSVGPathData())),t}(e);default:throwError("link",e.curveMode,"unexpected curvemode")}}}function decorate(e,t){e.visible=styleVisiblity2PixiVisible(t.visibility),e.alpha=styleOpacity2PixiAlpha(t.opacity)}function styleFontWeight2PixiFontWeight(e){switch(e){case"regular":return"normal";case"bold":return"bold";default:throwError("font weight",e,Errors.FEATURE_NOT_IMPLEMENTED)}}function styleAnchor2PixiAnchor(e){let t,i;switch(e[0]){case"left":t=0;break;case"center":t=.5;break;case"right":t=1;break;default:throwError("x anchor",e[0],Errors.UNKNOWN_ANCHOR)}switch(e[1]){case"hanging":case"top":i=0;break;case"central":case"middle":i=.5;break;case"bottom":i=1;break;default:throwError("y anchor",e[1],Errors.UNKNOWN_ANCHOR)}return[t,i]}function toHexColor(e){let t=d3__namespace.color(e);if(null==t)return null;{let e=t.formatHex();return PIXI__namespace.utils.string2hex(e)}}function styleVisiblity2PixiVisible(e){switch(e){case"hidden":return!1;case null:case void 0:case"visible":default:return!0}}function rotation2PixiAngle(e){return void 0===e||"number"!=typeof e[0]?0:e[0]}function rotation2PixiPivot(e){return void 0===e||"number"!=typeof e[0]?[0,0]:e.slice(1)}function styleOpacity2PixiAlpha(e){switch(e){case void 0:case null:return 1;default:return e}}function throwError(e,t,i){throw console.log(t),new Error(`${i}. Source: ${e}, Actual: `)}function beginGradientOrColorFill(e,t,i){let s=e.fillColor;if("none"==s)return;let a=toHexColor(s);null!=a?t.beginFill(a):t.beginTextureFill({color:16777215,texture:createLinearGradientTexture(i,s.stops,s.y1>s.y2)})}function createLinearGradientTexture(e,t,i){const s=document.createElement("canvas");s.height=e,s.width=1;const a=s.getContext("2d"),r=a.createLinearGradient(0,0,0,e);for(let e=0;e<t.length;e++)i?r.addColorStop(1-t[e].offset/100,t[e].color):r.addColorStop(t[e].offset/100,t[e].color);return a.fillStyle=r,a.fillRect(0,0,1,e),PIXI__namespace.Texture.from(s)}function drawOnGraphicsFromJSONData(e,t){let i=t.pop(),s=()=>{};"Z"==i.code.toUpperCase()?s=()=>e.lineTo(t[0].end.x,t[0].end.y):t.push(i);for(const i of t)draw(i,e);s()}function draw(e,t){switch(e.code.toUpperCase()){case"M":t.moveTo(e.end.x,e.end.y);break;case"L":t.lineTo(e.end.x,e.end.y);break;case"Q":t.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp1.x,e.cp1.y,e.end.x,e.end.y);break;case"C":t.bezierCurveTo(e.cp1.x,e.cp1.y,e.cp2.x,e.cp2.y,e.end.x,e.end.y);break;case"Z":throw new Error('Unexpected "z" marker. There\'s something wrong, I can feel it');default:return throwError("data",e,Errors.FEATURE_NOT_IMPLEMENTED)}}function drawDashLine(e,t,i){let s,a,r,n=0,o=0,l=t.split(" "),h=Number(l[0]),c=Number(l[1]);for(s=0;s<e.length&&(a=e[s],s!=e.length-1);s++){r=e[s+1];let t=r.x-a.x,l=r.y-a.y,d=Math.sqrt(t*t+l*l),u={x:t/d,y:l/d},p=0;for(i.moveTo(a.x+o*u.x,a.y+o*u.y);p<=d;)p+=o,p+=n>0?n:h,p>d?(n=p-d,p=d):n=0,i.lineTo(a.x+p*u.x,a.y+p*u.y),p+=c,p>d&&0==n?o=p-d:(o=0,i.moveTo(a.x+p*u.x,a.y+p*u.y))}}function parseDPath(e){let t={command:/\s*([achlmqstvz])/gi,number:/\s*([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/gi,comma:/\s*(?:(,)|\s)/g,flag:/\s*([01])/g},i={number:function(e){return+n("number",e)},"coordinate pair":function(e){let t=n("number",e);return null!==t||e?(n("comma"),{x:+t,y:+n("number",!0)}):null},"arc definition":function(e){let t=i["coordinate pair"](e);if(!t&&!e)return null;n("comma");let s=+n("number",!0);n("comma",!0);let a=!!+n("flag",!0);n("comma");let r=!!+n("flag",!0);return n("comma"),{radii:t,rotation:s,large:a,clockwise:r,end:i["coordinate pair"](!0)}}},s=0,a=[];for(;s<e.length;){let e,t=n("command"),i=t.toUpperCase(),l=t!==i;switch(i){case"M":e=o("coordinate pair").map((function(e,i){return 1===i&&(t=l?"l":"L"),r({end:e},t,l)}));break;case"L":case"T":e=o("coordinate pair").map((function(e){return r({end:e},t,l)}));break;case"C":if(e=o("coordinate pair"),e.length%3)throw Error("Expected coordinate pair triplet at position "+s);e=e.reduce((function(e,i,s){let a=s%3;if(a){e[e.length-1][1===a?"cp2":"end"]=i}else e.push(r({cp1:i},t,l));return e}),[]);break;case"Q":case"S":if(e=o("coordinate pair"),1&e.length)throw Error("Expected coordinate pair couple at position "+s);e=e.reduce((function(e,i,s){if(1&s){e[e.length-1].end=i}else e.push(r({cp:i},t,l));return e}),[]);break;case"H":case"V":e=o("number").map((function(e){return r({value:e},t,l)}));break;case"A":e=o("arc definition").map(r,t,l);break;case"Z":e=[{code:"Z"}]}a.push.apply(a,e)}return a;function r(e,t,i){return e.code=t,e.relative=i,e}function n(i,a){t[i].lastIndex=s;let r=t[i].exec(e);if(!r||r.index!==s){if(!a)return null;throw Error("Expected "+i+" at position "+s)}return s=t[i].lastIndex,r[1]}function o(e){let t,s=[],a=!0;for(;null!==(t=i[e](a));)s.push(t),a=!!n("comma");return s}}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function listCacheClear(){this.__data__=[],this.size=0}var _listCacheClear=listCacheClear;function eq(e,t){return e===t||e!=e&&t!=t}var eq_1=eq;function assocIndexOf(e,t){for(var i=e.length;i--;)if(eq_1(e[i][0],t))return i;return-1}var _assocIndexOf=assocIndexOf,arrayProto=Array.prototype,splice=arrayProto.splice;function listCacheDelete(e){var t=this.__data__,i=_assocIndexOf(t,e);return!(i<0)&&(i==t.length-1?t.pop():splice.call(t,i,1),--this.size,!0)}var _listCacheDelete=listCacheDelete;function listCacheGet(e){var t=this.__data__,i=_assocIndexOf(t,e);return i<0?void 0:t[i][1]}var _listCacheGet=listCacheGet;function listCacheHas(e){return _assocIndexOf(this.__data__,e)>-1}var _listCacheHas=listCacheHas;function listCacheSet(e,t){var i=this.__data__,s=_assocIndexOf(i,e);return s<0?(++this.size,i.push([e,t])):i[s][1]=t,this}var _listCacheSet=listCacheSet;function ListCache(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}ListCache.prototype.clear=_listCacheClear,ListCache.prototype.delete=_listCacheDelete,ListCache.prototype.get=_listCacheGet,ListCache.prototype.has=_listCacheHas,ListCache.prototype.set=_listCacheSet;var _ListCache=ListCache;function stackClear(){this.__data__=new _ListCache,this.size=0}var _stackClear=stackClear;function stackDelete(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i}var _stackDelete=stackDelete;function stackGet(e){return this.__data__.get(e)}var _stackGet=stackGet;function stackHas(e){return this.__data__.has(e)}var _stackHas=stackHas,freeGlobal="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,_freeGlobal=freeGlobal,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=_freeGlobal||freeSelf||Function("return this")(),_root=root,Symbol=_root.Symbol,_Symbol=Symbol,objectProto$i=Object.prototype,hasOwnProperty$f=objectProto$i.hasOwnProperty,nativeObjectToString$1=objectProto$i.toString,symToStringTag$1=_Symbol?_Symbol.toStringTag:void 0;
/**
	 * A specialized version of `baseGetTag` which ignores `Symbol.toStringTag` values.
	 *
	 * @private
	 * @param {*} value The value to query.
	 * @returns {string} Returns the raw `toStringTag`.
	 */
function getRawTag(e){var t=hasOwnProperty$f.call(e,symToStringTag$1),i=e[symToStringTag$1];try{e[symToStringTag$1]=void 0;var s=!0}catch(e){}var a=nativeObjectToString$1.call(e);return s&&(t?e[symToStringTag$1]=i:delete e[symToStringTag$1]),a}var _getRawTag=getRawTag,objectProto$h=Object.prototype,nativeObjectToString=objectProto$h.toString;function objectToString(e){return nativeObjectToString.call(e)}var _objectToString=objectToString,nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag=_Symbol?_Symbol.toStringTag:void 0;function baseGetTag(e){return null==e?void 0===e?undefinedTag:nullTag:symToStringTag&&symToStringTag in Object(e)?_getRawTag(e):_objectToString(e)}var _baseGetTag=baseGetTag;function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var isObject_1=isObject,asyncTag="[object AsyncFunction]",funcTag$2="[object Function]",genTag$1="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(e){if(!isObject_1(e))return!1;var t=_baseGetTag(e);return t==funcTag$2||t==genTag$1||t==asyncTag||t==proxyTag}var isFunction_1=isFunction,coreJsData=_root["__core-js_shared__"],_coreJsData=coreJsData,maskSrcKey=(uid=/[^.]+$/.exec(_coreJsData&&_coreJsData.keys&&_coreJsData.keys.IE_PROTO||""),uid?"Symbol(src)_1."+uid:""),uid;function isMasked(e){return!!maskSrcKey&&maskSrcKey in e}var _isMasked=isMasked,funcProto$2=Function.prototype,funcToString$2=funcProto$2.toString;function toSource(e){if(null!=e){try{return funcToString$2.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var _toSource=toSource,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto$1=Function.prototype,objectProto$g=Object.prototype,funcToString$1=funcProto$1.toString,hasOwnProperty$e=objectProto$g.hasOwnProperty,reIsNative=RegExp("^"+funcToString$1.call(hasOwnProperty$e).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(e){return!(!isObject_1(e)||_isMasked(e))&&(isFunction_1(e)?reIsNative:reIsHostCtor).test(_toSource(e))}var _baseIsNative=baseIsNative;function getValue(e,t){return null==e?void 0:e[t]}var _getValue=getValue;function getNative(e,t){var i=_getValue(e,t);return _baseIsNative(i)?i:void 0}var _getNative=getNative,Map$1=_getNative(_root,"Map"),_Map=Map$1,nativeCreate=_getNative(Object,"create"),_nativeCreate=nativeCreate;function hashClear(){this.__data__=_nativeCreate?_nativeCreate(null):{},this.size=0}var _hashClear=hashClear;function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var _hashDelete=hashDelete,HASH_UNDEFINED$2="__lodash_hash_undefined__",objectProto$f=Object.prototype,hasOwnProperty$d=objectProto$f.hasOwnProperty;function hashGet(e){var t=this.__data__;if(_nativeCreate){var i=t[e];return i===HASH_UNDEFINED$2?void 0:i}return hasOwnProperty$d.call(t,e)?t[e]:void 0}var _hashGet=hashGet,objectProto$e=Object.prototype,hasOwnProperty$c=objectProto$e.hasOwnProperty;function hashHas(e){var t=this.__data__;return _nativeCreate?void 0!==t[e]:hasOwnProperty$c.call(t,e)}var _hashHas=hashHas,HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=_nativeCreate&&void 0===t?HASH_UNDEFINED$1:t,this}var _hashSet=hashSet;function Hash(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}Hash.prototype.clear=_hashClear,Hash.prototype.delete=_hashDelete,Hash.prototype.get=_hashGet,Hash.prototype.has=_hashHas,Hash.prototype.set=_hashSet;var _Hash=Hash;function mapCacheClear(){this.size=0,this.__data__={hash:new _Hash,map:new(_Map||_ListCache),string:new _Hash}}var _mapCacheClear=mapCacheClear;function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}var _isKeyable=isKeyable;function getMapData(e,t){var i=e.__data__;return _isKeyable(t)?i["string"==typeof t?"string":"hash"]:i.map}var _getMapData=getMapData;function mapCacheDelete(e){var t=_getMapData(this,e).delete(e);return this.size-=t?1:0,t}var _mapCacheDelete=mapCacheDelete;function mapCacheGet(e){return _getMapData(this,e).get(e)}var _mapCacheGet=mapCacheGet;function mapCacheHas(e){return _getMapData(this,e).has(e)}var _mapCacheHas=mapCacheHas;function mapCacheSet(e,t){var i=_getMapData(this,e),s=i.size;return i.set(e,t),this.size+=i.size==s?0:1,this}var _mapCacheSet=mapCacheSet;function MapCache(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}MapCache.prototype.clear=_mapCacheClear,MapCache.prototype.delete=_mapCacheDelete,MapCache.prototype.get=_mapCacheGet,MapCache.prototype.has=_mapCacheHas,MapCache.prototype.set=_mapCacheSet;var _MapCache=MapCache,LARGE_ARRAY_SIZE$1=200;function stackSet(e,t){var i=this.__data__;if(i instanceof _ListCache){var s=i.__data__;if(!_Map||s.length<LARGE_ARRAY_SIZE$1-1)return s.push([e,t]),this.size=++i.size,this;i=this.__data__=new _MapCache(s)}return i.set(e,t),this.size=i.size,this}var _stackSet=stackSet;function Stack(e){var t=this.__data__=new _ListCache(e);this.size=t.size}Stack.prototype.clear=_stackClear,Stack.prototype.delete=_stackDelete,Stack.prototype.get=_stackGet,Stack.prototype.has=_stackHas,Stack.prototype.set=_stackSet;var _Stack=Stack;
/**
	 * A specialized version of `_.forEach` for arrays without support for
	 * iteratee shorthands.
	 *
	 * @private
	 * @param {Array} [array] The array to iterate over.
	 * @param {Function} iteratee The function invoked per iteration.
	 * @returns {Array} Returns `array`.
	 */function arrayEach(e,t){for(var i=-1,s=null==e?0:e.length;++i<s&&!1!==t(e[i],i,e););return e}var _arrayEach=arrayEach,defineProperty=function(){try{var e=_getNative(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),_defineProperty=defineProperty;function baseAssignValue(e,t,i){"__proto__"==t&&_defineProperty?_defineProperty(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}var _baseAssignValue=baseAssignValue,objectProto$d=Object.prototype,hasOwnProperty$b=objectProto$d.hasOwnProperty;function assignValue(e,t,i){var s=e[t];hasOwnProperty$b.call(e,t)&&eq_1(s,i)&&(void 0!==i||t in e)||_baseAssignValue(e,t,i)}var _assignValue=assignValue;function copyObject(e,t,i,s){var a=!i;i||(i={});for(var r=-1,n=t.length;++r<n;){var o=t[r],l=s?s(i[o],e[o],o,i,e):void 0;void 0===l&&(l=e[o]),a?_baseAssignValue(i,o,l):_assignValue(i,o,l)}return i}var _copyObject=copyObject;function baseTimes(e,t){for(var i=-1,s=Array(e);++i<e;)s[i]=t(i);return s}var _baseTimes=baseTimes;function isObjectLike(e){return null!=e&&"object"==typeof e}var isObjectLike_1=isObjectLike,argsTag$3="[object Arguments]";function baseIsArguments(e){return isObjectLike_1(e)&&_baseGetTag(e)==argsTag$3}var _baseIsArguments=baseIsArguments,objectProto$c=Object.prototype,hasOwnProperty$a=objectProto$c.hasOwnProperty,propertyIsEnumerable$1=objectProto$c.propertyIsEnumerable,isArguments=_baseIsArguments(function(){return arguments}())?_baseIsArguments:function(e){return isObjectLike_1(e)&&hasOwnProperty$a.call(e,"callee")&&!propertyIsEnumerable$1.call(e,"callee")},isArguments_1=isArguments,isArray=Array.isArray,isArray_1=isArray;function stubFalse(){return!1}var stubFalse_1=stubFalse,isBuffer_1=createCommonjsModule((function(e,t){var i=t&&!t.nodeType&&t,s=i&&e&&!e.nodeType&&e,a=s&&s.exports===i?_root.Buffer:void 0,r=(a?a.isBuffer:void 0)||stubFalse_1;e.exports=r})),MAX_SAFE_INTEGER$1=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;function isIndex(e,t){var i=typeof e;return!!(t=null==t?MAX_SAFE_INTEGER$1:t)&&("number"==i||"symbol"!=i&&reIsUint.test(e))&&e>-1&&e%1==0&&e<t}var _isIndex=isIndex,MAX_SAFE_INTEGER=9007199254740991;function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=MAX_SAFE_INTEGER}var isLength_1=isLength,argsTag$2="[object Arguments]",arrayTag$2="[object Array]",boolTag$3="[object Boolean]",dateTag$3="[object Date]",errorTag$2="[object Error]",funcTag$1="[object Function]",mapTag$7="[object Map]",numberTag$3="[object Number]",objectTag$4="[object Object]",regexpTag$3="[object RegExp]",setTag$7="[object Set]",stringTag$4="[object String]",weakMapTag$2="[object WeakMap]",arrayBufferTag$3="[object ArrayBuffer]",dataViewTag$4="[object DataView]",float32Tag$2="[object Float32Array]",float64Tag$2="[object Float64Array]",int8Tag$2="[object Int8Array]",int16Tag$2="[object Int16Array]",int32Tag$2="[object Int32Array]",uint8Tag$2="[object Uint8Array]",uint8ClampedTag$2="[object Uint8ClampedArray]",uint16Tag$2="[object Uint16Array]",uint32Tag$2="[object Uint32Array]",typedArrayTags={};function baseIsTypedArray(e){return isObjectLike_1(e)&&isLength_1(e.length)&&!!typedArrayTags[_baseGetTag(e)]}typedArrayTags[float32Tag$2]=typedArrayTags[float64Tag$2]=typedArrayTags[int8Tag$2]=typedArrayTags[int16Tag$2]=typedArrayTags[int32Tag$2]=typedArrayTags[uint8Tag$2]=typedArrayTags[uint8ClampedTag$2]=typedArrayTags[uint16Tag$2]=typedArrayTags[uint32Tag$2]=!0,typedArrayTags[argsTag$2]=typedArrayTags[arrayTag$2]=typedArrayTags[arrayBufferTag$3]=typedArrayTags[boolTag$3]=typedArrayTags[dataViewTag$4]=typedArrayTags[dateTag$3]=typedArrayTags[errorTag$2]=typedArrayTags[funcTag$1]=typedArrayTags[mapTag$7]=typedArrayTags[numberTag$3]=typedArrayTags[objectTag$4]=typedArrayTags[regexpTag$3]=typedArrayTags[setTag$7]=typedArrayTags[stringTag$4]=typedArrayTags[weakMapTag$2]=!1;var _baseIsTypedArray=baseIsTypedArray;function baseUnary(e){return function(t){return e(t)}}var _baseUnary=baseUnary,_nodeUtil=createCommonjsModule((function(e,t){var i=t&&!t.nodeType&&t,s=i&&e&&!e.nodeType&&e,a=s&&s.exports===i&&_freeGlobal.process,r=function(){try{var e=s&&s.require&&s.require("util").types;return e||a&&a.binding&&a.binding("util")}catch(e){}}();e.exports=r})),nodeIsTypedArray=_nodeUtil&&_nodeUtil.isTypedArray,isTypedArray=nodeIsTypedArray?_baseUnary(nodeIsTypedArray):_baseIsTypedArray,isTypedArray_1=isTypedArray,objectProto$b=Object.prototype,hasOwnProperty$9=objectProto$b.hasOwnProperty;function arrayLikeKeys(e,t){var i=isArray_1(e),s=!i&&isArguments_1(e),a=!i&&!s&&isBuffer_1(e),r=!i&&!s&&!a&&isTypedArray_1(e),n=i||s||a||r,o=n?_baseTimes(e.length,String):[],l=o.length;for(var h in e)!t&&!hasOwnProperty$9.call(e,h)||n&&("length"==h||a&&("offset"==h||"parent"==h)||r&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||_isIndex(h,l))||o.push(h);return o}var _arrayLikeKeys=arrayLikeKeys,objectProto$a=Object.prototype;function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||objectProto$a)}var _isPrototype=isPrototype;function overArg(e,t){return function(i){return e(t(i))}}var _overArg=overArg,nativeKeys=_overArg(Object.keys,Object),_nativeKeys=nativeKeys,objectProto$9=Object.prototype,hasOwnProperty$8=objectProto$9.hasOwnProperty;function baseKeys(e){if(!_isPrototype(e))return _nativeKeys(e);var t=[];for(var i in Object(e))hasOwnProperty$8.call(e,i)&&"constructor"!=i&&t.push(i);return t}var _baseKeys=baseKeys;function isArrayLike(e){return null!=e&&isLength_1(e.length)&&!isFunction_1(e)}var isArrayLike_1=isArrayLike;function keys(e){return isArrayLike_1(e)?_arrayLikeKeys(e):_baseKeys(e)}var keys_1=keys;function baseAssign(e,t){return e&&_copyObject(t,keys_1(t),e)}var _baseAssign=baseAssign;function nativeKeysIn(e){var t=[];if(null!=e)for(var i in Object(e))t.push(i);return t}var _nativeKeysIn=nativeKeysIn,objectProto$8=Object.prototype,hasOwnProperty$7=objectProto$8.hasOwnProperty;function baseKeysIn(e){if(!isObject_1(e))return _nativeKeysIn(e);var t=_isPrototype(e),i=[];for(var s in e)("constructor"!=s||!t&&hasOwnProperty$7.call(e,s))&&i.push(s);return i}var _baseKeysIn=baseKeysIn;function keysIn(e){return isArrayLike_1(e)?_arrayLikeKeys(e,!0):_baseKeysIn(e)}var keysIn_1=keysIn;function baseAssignIn(e,t){return e&&_copyObject(t,keysIn_1(t),e)}var _baseAssignIn=baseAssignIn,_cloneBuffer=createCommonjsModule((function(e,t){var i=t&&!t.nodeType&&t,s=i&&e&&!e.nodeType&&e,a=s&&s.exports===i?_root.Buffer:void 0,r=a?a.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var i=e.length,s=r?r(i):new e.constructor(i);return e.copy(s),s}}));function copyArray(e,t){var i=-1,s=e.length;for(t||(t=Array(s));++i<s;)t[i]=e[i];return t}var _copyArray=copyArray;
/**
	 * A specialized version of `_.filter` for arrays without support for
	 * iteratee shorthands.
	 *
	 * @private
	 * @param {Array} [array] The array to iterate over.
	 * @param {Function} predicate The function invoked per iteration.
	 * @returns {Array} Returns the new filtered array.
	 */function arrayFilter(e,t){for(var i=-1,s=null==e?0:e.length,a=0,r=[];++i<s;){var n=e[i];t(n,i,e)&&(r[a++]=n)}return r}var _arrayFilter=arrayFilter;function stubArray(){return[]}var stubArray_1=stubArray,objectProto$7=Object.prototype,propertyIsEnumerable=objectProto$7.propertyIsEnumerable,nativeGetSymbols$1=Object.getOwnPropertySymbols,getSymbols=nativeGetSymbols$1?function(e){return null==e?[]:(e=Object(e),_arrayFilter(nativeGetSymbols$1(e),(function(t){return propertyIsEnumerable.call(e,t)})))}:stubArray_1,_getSymbols=getSymbols;function copySymbols(e,t){return _copyObject(e,_getSymbols(e),t)}var _copySymbols=copySymbols;function arrayPush(e,t){for(var i=-1,s=t.length,a=e.length;++i<s;)e[a+i]=t[i];return e}var _arrayPush=arrayPush,getPrototype=_overArg(Object.getPrototypeOf,Object),_getPrototype=getPrototype,nativeGetSymbols=Object.getOwnPropertySymbols,getSymbolsIn=nativeGetSymbols?function(e){for(var t=[];e;)_arrayPush(t,_getSymbols(e)),e=_getPrototype(e);return t}:stubArray_1,_getSymbolsIn=getSymbolsIn;function copySymbolsIn(e,t){return _copyObject(e,_getSymbolsIn(e),t)}var _copySymbolsIn=copySymbolsIn;function baseGetAllKeys(e,t,i){var s=t(e);return isArray_1(e)?s:_arrayPush(s,i(e))}var _baseGetAllKeys=baseGetAllKeys;function getAllKeys(e){return _baseGetAllKeys(e,keys_1,_getSymbols)}var _getAllKeys=getAllKeys;function getAllKeysIn(e){return _baseGetAllKeys(e,keysIn_1,_getSymbolsIn)}var _getAllKeysIn=getAllKeysIn,DataView=_getNative(_root,"DataView"),_DataView=DataView,Promise$1=_getNative(_root,"Promise"),_Promise=Promise$1,Set$1=_getNative(_root,"Set"),_Set=Set$1,WeakMap=_getNative(_root,"WeakMap"),_WeakMap=WeakMap,mapTag$6="[object Map]",objectTag$3="[object Object]",promiseTag="[object Promise]",setTag$6="[object Set]",weakMapTag$1="[object WeakMap]",dataViewTag$3="[object DataView]",dataViewCtorString=_toSource(_DataView),mapCtorString=_toSource(_Map),promiseCtorString=_toSource(_Promise),setCtorString=_toSource(_Set),weakMapCtorString=_toSource(_WeakMap),getTag=_baseGetTag;(_DataView&&getTag(new _DataView(new ArrayBuffer(1)))!=dataViewTag$3||_Map&&getTag(new _Map)!=mapTag$6||_Promise&&getTag(_Promise.resolve())!=promiseTag||_Set&&getTag(new _Set)!=setTag$6||_WeakMap&&getTag(new _WeakMap)!=weakMapTag$1)&&(getTag=function(e){var t=_baseGetTag(e),i=t==objectTag$3?e.constructor:void 0,s=i?_toSource(i):"";if(s)switch(s){case dataViewCtorString:return dataViewTag$3;case mapCtorString:return mapTag$6;case promiseCtorString:return promiseTag;case setCtorString:return setTag$6;case weakMapCtorString:return weakMapTag$1}return t});var _getTag=getTag,objectProto$6=Object.prototype,hasOwnProperty$6=objectProto$6.hasOwnProperty;function initCloneArray(e){var t=e.length,i=new e.constructor(t);return t&&"string"==typeof e[0]&&hasOwnProperty$6.call(e,"index")&&(i.index=e.index,i.input=e.input),i}var _initCloneArray=initCloneArray,Uint8Array=_root.Uint8Array,_Uint8Array=Uint8Array;function cloneArrayBuffer(e){var t=new e.constructor(e.byteLength);return new _Uint8Array(t).set(new _Uint8Array(e)),t}var _cloneArrayBuffer=cloneArrayBuffer;function cloneDataView(e,t){var i=t?_cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}var _cloneDataView=cloneDataView,reFlags=/\w*$/;function cloneRegExp(e){var t=new e.constructor(e.source,reFlags.exec(e));return t.lastIndex=e.lastIndex,t}var _cloneRegExp=cloneRegExp,symbolProto$2=_Symbol?_Symbol.prototype:void 0,symbolValueOf$1=symbolProto$2?symbolProto$2.valueOf:void 0;function cloneSymbol(e){return symbolValueOf$1?Object(symbolValueOf$1.call(e)):{}}var _cloneSymbol=cloneSymbol;function cloneTypedArray(e,t){var i=t?_cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}var _cloneTypedArray=cloneTypedArray,boolTag$2="[object Boolean]",dateTag$2="[object Date]",mapTag$5="[object Map]",numberTag$2="[object Number]",regexpTag$2="[object RegExp]",setTag$5="[object Set]",stringTag$3="[object String]",symbolTag$3="[object Symbol]",arrayBufferTag$2="[object ArrayBuffer]",dataViewTag$2="[object DataView]",float32Tag$1="[object Float32Array]",float64Tag$1="[object Float64Array]",int8Tag$1="[object Int8Array]",int16Tag$1="[object Int16Array]",int32Tag$1="[object Int32Array]",uint8Tag$1="[object Uint8Array]",uint8ClampedTag$1="[object Uint8ClampedArray]",uint16Tag$1="[object Uint16Array]",uint32Tag$1="[object Uint32Array]";function initCloneByTag(e,t,i){var s=e.constructor;switch(t){case arrayBufferTag$2:return _cloneArrayBuffer(e);case boolTag$2:case dateTag$2:return new s(+e);case dataViewTag$2:return _cloneDataView(e,i);case float32Tag$1:case float64Tag$1:case int8Tag$1:case int16Tag$1:case int32Tag$1:case uint8Tag$1:case uint8ClampedTag$1:case uint16Tag$1:case uint32Tag$1:return _cloneTypedArray(e,i);case mapTag$5:return new s;case numberTag$2:case stringTag$3:return new s(e);case regexpTag$2:return _cloneRegExp(e);case setTag$5:return new s;case symbolTag$3:return _cloneSymbol(e)}}var _initCloneByTag=initCloneByTag,objectCreate=Object.create,baseCreate=function(){function e(){}return function(t){if(!isObject_1(t))return{};if(objectCreate)return objectCreate(t);e.prototype=t;var i=new e;return e.prototype=void 0,i}}(),_baseCreate=baseCreate;function initCloneObject(e){return"function"!=typeof e.constructor||_isPrototype(e)?{}:_baseCreate(_getPrototype(e))}var _initCloneObject=initCloneObject,mapTag$4="[object Map]";function baseIsMap(e){return isObjectLike_1(e)&&_getTag(e)==mapTag$4}var _baseIsMap=baseIsMap,nodeIsMap=_nodeUtil&&_nodeUtil.isMap,isMap=nodeIsMap?_baseUnary(nodeIsMap):_baseIsMap,isMap_1=isMap,setTag$4="[object Set]";function baseIsSet(e){return isObjectLike_1(e)&&_getTag(e)==setTag$4}var _baseIsSet=baseIsSet,nodeIsSet=_nodeUtil&&_nodeUtil.isSet,isSet=nodeIsSet?_baseUnary(nodeIsSet):_baseIsSet,isSet_1=isSet,CLONE_DEEP_FLAG$1=1,CLONE_FLAT_FLAG=2,CLONE_SYMBOLS_FLAG$2=4,argsTag$1="[object Arguments]",arrayTag$1="[object Array]",boolTag$1="[object Boolean]",dateTag$1="[object Date]",errorTag$1="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag$3="[object Map]",numberTag$1="[object Number]",objectTag$2="[object Object]",regexpTag$1="[object RegExp]",setTag$3="[object Set]",stringTag$2="[object String]",symbolTag$2="[object Symbol]",weakMapTag="[object WeakMap]",arrayBufferTag$1="[object ArrayBuffer]",dataViewTag$1="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",cloneableTags={};function baseClone(e,t,i,s,a,r){var n,o=t&CLONE_DEEP_FLAG$1,l=t&CLONE_FLAT_FLAG,h=t&CLONE_SYMBOLS_FLAG$2;if(i&&(n=a?i(e,s,a,r):i(e)),void 0!==n)return n;if(!isObject_1(e))return e;var c=isArray_1(e);if(c){if(n=_initCloneArray(e),!o)return _copyArray(e,n)}else{var d=_getTag(e),u=d==funcTag||d==genTag;if(isBuffer_1(e))return _cloneBuffer(e,o);if(d==objectTag$2||d==argsTag$1||u&&!a){if(n=l||u?{}:_initCloneObject(e),!o)return l?_copySymbolsIn(e,_baseAssignIn(n,e)):_copySymbols(e,_baseAssign(n,e))}else{if(!cloneableTags[d])return a?e:{};n=_initCloneByTag(e,d,o)}}r||(r=new _Stack);var p=r.get(e);if(p)return p;r.set(e,n),isSet_1(e)?e.forEach((function(s){n.add(baseClone(s,t,i,s,e,r))})):isMap_1(e)&&e.forEach((function(s,a){n.set(a,baseClone(s,t,i,a,e,r))}));var _=c?void 0:(h?l?_getAllKeysIn:_getAllKeys:l?keysIn_1:keys_1)(e);return _arrayEach(_||e,(function(s,a){_&&(s=e[a=s]),_assignValue(n,a,baseClone(s,t,i,a,e,r))})),n}cloneableTags[argsTag$1]=cloneableTags[arrayTag$1]=cloneableTags[arrayBufferTag$1]=cloneableTags[dataViewTag$1]=cloneableTags[boolTag$1]=cloneableTags[dateTag$1]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag$3]=cloneableTags[numberTag$1]=cloneableTags[objectTag$2]=cloneableTags[regexpTag$1]=cloneableTags[setTag$3]=cloneableTags[stringTag$2]=cloneableTags[symbolTag$2]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=!0,cloneableTags[errorTag$1]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=!1;var _baseClone=baseClone,CLONE_SYMBOLS_FLAG$1=4;function clone(e){return _baseClone(e,CLONE_SYMBOLS_FLAG$1)}var clone_1=clone;function constant(e){return function(){return e}}var constant_1=constant;function createBaseFor(e){return function(t,i,s){for(var a=-1,r=Object(t),n=s(t),o=n.length;o--;){var l=n[e?o:++a];if(!1===i(r[l],l,r))break}return t}}var _createBaseFor=createBaseFor,baseFor=_createBaseFor(),_baseFor=baseFor;function baseForOwn(e,t){return e&&_baseFor(e,t,keys_1)}var _baseForOwn=baseForOwn;function createBaseEach(e,t){return function(i,s){if(null==i)return i;if(!isArrayLike_1(i))return e(i,s);for(var a=i.length,r=t?a:-1,n=Object(i);(t?r--:++r<a)&&!1!==s(n[r],r,n););return i}}var _createBaseEach=createBaseEach,baseEach=_createBaseEach(_baseForOwn),_baseEach=baseEach;function identity(e){return e}var identity_1=identity;function castFunction(e){return"function"==typeof e?e:identity_1}var _castFunction=castFunction;function forEach(e,t){return(isArray_1(e)?_arrayEach:_baseEach)(e,_castFunction(t))}var forEach_1=forEach,each=forEach_1;function baseFilter(e,t){var i=[];return _baseEach(e,(function(e,s,a){t(e,s,a)&&i.push(e)})),i}var _baseFilter=baseFilter,HASH_UNDEFINED="__lodash_hash_undefined__";function setCacheAdd(e){return this.__data__.set(e,HASH_UNDEFINED),this}var _setCacheAdd=setCacheAdd;function setCacheHas(e){return this.__data__.has(e)}var _setCacheHas=setCacheHas;function SetCache(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new _MapCache;++t<i;)this.add(e[t])}SetCache.prototype.add=SetCache.prototype.push=_setCacheAdd,SetCache.prototype.has=_setCacheHas;var _SetCache=SetCache;
/**
	 * A specialized version of `_.some` for arrays without support for iteratee
	 * shorthands.
	 *
	 * @private
	 * @param {Array} [array] The array to iterate over.
	 * @param {Function} predicate The function invoked per iteration.
	 * @returns {boolean} Returns `true` if any element passes the predicate check,
	 *  else `false`.
	 */function arraySome(e,t){for(var i=-1,s=null==e?0:e.length;++i<s;)if(t(e[i],i,e))return!0;return!1}var _arraySome=arraySome;function cacheHas(e,t){return e.has(t)}var _cacheHas=cacheHas,COMPARE_PARTIAL_FLAG$5=1,COMPARE_UNORDERED_FLAG$3=2;
/**
	 * A specialized version of `baseIsEqualDeep` for arrays with support for
	 * partial deep comparisons.
	 *
	 * @private
	 * @param {Array} array The array to compare.
	 * @param {Array} other The other array to compare.
	 * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
	 * @param {Function} customizer The function to customize comparisons.
	 * @param {Function} equalFunc The function to determine equivalents of values.
	 * @param {Object} stack Tracks traversed `array` and `other` objects.
	 * @returns {boolean} Returns `true` if the arrays are equivalent, else `false`.
	 */
function equalArrays(e,t,i,s,a,r){var n=i&COMPARE_PARTIAL_FLAG$5,o=e.length,l=t.length;if(o!=l&&!(n&&l>o))return!1;var h=r.get(e),c=r.get(t);if(h&&c)return h==t&&c==e;var d=-1,u=!0,p=i&COMPARE_UNORDERED_FLAG$3?new _SetCache:void 0;for(r.set(e,t),r.set(t,e);++d<o;){var _=e[d],g=t[d];if(s)var f=n?s(g,_,d,t,e,r):s(_,g,d,e,t,r);if(void 0!==f){if(f)continue;u=!1;break}if(p){if(!_arraySome(t,(function(e,t){if(!_cacheHas(p,t)&&(_===e||a(_,e,i,s,r)))return p.push(t)}))){u=!1;break}}else if(_!==g&&!a(_,g,i,s,r)){u=!1;break}}return r.delete(e),r.delete(t),u}var _equalArrays=equalArrays;function mapToArray(e){var t=-1,i=Array(e.size);return e.forEach((function(e,s){i[++t]=[s,e]})),i}var _mapToArray=mapToArray;function setToArray(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e})),i}var _setToArray=setToArray,COMPARE_PARTIAL_FLAG$4=1,COMPARE_UNORDERED_FLAG$2=2,boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",mapTag$2="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag$2="[object Set]",stringTag$1="[object String]",symbolTag$1="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",symbolProto$1=_Symbol?_Symbol.prototype:void 0,symbolValueOf=symbolProto$1?symbolProto$1.valueOf:void 0;
/**
	 * A specialized version of `baseIsEqualDeep` for comparing objects of
	 * the same `toStringTag`.
	 *
	 * **Note:** This function only supports comparing values with tags of
	 * `Boolean`, `Date`, `Error`, `Number`, `RegExp`, or `String`.
	 *
	 * @private
	 * @param {Object} object The object to compare.
	 * @param {Object} other The other object to compare.
	 * @param {string} tag The `toStringTag` of the objects to compare.
	 * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
	 * @param {Function} customizer The function to customize comparisons.
	 * @param {Function} equalFunc The function to determine equivalents of values.
	 * @param {Object} stack Tracks traversed `object` and `other` objects.
	 * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
	 */
function equalByTag(e,t,i,s,a,r,n){switch(i){case dataViewTag:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case arrayBufferTag:return!(e.byteLength!=t.byteLength||!r(new _Uint8Array(e),new _Uint8Array(t)));case boolTag:case dateTag:case numberTag:return eq_1(+e,+t);case errorTag:return e.name==t.name&&e.message==t.message;case regexpTag:case stringTag$1:return e==t+"";case mapTag$2:var o=_mapToArray;case setTag$2:var l=s&COMPARE_PARTIAL_FLAG$4;if(o||(o=_setToArray),e.size!=t.size&&!l)return!1;var h=n.get(e);if(h)return h==t;s|=COMPARE_UNORDERED_FLAG$2,n.set(e,t);var c=_equalArrays(o(e),o(t),s,a,r,n);return n.delete(e),c;case symbolTag$1:if(symbolValueOf)return symbolValueOf.call(e)==symbolValueOf.call(t)}return!1}var _equalByTag=equalByTag,COMPARE_PARTIAL_FLAG$3=1,objectProto$5=Object.prototype,hasOwnProperty$5=objectProto$5.hasOwnProperty;
/**
	 * A specialized version of `baseIsEqualDeep` for objects with support for
	 * partial deep comparisons.
	 *
	 * @private
	 * @param {Object} object The object to compare.
	 * @param {Object} other The other object to compare.
	 * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
	 * @param {Function} customizer The function to customize comparisons.
	 * @param {Function} equalFunc The function to determine equivalents of values.
	 * @param {Object} stack Tracks traversed `object` and `other` objects.
	 * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
	 */
function equalObjects(e,t,i,s,a,r){var n=i&COMPARE_PARTIAL_FLAG$3,o=_getAllKeys(e),l=o.length;if(l!=_getAllKeys(t).length&&!n)return!1;for(var h=l;h--;){var c=o[h];if(!(n?c in t:hasOwnProperty$5.call(t,c)))return!1}var d=r.get(e),u=r.get(t);if(d&&u)return d==t&&u==e;var p=!0;r.set(e,t),r.set(t,e);for(var _=n;++h<l;){var g=e[c=o[h]],f=t[c];if(s)var y=n?s(f,g,c,t,e,r):s(g,f,c,e,t,r);if(!(void 0===y?g===f||a(g,f,i,s,r):y)){p=!1;break}_||(_="constructor"==c)}if(p&&!_){var m=e.constructor,b=t.constructor;m==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof m&&m instanceof m&&"function"==typeof b&&b instanceof b||(p=!1)}return r.delete(e),r.delete(t),p}var _equalObjects=equalObjects,COMPARE_PARTIAL_FLAG$2=1,argsTag="[object Arguments]",arrayTag="[object Array]",objectTag$1="[object Object]",objectProto$4=Object.prototype,hasOwnProperty$4=objectProto$4.hasOwnProperty;
/**
	 * A specialized version of `baseIsEqual` for arrays and objects which performs
	 * deep comparisons and tracks traversed objects enabling objects with circular
	 * references to be compared.
	 *
	 * @private
	 * @param {Object} object The object to compare.
	 * @param {Object} other The other object to compare.
	 * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
	 * @param {Function} customizer The function to customize comparisons.
	 * @param {Function} equalFunc The function to determine equivalents of values.
	 * @param {Object} [stack] Tracks traversed `object` and `other` objects.
	 * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
	 */
function baseIsEqualDeep(e,t,i,s,a,r){var n=isArray_1(e),o=isArray_1(t),l=n?arrayTag:_getTag(e),h=o?arrayTag:_getTag(t),c=(l=l==argsTag?objectTag$1:l)==objectTag$1,d=(h=h==argsTag?objectTag$1:h)==objectTag$1,u=l==h;if(u&&isBuffer_1(e)){if(!isBuffer_1(t))return!1;n=!0,c=!1}if(u&&!c)return r||(r=new _Stack),n||isTypedArray_1(e)?_equalArrays(e,t,i,s,a,r):_equalByTag(e,t,l,i,s,a,r);if(!(i&COMPARE_PARTIAL_FLAG$2)){var p=c&&hasOwnProperty$4.call(e,"__wrapped__"),_=d&&hasOwnProperty$4.call(t,"__wrapped__");if(p||_){var g=p?e.value():e,f=_?t.value():t;return r||(r=new _Stack),a(g,f,i,s,r)}}return!!u&&(r||(r=new _Stack),_equalObjects(e,t,i,s,a,r))}var _baseIsEqualDeep=baseIsEqualDeep;function baseIsEqual(e,t,i,s,a){return e===t||(null==e||null==t||!isObjectLike_1(e)&&!isObjectLike_1(t)?e!=e&&t!=t:_baseIsEqualDeep(e,t,i,s,baseIsEqual,a))}var _baseIsEqual=baseIsEqual,COMPARE_PARTIAL_FLAG$1=1,COMPARE_UNORDERED_FLAG$1=2;function baseIsMatch(e,t,i,s){var a=i.length,r=a,n=!s;if(null==e)return!r;for(e=Object(e);a--;){var o=i[a];if(n&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++a<r;){var l=(o=i[a])[0],h=e[l],c=o[1];if(n&&o[2]){if(void 0===h&&!(l in e))return!1}else{var d=new _Stack;if(s)var u=s(h,c,l,e,t,d);if(!(void 0===u?_baseIsEqual(c,h,COMPARE_PARTIAL_FLAG$1|COMPARE_UNORDERED_FLAG$1,s,d):u))return!1}}return!0}var _baseIsMatch=baseIsMatch;function isStrictComparable(e){return e==e&&!isObject_1(e)}var _isStrictComparable=isStrictComparable;function getMatchData(e){for(var t=keys_1(e),i=t.length;i--;){var s=t[i],a=e[s];t[i]=[s,a,_isStrictComparable(a)]}return t}var _getMatchData=getMatchData;
/**
	 * A specialized version of `matchesProperty` for source values suitable
	 * for strict equality comparisons, i.e. `===`.
	 *
	 * @private
	 * @param {string} key The key of the property to get.
	 * @param {*} srcValue The value to match.
	 * @returns {Function} Returns the new spec function.
	 */function matchesStrictComparable(e,t){return function(i){return null!=i&&(i[e]===t&&(void 0!==t||e in Object(i)))}}var _matchesStrictComparable=matchesStrictComparable;function baseMatches(e){var t=_getMatchData(e);return 1==t.length&&t[0][2]?_matchesStrictComparable(t[0][0],t[0][1]):function(i){return i===e||_baseIsMatch(i,e,t)}}var _baseMatches=baseMatches,symbolTag="[object Symbol]";function isSymbol(e){return"symbol"==typeof e||isObjectLike_1(e)&&_baseGetTag(e)==symbolTag}var isSymbol_1=isSymbol,reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/;function isKey(e,t){if(isArray_1(e))return!1;var i=typeof e;return!("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!isSymbol_1(e))||(reIsPlainProp.test(e)||!reIsDeepProp.test(e)||null!=t&&e in Object(t))}var _isKey=isKey,FUNC_ERROR_TEXT="Expected a function";function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(FUNC_ERROR_TEXT);var i=function(){var s=arguments,a=t?t.apply(this,s):s[0],r=i.cache;if(r.has(a))return r.get(a);var n=e.apply(this,s);return i.cache=r.set(a,n)||r,n};return i.cache=new(memoize.Cache||_MapCache),i}memoize.Cache=_MapCache;var memoize_1=memoize,MAX_MEMOIZE_SIZE=500;
/**
	 * A specialized version of `_.memoize` which clears the memoized function's
	 * cache when it exceeds `MAX_MEMOIZE_SIZE`.
	 *
	 * @private
	 * @param {Function} func The function to have its output memoized.
	 * @returns {Function} Returns the new memoized function.
	 */
function memoizeCapped(e){var t=memoize_1(e,(function(e){return i.size===MAX_MEMOIZE_SIZE&&i.clear(),e})),i=t.cache;return t}var _memoizeCapped=memoizeCapped,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=_memoizeCapped((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(rePropName,(function(e,i,s,a){t.push(s?a.replace(reEscapeChar,"$1"):i||e)})),t})),_stringToPath=stringToPath;
/**
	 * A specialized version of `_.map` for arrays without support for iteratee
	 * shorthands.
	 *
	 * @private
	 * @param {Array} [array] The array to iterate over.
	 * @param {Function} iteratee The function invoked per iteration.
	 * @returns {Array} Returns the new mapped array.
	 */
function arrayMap(e,t){for(var i=-1,s=null==e?0:e.length,a=Array(s);++i<s;)a[i]=t(e[i],i,e);return a}var _arrayMap=arrayMap,INFINITY$3=1/0,symbolProto=_Symbol?_Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function baseToString(e){if("string"==typeof e)return e;if(isArray_1(e))return _arrayMap(e,baseToString)+"";if(isSymbol_1(e))return symbolToString?symbolToString.call(e):"";var t=e+"";return"0"==t&&1/e==-INFINITY$3?"-0":t}var _baseToString=baseToString;function toString$1(e){return null==e?"":_baseToString(e)}var toString_1=toString$1;function castPath(e,t){return isArray_1(e)?e:_isKey(e,t)?[e]:_stringToPath(toString_1(e))}var _castPath=castPath,INFINITY$2=1/0;function toKey(e){if("string"==typeof e||isSymbol_1(e))return e;var t=e+"";return"0"==t&&1/e==-INFINITY$2?"-0":t}var _toKey=toKey;function baseGet(e,t){for(var i=0,s=(t=_castPath(t,e)).length;null!=e&&i<s;)e=e[_toKey(t[i++])];return i&&i==s?e:void 0}var _baseGet=baseGet;function get(e,t,i){var s=null==e?void 0:_baseGet(e,t);return void 0===s?i:s}var get_1=get;function baseHasIn(e,t){return null!=e&&t in Object(e)}var _baseHasIn=baseHasIn;function hasPath(e,t,i){for(var s=-1,a=(t=_castPath(t,e)).length,r=!1;++s<a;){var n=_toKey(t[s]);if(!(r=null!=e&&i(e,n)))break;e=e[n]}return r||++s!=a?r:!!(a=null==e?0:e.length)&&isLength_1(a)&&_isIndex(n,a)&&(isArray_1(e)||isArguments_1(e))}var _hasPath=hasPath;function hasIn(e,t){return null!=e&&_hasPath(e,t,_baseHasIn)}var hasIn_1=hasIn,COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2;function baseMatchesProperty(e,t){return _isKey(e)&&_isStrictComparable(t)?_matchesStrictComparable(_toKey(e),t):function(i){var s=get_1(i,e);return void 0===s&&s===t?hasIn_1(i,e):_baseIsEqual(t,s,COMPARE_PARTIAL_FLAG|COMPARE_UNORDERED_FLAG)}}var _baseMatchesProperty=baseMatchesProperty;function baseProperty(e){return function(t){return null==t?void 0:t[e]}}var _baseProperty=baseProperty;
/**
	 * A specialized version of `baseProperty` which supports deep paths.
	 *
	 * @private
	 * @param {Array|string} path The path of the property to get.
	 * @returns {Function} Returns the new accessor function.
	 */function basePropertyDeep(e){return function(t){return _baseGet(t,e)}}var _basePropertyDeep=basePropertyDeep;function property(e){return _isKey(e)?_baseProperty(_toKey(e)):_basePropertyDeep(e)}var property_1=property;function baseIteratee(e){return"function"==typeof e?e:null==e?identity_1:"object"==typeof e?isArray_1(e)?_baseMatchesProperty(e[0],e[1]):_baseMatches(e):property_1(e)}var _baseIteratee=baseIteratee;function filter(e,t){return(isArray_1(e)?_arrayFilter:_baseFilter)(e,_baseIteratee(t))}var filter_1=filter,objectProto$3=Object.prototype,hasOwnProperty$3=objectProto$3.hasOwnProperty;function baseHas(e,t){return null!=e&&hasOwnProperty$3.call(e,t)}var _baseHas=baseHas;function has(e,t){return null!=e&&_hasPath(e,t,_baseHas)}var has_1=has,mapTag$1="[object Map]",setTag$1="[object Set]",objectProto$2=Object.prototype,hasOwnProperty$2=objectProto$2.hasOwnProperty;function isEmpty(e){if(null==e)return!0;if(isArrayLike_1(e)&&(isArray_1(e)||"string"==typeof e||"function"==typeof e.splice||isBuffer_1(e)||isTypedArray_1(e)||isArguments_1(e)))return!e.length;var t=_getTag(e);if(t==mapTag$1||t==setTag$1)return!e.size;if(_isPrototype(e))return!_baseKeys(e).length;for(var i in e)if(hasOwnProperty$2.call(e,i))return!1;return!0}var isEmpty_1=isEmpty;function isUndefined(e){return void 0===e}var isUndefined_1=isUndefined;function baseMap(e,t){var i=-1,s=isArrayLike_1(e)?Array(e.length):[];return _baseEach(e,(function(e,a,r){s[++i]=t(e,a,r)})),s}var _baseMap=baseMap;function map(e,t){return(isArray_1(e)?_arrayMap:_baseMap)(e,_baseIteratee(t))}var map_1=map;
/**
	 * A specialized version of `_.reduce` for arrays without support for
	 * iteratee shorthands.
	 *
	 * @private
	 * @param {Array} [array] The array to iterate over.
	 * @param {Function} iteratee The function invoked per iteration.
	 * @param {*} [accumulator] The initial value.
	 * @param {boolean} [initAccum] Specify using the first element of `array` as
	 *  the initial value.
	 * @returns {*} Returns the accumulated value.
	 */function arrayReduce(e,t,i,s){var a=-1,r=null==e?0:e.length;for(s&&r&&(i=e[++a]);++a<r;)i=t(i,e[a],a,e);return i}var _arrayReduce=arrayReduce;function baseReduce(e,t,i,s,a){return a(e,(function(e,a,r){i=s?(s=!1,e):t(i,e,a,r)})),i}var _baseReduce=baseReduce;function reduce(e,t,i){var s=isArray_1(e)?_arrayReduce:_baseReduce,a=arguments.length<3;return s(e,_baseIteratee(t),i,a,_baseEach)}var reduce_1=reduce,stringTag="[object String]";function isString(e){return"string"==typeof e||!isArray_1(e)&&isObjectLike_1(e)&&_baseGetTag(e)==stringTag}var isString_1=isString,asciiSize=_baseProperty("length"),_asciiSize=asciiSize,rsAstralRange$1="\\ud800-\\udfff",rsComboMarksRange$1="\\u0300-\\u036f",reComboHalfMarksRange$1="\\ufe20-\\ufe2f",rsComboSymbolsRange$1="\\u20d0-\\u20ff",rsComboRange$1=rsComboMarksRange$1+reComboHalfMarksRange$1+rsComboSymbolsRange$1,rsVarRange$1="\\ufe0e\\ufe0f",rsZWJ$1="\\u200d",reHasUnicode=RegExp("["+rsZWJ$1+rsAstralRange$1+rsComboRange$1+rsVarRange$1+"]");function hasUnicode(e){return reHasUnicode.test(e)}var _hasUnicode=hasUnicode,rsAstralRange="\\ud800-\\udfff",rsComboMarksRange="\\u0300-\\u036f",reComboHalfMarksRange="\\ufe20-\\ufe2f",rsComboSymbolsRange="\\u20d0-\\u20ff",rsComboRange=rsComboMarksRange+reComboHalfMarksRange+rsComboSymbolsRange,rsVarRange="\\ufe0e\\ufe0f",rsAstral="["+rsAstralRange+"]",rsCombo="["+rsComboRange+"]",rsFitz="\\ud83c[\\udffb-\\udfff]",rsModifier="(?:"+rsCombo+"|"+rsFitz+")",rsNonAstral="[^"+rsAstralRange+"]",rsRegional="(?:\\ud83c[\\udde6-\\uddff]){2}",rsSurrPair="[\\ud800-\\udbff][\\udc00-\\udfff]",rsZWJ="\\u200d",reOptMod=rsModifier+"?",rsOptVar="["+rsVarRange+"]?",rsOptJoin="(?:"+rsZWJ+"(?:"+[rsNonAstral,rsRegional,rsSurrPair].join("|")+")"+rsOptVar+reOptMod+")*",rsSeq=rsOptVar+reOptMod+rsOptJoin,rsSymbol="(?:"+[rsNonAstral+rsCombo+"?",rsCombo,rsRegional,rsSurrPair,rsAstral].join("|")+")",reUnicode=RegExp(rsFitz+"(?="+rsFitz+")|"+rsSymbol+rsSeq,"g");function unicodeSize(e){for(var t=reUnicode.lastIndex=0;reUnicode.test(e);)++t;return t}var _unicodeSize=unicodeSize;function stringSize(e){return _hasUnicode(e)?_unicodeSize(e):_asciiSize(e)}var _stringSize=stringSize,mapTag="[object Map]",setTag="[object Set]";function size(e){if(null==e)return 0;if(isArrayLike_1(e))return isString_1(e)?_stringSize(e):e.length;var t=_getTag(e);return t==mapTag||t==setTag?e.size:_baseKeys(e).length}var size_1=size;function transform(e,t,i){var s=isArray_1(e),a=s||isBuffer_1(e)||isTypedArray_1(e);if(t=_baseIteratee(t),null==i){var r=e&&e.constructor;i=a?s?new r:[]:isObject_1(e)&&isFunction_1(r)?_baseCreate(_getPrototype(e)):{}}return(a?_arrayEach:_baseForOwn)(e,(function(e,s,a){return t(i,e,s,a)})),i}var transform_1=transform,spreadableSymbol=_Symbol?_Symbol.isConcatSpreadable:void 0;function isFlattenable(e){return isArray_1(e)||isArguments_1(e)||!!(spreadableSymbol&&e&&e[spreadableSymbol])}var _isFlattenable=isFlattenable;function baseFlatten(e,t,i,s,a){var r=-1,n=e.length;for(i||(i=_isFlattenable),a||(a=[]);++r<n;){var o=e[r];t>0&&i(o)?t>1?baseFlatten(o,t-1,i,s,a):_arrayPush(a,o):s||(a[a.length]=o)}return a}var _baseFlatten=baseFlatten;function apply(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}var _apply=apply,nativeMax$2=Math.max;
/**
	 * A specialized version of `baseRest` which transforms the rest array.
	 *
	 * @private
	 * @param {Function} func The function to apply a rest parameter to.
	 * @param {number} [start=func.length-1] The start position of the rest parameter.
	 * @param {Function} transform The rest array transform.
	 * @returns {Function} Returns the new function.
	 */
function overRest(e,t,i){return t=nativeMax$2(void 0===t?e.length-1:t,0),function(){for(var s=arguments,a=-1,r=nativeMax$2(s.length-t,0),n=Array(r);++a<r;)n[a]=s[t+a];a=-1;for(var o=Array(t+1);++a<t;)o[a]=s[a];return o[t]=i(n),_apply(e,this,o)}}var _overRest=overRest,baseSetToString=_defineProperty?function(e,t){return _defineProperty(e,"toString",{configurable:!0,enumerable:!1,value:constant_1(t),writable:!0})}:identity_1,_baseSetToString=baseSetToString,HOT_COUNT=800,HOT_SPAN=16,nativeNow=Date.now;function shortOut(e){var t=0,i=0;return function(){var s=nativeNow(),a=HOT_SPAN-(s-i);if(i=s,a>0){if(++t>=HOT_COUNT)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}var _shortOut=shortOut,setToString=_shortOut(_baseSetToString),_setToString=setToString;function baseRest(e,t){return _setToString(_overRest(e,t,identity_1),e+"")}var _baseRest=baseRest;function baseFindIndex(e,t,i,s){for(var a=e.length,r=i+(s?1:-1);s?r--:++r<a;)if(t(e[r],r,e))return r;return-1}var _baseFindIndex=baseFindIndex;function baseIsNaN(e){return e!=e}var _baseIsNaN=baseIsNaN;
/**
	 * A specialized version of `_.indexOf` which performs strict equality
	 * comparisons of values, i.e. `===`.
	 *
	 * @private
	 * @param {Array} array The array to inspect.
	 * @param {*} value The value to search for.
	 * @param {number} fromIndex The index to search from.
	 * @returns {number} Returns the index of the matched value, else `-1`.
	 */function strictIndexOf(e,t,i){for(var s=i-1,a=e.length;++s<a;)if(e[s]===t)return s;return-1}var _strictIndexOf=strictIndexOf;function baseIndexOf(e,t,i){return t==t?_strictIndexOf(e,t,i):_baseFindIndex(e,_baseIsNaN,i)}var _baseIndexOf=baseIndexOf;
/**
	 * A specialized version of `_.includes` for arrays without support for
	 * specifying an index to search from.
	 *
	 * @private
	 * @param {Array} [array] The array to inspect.
	 * @param {*} target The value to search for.
	 * @returns {boolean} Returns `true` if `target` is found, else `false`.
	 */function arrayIncludes(e,t){return!!(null==e?0:e.length)&&_baseIndexOf(e,t,0)>-1}var _arrayIncludes=arrayIncludes;function arrayIncludesWith(e,t,i){for(var s=-1,a=null==e?0:e.length;++s<a;)if(i(t,e[s]))return!0;return!1}var _arrayIncludesWith=arrayIncludesWith;function noop(){}var noop_1=noop,INFINITY$1=1/0,createSet=_Set&&1/_setToArray(new _Set([,-0]))[1]==INFINITY$1?function(e){return new _Set(e)}:noop_1,_createSet=createSet,LARGE_ARRAY_SIZE=200;function baseUniq(e,t,i){var s=-1,a=_arrayIncludes,r=e.length,n=!0,o=[],l=o;if(i)n=!1,a=_arrayIncludesWith;else if(r>=LARGE_ARRAY_SIZE){var h=t?null:_createSet(e);if(h)return _setToArray(h);n=!1,a=_cacheHas,l=new _SetCache}else l=t?[]:o;e:for(;++s<r;){var c=e[s],d=t?t(c):c;if(c=i||0!==c?c:0,n&&d==d){for(var u=l.length;u--;)if(l[u]===d)continue e;t&&l.push(d),o.push(c)}else a(l,d,i)||(l!==o&&l.push(d),o.push(c))}return o}var _baseUniq=baseUniq;function isArrayLikeObject(e){return isObjectLike_1(e)&&isArrayLike_1(e)}var isArrayLikeObject_1=isArrayLikeObject,union=_baseRest((function(e){return _baseUniq(_baseFlatten(e,1,isArrayLikeObject_1,!0))})),union_1=union;function baseValues(e,t){return _arrayMap(t,(function(t){return e[t]}))}var _baseValues=baseValues;function values(e){return null==e?[]:_baseValues(e,keys_1(e))}var values_1=values,lodash$1;if("function"==typeof commonjsRequire)try{lodash$1={clone:clone_1,constant:constant_1,each:each,filter:filter_1,has:has_1,isArray:isArray_1,isEmpty:isEmpty_1,isFunction:isFunction_1,isUndefined:isUndefined_1,keys:keys_1,map:map_1,reduce:reduce_1,size:size_1,transform:transform_1,union:union_1,values:values_1}}catch(e){}lodash$1||(lodash$1=window._);var lodash_1$1=lodash$1,graph=Graph$8,DEFAULT_EDGE_NAME="\0",GRAPH_NODE="\0",EDGE_KEY_DELIM="";function Graph$8(e){this._isDirected=!lodash_1$1.has(e,"directed")||e.directed,this._isMultigraph=!!lodash_1$1.has(e,"multigraph")&&e.multigraph,this._isCompound=!!lodash_1$1.has(e,"compound")&&e.compound,this._label=void 0,this._defaultNodeLabelFn=lodash_1$1.constant(void 0),this._defaultEdgeLabelFn=lodash_1$1.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[GRAPH_NODE]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}function incrementOrInitEntry(e,t){e[t]?e[t]++:e[t]=1}function decrementOrRemoveEntry(e,t){--e[t]||delete e[t]}function edgeArgsToId(e,t,i,s){var a=""+t,r=""+i;if(!e&&a>r){var n=a;a=r,r=n}return a+EDGE_KEY_DELIM+r+EDGE_KEY_DELIM+(lodash_1$1.isUndefined(s)?DEFAULT_EDGE_NAME:s)}function edgeArgsToObj(e,t,i,s){var a=""+t,r=""+i;if(!e&&a>r){var n=a;a=r,r=n}var o={v:a,w:r};return s&&(o.name=s),o}function edgeObjToId(e,t){return edgeArgsToId(e,t.v,t.w,t.name)}Graph$8.prototype._nodeCount=0,Graph$8.prototype._edgeCount=0,Graph$8.prototype.isDirected=function(){return this._isDirected},Graph$8.prototype.isMultigraph=function(){return this._isMultigraph},Graph$8.prototype.isCompound=function(){return this._isCompound},Graph$8.prototype.setGraph=function(e){return this._label=e,this},Graph$8.prototype.graph=function(){return this._label},Graph$8.prototype.setDefaultNodeLabel=function(e){return lodash_1$1.isFunction(e)||(e=lodash_1$1.constant(e)),this._defaultNodeLabelFn=e,this},Graph$8.prototype.nodeCount=function(){return this._nodeCount},Graph$8.prototype.nodes=function(){return lodash_1$1.keys(this._nodes)},Graph$8.prototype.sources=function(){var e=this;return lodash_1$1.filter(this.nodes(),(function(t){return lodash_1$1.isEmpty(e._in[t])}))},Graph$8.prototype.sinks=function(){var e=this;return lodash_1$1.filter(this.nodes(),(function(t){return lodash_1$1.isEmpty(e._out[t])}))},Graph$8.prototype.setNodes=function(e,t){var i=arguments,s=this;return lodash_1$1.each(e,(function(e){i.length>1?s.setNode(e,t):s.setNode(e)})),this},Graph$8.prototype.setNode=function(e,t){return lodash_1$1.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]=GRAPH_NODE,this._children[e]={},this._children[GRAPH_NODE][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)},Graph$8.prototype.node=function(e){return this._nodes[e]},Graph$8.prototype.hasNode=function(e){return lodash_1$1.has(this._nodes,e)},Graph$8.prototype.removeNode=function(e){var t=this;if(lodash_1$1.has(this._nodes,e)){var i=function(e){t.removeEdge(t._edgeObjs[e])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],lodash_1$1.each(this.children(e),(function(e){t.setParent(e)})),delete this._children[e]),lodash_1$1.each(lodash_1$1.keys(this._in[e]),i),delete this._in[e],delete this._preds[e],lodash_1$1.each(lodash_1$1.keys(this._out[e]),i),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this},Graph$8.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(lodash_1$1.isUndefined(t))t=GRAPH_NODE;else{for(var i=t+="";!lodash_1$1.isUndefined(i);i=this.parent(i))if(i===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this},Graph$8.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]},Graph$8.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if(t!==GRAPH_NODE)return t}},Graph$8.prototype.children=function(e){if(lodash_1$1.isUndefined(e)&&(e=GRAPH_NODE),this._isCompound){var t=this._children[e];if(t)return lodash_1$1.keys(t)}else{if(e===GRAPH_NODE)return this.nodes();if(this.hasNode(e))return[]}},Graph$8.prototype.predecessors=function(e){var t=this._preds[e];if(t)return lodash_1$1.keys(t)},Graph$8.prototype.successors=function(e){var t=this._sucs[e];if(t)return lodash_1$1.keys(t)},Graph$8.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return lodash_1$1.union(t,this.successors(e))},Graph$8.prototype.isLeaf=function(e){return 0===(this.isDirected()?this.successors(e):this.neighbors(e)).length},Graph$8.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var i=this;lodash_1$1.each(this._nodes,(function(i,s){e(s)&&t.setNode(s,i)})),lodash_1$1.each(this._edgeObjs,(function(e){t.hasNode(e.v)&&t.hasNode(e.w)&&t.setEdge(e,i.edge(e))}));var s={};function a(e){var r=i.parent(e);return void 0===r||t.hasNode(r)?(s[e]=r,r):r in s?s[r]:a(r)}return this._isCompound&&lodash_1$1.each(t.nodes(),(function(e){t.setParent(e,a(e))})),t},Graph$8.prototype.setDefaultEdgeLabel=function(e){return lodash_1$1.isFunction(e)||(e=lodash_1$1.constant(e)),this._defaultEdgeLabelFn=e,this},Graph$8.prototype.edgeCount=function(){return this._edgeCount},Graph$8.prototype.edges=function(){return lodash_1$1.values(this._edgeObjs)},Graph$8.prototype.setPath=function(e,t){var i=this,s=arguments;return lodash_1$1.reduce(e,(function(e,a){return s.length>1?i.setEdge(e,a,t):i.setEdge(e,a),a})),this},Graph$8.prototype.setEdge=function(){var e,t,i,s,a=!1,r=arguments[0];"object"==typeof r&&null!==r&&"v"in r?(e=r.v,t=r.w,i=r.name,2===arguments.length&&(s=arguments[1],a=!0)):(e=r,t=arguments[1],i=arguments[3],arguments.length>2&&(s=arguments[2],a=!0)),e=""+e,t=""+t,lodash_1$1.isUndefined(i)||(i=""+i);var n=edgeArgsToId(this._isDirected,e,t,i);if(lodash_1$1.has(this._edgeLabels,n))return a&&(this._edgeLabels[n]=s),this;if(!lodash_1$1.isUndefined(i)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[n]=a?s:this._defaultEdgeLabelFn(e,t,i);var o=edgeArgsToObj(this._isDirected,e,t,i);return e=o.v,t=o.w,Object.freeze(o),this._edgeObjs[n]=o,incrementOrInitEntry(this._preds[t],e),incrementOrInitEntry(this._sucs[e],t),this._in[t][n]=o,this._out[e][n]=o,this._edgeCount++,this},Graph$8.prototype.edge=function(e,t,i){var s=1===arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,i);return this._edgeLabels[s]},Graph$8.prototype.hasEdge=function(e,t,i){var s=1===arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,i);return lodash_1$1.has(this._edgeLabels,s)},Graph$8.prototype.removeEdge=function(e,t,i){var s=1===arguments.length?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,e,t,i),a=this._edgeObjs[s];return a&&(e=a.v,t=a.w,delete this._edgeLabels[s],delete this._edgeObjs[s],decrementOrRemoveEntry(this._preds[t],e),decrementOrRemoveEntry(this._sucs[e],t),delete this._in[t][s],delete this._out[e][s],this._edgeCount--),this},Graph$8.prototype.inEdges=function(e,t){var i=this._in[e];if(i){var s=lodash_1$1.values(i);return t?lodash_1$1.filter(s,(function(e){return e.v===t})):s}},Graph$8.prototype.outEdges=function(e,t){var i=this._out[e];if(i){var s=lodash_1$1.values(i);return t?lodash_1$1.filter(s,(function(e){return e.w===t})):s}},Graph$8.prototype.nodeEdges=function(e,t){var i=this.inEdges(e,t);if(i)return i.concat(this.outEdges(e,t))};var version$1="2.1.8",lib={Graph:graph,version:version$1},json={write:write,read:read};function write(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:writeNodes(e),edges:writeEdges(e)};return lodash_1$1.isUndefined(e.graph())||(t.value=lodash_1$1.clone(e.graph())),t}function writeNodes(e){return lodash_1$1.map(e.nodes(),(function(t){var i=e.node(t),s=e.parent(t),a={v:t};return lodash_1$1.isUndefined(i)||(a.value=i),lodash_1$1.isUndefined(s)||(a.parent=s),a}))}function writeEdges(e){return lodash_1$1.map(e.edges(),(function(t){var i=e.edge(t),s={v:t.v,w:t.w};return lodash_1$1.isUndefined(t.name)||(s.name=t.name),lodash_1$1.isUndefined(i)||(s.value=i),s}))}function read(e){var t=new graph(e.options).setGraph(e.value);return lodash_1$1.each(e.nodes,(function(e){t.setNode(e.v,e.value),e.parent&&t.setParent(e.v,e.parent)})),lodash_1$1.each(e.edges,(function(e){t.setEdge({v:e.v,w:e.w,name:e.name},e.value)})),t}json.write,json.read;var components_1=components;function components(e){var t,i={},s=[];function a(s){lodash_1$1.has(i,s)||(i[s]=!0,t.push(s),lodash_1$1.each(e.successors(s),a),lodash_1$1.each(e.predecessors(s),a))}return lodash_1$1.each(e.nodes(),(function(e){t=[],a(e),t.length&&s.push(t)})),s}var priorityQueue=PriorityQueue;function PriorityQueue(){this._arr=[],this._keyIndices={}}PriorityQueue.prototype.size=function(){return this._arr.length},PriorityQueue.prototype.keys=function(){return this._arr.map((function(e){return e.key}))},PriorityQueue.prototype.has=function(e){return lodash_1$1.has(this._keyIndices,e)},PriorityQueue.prototype.priority=function(e){var t=this._keyIndices[e];if(void 0!==t)return this._arr[t].priority},PriorityQueue.prototype.min=function(){if(0===this.size())throw new Error("Queue underflow");return this._arr[0].key},PriorityQueue.prototype.add=function(e,t){var i=this._keyIndices;if(e=String(e),!lodash_1$1.has(i,e)){var s=this._arr,a=s.length;return i[e]=a,s.push({key:e,priority:t}),this._decrease(a),!0}return!1},PriorityQueue.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key},PriorityQueue.prototype.decrease=function(e,t){var i=this._keyIndices[e];if(t>this._arr[i].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[i].priority+" New: "+t);this._arr[i].priority=t,this._decrease(i)},PriorityQueue.prototype._heapify=function(e){var t=this._arr,i=2*e,s=i+1,a=e;i<t.length&&(a=t[i].priority<t[a].priority?i:a,s<t.length&&(a=t[s].priority<t[a].priority?s:a),a!==e&&(this._swap(e,a),this._heapify(a)))},PriorityQueue.prototype._decrease=function(e){for(var t,i=this._arr,s=i[e].priority;0!==e&&!(i[t=e>>1].priority<s);)this._swap(e,t),e=t},PriorityQueue.prototype._swap=function(e,t){var i=this._arr,s=this._keyIndices,a=i[e],r=i[t];i[e]=r,i[t]=a,s[r.key]=e,s[a.key]=t};var dijkstra_1=dijkstra,DEFAULT_WEIGHT_FUNC$1=lodash_1$1.constant(1);function dijkstra(e,t,i,s){return runDijkstra(e,String(t),i||DEFAULT_WEIGHT_FUNC$1,s||function(t){return e.outEdges(t)})}function runDijkstra(e,t,i,s){var a,r,n={},o=new priorityQueue,l=function(e){var t=e.v!==a?e.v:e.w,s=n[t],l=i(e),h=r.distance+l;if(l<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+e+" Weight: "+l);h<s.distance&&(s.distance=h,s.predecessor=a,o.decrease(t,h))};for(e.nodes().forEach((function(e){var i=e===t?0:Number.POSITIVE_INFINITY;n[e]={distance:i},o.add(e,i)}));o.size()>0&&(a=o.removeMin(),(r=n[a]).distance!==Number.POSITIVE_INFINITY);)s(a).forEach(l);return n}var dijkstraAll_1=dijkstraAll;function dijkstraAll(e,t,i){return lodash_1$1.transform(e.nodes(),(function(s,a){s[a]=dijkstra_1(e,a,t,i)}),{})}var tarjan_1=tarjan;function tarjan(e){var t=0,i=[],s={},a=[];function r(n){var o=s[n]={onStack:!0,lowlink:t,index:t++};if(i.push(n),e.successors(n).forEach((function(e){lodash_1$1.has(s,e)?s[e].onStack&&(o.lowlink=Math.min(o.lowlink,s[e].index)):(r(e),o.lowlink=Math.min(o.lowlink,s[e].lowlink))})),o.lowlink===o.index){var l,h=[];do{l=i.pop(),s[l].onStack=!1,h.push(l)}while(n!==l);a.push(h)}}return e.nodes().forEach((function(e){lodash_1$1.has(s,e)||r(e)})),a}var findCycles_1=findCycles;function findCycles(e){return lodash_1$1.filter(tarjan_1(e),(function(t){return t.length>1||1===t.length&&e.hasEdge(t[0],t[0])}))}var floydWarshall_1=floydWarshall,DEFAULT_WEIGHT_FUNC=lodash_1$1.constant(1);function floydWarshall(e,t,i){return runFloydWarshall(e,t||DEFAULT_WEIGHT_FUNC,i||function(t){return e.outEdges(t)})}function runFloydWarshall(e,t,i){var s={},a=e.nodes();return a.forEach((function(e){s[e]={},s[e][e]={distance:0},a.forEach((function(t){e!==t&&(s[e][t]={distance:Number.POSITIVE_INFINITY})})),i(e).forEach((function(i){var a=i.v===e?i.w:i.v,r=t(i);s[e][a]={distance:r,predecessor:e}}))})),a.forEach((function(e){var t=s[e];a.forEach((function(i){var r=s[i];a.forEach((function(i){var s=r[e],a=t[i],n=r[i],o=s.distance+a.distance;o<n.distance&&(n.distance=o,n.predecessor=a.predecessor)}))}))})),s}var topsort_1=topsort;function topsort(e){var t={},i={},s=[];if(lodash_1$1.each(e.sinks(),(function a(r){if(lodash_1$1.has(i,r))throw new CycleException;lodash_1$1.has(t,r)||(i[r]=!0,t[r]=!0,lodash_1$1.each(e.predecessors(r),a),delete i[r],s.push(r))})),lodash_1$1.size(t)!==e.nodeCount())throw new CycleException;return s}function CycleException(){}topsort.CycleException=CycleException,CycleException.prototype=new Error;var isAcyclic_1=isAcyclic;function isAcyclic(e){try{topsort_1(e)}catch(e){if(e instanceof topsort_1.CycleException)return!1;throw e}return!0}var dfs_1=dfs$1;function dfs$1(e,t,i){lodash_1$1.isArray(t)||(t=[t]);var s=(e.isDirected()?e.successors:e.neighbors).bind(e),a=[],r={};return lodash_1$1.each(t,(function(t){if(!e.hasNode(t))throw new Error("Graph does not have node: "+t);doDfs(e,t,"post"===i,r,s,a)})),a}function doDfs(e,t,i,s,a,r){lodash_1$1.has(s,t)||(s[t]=!0,i||r.push(t),lodash_1$1.each(a(t),(function(t){doDfs(e,t,i,s,a,r)})),i&&r.push(t))}var postorder_1=postorder$2;function postorder$2(e,t){return dfs_1(e,t,"post")}var preorder_1=preorder$1;function preorder$1(e,t){return dfs_1(e,t,"pre")}var prim_1=prim;function prim(e,t){var i,s=new graph,a={},r=new priorityQueue;function n(e){var s=e.v===i?e.w:e.v,n=r.priority(s);if(void 0!==n){var o=t(e);o<n&&(a[s]=i,r.decrease(s,o))}}if(0===e.nodeCount())return s;lodash_1$1.each(e.nodes(),(function(e){r.add(e,Number.POSITIVE_INFINITY),s.setNode(e)})),r.decrease(e.nodes()[0],0);for(var o=!1;r.size()>0;){if(i=r.removeMin(),lodash_1$1.has(a,i))s.setEdge(i,a[i]);else{if(o)throw new Error("Input graph is not connected: "+e);o=!0}e.nodeEdges(i).forEach(n)}return s}var alg={components:components_1,dijkstra:dijkstra_1,dijkstraAll:dijkstraAll_1,findCycles:findCycles_1,floydWarshall:floydWarshall_1,isAcyclic:isAcyclic_1,postorder:postorder_1,preorder:preorder_1,prim:prim_1,tarjan:tarjan_1,topsort:topsort_1};alg.components,alg.dijkstra,alg.dijkstraAll,alg.findCycles,alg.floydWarshall,alg.isAcyclic,alg.postorder,alg.preorder,alg.prim,alg.tarjan,alg.topsort;var graphlib$1={Graph:lib.Graph,json:json,alg:alg,version:lib.version},graphlib;if(graphlib$1.Graph,graphlib$1.json,graphlib$1.alg,graphlib$1.version,"function"==typeof commonjsRequire)try{graphlib=graphlib$1}catch(e){}graphlib||(graphlib=window.graphlib);var graphlib_1=graphlib,CLONE_DEEP_FLAG=1,CLONE_SYMBOLS_FLAG=4;function cloneDeep(e){return _baseClone(e,CLONE_DEEP_FLAG|CLONE_SYMBOLS_FLAG)}var cloneDeep_1=cloneDeep;function isIterateeCall(e,t,i){if(!isObject_1(i))return!1;var s=typeof t;return!!("number"==s?isArrayLike_1(i)&&_isIndex(t,i.length):"string"==s&&t in i)&&eq_1(i[t],e)}var _isIterateeCall=isIterateeCall,objectProto$1=Object.prototype,hasOwnProperty$1=objectProto$1.hasOwnProperty,defaults=_baseRest((function(e,t){e=Object(e);var i=-1,s=t.length,a=s>2?t[2]:void 0;for(a&&_isIterateeCall(t[0],t[1],a)&&(s=1);++i<s;)for(var r=t[i],n=keysIn_1(r),o=-1,l=n.length;++o<l;){var h=n[o],c=e[h];(void 0===c||eq_1(c,objectProto$1[h])&&!hasOwnProperty$1.call(e,h))&&(e[h]=r[h])}return e})),defaults_1=defaults;function createFind(e){return function(t,i,s){var a=Object(t);if(!isArrayLike_1(t)){var r=_baseIteratee(i);t=keys_1(t),i=function(e){return r(a[e],e,a)}}var n=e(t,i,s);return n>-1?a[r?t[n]:n]:void 0}}var _createFind=createFind,reWhitespace=/\s/;function trimmedEndIndex(e){for(var t=e.length;t--&&reWhitespace.test(e.charAt(t)););return t}var _trimmedEndIndex=trimmedEndIndex,reTrimStart=/^\s+/;function baseTrim(e){return e?e.slice(0,_trimmedEndIndex(e)+1).replace(reTrimStart,""):e}var _baseTrim=baseTrim,NAN=NaN,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt;function toNumber(e){if("number"==typeof e)return e;if(isSymbol_1(e))return NAN;if(isObject_1(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject_1(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=_baseTrim(e);var i=reIsBinary.test(e);return i||reIsOctal.test(e)?freeParseInt(e.slice(2),i?2:8):reIsBadHex.test(e)?NAN:+e}var toNumber_1=toNumber,INFINITY=1/0,MAX_INTEGER=17976931348623157e292;function toFinite(e){return e?(e=toNumber_1(e))===INFINITY||e===-INFINITY?(e<0?-1:1)*MAX_INTEGER:e==e?e:0:0===e?e:0}var toFinite_1=toFinite;function toInteger(e){var t=toFinite_1(e),i=t%1;return t==t?i?t-i:t:0}var toInteger_1=toInteger,nativeMax$1=Math.max;function findIndex(e,t,i){var s=null==e?0:e.length;if(!s)return-1;var a=null==i?0:toInteger_1(i);return a<0&&(a=nativeMax$1(s+a,0)),_baseFindIndex(e,_baseIteratee(t),a)}var findIndex_1=findIndex,find=_createFind(findIndex_1),find_1=find;function flatten(e){return(null==e?0:e.length)?_baseFlatten(e,1):[]}var flatten_1=flatten;function forIn(e,t){return null==e?e:_baseFor(e,_castFunction(t),keysIn_1)}var forIn_1=forIn;function last(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}var last_1=last;function mapValues(e,t){var i={};return t=_baseIteratee(t),_baseForOwn(e,(function(e,s,a){_baseAssignValue(i,s,t(e,s,a))})),i}var mapValues_1=mapValues;function baseExtremum(e,t,i){for(var s=-1,a=e.length;++s<a;){var r=e[s],n=t(r);if(null!=n&&(void 0===o?n==n&&!isSymbol_1(n):i(n,o)))var o=n,l=r}return l}var _baseExtremum=baseExtremum;function baseGt(e,t){return e>t}var _baseGt=baseGt;function max(e){return e&&e.length?_baseExtremum(e,identity_1,_baseGt):void 0}var max_1=max;function assignMergeValue(e,t,i){(void 0!==i&&!eq_1(e[t],i)||void 0===i&&!(t in e))&&_baseAssignValue(e,t,i)}var _assignMergeValue=assignMergeValue,objectTag="[object Object]",funcProto=Function.prototype,objectProto=Object.prototype,funcToString=funcProto.toString,hasOwnProperty=objectProto.hasOwnProperty,objectCtorString=funcToString.call(Object);function isPlainObject(e){if(!isObjectLike_1(e)||_baseGetTag(e)!=objectTag)return!1;var t=_getPrototype(e);if(null===t)return!0;var i=hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&funcToString.call(i)==objectCtorString}var isPlainObject_1=isPlainObject;function safeGet(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var _safeGet=safeGet;function toPlainObject(e){return _copyObject(e,keysIn_1(e))}var toPlainObject_1=toPlainObject;
/**
	 * A specialized version of `baseMerge` for arrays and objects which performs
	 * deep merges and tracks traversed objects enabling objects with circular
	 * references to be merged.
	 *
	 * @private
	 * @param {Object} object The destination object.
	 * @param {Object} source The source object.
	 * @param {string} key The key of the value to merge.
	 * @param {number} srcIndex The index of `source`.
	 * @param {Function} mergeFunc The function to merge values.
	 * @param {Function} [customizer] The function to customize assigned values.
	 * @param {Object} [stack] Tracks traversed source values and their merged
	 *  counterparts.
	 */function baseMergeDeep(e,t,i,s,a,r,n){var o=_safeGet(e,i),l=_safeGet(t,i),h=n.get(l);if(h)_assignMergeValue(e,i,h);else{var c=r?r(o,l,i+"",e,t,n):void 0,d=void 0===c;if(d){var u=isArray_1(l),p=!u&&isBuffer_1(l),_=!u&&!p&&isTypedArray_1(l);c=l,u||p||_?isArray_1(o)?c=o:isArrayLikeObject_1(o)?c=_copyArray(o):p?(d=!1,c=_cloneBuffer(l,!0)):_?(d=!1,c=_cloneTypedArray(l,!0)):c=[]:isPlainObject_1(l)||isArguments_1(l)?(c=o,isArguments_1(o)?c=toPlainObject_1(o):isObject_1(o)&&!isFunction_1(o)||(c=_initCloneObject(l))):d=!1}d&&(n.set(l,c),a(c,l,s,r,n),n.delete(l)),_assignMergeValue(e,i,c)}}var _baseMergeDeep=baseMergeDeep;function baseMerge(e,t,i,s,a){e!==t&&_baseFor(t,(function(r,n){if(a||(a=new _Stack),isObject_1(r))_baseMergeDeep(e,t,n,i,baseMerge,s,a);else{var o=s?s(_safeGet(e,n),r,n+"",e,t,a):void 0;void 0===o&&(o=r),_assignMergeValue(e,n,o)}}),keysIn_1)}var _baseMerge=baseMerge;function createAssigner(e){return _baseRest((function(t,i){var s=-1,a=i.length,r=a>1?i[a-1]:void 0,n=a>2?i[2]:void 0;for(r=e.length>3&&"function"==typeof r?(a--,r):void 0,n&&_isIterateeCall(i[0],i[1],n)&&(r=a<3?void 0:r,a=1),t=Object(t);++s<a;){var o=i[s];o&&e(t,o,s,r)}return t}))}var _createAssigner=createAssigner,merge=_createAssigner((function(e,t,i){_baseMerge(e,t,i)})),merge_1=merge;function baseLt(e,t){return e<t}var _baseLt=baseLt;function min(e){return e&&e.length?_baseExtremum(e,identity_1,_baseLt):void 0}var min_1=min;function minBy(e,t){return e&&e.length?_baseExtremum(e,_baseIteratee(t),_baseLt):void 0}var minBy_1=minBy,now=function(){return _root.Date.now()},now_1=now;function baseSet(e,t,i,s){if(!isObject_1(e))return e;for(var a=-1,r=(t=_castPath(t,e)).length,n=r-1,o=e;null!=o&&++a<r;){var l=_toKey(t[a]),h=i;if("__proto__"===l||"constructor"===l||"prototype"===l)return e;if(a!=n){var c=o[l];void 0===(h=s?s(c,l,o):void 0)&&(h=isObject_1(c)?c:_isIndex(t[a+1])?[]:{})}_assignValue(o,l,h),o=o[l]}return e}var _baseSet=baseSet;function basePickBy(e,t,i){for(var s=-1,a=t.length,r={};++s<a;){var n=t[s],o=_baseGet(e,n);i(o,n)&&_baseSet(r,_castPath(n,e),o)}return r}var _basePickBy=basePickBy;function basePick(e,t){return _basePickBy(e,t,(function(t,i){return hasIn_1(e,i)}))}var _basePick=basePick;
/**
	 * A specialized version of `baseRest` which flattens the rest array.
	 *
	 * @private
	 * @param {Function} func The function to apply a rest parameter to.
	 * @returns {Function} Returns the new function.
	 */function flatRest(e){return _setToString(_overRest(e,void 0,flatten_1),e+"")}var _flatRest=flatRest,pick=_flatRest((function(e,t){return null==e?{}:_basePick(e,t)})),pick_1=pick,nativeCeil=Math.ceil,nativeMax=Math.max;function baseRange(e,t,i,s){for(var a=-1,r=nativeMax(nativeCeil((t-e)/(i||1)),0),n=Array(r);r--;)n[s?r:++a]=e,e+=i;return n}var _baseRange=baseRange;function createRange(e){return function(t,i,s){return s&&"number"!=typeof s&&_isIterateeCall(t,i,s)&&(i=s=void 0),t=toFinite_1(t),void 0===i?(i=t,t=0):i=toFinite_1(i),s=void 0===s?t<i?1:-1:toFinite_1(s),_baseRange(t,i,s,e)}}var _createRange=createRange,range=_createRange(),range_1=range;function baseSortBy(e,t){var i=e.length;for(e.sort(t);i--;)e[i]=e[i].value;return e}var _baseSortBy=baseSortBy;function compareAscending(e,t){if(e!==t){var i=void 0!==e,s=null===e,a=e==e,r=isSymbol_1(e),n=void 0!==t,o=null===t,l=t==t,h=isSymbol_1(t);if(!o&&!h&&!r&&e>t||r&&n&&l&&!o&&!h||s&&n&&l||!i&&l||!a)return 1;if(!s&&!r&&!h&&e<t||h&&i&&a&&!s&&!r||o&&i&&a||!n&&a||!l)return-1}return 0}var _compareAscending=compareAscending;function compareMultiple(e,t,i){for(var s=-1,a=e.criteria,r=t.criteria,n=a.length,o=i.length;++s<n;){var l=_compareAscending(a[s],r[s]);if(l)return s>=o?l:l*("desc"==i[s]?-1:1)}return e.index-t.index}var _compareMultiple=compareMultiple;function baseOrderBy(e,t,i){t=t.length?_arrayMap(t,(function(e){return isArray_1(e)?function(t){return _baseGet(t,1===e.length?e[0]:e)}:e})):[identity_1];var s=-1;t=_arrayMap(t,_baseUnary(_baseIteratee));var a=_baseMap(e,(function(e,i,a){return{criteria:_arrayMap(t,(function(t){return t(e)})),index:++s,value:e}}));return _baseSortBy(a,(function(e,t){return _compareMultiple(e,t,i)}))}var _baseOrderBy=baseOrderBy,sortBy=_baseRest((function(e,t){if(null==e)return[];var i=t.length;return i>1&&_isIterateeCall(e,t[0],t[1])?t=[]:i>2&&_isIterateeCall(t[0],t[1],t[2])&&(t=[t[0]]),_baseOrderBy(e,_baseFlatten(t,1),[])})),sortBy_1=sortBy,idCounter=0;function uniqueId(e){var t=++idCounter;return toString_1(e)+t}var uniqueId_1=uniqueId;function baseZipObject(e,t,i){for(var s=-1,a=e.length,r=t.length,n={};++s<a;){var o=s<r?t[s]:void 0;i(n,e[s],o)}return n}var _baseZipObject=baseZipObject;function zipObject(e,t){return _baseZipObject(e||[],t||[],_assignValue)}var zipObject_1=zipObject,lodash;if("function"==typeof commonjsRequire)try{lodash={cloneDeep:cloneDeep_1,constant:constant_1,defaults:defaults_1,each:each,filter:filter_1,find:find_1,flatten:flatten_1,forEach:forEach_1,forIn:forIn_1,has:has_1,isUndefined:isUndefined_1,last:last_1,map:map_1,mapValues:mapValues_1,max:max_1,merge:merge_1,min:min_1,minBy:minBy_1,now:now_1,pick:pick_1,range:range_1,reduce:reduce_1,sortBy:sortBy_1,uniqueId:uniqueId_1,values:values_1,zipObject:zipObject_1}}catch(e){}lodash||(lodash=window._);var lodash_1=lodash,list=List;function List(){var e={};e._next=e._prev=e,this._sentinel=e}function unlink(e){e._prev._next=e._next,e._next._prev=e._prev,delete e._next,delete e._prev}function filterOutLinks(e,t){if("_next"!==e&&"_prev"!==e)return t}List.prototype.dequeue=function(){var e=this._sentinel,t=e._prev;if(t!==e)return unlink(t),t},List.prototype.enqueue=function(e){var t=this._sentinel;e._prev&&e._next&&unlink(e),e._next=t._next,t._next._prev=e,t._next=e,e._prev=t},List.prototype.toString=function(){for(var e=[],t=this._sentinel,i=t._prev;i!==t;)e.push(JSON.stringify(i,filterOutLinks)),i=i._prev;return"["+e.join(", ")+"]"};var Graph$7=graphlib_1.Graph,greedyFas=greedyFAS,DEFAULT_WEIGHT_FN=lodash_1.constant(1);function greedyFAS(e,t){if(e.nodeCount()<=1)return[];var i=buildState(e,t||DEFAULT_WEIGHT_FN),s=doGreedyFAS(i.graph,i.buckets,i.zeroIdx);return lodash_1.flatten(lodash_1.map(s,(function(t){return e.outEdges(t.v,t.w)})),!0)}function doGreedyFAS(e,t,i){for(var s,a=[],r=t[t.length-1],n=t[0];e.nodeCount();){for(;s=n.dequeue();)removeNode(e,t,i,s);for(;s=r.dequeue();)removeNode(e,t,i,s);if(e.nodeCount())for(var o=t.length-2;o>0;--o)if(s=t[o].dequeue()){a=a.concat(removeNode(e,t,i,s,!0));break}}return a}function removeNode(e,t,i,s,a){var r=a?[]:void 0;return lodash_1.forEach(e.inEdges(s.v),(function(s){var n=e.edge(s),o=e.node(s.v);a&&r.push({v:s.v,w:s.w}),o.out-=n,assignBucket(t,i,o)})),lodash_1.forEach(e.outEdges(s.v),(function(s){var a=e.edge(s),r=s.w,n=e.node(r);n.in-=a,assignBucket(t,i,n)})),e.removeNode(s.v),r}function buildState(e,t){var i=new Graph$7,s=0,a=0;lodash_1.forEach(e.nodes(),(function(e){i.setNode(e,{v:e,in:0,out:0})})),lodash_1.forEach(e.edges(),(function(e){var r=i.edge(e.v,e.w)||0,n=t(e),o=r+n;i.setEdge(e.v,e.w,o),a=Math.max(a,i.node(e.v).out+=n),s=Math.max(s,i.node(e.w).in+=n)}));var r=lodash_1.range(a+s+3).map((function(){return new list})),n=s+1;return lodash_1.forEach(i.nodes(),(function(e){assignBucket(r,n,i.node(e))})),{graph:i,buckets:r,zeroIdx:n}}function assignBucket(e,t,i){i.out?i.in?e[i.out-i.in+t].enqueue(i):e[e.length-1].enqueue(i):e[0].enqueue(i)}var acyclic={run:run$2,undo:undo$2};function run$2(e){var t="greedy"===e.graph().acyclicer?greedyFas(e,function(e){return function(t){return e.edge(t).weight}}(e)):dfsFAS(e);lodash_1.forEach(t,(function(t){var i=e.edge(t);e.removeEdge(t),i.forwardName=t.name,i.reversed=!0,e.setEdge(t.w,t.v,i,lodash_1.uniqueId("rev"))}))}function dfsFAS(e){var t=[],i={},s={};return lodash_1.forEach(e.nodes(),(function a(r){lodash_1.has(s,r)||(s[r]=!0,i[r]=!0,lodash_1.forEach(e.outEdges(r),(function(e){lodash_1.has(i,e.w)?t.push(e):a(e.w)})),delete i[r])})),t}function undo$2(e){lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);if(i.reversed){e.removeEdge(t);var s=i.forwardName;delete i.reversed,delete i.forwardName,e.setEdge(t.w,t.v,i,s)}}))}var Graph$6=graphlib_1.Graph,util$2={addDummyNode:addDummyNode,simplify:simplify$1,asNonCompoundGraph:asNonCompoundGraph,successorWeights:successorWeights,predecessorWeights:predecessorWeights,intersectRect:intersectRect,buildLayerMatrix:buildLayerMatrix,normalizeRanks:normalizeRanks$1,removeEmptyRanks:removeEmptyRanks$1,addBorderNode:addBorderNode$1,maxRank:maxRank,partition:partition,time:time,notime:notime};function addDummyNode(e,t,i,s){var a;do{a=lodash_1.uniqueId(s)}while(e.hasNode(a));return i.dummy=t,e.setNode(a,i),a}function simplify$1(e){var t=(new Graph$6).setGraph(e.graph());return lodash_1.forEach(e.nodes(),(function(i){t.setNode(i,e.node(i))})),lodash_1.forEach(e.edges(),(function(i){var s=t.edge(i.v,i.w)||{weight:0,minlen:1},a=e.edge(i);t.setEdge(i.v,i.w,{weight:s.weight+a.weight,minlen:Math.max(s.minlen,a.minlen)})})),t}function asNonCompoundGraph(e){var t=new Graph$6({multigraph:e.isMultigraph()}).setGraph(e.graph());return lodash_1.forEach(e.nodes(),(function(i){e.children(i).length||t.setNode(i,e.node(i))})),lodash_1.forEach(e.edges(),(function(i){t.setEdge(i,e.edge(i))})),t}function successorWeights(e){var t=lodash_1.map(e.nodes(),(function(t){var i={};return lodash_1.forEach(e.outEdges(t),(function(t){i[t.w]=(i[t.w]||0)+e.edge(t).weight})),i}));return lodash_1.zipObject(e.nodes(),t)}function predecessorWeights(e){var t=lodash_1.map(e.nodes(),(function(t){var i={};return lodash_1.forEach(e.inEdges(t),(function(t){i[t.v]=(i[t.v]||0)+e.edge(t).weight})),i}));return lodash_1.zipObject(e.nodes(),t)}function intersectRect(e,t){var i,s,a=e.x,r=e.y,n=t.x-a,o=t.y-r,l=e.width/2,h=e.height/2;if(!n&&!o)throw new Error("Not possible to find intersection inside of the rectangle");return Math.abs(o)*l>Math.abs(n)*h?(o<0&&(h=-h),i=h*n/o,s=h):(n<0&&(l=-l),i=l,s=l*o/n),{x:a+i,y:r+s}}function buildLayerMatrix(e){var t=lodash_1.map(lodash_1.range(maxRank(e)+1),(function(){return[]}));return lodash_1.forEach(e.nodes(),(function(i){var s=e.node(i),a=s.rank;lodash_1.isUndefined(a)||(t[a][s.order]=i)})),t}function normalizeRanks$1(e){var t=lodash_1.min(lodash_1.map(e.nodes(),(function(t){return e.node(t).rank})));lodash_1.forEach(e.nodes(),(function(i){var s=e.node(i);lodash_1.has(s,"rank")&&(s.rank-=t)}))}function removeEmptyRanks$1(e){var t=lodash_1.min(lodash_1.map(e.nodes(),(function(t){return e.node(t).rank}))),i=[];lodash_1.forEach(e.nodes(),(function(s){var a=e.node(s).rank-t;i[a]||(i[a]=[]),i[a].push(s)}));var s=0,a=e.graph().nodeRankFactor;lodash_1.forEach(i,(function(t,i){lodash_1.isUndefined(t)&&i%a!=0?--s:s&&lodash_1.forEach(t,(function(t){e.node(t).rank+=s}))}))}function addBorderNode$1(e,t,i,s){var a={width:0,height:0};return arguments.length>=4&&(a.rank=i,a.order=s),addDummyNode(e,"border",a,t)}function maxRank(e){return lodash_1.max(lodash_1.map(e.nodes(),(function(t){var i=e.node(t).rank;if(!lodash_1.isUndefined(i))return i})))}function partition(e,t){var i={lhs:[],rhs:[]};return lodash_1.forEach(e,(function(e){t(e)?i.lhs.push(e):i.rhs.push(e)})),i}function time(e,t){var i=lodash_1.now();try{return t()}finally{console.log(e+" time: "+(lodash_1.now()-i)+"ms")}}function notime(e,t){return t()}var normalize={run:run$1,undo:undo$1};function run$1(e){e.graph().dummyChains=[],lodash_1.forEach(e.edges(),(function(t){normalizeEdge(e,t)}))}function normalizeEdge(e,t){var i=t.v,s=e.node(i).rank,a=t.w,r=e.node(a).rank,n=t.name,o=e.edge(t),l=o.labelRank;if(r!==s+1){var h,c,d;for(e.removeEdge(t),d=0,++s;s<r;++d,++s)o.points=[],c={width:0,height:0,edgeLabel:o,edgeObj:t,rank:s},h=util$2.addDummyNode(e,"edge",c,"_d"),s===l&&(c.width=o.width,c.height=o.height,c.dummy="edge-label",c.labelpos=o.labelpos),e.setEdge(i,h,{weight:o.weight},n),0===d&&e.graph().dummyChains.push(h),i=h;e.setEdge(i,a,{weight:o.weight},n)}}function undo$1(e){lodash_1.forEach(e.graph().dummyChains,(function(t){var i,s=e.node(t),a=s.edgeLabel;for(e.setEdge(s.edgeObj,a);s.dummy;)i=e.successors(t)[0],e.removeNode(t),a.points.push({x:s.x,y:s.y}),"edge-label"===s.dummy&&(a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height),t=i,s=e.node(t)}))}var util$1={longestPath:longestPath$1,slack:slack$2};function longestPath$1(e){var t={};lodash_1.forEach(e.sources(),(function i(s){var a=e.node(s);if(lodash_1.has(t,s))return a.rank;t[s]=!0;var r=lodash_1.min(lodash_1.map(e.outEdges(s),(function(t){return i(t.w)-e.edge(t).minlen})));return r!==Number.POSITIVE_INFINITY&&null!=r||(r=0),a.rank=r}))}function slack$2(e,t){return e.node(t.w).rank-e.node(t.v).rank-e.edge(t).minlen}var Graph$5=graphlib_1.Graph,slack$1=util$1.slack,feasibleTree_1=feasibleTree;function feasibleTree(e){var t,i,s=new Graph$5({directed:!1}),a=e.nodes()[0],r=e.nodeCount();for(s.setNode(a,{});tightTree(s,e)<r;)t=findMinSlackEdge(s,e),i=s.hasNode(t.v)?slack$1(e,t):-slack$1(e,t),shiftRanks(s,e,i);return s}function tightTree(e,t){return lodash_1.forEach(e.nodes(),(function i(s){lodash_1.forEach(t.nodeEdges(s),(function(a){var r=a.v,n=s===r?a.w:r;e.hasNode(n)||slack$1(t,a)||(e.setNode(n,{}),e.setEdge(s,n,{}),i(n))}))})),e.nodeCount()}function findMinSlackEdge(e,t){return lodash_1.minBy(t.edges(),(function(i){if(e.hasNode(i.v)!==e.hasNode(i.w))return slack$1(t,i)}))}function shiftRanks(e,t,i){lodash_1.forEach(e.nodes(),(function(e){t.node(e).rank+=i}))}var slack=util$1.slack,initRank=util$1.longestPath,preorder=graphlib_1.alg.preorder,postorder$1=graphlib_1.alg.postorder,simplify=util$2.simplify,networkSimplex_1=networkSimplex;function networkSimplex(e){e=simplify(e),initRank(e);var t,i=feasibleTree_1(e);for(initLowLimValues(i),initCutValues(i,e);t=leaveEdge(i);)exchangeEdges(i,e,t,enterEdge(i,e,t))}function initCutValues(e,t){var i=postorder$1(e,e.nodes());i=i.slice(0,i.length-1),lodash_1.forEach(i,(function(i){assignCutValue(e,t,i)}))}function assignCutValue(e,t,i){var s=e.node(i).parent;e.edge(i,s).cutvalue=calcCutValue(e,t,i)}function calcCutValue(e,t,i){var s=e.node(i).parent,a=!0,r=t.edge(i,s),n=0;return r||(a=!1,r=t.edge(s,i)),n=r.weight,lodash_1.forEach(t.nodeEdges(i),(function(r){var o=r.v===i,l=o?r.w:r.v;if(l!==s){var h=o===a,c=t.edge(r).weight;if(n+=h?c:-c,isTreeEdge(e,i,l)){var d=e.edge(i,l).cutvalue;n+=h?-d:d}}})),n}function initLowLimValues(e,t){arguments.length<2&&(t=e.nodes()[0]),dfsAssignLowLim(e,{},1,t)}function dfsAssignLowLim(e,t,i,s,a){var r=i,n=e.node(s);return t[s]=!0,lodash_1.forEach(e.neighbors(s),(function(a){lodash_1.has(t,a)||(i=dfsAssignLowLim(e,t,i,a,s))})),n.low=r,n.lim=i++,a?n.parent=a:delete n.parent,i}function leaveEdge(e){return lodash_1.find(e.edges(),(function(t){return e.edge(t).cutvalue<0}))}function enterEdge(e,t,i){var s=i.v,a=i.w;t.hasEdge(s,a)||(s=i.w,a=i.v);var r=e.node(s),n=e.node(a),o=r,l=!1;r.lim>n.lim&&(o=n,l=!0);var h=lodash_1.filter(t.edges(),(function(t){return l===isDescendant(e,e.node(t.v),o)&&l!==isDescendant(e,e.node(t.w),o)}));return lodash_1.minBy(h,(function(e){return slack(t,e)}))}function exchangeEdges(e,t,i,s){var a=i.v,r=i.w;e.removeEdge(a,r),e.setEdge(s.v,s.w,{}),initLowLimValues(e),initCutValues(e,t),updateRanks(e,t)}function updateRanks(e,t){var i=lodash_1.find(e.nodes(),(function(e){return!t.node(e).parent})),s=preorder(e,i);s=s.slice(1),lodash_1.forEach(s,(function(i){var s=e.node(i).parent,a=t.edge(i,s),r=!1;a||(a=t.edge(s,i),r=!0),t.node(i).rank=t.node(s).rank+(r?a.minlen:-a.minlen)}))}function isTreeEdge(e,t,i){return e.hasEdge(t,i)}function isDescendant(e,t,i){return i.low<=t.lim&&t.lim<=i.lim}networkSimplex.initLowLimValues=initLowLimValues,networkSimplex.initCutValues=initCutValues,networkSimplex.calcCutValue=calcCutValue,networkSimplex.leaveEdge=leaveEdge,networkSimplex.enterEdge=enterEdge,networkSimplex.exchangeEdges=exchangeEdges;var longestPath=util$1.longestPath,rank_1=rank;function rank(e){switch(e.graph().ranker){case"network-simplex":networkSimplexRanker(e);break;case"tight-tree":tightTreeRanker(e);break;case"longest-path":longestPathRanker(e);break;default:networkSimplexRanker(e)}}var longestPathRanker=longestPath;function tightTreeRanker(e){longestPath(e),feasibleTree_1(e)}function networkSimplexRanker(e){networkSimplex_1(e)}var parentDummyChains_1=parentDummyChains;function parentDummyChains(e){var t=postorder(e);lodash_1.forEach(e.graph().dummyChains,(function(i){for(var s=e.node(i),a=s.edgeObj,r=findPath(e,t,a.v,a.w),n=r.path,o=r.lca,l=0,h=n[l],c=!0;i!==a.w;){if(s=e.node(i),c){for(;(h=n[l])!==o&&e.node(h).maxRank<s.rank;)l++;h===o&&(c=!1)}if(!c){for(;l<n.length-1&&e.node(h=n[l+1]).minRank<=s.rank;)l++;h=n[l]}e.setParent(i,h),i=e.successors(i)[0]}}))}function findPath(e,t,i,s){var a,r,n=[],o=[],l=Math.min(t[i].low,t[s].low),h=Math.max(t[i].lim,t[s].lim);a=i;do{a=e.parent(a),n.push(a)}while(a&&(t[a].low>l||h>t[a].lim));for(r=a,a=s;(a=e.parent(a))!==r;)o.push(a);return{path:n.concat(o.reverse()),lca:r}}function postorder(e){var t={},i=0;return lodash_1.forEach(e.children(),(function s(a){var r=i;lodash_1.forEach(e.children(a),s),t[a]={low:r,lim:i++}})),t}var nestingGraph={run:run,cleanup:cleanup};function run(e){var t=util$2.addDummyNode(e,"root",{},"_root"),i=treeDepths(e),s=lodash_1.max(lodash_1.values(i))-1,a=2*s+1;e.graph().nestingRoot=t,lodash_1.forEach(e.edges(),(function(t){e.edge(t).minlen*=a}));var r=sumWeights(e)+1;lodash_1.forEach(e.children(),(function(n){dfs(e,t,a,r,s,i,n)})),e.graph().nodeRankFactor=a}function dfs(e,t,i,s,a,r,n){var o=e.children(n);if(o.length){var l=util$2.addBorderNode(e,"_bt"),h=util$2.addBorderNode(e,"_bb"),c=e.node(n);e.setParent(l,n),c.borderTop=l,e.setParent(h,n),c.borderBottom=h,lodash_1.forEach(o,(function(o){dfs(e,t,i,s,a,r,o);var c=e.node(o),d=c.borderTop?c.borderTop:o,u=c.borderBottom?c.borderBottom:o,p=c.borderTop?s:2*s,_=d!==u?1:a-r[n]+1;e.setEdge(l,d,{weight:p,minlen:_,nestingEdge:!0}),e.setEdge(u,h,{weight:p,minlen:_,nestingEdge:!0})})),e.parent(n)||e.setEdge(t,l,{weight:0,minlen:a+r[n]})}else n!==t&&e.setEdge(t,n,{weight:0,minlen:i})}function treeDepths(e){var t={};function i(s,a){var r=e.children(s);r&&r.length&&lodash_1.forEach(r,(function(e){i(e,a+1)})),t[s]=a}return lodash_1.forEach(e.children(),(function(e){i(e,1)})),t}function sumWeights(e){return lodash_1.reduce(e.edges(),(function(t,i){return t+e.edge(i).weight}),0)}function cleanup(e){var t=e.graph();e.removeNode(t.nestingRoot),delete t.nestingRoot,lodash_1.forEach(e.edges(),(function(t){e.edge(t).nestingEdge&&e.removeEdge(t)}))}var addBorderSegments_1=addBorderSegments;function addBorderSegments(e){lodash_1.forEach(e.children(),(function t(i){var s=e.children(i),a=e.node(i);if(s.length&&lodash_1.forEach(s,t),lodash_1.has(a,"minRank")){a.borderLeft=[],a.borderRight=[];for(var r=a.minRank,n=a.maxRank+1;r<n;++r)addBorderNode(e,"borderLeft","_bl",i,a,r),addBorderNode(e,"borderRight","_br",i,a,r)}}))}function addBorderNode(e,t,i,s,a,r){var n={width:0,height:0,rank:r,borderType:t},o=a[t][r-1],l=util$2.addDummyNode(e,"border",n,i);a[t][r]=l,e.setParent(l,s),o&&e.setEdge(o,l,{weight:1})}var coordinateSystem={adjust:adjust,undo:undo};function adjust(e){var t=e.graph().rankdir.toLowerCase();"lr"!==t&&"rl"!==t||swapWidthHeight(e)}function undo(e){var t=e.graph().rankdir.toLowerCase();"bt"!==t&&"rl"!==t||reverseY(e),"lr"!==t&&"rl"!==t||(swapXY(e),swapWidthHeight(e))}function swapWidthHeight(e){lodash_1.forEach(e.nodes(),(function(t){swapWidthHeightOne(e.node(t))})),lodash_1.forEach(e.edges(),(function(t){swapWidthHeightOne(e.edge(t))}))}function swapWidthHeightOne(e){var t=e.width;e.width=e.height,e.height=t}function reverseY(e){lodash_1.forEach(e.nodes(),(function(t){reverseYOne(e.node(t))})),lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);lodash_1.forEach(i.points,reverseYOne),lodash_1.has(i,"y")&&reverseYOne(i)}))}function reverseYOne(e){e.y=-e.y}function swapXY(e){lodash_1.forEach(e.nodes(),(function(t){swapXYOne(e.node(t))})),lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);lodash_1.forEach(i.points,swapXYOne),lodash_1.has(i,"x")&&swapXYOne(i)}))}function swapXYOne(e){var t=e.x;e.x=e.y,e.y=t}var initOrder_1=initOrder;function initOrder(e){var t={},i=lodash_1.filter(e.nodes(),(function(t){return!e.children(t).length})),s=lodash_1.max(lodash_1.map(i,(function(t){return e.node(t).rank}))),a=lodash_1.map(lodash_1.range(s+1),(function(){return[]}));var r=lodash_1.sortBy(i,(function(t){return e.node(t).rank}));return lodash_1.forEach(r,(function i(s){if(!lodash_1.has(t,s)){t[s]=!0;var r=e.node(s);a[r.rank].push(s),lodash_1.forEach(e.successors(s),i)}})),a}var crossCount_1=crossCount;function crossCount(e,t){for(var i=0,s=1;s<t.length;++s)i+=twoLayerCrossCount(e,t[s-1],t[s]);return i}function twoLayerCrossCount(e,t,i){for(var s=lodash_1.zipObject(i,lodash_1.map(i,(function(e,t){return t}))),a=lodash_1.flatten(lodash_1.map(t,(function(t){return lodash_1.sortBy(lodash_1.map(e.outEdges(t),(function(t){return{pos:s[t.w],weight:e.edge(t).weight}})),"pos")})),!0),r=1;r<i.length;)r<<=1;var n=2*r-1;r-=1;var o=lodash_1.map(new Array(n),(function(){return 0})),l=0;return lodash_1.forEach(a.forEach((function(e){var t=e.pos+r;o[t]+=e.weight;for(var i=0;t>0;)t%2&&(i+=o[t+1]),o[t=t-1>>1]+=e.weight;l+=e.weight*i}))),l}var barycenter_1=barycenter;function barycenter(e,t){return lodash_1.map(t,(function(t){var i=e.inEdges(t);if(i.length){var s=lodash_1.reduce(i,(function(t,i){var s=e.edge(i),a=e.node(i.v);return{sum:t.sum+s.weight*a.order,weight:t.weight+s.weight}}),{sum:0,weight:0});return{v:t,barycenter:s.sum/s.weight,weight:s.weight}}return{v:t}}))}var resolveConflicts_1=resolveConflicts;function resolveConflicts(e,t){var i={};return lodash_1.forEach(e,(function(e,t){var s=i[e.v]={indegree:0,in:[],out:[],vs:[e.v],i:t};lodash_1.isUndefined(e.barycenter)||(s.barycenter=e.barycenter,s.weight=e.weight)})),lodash_1.forEach(t.edges(),(function(e){var t=i[e.v],s=i[e.w];lodash_1.isUndefined(t)||lodash_1.isUndefined(s)||(s.indegree++,t.out.push(i[e.w]))})),doResolveConflicts(lodash_1.filter(i,(function(e){return!e.indegree})))}function doResolveConflicts(e){var t=[];function i(e){return function(t){t.merged||(lodash_1.isUndefined(t.barycenter)||lodash_1.isUndefined(e.barycenter)||t.barycenter>=e.barycenter)&&mergeEntries(e,t)}}function s(t){return function(i){i.in.push(t),0==--i.indegree&&e.push(i)}}for(;e.length;){var a=e.pop();t.push(a),lodash_1.forEach(a.in.reverse(),i(a)),lodash_1.forEach(a.out,s(a))}return lodash_1.map(lodash_1.filter(t,(function(e){return!e.merged})),(function(e){return lodash_1.pick(e,["vs","i","barycenter","weight"])}))}function mergeEntries(e,t){var i=0,s=0;e.weight&&(i+=e.barycenter*e.weight,s+=e.weight),t.weight&&(i+=t.barycenter*t.weight,s+=t.weight),e.vs=t.vs.concat(e.vs),e.barycenter=i/s,e.weight=s,e.i=Math.min(t.i,e.i),t.merged=!0}var sort_1=sort;function sort(e,t){var i=util$2.partition(e,(function(e){return lodash_1.has(e,"barycenter")})),s=i.lhs,a=lodash_1.sortBy(i.rhs,(function(e){return-e.i})),r=[],n=0,o=0,l=0;s.sort(compareWithBias(!!t)),l=consumeUnsortable(r,a,l),lodash_1.forEach(s,(function(e){l+=e.vs.length,r.push(e.vs),n+=e.barycenter*e.weight,o+=e.weight,l=consumeUnsortable(r,a,l)}));var h={vs:lodash_1.flatten(r,!0)};return o&&(h.barycenter=n/o,h.weight=o),h}function consumeUnsortable(e,t,i){for(var s;t.length&&(s=lodash_1.last(t)).i<=i;)t.pop(),e.push(s.vs),i++;return i}function compareWithBias(e){return function(t,i){return t.barycenter<i.barycenter?-1:t.barycenter>i.barycenter?1:e?i.i-t.i:t.i-i.i}}var sortSubgraph_1=sortSubgraph;function sortSubgraph(e,t,i,s){var a=e.children(t),r=e.node(t),n=r?r.borderLeft:void 0,o=r?r.borderRight:void 0,l={};n&&(a=lodash_1.filter(a,(function(e){return e!==n&&e!==o})));var h=barycenter_1(e,a);lodash_1.forEach(h,(function(t){if(e.children(t.v).length){var a=sortSubgraph(e,t.v,i,s);l[t.v]=a,lodash_1.has(a,"barycenter")&&mergeBarycenters(t,a)}}));var c=resolveConflicts_1(h,i);expandSubgraphs(c,l);var d=sort_1(c,s);if(n&&(d.vs=lodash_1.flatten([n,d.vs,o],!0),e.predecessors(n).length)){var u=e.node(e.predecessors(n)[0]),p=e.node(e.predecessors(o)[0]);lodash_1.has(d,"barycenter")||(d.barycenter=0,d.weight=0),d.barycenter=(d.barycenter*d.weight+u.order+p.order)/(d.weight+2),d.weight+=2}return d}function expandSubgraphs(e,t){lodash_1.forEach(e,(function(e){e.vs=lodash_1.flatten(e.vs.map((function(e){return t[e]?t[e].vs:e})),!0)}))}function mergeBarycenters(e,t){lodash_1.isUndefined(e.barycenter)?(e.barycenter=t.barycenter,e.weight=t.weight):(e.barycenter=(e.barycenter*e.weight+t.barycenter*t.weight)/(e.weight+t.weight),e.weight+=t.weight)}var Graph$4=graphlib_1.Graph,buildLayerGraph_1=buildLayerGraph;function buildLayerGraph(e,t,i){var s=createRootNode(e),a=new Graph$4({compound:!0}).setGraph({root:s}).setDefaultNodeLabel((function(t){return e.node(t)}));return lodash_1.forEach(e.nodes(),(function(r){var n=e.node(r),o=e.parent(r);(n.rank===t||n.minRank<=t&&t<=n.maxRank)&&(a.setNode(r),a.setParent(r,o||s),lodash_1.forEach(e[i](r),(function(t){var i=t.v===r?t.w:t.v,s=a.edge(i,r),n=lodash_1.isUndefined(s)?0:s.weight;a.setEdge(i,r,{weight:e.edge(t).weight+n})})),lodash_1.has(n,"minRank")&&a.setNode(r,{borderLeft:n.borderLeft[t],borderRight:n.borderRight[t]}))})),a}function createRootNode(e){for(var t;e.hasNode(t=lodash_1.uniqueId("_root")););return t}var addSubgraphConstraints_1=addSubgraphConstraints;function addSubgraphConstraints(e,t,i){var s,a={};lodash_1.forEach(i,(function(i){for(var r,n,o=e.parent(i);o;){if((r=e.parent(o))?(n=a[r],a[r]=o):(n=s,s=o),n&&n!==o)return void t.setEdge(n,o);o=r}}))}var Graph$3=graphlib_1.Graph,order_1=order;function order(e){var t=util$2.maxRank(e),i=buildLayerGraphs(e,lodash_1.range(1,t+1),"inEdges"),s=buildLayerGraphs(e,lodash_1.range(t-1,-1,-1),"outEdges"),a=initOrder_1(e);assignOrder(e,a);for(var r,n=Number.POSITIVE_INFINITY,o=0,l=0;l<4;++o,++l){sweepLayerGraphs(o%2?i:s,o%4>=2),a=util$2.buildLayerMatrix(e);var h=crossCount_1(e,a);h<n&&(l=0,r=lodash_1.cloneDeep(a),n=h)}assignOrder(e,r)}function buildLayerGraphs(e,t,i){return lodash_1.map(t,(function(t){return buildLayerGraph_1(e,t,i)}))}function sweepLayerGraphs(e,t){var i=new Graph$3;lodash_1.forEach(e,(function(e){var s=e.graph().root,a=sortSubgraph_1(e,s,i,t);lodash_1.forEach(a.vs,(function(t,i){e.node(t).order=i})),addSubgraphConstraints_1(e,i,a.vs)}))}function assignOrder(e,t){lodash_1.forEach(t,(function(t){lodash_1.forEach(t,(function(t,i){e.node(t).order=i}))}))}var Graph$2=graphlib_1.Graph,bk={positionX:positionX$1,findType1Conflicts:findType1Conflicts,findType2Conflicts:findType2Conflicts,addConflict:addConflict,hasConflict:hasConflict,verticalAlignment:verticalAlignment,horizontalCompaction:horizontalCompaction,alignCoordinates:alignCoordinates,findSmallestWidthAlignment:findSmallestWidthAlignment,balance:balance};function findType1Conflicts(e,t){var i={};return lodash_1.reduce(t,(function(t,s){var a=0,r=0,n=t.length,o=lodash_1.last(s);return lodash_1.forEach(s,(function(t,l){var h=findOtherInnerSegmentNode(e,t),c=h?e.node(h).order:n;(h||t===o)&&(lodash_1.forEach(s.slice(r,l+1),(function(t){lodash_1.forEach(e.predecessors(t),(function(s){var r=e.node(s),n=r.order;!(n<a||c<n)||r.dummy&&e.node(t).dummy||addConflict(i,s,t)}))})),r=l+1,a=c)})),s})),i}function findType2Conflicts(e,t){var i={};function s(t,s,a,r,n){var o;lodash_1.forEach(lodash_1.range(s,a),(function(s){o=t[s],e.node(o).dummy&&lodash_1.forEach(e.predecessors(o),(function(t){var s=e.node(t);s.dummy&&(s.order<r||s.order>n)&&addConflict(i,t,o)}))}))}return lodash_1.reduce(t,(function(t,i){var a,r=-1,n=0;return lodash_1.forEach(i,(function(o,l){if("border"===e.node(o).dummy){var h=e.predecessors(o);h.length&&(a=e.node(h[0]).order,s(i,n,l,r,a),n=l,r=a)}s(i,n,i.length,a,t.length)})),i})),i}function findOtherInnerSegmentNode(e,t){if(e.node(t).dummy)return lodash_1.find(e.predecessors(t),(function(t){return e.node(t).dummy}))}function addConflict(e,t,i){if(t>i){var s=t;t=i,i=s}var a=e[t];a||(e[t]=a={}),a[i]=!0}function hasConflict(e,t,i){if(t>i){var s=t;t=i,i=s}return lodash_1.has(e[t],i)}function verticalAlignment(e,t,i,s){var a={},r={},n={};return lodash_1.forEach(t,(function(e){lodash_1.forEach(e,(function(e,t){a[e]=e,r[e]=e,n[e]=t}))})),lodash_1.forEach(t,(function(e){var t=-1;lodash_1.forEach(e,(function(e){var o=s(e);if(o.length)for(var l=((o=lodash_1.sortBy(o,(function(e){return n[e]}))).length-1)/2,h=Math.floor(l),c=Math.ceil(l);h<=c;++h){var d=o[h];r[e]===e&&t<n[d]&&!hasConflict(i,e,d)&&(r[d]=e,r[e]=a[e]=a[d],t=n[d])}}))})),{root:a,align:r}}function horizontalCompaction(e,t,i,s,a){var r={},n=buildBlockGraph(e,t,i,a),o=a?"borderLeft":"borderRight";function l(e,t){for(var i=n.nodes(),s=i.pop(),a={};s;)a[s]?e(s):(a[s]=!0,i.push(s),i=i.concat(t(s))),s=i.pop()}return l((function(e){r[e]=n.inEdges(e).reduce((function(e,t){return Math.max(e,r[t.v]+n.edge(t))}),0)}),n.predecessors.bind(n)),l((function(t){var i=n.outEdges(t).reduce((function(e,t){return Math.min(e,r[t.w]-n.edge(t))}),Number.POSITIVE_INFINITY),s=e.node(t);i!==Number.POSITIVE_INFINITY&&s.borderType!==o&&(r[t]=Math.max(r[t],i))}),n.successors.bind(n)),lodash_1.forEach(s,(function(e){r[e]=r[i[e]]})),r}function buildBlockGraph(e,t,i,s){var a=new Graph$2,r=e.graph(),n=sep(r.nodesep,r.edgesep,s);return lodash_1.forEach(t,(function(t){var s;lodash_1.forEach(t,(function(t){var r=i[t];if(a.setNode(r),s){var o=i[s],l=a.edge(o,r);a.setEdge(o,r,Math.max(n(e,t,s),l||0))}s=t}))})),a}function findSmallestWidthAlignment(e,t){return lodash_1.minBy(lodash_1.values(t),(function(t){var i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;return lodash_1.forIn(t,(function(t,a){var r=width(e,a)/2;i=Math.max(t+r,i),s=Math.min(t-r,s)})),i-s}))}function alignCoordinates(e,t){var i=lodash_1.values(t),s=lodash_1.min(i),a=lodash_1.max(i);lodash_1.forEach(["u","d"],(function(i){lodash_1.forEach(["l","r"],(function(r){var n,o=i+r,l=e[o];if(l!==t){var h=lodash_1.values(l);(n="l"===r?s-lodash_1.min(h):a-lodash_1.max(h))&&(e[o]=lodash_1.mapValues(l,(function(e){return e+n})))}}))}))}function balance(e,t){return lodash_1.mapValues(e.ul,(function(i,s){if(t)return e[t.toLowerCase()][s];var a=lodash_1.sortBy(lodash_1.map(e,s));return(a[1]+a[2])/2}))}function positionX$1(e){var t,i=util$2.buildLayerMatrix(e),s=lodash_1.merge(findType1Conflicts(e,i),findType2Conflicts(e,i)),a={};lodash_1.forEach(["u","d"],(function(r){t="u"===r?i:lodash_1.values(i).reverse(),lodash_1.forEach(["l","r"],(function(i){"r"===i&&(t=lodash_1.map(t,(function(e){return lodash_1.values(e).reverse()})));var n=("u"===r?e.predecessors:e.successors).bind(e),o=verticalAlignment(e,t,s,n),l=horizontalCompaction(e,t,o.root,o.align,"r"===i);"r"===i&&(l=lodash_1.mapValues(l,(function(e){return-e}))),a[r+i]=l}))}));var r=findSmallestWidthAlignment(e,a);return alignCoordinates(a,r),balance(a,e.graph().align)}function sep(e,t,i){return function(s,a,r){var n,o=s.node(a),l=s.node(r),h=0;if(h+=o.width/2,lodash_1.has(o,"labelpos"))switch(o.labelpos.toLowerCase()){case"l":n=-o.width/2;break;case"r":n=o.width/2}if(n&&(h+=i?n:-n),n=0,h+=(o.dummy?t:e)/2,h+=(l.dummy?t:e)/2,h+=l.width/2,lodash_1.has(l,"labelpos"))switch(l.labelpos.toLowerCase()){case"l":n=l.width/2;break;case"r":n=-l.width/2}return n&&(h+=i?n:-n),n=0,h}}function width(e,t){return e.node(t).width}var positionX=bk.positionX,position_1=position;function position(e){positionY(e=util$2.asNonCompoundGraph(e)),lodash_1.forEach(positionX(e),(function(t,i){e.node(i).x=t}))}function positionY(e){var t=util$2.buildLayerMatrix(e),i=e.graph().ranksep,s=0;lodash_1.forEach(t,(function(t){var a=lodash_1.max(lodash_1.map(t,(function(t){return e.node(t).height})));lodash_1.forEach(t,(function(t){e.node(t).y=s+a/2})),s+=a+i}))}var normalizeRanks=util$2.normalizeRanks,removeEmptyRanks=util$2.removeEmptyRanks,util=util$2,Graph$1=graphlib_1.Graph,layout_1=layout$1;function layout$1(e,t){var i=t&&t.debugTiming?util.time:util.notime;i("layout",(function(){var t=i("  buildLayoutGraph",(function(){return buildLayoutGraph(e)}));i("  runLayout",(function(){runLayout(t,i)})),i("  updateInputGraph",(function(){updateInputGraph(e,t)}))}))}function runLayout(e,t){t("    makeSpaceForEdgeLabels",(function(){makeSpaceForEdgeLabels(e)})),t("    removeSelfEdges",(function(){removeSelfEdges(e)})),t("    acyclic",(function(){acyclic.run(e)})),t("    nestingGraph.run",(function(){nestingGraph.run(e)})),t("    rank",(function(){rank_1(util.asNonCompoundGraph(e))})),t("    injectEdgeLabelProxies",(function(){injectEdgeLabelProxies(e)})),t("    removeEmptyRanks",(function(){removeEmptyRanks(e)})),t("    nestingGraph.cleanup",(function(){nestingGraph.cleanup(e)})),t("    normalizeRanks",(function(){normalizeRanks(e)})),t("    assignRankMinMax",(function(){assignRankMinMax(e)})),t("    removeEdgeLabelProxies",(function(){removeEdgeLabelProxies(e)})),t("    normalize.run",(function(){normalize.run(e)})),t("    parentDummyChains",(function(){parentDummyChains_1(e)})),t("    addBorderSegments",(function(){addBorderSegments_1(e)})),t("    order",(function(){order_1(e)})),t("    insertSelfEdges",(function(){insertSelfEdges(e)})),t("    adjustCoordinateSystem",(function(){coordinateSystem.adjust(e)})),t("    position",(function(){position_1(e)})),t("    positionSelfEdges",(function(){positionSelfEdges(e)})),t("    removeBorderNodes",(function(){removeBorderNodes(e)})),t("    normalize.undo",(function(){normalize.undo(e)})),t("    fixupEdgeLabelCoords",(function(){fixupEdgeLabelCoords(e)})),t("    undoCoordinateSystem",(function(){coordinateSystem.undo(e)})),t("    translateGraph",(function(){translateGraph(e)})),t("    assignNodeIntersects",(function(){assignNodeIntersects(e)})),t("    reversePoints",(function(){reversePointsForReversedEdges(e)})),t("    acyclic.undo",(function(){acyclic.undo(e)}))}function updateInputGraph(e,t){lodash_1.forEach(e.nodes(),(function(i){var s=e.node(i),a=t.node(i);s&&(s.x=a.x,s.y=a.y,t.children(i).length&&(s.width=a.width,s.height=a.height))})),lodash_1.forEach(e.edges(),(function(i){var s=e.edge(i),a=t.edge(i);s.points=a.points,lodash_1.has(a,"x")&&(s.x=a.x,s.y=a.y)})),e.graph().width=t.graph().width,e.graph().height=t.graph().height}var graphNumAttrs=["nodesep","edgesep","ranksep","marginx","marginy"],graphDefaults={ranksep:50,edgesep:20,nodesep:50,rankdir:"tb"},graphAttrs=["acyclicer","ranker","rankdir","align"],nodeNumAttrs=["width","height"],nodeDefaults={width:0,height:0},edgeNumAttrs=["minlen","weight","width","height","labeloffset"],edgeDefaults={minlen:1,weight:1,width:0,height:0,labeloffset:10,labelpos:"r"},edgeAttrs=["labelpos"];function buildLayoutGraph(e){var t=new Graph$1({multigraph:!0,compound:!0}),i=canonicalize(e.graph());return t.setGraph(lodash_1.merge({},graphDefaults,selectNumberAttrs(i,graphNumAttrs),lodash_1.pick(i,graphAttrs))),lodash_1.forEach(e.nodes(),(function(i){var s=canonicalize(e.node(i));t.setNode(i,lodash_1.defaults(selectNumberAttrs(s,nodeNumAttrs),nodeDefaults)),t.setParent(i,e.parent(i))})),lodash_1.forEach(e.edges(),(function(i){var s=canonicalize(e.edge(i));t.setEdge(i,lodash_1.merge({},edgeDefaults,selectNumberAttrs(s,edgeNumAttrs),lodash_1.pick(s,edgeAttrs)))})),t}function makeSpaceForEdgeLabels(e){var t=e.graph();t.ranksep/=2,lodash_1.forEach(e.edges(),(function(i){var s=e.edge(i);s.minlen*=2,"c"!==s.labelpos.toLowerCase()&&("TB"===t.rankdir||"BT"===t.rankdir?s.width+=s.labeloffset:s.height+=s.labeloffset)}))}function injectEdgeLabelProxies(e){lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);if(i.width&&i.height){var s=e.node(t.v),a={rank:(e.node(t.w).rank-s.rank)/2+s.rank,e:t};util.addDummyNode(e,"edge-proxy",a,"_ep")}}))}function assignRankMinMax(e){var t=0;lodash_1.forEach(e.nodes(),(function(i){var s=e.node(i);s.borderTop&&(s.minRank=e.node(s.borderTop).rank,s.maxRank=e.node(s.borderBottom).rank,t=lodash_1.max(t,s.maxRank))})),e.graph().maxRank=t}function removeEdgeLabelProxies(e){lodash_1.forEach(e.nodes(),(function(t){var i=e.node(t);"edge-proxy"===i.dummy&&(e.edge(i.e).labelRank=i.rank,e.removeNode(t))}))}function translateGraph(e){var t=Number.POSITIVE_INFINITY,i=0,s=Number.POSITIVE_INFINITY,a=0,r=e.graph(),n=r.marginx||0,o=r.marginy||0;function l(e){var r=e.x,n=e.y,o=e.width,l=e.height;t=Math.min(t,r-o/2),i=Math.max(i,r+o/2),s=Math.min(s,n-l/2),a=Math.max(a,n+l/2)}lodash_1.forEach(e.nodes(),(function(t){l(e.node(t))})),lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);lodash_1.has(i,"x")&&l(i)})),t-=n,s-=o,lodash_1.forEach(e.nodes(),(function(i){var a=e.node(i);a.x-=t,a.y-=s})),lodash_1.forEach(e.edges(),(function(i){var a=e.edge(i);lodash_1.forEach(a.points,(function(e){e.x-=t,e.y-=s})),lodash_1.has(a,"x")&&(a.x-=t),lodash_1.has(a,"y")&&(a.y-=s)})),r.width=i-t+n,r.height=a-s+o}function assignNodeIntersects(e){lodash_1.forEach(e.edges(),(function(t){var i,s,a=e.edge(t),r=e.node(t.v),n=e.node(t.w);a.points?(i=a.points[0],s=a.points[a.points.length-1]):(a.points=[],i=n,s=r),a.points.unshift(util.intersectRect(r,i)),a.points.push(util.intersectRect(n,s))}))}function fixupEdgeLabelCoords(e){lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);if(lodash_1.has(i,"x"))switch("l"!==i.labelpos&&"r"!==i.labelpos||(i.width-=i.labeloffset),i.labelpos){case"l":i.x-=i.width/2+i.labeloffset;break;case"r":i.x+=i.width/2+i.labeloffset}}))}function reversePointsForReversedEdges(e){lodash_1.forEach(e.edges(),(function(t){var i=e.edge(t);i.reversed&&i.points.reverse()}))}function removeBorderNodes(e){lodash_1.forEach(e.nodes(),(function(t){if(e.children(t).length){var i=e.node(t),s=e.node(i.borderTop),a=e.node(i.borderBottom),r=e.node(lodash_1.last(i.borderLeft)),n=e.node(lodash_1.last(i.borderRight));i.width=Math.abs(n.x-r.x),i.height=Math.abs(a.y-s.y),i.x=r.x+i.width/2,i.y=s.y+i.height/2}})),lodash_1.forEach(e.nodes(),(function(t){"border"===e.node(t).dummy&&e.removeNode(t)}))}function removeSelfEdges(e){lodash_1.forEach(e.edges(),(function(t){if(t.v===t.w){var i=e.node(t.v);i.selfEdges||(i.selfEdges=[]),i.selfEdges.push({e:t,label:e.edge(t)}),e.removeEdge(t)}}))}function insertSelfEdges(e){var t=util.buildLayerMatrix(e);lodash_1.forEach(t,(function(t){var i=0;lodash_1.forEach(t,(function(t,s){var a=e.node(t);a.order=s+i,lodash_1.forEach(a.selfEdges,(function(t){util.addDummyNode(e,"selfedge",{width:t.label.width,height:t.label.height,rank:a.rank,order:s+ ++i,e:t.e,label:t.label},"_se")})),delete a.selfEdges}))}))}function positionSelfEdges(e){lodash_1.forEach(e.nodes(),(function(t){var i=e.node(t);if("selfedge"===i.dummy){var s=e.node(i.e.v),a=s.x+s.width/2,r=s.y,n=i.x-a,o=s.height/2;e.setEdge(i.e,i.label),e.removeNode(t),i.label.points=[{x:a+2*n/3,y:r-o},{x:a+5*n/6,y:r-o},{x:a+n,y:r},{x:a+5*n/6,y:r+o},{x:a+2*n/3,y:r+o}],i.label.x=i.x,i.label.y=i.y}}))}function selectNumberAttrs(e,t){return lodash_1.mapValues(lodash_1.pick(e,t),Number)}function canonicalize(e){var t={};return lodash_1.forEach(e,(function(e,i){t[i.toLowerCase()]=e})),t}var Graph=graphlib_1.Graph,debug={debugOrdering:debugOrdering};function debugOrdering(e){var t=util$2.buildLayerMatrix(e),i=new Graph({compound:!0,multigraph:!0}).setGraph({});return lodash_1.forEach(e.nodes(),(function(t){i.setNode(t,{label:t}),i.setParent(t,"layer"+e.node(t).rank)})),lodash_1.forEach(e.edges(),(function(e){i.setEdge(e.v,e.w,{},e.name)})),lodash_1.forEach(t,(function(e,t){var s="layer"+t;i.setNode(s,{rank:"same"}),lodash_1.reduce(e,(function(e,t){return i.setEdge(e,t,{style:"invis"}),t}))})),i}var version="0.8.5",dagre={graphlib:graphlib_1,layout:layout_1,debug:debug,util:{time:util$2.time,notime:util$2.notime},version:version},dagre_1=dagre.graphlib,dagre_2=dagre.layout;class SugiyamaLayout extends Layout{constructor(e){super(e),this.type=LayoutType.Sugiyama,this._width="width"in e?e.width:500,this._height="height"in e?e.height:300,this._top="top"in e?e.top:0,this._left="left"in e?e.left:0}toJSON(){let e={args:{}};return e.type=this.type,e}run(){let e=this.group.children[0].dataScope._dt.graph;if(!e)return;var t=new dagre_1.Graph;t.setGraph({edgesep:50}),t.setDefaultEdgeLabel((function(){return{}}));let i=new Map;for(let e of this.group.children){let s=e.dataScope.getFieldValue(nodeId);i.set(s,s+""),t.setNode(s,{label:e.text?e.text:"",width:e.bounds.width,height:e.bounds.height})}for(let i of e.links)t.setEdge(i.source,i.target);dagre_2(t);const s={};let a=Math.min(...t.nodes().map((e=>t.node(e).y))),r=Math.min(...t.nodes().map((e=>t.node(e).x))),n=this._left-r,o=this._top-a;for(const e of t.nodes())s[e]={x:t.node(e).x+n,y:t.node(e).y+o};for(let e of this.group.children){let t=e.dataScope.getFieldValue(nodeId);e.x=s[i.get(t)].x,e.y=s[i.get(t)].y}}}var pixiRenderers={};function scene(e){return new Scene(e)}function renderer(e,t){switch(e){case"svg":return new SVGRenderer(t);case"webgl":return t in pixiRenderers||(pixiRenderers[t]=new WebGLRenderer(t)),pixiRenderers[t]}}function createScale(e,t){if(ScaleType.indexOf(e)<0)throw new Error(Errors.UNKOWNN_SCALE_TYPE+": "+e);return new Scale(e,t)}function layout(e,t){let i=t||{};switch(e.toLowerCase()){case"grid":return new GridLayout(i);case"packing":return new PackingLayout(i);case"treemap":return new TreemapLayout(i);case"stack":return new StackLayout(i);case"tidytree":return new TidyTreeLayout(i);case"force":return new ForceLayout(i);case"sugiyama":return new SugiyamaLayout(i)}}function linearGradient(e){return new LinearGradient(e||{})}function sceneLoader(){return new SceneLoader}function specGenerator(){return new SpecGenerator}function specExecutor(){return new SpecExecutor}function makeRequest(e,t){return new Promise((function(i,s){let a=new XMLHttpRequest;a.open(e,t),a.onload=function(){this.status>=200&&this.status<300?i(a.response):s({status:this.status,statusText:a.statusText})},a.onerror=function(){s({status:this.status,statusText:a.statusText})},a.send()}))}async function csv(e){let t=await makeRequest("GET",e),i=d3__namespace.csvParse(t.trim(),d3__namespace.autoType);return new DataTable(i,e)}async function csvFromFile(e){let t=d3__namespace.csvParse(e.trim(),d3__namespace.autoType);return new DataTable(t,"")}function csvFromString(e,t){let i=d3__namespace.csvParse(e.trim(),d3__namespace.autoType);return new DataTable(i,t)}async function treejson(e){let t=await makeRequest("GET",e);return new Tree(JSON.parse(t),e)}async function graphjson(e){let t=await makeRequest("GET",e);return new Network(JSON.parse(t),e)}function csvSync(e,t){let i=!!t;var s=new XMLHttpRequest;if(s.open("GET",e,i),s.send(),!i&&validResponse(s)){let t=d3__namespace.csvParse(s.responseText.trim(),d3__namespace.autoType);return new DataTable(t,e)}}function validResponse(e){var t=e.responseType;return t&&"text"!==t?e.response:e.responseText}function cartesianToPolar(e,t,i,s){return cartesian2Polar(e,t,i,s)}function polarToCartesian(e,t,i,s){return polar2Cartesian(e,t,i,s)}function inMarkRectHitTest(e,t,i){let s=i||2;if(isMark(e)){let i=[];for(let t of e.vertices){let e=Math.max(s,t.width,2*t.radius),a=Math.max(s,t.height,2*t.radius);i.push({i:t,b:new Rectangle(t.x-e/2,t.y-a/2,e,a)})}if(e.type===ItemType.Rect)for(let t of e.segments){let a=Math.max(e.strokeWidth,s);"v"===(t.vertex1.x===t.vertex2.x?"v":"h")?i.push({i:t,b:new Rectangle(t.vertex1.x-a/2,Math.min(t.vertex1.y,t.vertex2.y)-a/2,a,Math.abs(t.vertex1.y-t.vertex2.y))}):i.push({i:t,b:new Rectangle(Math.min(t.vertex1.x,t.vertex2.x)-a/2,t.vertex1.y-a/2,Math.abs(t.vertex1.x-t.vertex2.x),a)})}for(let e of i)if(e.b.overlap(t))return e.i;return null}if(!isGuide(e)&&e.children&&e.children.length>0){for(let i of e.children)if(i.bounds.overlap(t)){let e=inMarkRectHitTest(i,t,s);if(e)return e}return null}return null}function inMarkHitTest(e,t,i,s){let a=e,r=!1,n=s||2;for(;a.children&&a.children.length>0;){for(let e of a.children)if(e.contains(t,i)&&!isGuide(e)){a=e,r=!0;break}if(!r)break;r=!1}if(!isMark(a))return null;let o=[];for(let e of a.vertices){let t=Math.max(n,e.width,2*e.radius),i=Math.max(n,e.height,2*e.radius);o.push({i:e,b:new Rectangle(e.x-t/2,e.y-i/2,t,i)})}if(a.type===ItemType.Rect)for(let e of a.segments){let t=Math.max(a.strokeWidth,n);"v"===(e.vertex1.x===e.vertex2.x?"v":"h")?o.push({i:e,b:new Rectangle(e.vertex1.x-t/2,Math.min(e.vertex1.y,e.vertex2.y)-t/2,t,Math.abs(e.vertex1.y-e.vertex2.y))}):o.push({i:e,b:new Rectangle(Math.min(e.vertex1.x,e.vertex2.x)-t/2,e.vertex1.y-t/2,Math.abs(e.vertex1.x-e.vertex2.x),t)})}for(let e of o)if(e.b.contains(t,i))return e.i;return null}function rectHitTest(e,t){let i=[];if(!e.children||0==e.children.length)return e.bounds.overlap(t)&&e.type!==ItemType.Scene?[e]:[];for(let s=e.children.length-1;s>=0;s--){let a=e.children[s];a.bounds.overlap(t)&&i.push(a)}return i}function hitTest(e,t,i){if(!e.children||0==e.children.length)return e.contains(t,i)&&e.type!==ItemType.Scene?e:null;for(let s=e.children.length-1;s>=0;s--){let a=e.children[s];if(a.contains(t,i))return a}return null}function hitTestAll(e,t,i){let s=getLeafItems(e);for(let e=s.length-1;e>=0;e--){let a=s[e];if(a.contains(t,i))return a}return null}function canRepeat(e){return!(!isMark(e)&&e.type!=ItemType.Glyph||e.dataScope)||e.type==ItemType.Collection}function canDivide(e){if([ItemType.Line,ItemType.Circle,ItemType.Rect,ItemType.Area,ItemType.Ring].indexOf(e.type)<0)return!1;if(e.dataScope){let t=getPeers(e,e.getScene());for(let e of t)if(e.dataScope.numTuples>1)return!0;return!1}return!0}function canDensify(e){if([ItemType.Line,ItemType.Circle,ItemType.Rect,ItemType.Area].indexOf(e.type)<0)return!1;if(e.dataScope){let t=getPeers(e,e.getScene());for(let e of t)if(e.dataScope.numTuples>1)return!0;return!1}return!0}function getPeersInScene(e){return"vertex"==e.type||"segment"==e.type?getPeers(e,e.parent.getScene()):getPeers(e,e.getScene())}exports.canDensify=canDensify,exports.canDivide=canDivide,exports.canRepeat=canRepeat,exports.cartesianToPolar=cartesianToPolar,exports.createScale=createScale,exports.csv=csv,exports.csvFromFile=csvFromFile,exports.csvFromString=csvFromString,exports.csvSync=csvSync,exports.getPeersInScene=getPeersInScene,exports.graphjson=graphjson,exports.hitTest=hitTest,exports.hitTestAll=hitTestAll,exports.inMarkHitTest=inMarkHitTest,exports.inMarkRectHitTest=inMarkRectHitTest,exports.layout=layout,exports.linearGradient=linearGradient,exports.polarToCartesian=polarToCartesian,exports.rectHitTest=rectHitTest,exports.renderer=renderer,exports.scene=scene,exports.sceneLoader=sceneLoader,exports.specExecutor=specExecutor,exports.specGenerator=specGenerator,exports.treejson=treejson,Object.defineProperty(exports,"__esModule",{value:!0})}));
